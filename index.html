<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>🇯🇵 Japan Travel App - Updated</title>
  
  <!-- Mobile optimizations -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Japan Travel">
  <meta name="theme-color" content="#6366f1">
  
  <style>
    /* Inline CSS - no external dependencies */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f9fafb 0%, #e2e8f0 100%);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Loading screen styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
      text-align: center;
    }
    
    .loading-logo {
      font-size: 48px;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    
    .loading-title {
      font-size: 24px;
      font-weight: bold;
      color: #4f46e5;
      margin-bottom: 10px;
    }
    
    .loading-subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 30px;
    }
    
    /* Loading bar */
    .loading-bar-container {
      width: 100%;
      max-width: 300px;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, #4f46e5, #7c3aed);
      border-radius: 4px;
      animation: loading 3s ease-in-out infinite;
      transform-origin: left;
    }
    
    .debug-log {
      width: 100%;
      max-width: 300px;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 15px;
      font-size: 12px;
      color: #374151;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .debug-item {
      padding: 2px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .debug-item:last-child {
      border-bottom: none;
    }
    
    .version-info {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-size: 11px;
      color: #9ca3af;
      opacity: 0.7;
      font-family: 'Monaco', 'Menlo', monospace;
    }
    
    .success {
      color: #059669;
    }
    
    .error {
      color: #dc2626;
    }
    
    .hidden {
      display: none;
    }
    
    /* App styles */
    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: linear-gradient(90deg, #4f46e5, #7c3aed, #4f46e5);
      color: white;
      padding: 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      /* Extend header to account for iPhone status bar */
      padding-top: max(16px, calc(16px + env(safe-area-inset-top)));
    }
    
    .header-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .header-subtitle {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .content {
      flex: 1;
      padding: 16px;
      padding-bottom: 145px; /* Space for both navigation bars (66px + larger bottom nav) */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    .day-title {
      font-size: var(--title-text);
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .city-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #3730a3;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: var(--small-text);
      font-weight: 500;
      margin-left: 8px;
    }
    
    .date-text {
      color: #6b7280;
      font-size: var(--base-text);
      margin-bottom: 16px;
    }
    
    .weather-warning {
      background: #fef3c7;
      color: #92400e;
      padding: 12px;
      border-radius: 8px;
      font-size: var(--base-text);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .activity-card {
      background: linear-gradient(135deg, #ddd6fe, #e0e7ff);
      border: 1px solid #c4b5fd;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .activity-type {
      font-size: var(--small-text);
      text-transform: uppercase;
      font-weight: 500;
      opacity: 0.7;
      letter-spacing: 0.5px;
    }
    
    .activity-time {
      font-size: var(--small-text);
      opacity: 0.7;
      margin-top: 4px;
    }
    
    .activity-cost {
      background: rgba(255,255,255,0.7);
      padding: 8px;
      border-radius: 8px;
      text-align: right;
    }
    
    .cost-yen {
      font-weight: bold;
      font-size: var(--base-text);
    }
    
    .cost-usd {
      font-size: var(--small-text);
      opacity: 0.7;
    }
    
    .activity-title {
      font-size: var(--large-text);
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .activity-location {
      color: #6b7280;
      font-size: var(--base-text);
      margin-bottom: 8px;
    }
    
    .activity-description {
      font-size: var(--base-text);
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .significance-box {
      background: rgba(255,255,255,0.5);
      padding: 12px;
      border-radius: 8px;
    }
    
    .significance-title {
      font-weight: 500;
      font-size: var(--base-text);
      margin-bottom: 4px;
    }
    
    /* Day Navigation */
    .day-nav {
      position: fixed;
      bottom: 62px; /* Positioned to connect seamlessly with bottom nav */
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 12px 16px;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      z-index: 90;
    }
    
    /* Date Picker Tray */
    .date-picker-tray {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      z-index: 95;
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .date-picker-tray.show {
      transform: translateY(0);
    }
    
    .tray-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fafc;
      text-align: center;
      font-weight: 600;
      color: #374151;
    }
    
    .date-list {
      padding: 8px 0;
    }
    
    .date-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .date-item:hover {
      background: #f3f4f6;
    }
    
    .date-item.current {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
    }
    
    .date-item.today {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
    }
    
    .date-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 12px;
      font-size: 14px;
    }
    
    .date-item.current .date-number {
      background: #3b82f6;
      color: white;
    }
    
    .date-item.today .date-number {
      background: #f59e0b;
      color: white;
    }
    
    .date-details {
      flex: 1;
    }
    
    .date-title {
      font-weight: 500;
      font-size: 16px;
      color: #374151;
      margin-bottom: 2px;
    }
    
    .date-subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    
    .date-city {
      font-size: 12px;
      color: #3b82f6;
      font-weight: 500;
      margin-top: 2px;
    }
    
    /* Version History Modal */
    .version-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .version-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .version-content {
      background: white;
      border-radius: 12px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .version-modal.show .version-content {
      transform: translateY(0);
    }
    
    .version-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: 12px 12px 0 0;
    }
    
    .version-title {
      font-size: 20px;
      font-weight: bold;
      color: #1f2937;
      margin: 0 0 8px 0;
    }
    
    .version-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    
    .version-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }
    
    .version-close:hover {
      background: #f3f4f6;
    }
    
    .version-list {
      padding: 20px;
    }
    
    .version-item {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .version-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .version-number {
      font-size: 18px;
      font-weight: bold;
      color: #3b82f6;
      margin-bottom: 8px;
    }
    
    .version-date {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    
    .version-changes {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .version-changes li {
      display: flex;
      align-items: flex-start;
      margin-bottom: 6px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .version-changes li:last-child {
      margin-bottom: 0;
    }
    
    .change-type {
      margin-right: 8px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .version-changes .added { color: #059669; }
    .version-changes .improved { color: #3b82f6; }
    .version-changes .fixed { color: #f59e0b; }
    
    .day-nav-button {
      background: #f3f4f6;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    .day-nav-button:hover {
      background: #e5e7eb;
    }
    
    .day-nav-button:disabled {
      background: #f9fafb;
      color: #d1d5db;
      cursor: not-allowed;
    }
    
    .day-nav-center {
      flex: 1;
      text-align: center;
      padding: 0 16px;
    }
    
    .day-nav-date {
      font-weight: 600;
      font-size: var(--base-text);
      color: #1f2937;
      margin-bottom: 2px;
    }
    
    .day-nav-day {
      font-size: var(--small-text);
      color: #6b7280;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      z-index: 80;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    
    .nav-button {
      flex: 1;
      padding: 25px 10px 15px 10px;
      text-align: center;
      border: none;
      background: none;
      cursor: pointer;
      color: #6b7280;
      font-size: 12.5px;
      font-weight: 500;
    }
    
    .nav-button.active {
      color: #4f46e5;
    }
    
    .nav-icon {
      font-size: 20px;
      margin-bottom: 2.5px;
      display: block;
    }
    
    /* CSS Variables for text scaling */
    :root {
      --text-scale: 1;
    }
    
    :root[data-text-size="small"] {
      --text-scale: 0.85;
    }
    
    :root[data-text-size="medium"] {
      --text-scale: 1;
    }
    
    :root[data-text-size="large"] {
      --text-scale: 1.15;
    }
    
    :root[data-text-size="xlarge"] {
      --text-scale: 1.3;
    }
    
    /* Text size calculations */
    :root {
      --small-text: calc(12px * var(--text-scale));
      --base-text: calc(14px * var(--text-scale));
      --medium-text: calc(16px * var(--text-scale));
      --large-text: calc(18px * var(--text-scale));
      --xl-text: calc(20px * var(--text-scale));
      --title-text: calc(24px * var(--text-scale));
    }

    /* Text Size Controls - Collapsible */
    .text-toggle {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top)); /* Within header area */
      left: 20px;
      z-index: 1000;
    }
    
    .text-toggle-btn {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #4f46e5;
      font-weight: bold;
      font-size: 16px;
      font-family: serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    
    .text-toggle-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.05);
    }
    
    .text-controls {
      position: absolute;
      top: 50px;
      left: 0;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }
    
    .text-controls.show {
      display: flex;
    }
    
    .text-size-option {
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: #374151;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .text-size-option:hover {
      background: #f3f4f6;
    }
    
    .text-size-option.active {
      background: #4f46e5;
      color: white;
    }
    
    .size-preview {
      font-family: serif;
      font-weight: bold;
    }
    
    .size-preview.small { font-size: 11px; }
    .size-preview.medium { font-size: 13px; }
    .size-preview.large { font-size: 15px; }
    .size-preview.xlarge { font-size: 17px; }
    

    /* Animations */
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes loading {
      0% {
        transform: scaleX(0);
      }
      50% {
        transform: scaleX(0.7);
      }
      100% {
        transform: scaleX(1);
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading" class="loading-container">
    <div class="loading-logo">🇯🇵</div>
    <div class="loading-title">Japan Travel App</div>
    <div class="loading-subtitle">Preparing your adventure...</div>
    
    <div class="loading-bar-container">
      <div class="loading-bar"></div>
    </div>
    
    <div id="debug-log" class="debug-log">
      <div class="debug-item">🔄 Initializing app...</div>
    </div>
    
    <div class="version-info" id="version-display">v0.9.20250110</div>
  </div>

  <!-- Main App (initially hidden) -->
  <div id="app" class="app-container hidden">
    <!-- Text Size Controls -->
    <div class="text-toggle">
      <button class="text-toggle-btn" onclick="toggleTextControls()" id="text-toggle" title="Text size">A</button>
      <div class="text-controls" id="text-controls">
        <button class="text-size-option" onclick="setTextSize('small')" id="text-small">
          <span class="size-preview small">A</span>
          <span>Small</span>
        </button>
        <button class="text-size-option active" onclick="setTextSize('medium')" id="text-medium">
          <span class="size-preview medium">A</span>
          <span>Medium</span>
        </button>
        <button class="text-size-option" onclick="setTextSize('large')" id="text-large">
          <span class="size-preview large">A</span>
          <span>Large</span>
        </button>
        <button class="text-size-option" onclick="setTextSize('xlarge')" id="text-xlarge">
          <span class="size-preview xlarge">A</span>
          <span>Extra Large</span>
        </button>
      </div>
    </div>
    
    <!-- Header -->
    <header class="header">
      <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
        <span style="font-size: 24px;">🏔️</span>
        <div>
          <div class="header-title">Japan Adventure</div>
          <div class="header-subtitle">Tokyo • Kyoto • Osaka</div>
        </div>
        <span style="font-size: 24px;">🌸</span>
      </div>
    </header>

    <!-- Main Content -->
    <main class="content">
      <!-- Today View -->
      <div id="today-view">
        <div id="day-content">
          <!-- Day content will be populated dynamically -->
        </div>
      </div>
      
      <!-- Overview View -->
      <div id="overview-view" class="content hidden">
        <!-- Overview content will be populated here -->
      </div>
      
      <!-- Budget View -->
      <div id="budget-view" class="content hidden">
        <!-- Budget content will be populated here -->
      </div>
      
      <!-- Forecast View -->
      <div id="forecast-view" class="content hidden">
        <!-- Forecast content will be populated here -->
      </div>
      
    </main>

    <!-- Day Navigation -->
    <div class="day-nav">
      <button class="day-nav-button" onclick="previousDay()" id="prev-day">
        ←
      </button>
      <div class="day-nav-center" onclick="toggleDatePicker()" style="cursor: pointer;">
        <div class="day-nav-date" id="current-date">Monday, July 14</div>
        <div class="day-nav-day" id="current-day">Day 1 of 13</div>
      </div>
      <button class="day-nav-button" onclick="nextDay()" id="next-day">
        →
      </button>
    </div>

    <!-- Date Picker Tray -->
    <div class="date-picker-tray" id="date-picker-tray">
      <div class="tray-header">
        Select Trip Day
      </div>
      <div class="date-list" id="date-list">
        <!-- Date items will be populated by JavaScript -->
      </div>
    </div>

    <!-- Version History Modal -->
    <div class="version-modal" id="version-modal">
      <div class="version-content">
        <div class="version-header">
          <button class="version-close" onclick="closeVersionHistory()">×</button>
          <h2 class="version-title">🇯🇵 Japan Travel App</h2>
          <p class="version-subtitle">Version History & Release Notes</p>
        </div>
        <div class="version-list" id="version-history-list">
          <!-- Version history will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <button class="nav-button active" onclick="showView('today')" id="nav-today">
        <span class="nav-icon">📅</span>
        Today
      </button>
      <button class="nav-button" onclick="showView('overview')" id="nav-overview">
        <span class="nav-icon">📍</span>
        Overview
      </button>
      <button class="nav-button" onclick="showView('budget')" id="nav-budget">
        <span class="nav-icon">💰</span>
        Budget
      </button>
      <button class="nav-button" onclick="showView('forecast')" id="nav-forecast">
        <span class="nav-icon">🌤️</span>
        Forecast
      </button>
    </div>
  </div>

  <script>
    // App version
    const APP_VERSION = 'v1.6.20250115';
    
    // Weather API Configuration with CORS proxy for production deployment
    // SETUP: Add your OpenWeatherMap API key below to enable live weather on production site
    const WEATHER_CONFIG = {
      apiKey: "30812f90aa07f58d0028e8649f21e58a", // OpenWeatherMap API key for live weather
      baseUrl: 'https://api.allorigins.win/get?url=',
      updateInterval: 30 * 60 * 1000, // 30 minutes
      cache: {
        duration: 15 * 60 * 1000, // 15 minutes
        key: 'japan_weather_cache'
      }
    };
    
    // OpenRouteService Configuration (API key should be in environment variables)
    const ORS_CONFIG = {
      apiKey: null, // SETUP: Add your OpenRouteService API key here for testing, remove before commit
      baseUrl: 'https://api.openrouteservice.org/v2/directions',
      cache: {
        duration: 5 * 60 * 1000, // 5 minutes for routing data
        key: 'japan_routing_cache'
      },
      // Free tier: 2,000 requests/day, 40 requests/minute
      rateLimit: {
        requestsPerMinute: 35, // Stay under limit
        lastRequest: 0
      }
    };
    
    // City coordinates for weather API
    const CITY_COORDINATES = {
      'Tokyo': { lat: 35.6762, lon: 139.6503 },
      'Kyoto': { lat: 35.0116, lon: 135.7681 },
      'Osaka': { lat: 34.6937, lon: 135.5023 }
    };
    
    // Weather icons mapping
    const WEATHER_ICONS = {
      'clear': '☀️',
      'clouds': '☁️',
      'rain': '🌧️',
      'drizzle': '🌦️',
      'thunderstorm': '⛈️',
      'snow': '❄️',
      'mist': '🌫️',
      'fog': '🌫️',
      'haze': '🌫️'
    };
    
    
    // Comprehensive version history
    const VERSION_HISTORY = [
      {
        version: 'v1.6.20250115',
        date: 'January 15, 2025',
        changes: [
          { type: 'added', text: 'Day-specific weather forecasts for each trip day' },
          { type: 'improved', text: 'Weather display shows forecast for the exact date being viewed' },
          { type: 'added', text: 'Smart date detection: future trip days show forecasts, past days show current weather' },
          { type: 'added', text: 'Specific rain timing predictions (e.g., "Rain expected: 2 PM, 5 PM")' },
          { type: 'improved', text: 'Dynamic headers: "Forecast for July 18" vs "Live Weather & Today\'s Forecast"' },
          { type: 'added', text: 'Trip-aware weather logic that adapts based on viewing date vs current date' },
          { type: 'improved', text: 'Enhanced weather recommendations specific to each day\'s conditions' }
        ]
      },
      {
        version: 'v1.5.20250115',
        date: 'January 15, 2025',
        changes: [
          { type: 'added', text: '5-Day Weather Forecast tab with dynamic city-based predictions' },
          { type: 'added', text: 'Smart forecast location detection based on trip itinerary' },
          { type: 'added', text: 'Automatic past day filtering for relevant future forecasts' },
          { type: 'improved', text: 'Navigation expanded to 4 tabs with new Forecast section' },
          { type: 'added', text: 'Free OpenWeatherMap 5-day/3-hour forecast API integration' },
          { type: 'added', text: 'Daily high/low temperature aggregation from 3-hour data' },
          { type: 'added', text: 'Fallback July weather information when API unavailable' }
        ]
      },
      {
        version: 'v1.4.1.20250113',
        date: 'January 13, 2025',
        changes: [
          { type: 'improved', text: 'Budget tab completely updated with accurate Trip_Plan.md data' },
          { type: 'fixed', text: 'Corrected total budget from inaccurate estimates to ¥168,310 ($1,178.17)' },
          { type: 'fixed', text: 'Fixed daily cost breakdown to show all 13 days instead of 11' },
          { type: 'added', text: 'Added comprehensive category breakdown (Food, Transport, Attractions, etc.)' },
          { type: 'improved', text: 'Updated phase groupings: Tokyo Phase 1, Kyoto Phase, Tokyo Bay Phase' },
          { type: 'improved', text: 'Enhanced budget details with accurate exchange rate (¥143 = $1)' },
          { type: 'added', text: 'Added Tokyo Bay Phase with Disney and departure costs' },
          { type: 'fixed', text: 'Corrected day-by-day cost accuracy from Trip_Plan.md source' }
        ]
      },
      {
        version: 'v1.1.1.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'fixed', text: 'Version history modal access - entire version tile now clickable' },
          { type: 'improved', text: 'Enhanced version tile with touch feedback and visual cues' },
          { type: 'improved', text: 'Added tap indicator and mobile-optimized interactions' }
        ]
      },
      {
        version: 'v1.1.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Interactive date picker tray with slide-up animation' },
          { type: 'added', text: 'Quick day selection by tapping date in navigation bar' },
          { type: 'added', text: 'Comprehensive version history library with modal access' },
          { type: 'improved', text: 'Visual indicators for current day and actual "today"' },
          { type: 'improved', text: 'Enhanced mobile UX with smooth transitions' }
        ]
      },
      {
        version: 'v1.0.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Smart "Today" button navigation based on actual trip dates' },
          { type: 'added', text: 'Automatic current day detection (July 12-26, 2025)' },
          { type: 'added', text: 'Real-time "TODAY" indicator in day navigation' },
          { type: 'improved', text: 'App initialization starts on current trip day' },
          { type: 'improved', text: 'Enhanced debug logging for date calculations' }
        ]
      },
      {
        version: 'v0.95.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Apple Maps integration for all location links' },
          { type: 'fixed', text: 'Address validation: Hyatt House Shibuya, Caption by Hyatt Namba' },
          { type: 'fixed', text: 'Restaurant address corrections: Uobei Shibuya Dogenzaka' },
          { type: 'added', text: 'Comprehensive location database with 35+ verified addresses' },
          { type: 'improved', text: 'Native iOS map experience with precise navigation' }
        ]
      },
      {
        version: 'v0.9.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Clickable map links for hotels, restaurants, and attractions' },
          { type: 'added', text: 'Address display with pin emoji for all locations' },
          { type: 'added', text: 'Restaurant validation: Numazuko closure handling' },
          { type: 'improved', text: 'Location database with verified addresses' },
          { type: 'improved', text: 'Enhanced navigation to all trip destinations' }
        ]
      },
      {
        version: 'v0.8.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Sticky header and dual footer layout design' },
          { type: 'added', text: 'Text size adjustment with collapsible "A" button' },
          { type: 'added', text: 'Working Overview and Budget navigation' },
          { type: 'added', text: 'Comprehensive Budget breakdown ($1,178.17 total)' },
          { type: 'added', text: 'Cultural highlights and trip overview content' },
          { type: 'fixed', text: 'Text size CSS variables implementation' },
          { type: 'fixed', text: 'Bottom navigation functionality restored' }
        ]
      },
      {
        version: 'v0.7.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Complete Days 6-11 with enhanced CLAUDE.md structure' },
          { type: 'added', text: 'Kyoto temple experiences and bamboo grove visits' },
          { type: 'added', text: 'Osaka culinary adventures with street food marathon' },
          { type: 'added', text: 'LGBTQ+ nightlife venues in all cities' },
          { type: 'added', text: 'Premium rooftop bars and city views' },
          { type: 'improved', text: 'Cultural etiquette sections for all activities' },
          { type: 'improved', text: 'Multiple restaurant options with detailed descriptions' }
        ]
      },
      {
        version: 'v0.6.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Enhanced Days 1-5 with complete activity details' },
          { type: 'added', text: 'Festival integration: Mitama Matsuri and Gion Matsuri' },
          { type: 'added', text: 'teamLab Planets and Mario Kart Tokyo experiences' },
          { type: 'added', text: 'EDM club recommendations: WOMB Shibuya' },
          { type: 'added', text: 'Traditional cultural experiences and etiquette guides' },
          { type: 'fixed', text: 'Chronological activity ordering (morning to evening)' },
          { type: 'improved', text: 'Comprehensive "What to Do" and "What to Expect" sections' }
        ]
      },
      {
        version: 'v0.5.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Dynamic day navigation with previous/next arrows' },
          { type: 'added', text: 'Complete trip data structure for all 13 days' },
          { type: 'added', text: 'Activity type categorization with color coding' },
          { type: 'added', text: 'Cost summaries and budget tracking' },
          { type: 'fixed', text: 'Mobile browser compatibility (no external dependencies)' },
          { type: 'fixed', text: 'Day 1 static content loading issue' },
          { type: 'improved', text: 'Activity card design with enhanced visual hierarchy' }
        ]
      },
      {
        version: 'v0.4.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Weather advisory system with dynamic display' },
          { type: 'added', text: 'Loading screen with progress indicators' },
          { type: 'added', text: 'Debug logging system for troubleshooting' },
          { type: 'improved', text: 'Mobile responsiveness and touch optimization' },
          { type: 'improved', text: 'iOS web app meta tags and optimizations' }
        ]
      },
      {
        version: 'v0.3.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Basic 11-day Japan itinerary structure' },
          { type: 'added', text: 'Hotel information: Hyatt House, Hyatt Place, Caption by Hyatt' },
          { type: 'added', text: 'Restaurant recommendations with pricing' },
          { type: 'added', text: 'Transportation details and costs' },
          { type: 'improved', text: 'Daily activity organization and timing' }
        ]
      },
      {
        version: 'v0.2.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Mobile-first responsive design' },
          { type: 'added', text: 'CSS gradient backgrounds and modern styling' },
          { type: 'added', text: 'Bottom navigation bar' },
          { type: 'improved', text: 'Touch-friendly interface elements' }
        ]
      },
      {
        version: 'v0.1.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Initial app framework and structure' },
          { type: 'added', text: 'Basic HTML/CSS/JavaScript foundation' },
          { type: 'added', text: 'App versioning system implementation' }
        ]
      }
    ];
    
    // Location database with addresses for map links
    const LOCATION_DATABASE = {
      // Hotels
      'Hyatt House Shibuya': {
        address: '3-3 Sakuragaoka-cho, Shibuya City, Tokyo 150-0031, Japan',
        type: 'hotel'
      },
      'Hyatt Place Kyoto': {
        address: '644-2 Sannenzaka, Higashiyama Ward, Kyoto 605-0862, Japan',
        type: 'hotel'
      },
      'Caption by Hyatt Namba': {
        address: '2-7-5 Nippombashi, Chuo Ward, Osaka 542-0073, Japan',
        type: 'hotel'
      },
      
      // Major Attractions
      'Shibuya Crossing': {
        address: '2-2-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'attraction'
      },
      'Meiji Shrine': {
        address: '1-1 Kamizono-cho, Shibuya City, Tokyo 151-8557, Japan',
        type: 'shrine'
      },
      'Sensoji Temple': {
        address: '2-3-1 Asakusa, Taito City, Tokyo 111-0032, Japan',
        type: 'temple'
      },
      'Tokyo National Museum': {
        address: '13-9 Uenokoen, Taito City, Tokyo 110-8712, Japan',
        type: 'museum'
      },
      'Sumida Hokusai Museum': {
        address: '2-7-2 Kamezawa, Sumida City, Tokyo 130-0014, Japan',
        type: 'museum'
      },
      'Fushimi Inari Shrine': {
        address: '68 Fukakusa Yabunouchicho, Fushimi Ward, Kyoto 612-0882, Japan',
        type: 'shrine'
      },
      'Arashiyama Bamboo Grove': {
        address: 'Arashiyama Sagatenryuji Susukinobabacho, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'attraction'
      },
      'Gion District': {
        address: 'Gion, Higashiyama Ward, Kyoto 605-0001, Japan',
        type: 'district'
      },
      'Nijo Castle': {
        address: '541 Nijojocho, Nakagyo Ward, Kyoto 604-8301, Japan',
        type: 'castle'
      },
      'Osaka Castle': {
        address: '1-1 Osakajo, Chuo Ward, Osaka 540-0002, Japan',
        type: 'castle'
      },
      'Dotonbori': {
        address: 'Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'district'
      },
      
      // Transportation
      'Haneda Airport': {
        address: '3-3-2 Hanedakuko, Ota City, Tokyo 144-0041, Japan',
        type: 'airport'
      },
      'Shibuya Station': {
        address: '2-24-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'station'
      },
      'Tokyo Station': {
        address: '1-1 Marunouchi, Chiyoda City, Tokyo 100-0005, Japan',
        type: 'station'
      },
      'Kyoto Station': {
        address: 'Higashishiokoji-cho, Shimogyo Ward, Kyoto 600-8216, Japan',
        type: 'station'
      },
      
      // Restaurants
      'Uobei Shibuya Dogenzaka': {
        address: '1F Dai-roku Central Building, 2-29-11 Dogenzaka, Shibuya City, Tokyo 150-0043, Japan',
        type: 'restaurant'
      },
      'Numazuko Sushi (Tokyo Station)': {
        address: '3-34-16 Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'restaurant'
      },
      'Seamon Ginza': {
        address: '4-14-16 Ginza, Chuo City, Tokyo 104-0061, Japan',
        type: 'restaurant'
      },
      'Nakiryu': {
        address: '2-34-4 Minamiikebukuro, Toshima City, Tokyo 171-0022, Japan',
        type: 'restaurant'
      },
      'Nakiryu (Otsuka)': {
        address: '2-34-4 Minamiikebukuro, Toshima City, Tokyo 171-0022, Japan',
        type: 'restaurant'
      },
      'Katsukura Kyoto Station': {
        address: 'Kyoto Station Building, 901 Higashishiokoji-cho, Shimogyo Ward, Kyoto 600-8216, Japan',
        type: 'restaurant'
      },
      'Wanaka': {
        address: '1-4-16 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      'Takoyaki at Wanaka': {
        address: '1-4-16 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      'Mizuno': {
        address: '1-4-15 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      'Okonomiyaki at Mizuno': {
        address: '1-4-15 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      
      // More Restaurants
      'Ganko Sushi': {
        address: '6-4-12 Ginza, Chuo City, Tokyo 104-0061, Japan',
        type: 'restaurant'
      },
      'Chanko Kirishima': {
        address: '2-13-1 Ryogoku, Sumida City, Tokyo 130-0026, Japan',
        type: 'restaurant'
      },
      'Ryogoku Terrace Cafe': {
        address: '1-3-28 Yokoami, Sumida City, Tokyo 130-0015, Japan (Ryogoku Kokugikan 9F)',
        type: 'restaurant'
      },
      'Tsukiji Itadori Ryogoku': {
        address: '1-2-18 Ryogoku, Sumida City, Tokyo 130-0026, Japan',
        type: 'restaurant'
      },
      'Kihachi Marunouchi Building': {
        address: '2-4-1 Marunouchi, Chiyoda City, Tokyo 100-6390, Japan (Marunouchi Building 35F)',
        type: 'restaurant'
      },
      'Nihonbashi Tamai Tokyo Station': {
        address: '1-9-1 Marunouchi, Chiyoda City, Tokyo 100-0005, Japan (Tokyo Station 1F)',
        type: 'restaurant'
      },
      'Kyoboshi Marunouchi': {
        address: '2-7-3 Marunouchi, Chiyoda City, Tokyo 100-0005, Japan (Tokia Building B1F)',
        type: 'restaurant'
      },
      'teamLab Planets': {
        address: '6-chōme-1-16 Toyosu, Koto City, Tokyo 135-0061, Japan (near Shin-Toyosu Station)',
        type: 'museum'
      },
      'Kura Sushi Shibuya': {
        address: '28-6 Udagawacho, Shibuya City, Tokyo 150-0042, Japan',
        type: 'restaurant'
      },
      'Ichiran Ramen Shibuya': {
        address: '1-22-7 Jinnan, Shibuya City, Tokyo 150-0041, Japan',
        type: 'restaurant'
      },
      'Ramen Break Beats': {
        address: '1-5-8 Meguro, Meguro City, Tokyo 153-0063, Japan',
        type: 'restaurant'
      },
      'Konjiki Hototogisu': {
        address: '1-17-1 Kabukicho, Shinjuku City, Tokyo 160-0021, Japan',
        type: 'restaurant'
      },
      'Kyoto Station Ramen Koji': {
        address: 'Kyoto Station Building 10F, 901 Higashishiokoji-cho, Shimogyo Ward, Kyoto 600-8216, Japan',
        type: 'restaurant'
      },
      'Yudofu Sagano': {
        address: '45 Saga Tenryuji Susukinobabacho, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'restaurant'
      },
      'Daruma Kushikatsu': {
        address: '1-8-25 Shinsekai, Naniwa Ward, Osaka 556-0002, Japan',
        type: 'restaurant'
      },
      
      // More Attractions
      'Shibuya Sky': {
        address: '2-24-12 Shibuya, Shibuya City, Tokyo 150-0002, Japan (47F Shibuya Scramble Square)',
        type: 'attraction'
      },
      'Yasukuni Shrine': {
        address: '3-1-1 Kudanminami, Chiyoda City, Tokyo 102-8246, Japan',
        type: 'shrine'
      },
      'Imperial Palace East Gardens': {
        address: '1-1 Chiyoda, Chiyoda City, Tokyo 100-8111, Japan (Otemon Gate entrance)',
        type: 'attraction'
      },
      'Ueno Park': {
        address: 'Uenokoen, Taito City, Tokyo 110-0007, Japan',
        type: 'park'
      },
      'Tokyo Tower': {
        address: '4-2-8 Shibakoen, Minato City, Tokyo 105-0011, Japan',
        type: 'attraction'
      },
      'Tokyo Skytree': {
        address: '1-1-2 Oshiage, Sumida City, Tokyo 131-0045, Japan',
        type: 'attraction'
      },
      'teamLab Planets': {
        address: '6-chōme-1-16 Toyosu, Koto City, Tokyo 135-0061, Japan (near Shin-Toyosu Station)',
        type: 'museum'
      },
      'Tenryu-ji Temple': {
        address: '68 Saga Tenryuji Susukinobabacho, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'temple'
      },
      'Yasaka Shrine': {
        address: '625 Gionmachi Kitagawa, Higashiyama Ward, Kyoto 605-0073, Japan',
        type: 'shrine'
      },
      'Nishiki Market': {
        address: '604 Nishiki-koji Dori, Nakagyo Ward, Kyoto 604-8054, Japan',
        type: 'market'
      },
      
      // Districts
      'Harajuku': {
        address: 'Harajuku, Shibuya City, Tokyo 150-0001, Japan',
        type: 'district'
      },
      'Asakusa': {
        address: 'Asakusa, Taito City, Tokyo 111-0032, Japan',
        type: 'district'
      },
      'Shinjuku': {
        address: 'Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'district'
      },
      'Ginza': {
        address: 'Ginza, Chuo City, Tokyo 104-0061, Japan',
        type: 'district'
      },
      'Shibuya': {
        address: 'Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'district'
      },
      'Arashiyama': {
        address: 'Arashiyama, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'district'
      },
      'Higashiyama': {
        address: 'Higashiyama Ward, Kyoto 605-0000, Japan',
        type: 'district'
      },
      'Namba': {
        address: 'Namba, Chuo Ward, Osaka 542-0076, Japan',
        type: 'district'
      },
      
      // Nightlife
      'WOMB Shibuya': {
        address: '2-16 Maruyamacho, Shibuya City, Tokyo 150-0044, Japan',
        type: 'nightlife'
      },
      'Shinjuku Golden Gai': {
        address: '1-1-6 Kabukicho, Shinjuku City, Tokyo 160-0021, Japan',
        type: 'nightlife'
      },
      'Ni-chome': {
        address: '2-chome Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'district'
      },
      'CÉ LA VI Tokyo': {
        address: '6-10-1 Roppongi, Minato City, Tokyo 106-6108, Japan',
        type: 'nightlife'
      },
      'Andaz Tokyo Rooftop': {
        address: '1-23-4 Toranomon, Minato City, Tokyo 105-0001, Japan',
        type: 'nightlife'
      },
      'K36 Rooftop Bar': {
        address: '36 Kodonocho, Higashiyama Ward, Kyoto 605-0921, Japan',
        type: 'nightlife'
      },
      
      // Additional Restaurants
      'Ganko Ramen (Tokyo Station)': {
        address: 'B1F Yaesu South Exit, Tokyo Station, Chiyoda City, Tokyo 100-0005, Japan',
        type: 'restaurant'
      },
      'Daikokuya Tempura (Asakusa)': {
        address: '1-38-10 Asakusa, Taito City, Tokyo 111-0032, Japan',
        type: 'restaurant'
      },
      'Namiki Yabu Soba (Asakusa)': {
        address: '2-11-9 Kaminarimon, Taito City, Tokyo 111-0034, Japan',
        type: 'restaurant'
      },
      'Torikizoku (Shibuya)': {
        address: '2-20-11 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'restaurant'
      },
      'Numazuko Sushi (Tokyo Station)': {
        address: 'B1F Tokyo Station, Chiyoda City, Tokyo 100-0005, Japan',
        type: 'restaurant'
      },
      'Kawaii Monster Cafe (Harajuku)': {
        address: '4F YM Square Harajuku, 4-31-10 Jingumae, Shibuya City, Tokyo 150-0001, Japan',
        type: 'restaurant'
      },
      'Bills Omotesando': {
        address: '4F Omotesando Hills West Building, 4-12-10 Jingumae, Shibuya City, Tokyo 150-0001, Japan',
        type: 'restaurant'
      },
      'Shibuya Food Show (Tokyu)': {
        address: 'B1F-B2F Tokyu Department Store, 2-24-1 Shibuya, Shibuya City, Tokyo 150-8019, Japan',
        type: 'restaurant'
      },
      'Hanasaki Manjiro (Higashiyama)': {
        address: '518 Washiocho, Higashiyama Ward, Kyoto 605-0072, Japan',
        type: 'restaurant'
      },
      'Kushikatsu at Daruma': {
        address: '1-8-25 Shinsekai, Naniwa Ward, Osaka 556-0002, Japan',
        type: 'restaurant'
      },
      'Rengetsu-jaya (Higashiyama)': {
        address: 'Higashiyama Ward, Kyoto 605-0862, Japan',
        type: 'restaurant'
      },
      'Tousuiro (Gion or Nakagyo location)': {
        address: 'Gion, Higashiyama Ward, Kyoto 605-0001, Japan',
        type: 'restaurant'
      },
      'Yudofu Sagano (Arashiyama)': {
        address: '45 Susukinobana-cho, SagaTenryu-ji, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'restaurant'
      },
      'Yudofu Sagano': {
        address: '45 Susukinobana-cho, SagaTenryu-ji, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'restaurant'
      },
      
      // Additional locations from activities
      'Haneda Airport to Shibuya': {
        address: '2-24-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'route'
      },
      'Shinjuku Ni-chome': {
        address: '2-chome Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'district'
      },
      'Central Kyoto': {
        address: 'Nakagyo Ward, Kyoto 604-8006, Japan',
        type: 'district'
      },
      'Dotonbori area': {
        address: 'Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'district'
      },
      
      // Additional exact addresses verified with Google Maps 2024
      'Mario Kart Street Racing': {
        address: '2-9-10 Shibuya, Shibuya City, Tokyo 150-0002, Japan (Street Kart Shibuya main location)',
        type: 'activity'
      },
      'Tokyo Tower': {
        address: '4-2-8 Shibakoen, Minato City, Tokyo 105-0011, Japan',
        type: 'attraction'
      },
      'Roppongi Hills': {
        address: '6-10-1 Roppongi, Minato City, Tokyo 106-6108, Japan',
        type: 'attraction'
      },
      'Toranomon Hills': {
        address: '2-6-4 Toranomon, Minato City, Tokyo 105-0001, Japan (Station Tower)',
        type: 'attraction'
      },
      'Tsukiji Outer Market': {
        address: '4-16-2 Tsukiji, Chuo City, Tokyo 104-0045, Japan',
        type: 'market'
      }
    };
    
    // Weather API Functions
    class WeatherCache {
      static isValid(timestamp) {
        return Date.now() - timestamp < WEATHER_CONFIG.cache.duration;
      }
      
      static save(city, data) {
        try {
          localStorage.setItem(`weather_${city}`, JSON.stringify({
            data,
            timestamp: Date.now()
          }));
        } catch (error) {
          console.warn('Weather cache save failed:', error);
        }
      }
      
      static load(city) {
        try {
          const cached = localStorage.getItem(`weather_${city}`);
          if (cached) {
            const parsed = JSON.parse(cached);
            if (this.isValid(parsed.timestamp)) {
              return parsed.data;
            }
          }
        } catch (error) {
          console.warn('Weather cache load failed:', error);
        }
        return null;
      }
    }
    
    async function getCurrentWeather(city) {
      console.log(`🔑 Weather API key configured: ${WEATHER_CONFIG.apiKey ? 'YES' : 'NO'}`);
      
      if (!WEATHER_CONFIG.apiKey || WEATHER_CONFIG.apiKey === 'YOUR_API_KEY_HERE') {
        throw new Error('Weather API key not configured');
      }
      
      const coords = CITY_COORDINATES[city];
      if (!coords) {
        throw new Error(`No coordinates found for city: ${city}`);
      }
      
      // Use CORS proxy for production
      const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${coords.lat}&lon=${coords.lon}&appid=${WEATHER_CONFIG.apiKey}&units=metric`;
      const url = `${WEATHER_CONFIG.baseUrl}${encodeURIComponent(weatherUrl)}`;
      
      console.log(`🌐 Making weather API request to: ${url}`);
      console.log(`📍 Coordinates for ${city}: ${coords.lat}, ${coords.lon}`);
      
      const response = await fetch(url);
      console.log(`📡 Weather API response status: ${response.status}`);
      
      if (!response.ok) {
        throw new Error(`Weather API error: ${response.status}`);
      }
      
      const proxyData = await response.json();
      console.log(`📦 Proxy response:`, proxyData);
      
      // AllOrigins wraps the response in a 'contents' field
      const weatherData = JSON.parse(proxyData.contents);
      console.log(`🌤️ Parsed weather data:`, weatherData);
      
      return weatherData;
    }
    
    async function getWeatherWithFallback(city) {
      try {
        // Try cache first
        const cached = WeatherCache.load(city);
        if (cached) {
          addDebugLog(`☁️ Using cached weather for ${city}`, 'info');
          return cached;
        }
        
        // Fetch fresh data
        addDebugLog(`🌐 Fetching live weather for ${city}`, 'info');
        const weather = await getCurrentWeather(city);
        WeatherCache.save(city, weather);
        addDebugLog(`✅ Live weather loaded for ${city}`, 'success');
        return weather;
      } catch (error) {
        addDebugLog(`❌ Weather API error: ${error.message}`, 'error');
        console.error('Weather API error:', error);
        // Fall back to static weather data
        return getStaticWeatherData(city);
      }
    }
    
    function getStaticWeatherData(city) {
      // Fallback weather data for July in Japan
      return {
        main: {
          temp: 30,
          feels_like: 35,
          humidity: 78,
          temp_min: 28,
          temp_max: 32
        },
        weather: [{
          main: 'Clear',
          description: 'hot and humid',
          icon: '01d'
        }],
        name: city,
        isStatic: true
      };
    }
    
    function getWeatherIcon(weatherMain) {
      if (!weatherMain) return '🌤️';
      const main = weatherMain.toLowerCase();
      return WEATHER_ICONS[main] || '🌤️';
    }
    
    function createWeatherDisplay(weatherData, includeDetails = true) {
      if (!weatherData || !weatherData.weather || !weatherData.weather[0]) {
        return includeDetails ? 
          '🌤️ Hot & humid (84-90°F) - estimated' : 
          '🌤️ 84-90°F (estimated)';
      }
      
      const icon = getWeatherIcon(weatherData.weather[0].main);
      const isStatic = weatherData.isStatic;
      const staticIndicator = isStatic ? ' (estimated)' : '';
      
      if (!includeDetails) {
        return weatherData.main ? 
          `${icon} ${celsiusToFahrenheit(weatherData.main.temp)}°F${staticIndicator}` :
          `${icon} 84-90°F (estimated)`;
      }
      
      if (!weatherData.main) {
        return `
          <div style="display: flex; align-items: center; gap: 8px; font-size: var(--base-text);">
            <span style="font-size: var(--medium-text);">${icon}</span>
            <div>
              <div style="font-weight: 600;">Hot & humid (84-90°F) - estimated</div>
              <div style="font-size: var(--small-text); opacity: 0.8;">Typical July weather for Japan</div>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="display: flex; align-items: center; gap: 8px; font-size: var(--base-text);">
          <span style="font-size: var(--medium-text);">${icon}</span>
          <div>
            <div style="font-weight: 600;">${celsiusToFahrenheit(weatherData.main.temp)}°F (feels like ${celsiusToFahrenheit(weatherData.main.feels_like)}°F)${staticIndicator}</div>
            <div style="font-size: var(--small-text); opacity: 0.8;">${weatherData.weather[0].description} • ${weatherData.main.humidity}% humidity</div>
          </div>
        </div>
      `;
    }
    
    function getWeatherRecommendation(weatherData) {
      // Handle incomplete weather data gracefully
      if (!weatherData || !weatherData.main || !weatherData.weather || !weatherData.weather[0]) {
        return {
          type: 'good',
          advice: 'Check local weather conditions for your travel dates',
          icon: '🌤️'
        };
      }
      
      const temp = weatherData.main.temp;
      const humidity = weatherData.main.humidity;
      const condition = weatherData.weather[0].main.toLowerCase();
      
      if (condition.includes('rain') || condition.includes('drizzle')) {
        return {
          type: 'rain',
          icon: '☔',
          message: 'Rain expected - consider indoor activities like museums, shopping centers, or covered markets'
        };
      }
      
      if (condition.includes('thunderstorm')) {
        return {
          type: 'storm',
          icon: '⛈️',
          message: 'Thunderstorms possible - stay indoors and avoid outdoor sightseeing'
        };
      }
      
      if (temp > 32 || (temp > 28 && humidity > 75)) {
        return {
          type: 'heat',
          icon: '🌡️',
          message: 'Very hot and humid - stay hydrated, seek air conditioning, and plan outdoor activities for early morning or evening'
        };
      }
      
      if (temp > 28) {
        return {
          type: 'warm',
          icon: '☀️',
          message: 'Hot weather - stay hydrated and take breaks in air-conditioned spaces'
        };
      }
      
      return {
        type: 'good',
        icon: '✨',
        message: 'Great weather for outdoor activities!'
      };
    }
    
    // Transit API Functions
    class TransitCache {
      static isValid(timestamp) {
        return Date.now() - timestamp < TRANSIT_CONFIG.cache.duration;
      }
      
      static save(routeKey, data) {
        try {
          localStorage.setItem(`transit_${routeKey}`, JSON.stringify({
            data,
            timestamp: Date.now()
          }));
        } catch (error) {
          console.warn('Transit cache save failed:', error);
        }
      }
      
      static load(routeKey) {
        try {
          const cached = localStorage.getItem(`transit_${routeKey}`);
          if (cached) {
            const parsed = JSON.parse(cached);
            if (this.isValid(parsed.timestamp)) {
              return parsed.data;
            }
          }
        } catch (error) {
          console.warn('Transit cache load failed:', error);
        }
        return null;
      }
    }
    
    // OpenRouteService Cache Management
    const ORSCache = {
      save(key, data) {
        try {
          const cacheData = {
            data: data,
            timestamp: Date.now()
          };
          localStorage.setItem(`${ORS_CONFIG.cache.key}_${key}`, JSON.stringify(cacheData));
        } catch (error) {
          console.warn('ORS cache save failed:', error);
        }
      },
      
      load(key) {
        try {
          const cached = localStorage.getItem(`${ORS_CONFIG.cache.key}_${key}`);
          if (cached) {
            const parsed = JSON.parse(cached);
            if (Date.now() - parsed.timestamp < ORS_CONFIG.cache.duration) {
              return parsed.data;
            }
          }
        } catch (error) {
          console.warn('ORS cache load failed:', error);
        }
        return null;
      }
    };

    // Rate limiting for OpenRouteService
    function checkRateLimit() {
      const now = Date.now();
      const timeSinceLastRequest = now - ORS_CONFIG.rateLimit.lastRequest;
      const minInterval = 60000 / ORS_CONFIG.rateLimit.requestsPerMinute; // ms between requests
      
      if (timeSinceLastRequest < minInterval) {
        const waitTime = minInterval - timeSinceLastRequest;
        return waitTime;
      }
      
      ORS_CONFIG.rateLimit.lastRequest = now;
      return 0;
    }

    // Convert address to coordinates (simple geocoding for major Japan locations)
    function getCoordinatesFromAddress(address) {
      const locations = {
        // Tokyo major locations
        'Tokyo Station': { lat: 35.6812, lon: 139.7671 },
        'Shibuya': { lat: 35.6595, lon: 139.7006 },
        'Shinjuku': { lat: 35.6902, lon: 139.7006 },
        'Harajuku': { lat: 35.6706, lon: 139.7026 },
        'Asakusa': { lat: 35.7148, lon: 139.7967 },
        'Ginza': { lat: 35.6714, lon: 139.7656 },
        'Haneda Airport': { lat: 35.5494, lon: 139.7798 },
        
        // Kyoto major locations
        'Kyoto Station': { lat: 34.9857, lon: 135.7588 },
        'Gion': { lat: 35.0033, lon: 135.7778 },
        'Fushimi Inari': { lat: 34.9669, lon: 135.7727 },
        'Arashiyama': { lat: 35.0170, lon: 135.6761 },
        
        // Osaka major locations
        'Osaka Station': { lat: 34.7024, lon: 135.4959 },
        'Dotonbori': { lat: 34.6686, lon: 135.5023 },
        'Kansai Airport': { lat: 34.4347, lon: 135.2441 }
      };
      
      // Try exact match first
      if (locations[address]) {
        return locations[address];
      }
      
      // Try partial match
      for (const [key, coords] of Object.entries(locations)) {
        if (address.includes(key) || key.includes(address)) {
          return coords;
        }
      }
      
      return null;
    }

    async function getORSDirections(origin, destination, profile = 'driving-car') {
      // Check if we have API key
      if (!ORS_CONFIG.apiKey) {
        addDebugLog('🔑 OpenRouteService API key not configured', 'warning');
        throw new Error('OpenRouteService API key not configured');
      }
      
      // Check rate limit
      const waitTime = checkRateLimit();
      if (waitTime > 0) {
        addDebugLog(`⏳ Rate limit: waiting ${waitTime}ms`, 'warning');
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
      
      // Get coordinates
      const originCoords = getCoordinatesFromAddress(origin);
      const destCoords = getCoordinatesFromAddress(destination);
      
      if (!originCoords || !destCoords) {
        throw new Error(`Could not find coordinates for ${origin} or ${destination}`);
      }
      
      // Create cache key
      const cacheKey = `${origin}_${destination}_${profile}`.replace(/[^a-zA-Z0-9]/g, '_');
      
      // Check cache first
      const cached = ORSCache.load(cacheKey);
      if (cached) {
        addDebugLog(`📋 Using cached ORS data for ${origin} to ${destination}`, 'info');
        return cached;
      }
      
      try {
        const url = `${ORS_CONFIG.baseUrl}/${profile}`;
        const requestBody = {
          coordinates: [
            [originCoords.lon, originCoords.lat],
            [destCoords.lon, destCoords.lat]
          ],
          format: 'json',
          instructions: false,
          geometry: false
        };
        
        addDebugLog(`🌐 Fetching ORS directions: ${profile}`, 'info');
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': ORS_CONFIG.apiKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          throw new Error(`ORS API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const result = {
            distance: route.summary.distance, // meters
            duration: route.summary.duration, // seconds
            profile: profile
          };
          
          // Cache the result
          ORSCache.save(cacheKey, result);
          addDebugLog(`✅ ORS directions loaded: ${Math.round(result.distance/1000)}km, ${Math.round(result.duration/60)}min`, 'success');
          
          return result;
        } else {
          throw new Error('No routes found');
        }
        
      } catch (error) {
        addDebugLog(`❌ ORS API error: ${error.message}`, 'error');
        throw error;
      }
    }

    async function getMultiModalDirections(origin, destination) {
      // Try OpenRouteService first
      try {
        addDebugLog(`🚆 Fetching multi-modal directions: ${origin} to ${destination}`, 'info');
        
        const results = {};
        const profiles = [
          { name: 'walking', ors: 'foot-walking' },
          { name: 'driving', ors: 'driving-car' },
          { name: 'cycling', ors: 'cycling-regular' }
        ];
        
        // Get multiple transport modes
        for (const profile of profiles) {
          try {
            const result = await getORSDirections(origin, destination, profile.ors);
            results[profile.name] = {
              distance: result.distance,
              duration: result.duration,
              mode: profile.name
            };
          } catch (error) {
            addDebugLog(`⚠️ Failed to get ${profile.name} directions: ${error.message}`, 'warning');
          }
        }
        
        if (Object.keys(results).length > 0) {
          addDebugLog(`✅ Multi-modal ORS data loaded (${Object.keys(results).length} modes)`, 'success');
          return results;
        } else {
          throw new Error('No transportation modes available from ORS');
        }
        
      } catch (error) {
        addDebugLog(`❌ OpenRouteService error: ${error.message}`, 'error');
        // Fall back to static estimates
        addDebugLog(`🚆 Falling back to static estimates for ${origin} to ${destination}`, 'info');
        throw new Error('Using static estimates - ORS unavailable');
      }
    }
    
    async function getTransitWithFallback(origin, destination) {
      try {
        addDebugLog(`🚆 Fetching multi-modal transit: ${origin} to ${destination}`, 'info');
        const multiModalData = await getMultiModalDirections(origin, destination);
        addDebugLog(`✅ Multi-modal transit data loaded`, 'success');
        return parseMultiModalData(multiModalData);
      } catch (error) {
        addDebugLog(`❌ Transit API error: ${error.message}`, 'error');
        console.error('Transit API error:', error);
        // Fall back to static transit data
        return getStaticMultiModalData(origin, destination);
      }
    }
    
    function parseMultiModalData(multiModalData) {
      const options = [];
      
      // Parse walking
      if (multiModalData.walking) {
        const walkingRoute = multiModalData.walking.routes[0];
        const walkingLeg = walkingRoute.legs[0];
        options.push({
          mode: 'walking',
          icon: '🚶',
          duration: walkingLeg.duration.text,
          distance: walkingLeg.distance.text,
          description: 'Walking route',
          isLive: true
        });
      }
      
      // Parse transit
      if (multiModalData.transit) {
        const transitRoute = multiModalData.transit.routes[0];
        const transitLeg = transitRoute.legs[0];
        const transitSteps = transitLeg.steps.filter(step => step.travel_mode === 'TRANSIT');
        
        options.push({
          mode: 'transit',
          icon: '🚆',
          duration: transitLeg.duration.text,
          distance: transitLeg.distance.text,
          departure_time: transitLeg.departure_time?.text || 'Now',
          arrival_time: transitLeg.arrival_time?.text || 'Unknown',
          steps: transitSteps.map(step => ({
            line: step.transit_details?.line?.short_name || step.transit_details?.line?.name || 'Train',
            departure_stop: step.transit_details?.departure_stop?.name || 'Unknown',
            arrival_stop: step.transit_details?.arrival_stop?.name || 'Unknown',
            departure_time: step.transit_details?.departure_time?.text || 'Unknown',
            num_stops: step.transit_details?.num_stops || 0
          })),
          fare: transitRoute.fare?.text || null,
          description: `${transitSteps.length} transit step${transitSteps.length > 1 ? 's' : ''}`,
          isLive: true
        });
      }
      
      // Parse driving (taxi)
      if (multiModalData.driving) {
        const drivingRoute = multiModalData.driving.routes[0];
        const drivingLeg = drivingRoute.legs[0];
        options.push({
          mode: 'driving',
          icon: '🚕',
          duration: drivingLeg.duration.text,
          distance: drivingLeg.distance.text,
          description: 'Taxi/ride-sharing',
          estimatedCost: estimateTaxiCost(drivingLeg.distance.value, drivingLeg.duration.value),
          isLive: true
        });
      }
      
      return options;
    }
    
    function estimateTaxiCost(distanceMeters, durationSeconds) {
      // Tokyo taxi rates (approximate): ¥410 initial + ¥80 per 280m or 90 seconds
      const initialFare = 410;
      const additionalUnits = Math.max(
        Math.ceil(distanceMeters / 280), 
        Math.ceil(durationSeconds / 90)
      ) - 1;
      const totalYen = initialFare + (additionalUnits * 80);
      const totalUSD = totalYen * 0.007; // Approximate conversion
      
      return {
        yen: `¥${totalYen.toLocaleString()}`,
        usd: `$${totalUSD.toFixed(2)}`
      };
    }
    
    function getStaticMultiModalData(origin, destination) {
      // Estimate distances for common Tokyo routes
      const estimatedDistance = estimateDistance(origin, destination);
      
      // More realistic timing calculations
      let walkingTime, transitTime, taxiTime;
      
      if (estimatedDistance >= 50) { // Inter-city (bullet train routes)
        walkingTime = 999; // Not walkable
        transitTime = Math.ceil(estimatedDistance / 5); // ~186 mph average including stops
        taxiTime = Math.ceil(estimatedDistance / 1.2); // ~43 mph highway average
      } else if (estimatedDistance >= 10) { // Long distance within city
        walkingTime = Math.ceil(estimatedDistance * 12); // 3 mph walking speed
        transitTime = Math.max(15, Math.ceil(estimatedDistance * 3.5 + 10)); // Transit + waiting time
        taxiTime = Math.max(15, Math.ceil(estimatedDistance * 2.5 + 5)); // Traffic + pickup time
      } else { // Local neighborhood travel
        walkingTime = Math.max(3, Math.ceil(estimatedDistance * 12)); // 3 mph walking
        transitTime = Math.max(8, Math.ceil(estimatedDistance * 4 + 8)); // Local trains + walking to stations
        taxiTime = Math.max(5, Math.ceil(estimatedDistance * 4 + 3)); // City traffic
      }
      
      const options = [];
      
      // Walking option (if reasonable distance)
      if (walkingTime < 120) { // Less than 2 hours
        options.push({
          mode: 'walking',
          icon: '🚶',
          duration: `${walkingTime} min`,
          distance: `${kmToMiles(estimatedDistance)} mi`,
          description: walkingTime <= 20 ? 'Pleasant walk' : walkingTime <= 45 ? 'Long walk' : 'Very long walk',
          isLive: false
        });
      }
      
      // Transit option
      const transitIcon = estimatedDistance >= 50 ? '🚄' : estimatedDistance >= 10 ? '🚆' : '🚇';
      const transitDesc = estimatedDistance >= 50 ? 'Bullet train' : estimatedDistance >= 10 ? 'Express train' : 'Local train/subway';
      const transitFare = estimatedDistance >= 50 ? 
        Math.ceil(estimatedDistance * 25) : // Bullet train pricing
        Math.max(150, Math.ceil(estimatedDistance * 180)); // Local transit
      
      options.push({
        mode: 'transit',
        icon: transitIcon,
        duration: `${transitTime} min`,
        distance: `${kmToMiles(estimatedDistance)} mi`,
        description: transitDesc,
        fare: `¥${transitFare.toLocaleString()}`,
        isLive: false
      });
      
      // Taxi option (if reasonable for the distance)
      if (estimatedDistance < 50) { // Don't suggest taxi for inter-city
        const taxiCost = estimatedDistance >= 10 ? 
          Math.ceil(estimatedDistance * 800) : // Long distance taxi
          Math.max(500, Math.ceil(estimatedDistance * 600)); // Local taxi
        
        options.push({
          mode: 'driving',
          icon: '🚕',
          duration: `${taxiTime} min`,
          distance: `${kmToMiles(estimatedDistance)} mi`,
          description: estimatedDistance >= 10 ? 'Long taxi ride' : 'Taxi/ride-sharing',
          estimatedCost: {
            yen: `¥${taxiCost.toLocaleString()}`,
            usd: `$${(taxiCost * 0.007).toFixed(2)}`
          },
          isLive: false
        });
      }
      
      return options;
    }
    
    function estimateDistance(origin, destination) {
      // Enhanced distance estimation for Tokyo neighborhoods and regions
      const distances = {
        // Tokyo neighborhoods - precise distances
        'shibuya_to_harajuku': 1.2,
        'shibuya_to_meiji': 1.5,
        'harajuku_to_meiji': 0.3,
        'shibuya_to_ginza': 3.5,
        'shibuya_to_shinjuku': 2.1,
        'shibuya_to_asakusa': 8.5,
        'shibuya_to_ueno': 7.2,
        'shibuya_to_akihabara': 6.8,
        'shibuya_to_tsukiji': 4.3,
        'ginza_to_tsukiji': 1.8,
        'ginza_to_asakusa': 5.2,
        'ginza_to_tokyo_station': 1.2,
        'harajuku_to_shinjuku': 1.8,
        'harajuku_to_akihabara': 5.9,
        'shinjuku_to_asakusa': 7.8,
        'shinjuku_to_akihabara': 4.2,
        'asakusa_to_ueno': 2.1,
        'asakusa_to_akihabara': 3.5,
        'ueno_to_akihabara': 1.8,
        'tokyo_station_to_asakusa': 4.1,
        'tokyo_station_to_ginza': 1.2,
        'tokyo_station_to_shinjuku': 3.8,
        
        // Inter-city distances
        'tokyo_to_kyoto': 475,
        'kyoto_to_osaka': 55,
        'osaka_to_itami': 15,
        'osaka_to_namba': 2.1,
        'kyoto_to_namba': 57,
        
        // Kyoto neighborhoods
        'kyoto_station_to_gion': 3.2,
        'kyoto_station_to_fushimi': 8.5,
        'kyoto_station_to_arashiyama': 12.1,
        'gion_to_fushimi': 6.8,
        'gion_to_arashiyama': 9.5,
        'fushimi_to_arashiyama': 15.2,
        
        // Osaka neighborhoods  
        'osaka_station_to_dotonbori': 2.8,
        'osaka_station_to_namba': 2.1,
        'namba_to_dotonbori': 0.4,
        'osaka_station_to_shinsekai': 3.5,
        'namba_to_shinsekai': 1.2
      };
      
      // Normalize location names for comparison
      const normalizeLocation = (loc) => {
        return loc.toLowerCase()
          .replace(/[^a-z]/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '');
      };
      
      const normOrigin = normalizeLocation(origin);
      const normDest = normalizeLocation(destination);
      
      // Direct route lookup
      const directRoute = `${normOrigin}_to_${normDest}`;
      const reverseRoute = `${normDest}_to_${normOrigin}`;
      
      if (distances[directRoute]) return distances[directRoute];
      if (distances[reverseRoute]) return distances[reverseRoute];
      
      // Partial matching with neighborhoods
      for (const [route, dist] of Object.entries(distances)) {
        const [routeOrigin, routeDest] = route.split('_to_');
        
        // Check if either origin or destination contains the route components
        if ((normOrigin.includes(routeOrigin) || routeOrigin.includes(normOrigin)) &&
            (normDest.includes(routeDest) || routeDest.includes(normDest))) {
          return dist;
        }
        
        // Check reverse
        if ((normOrigin.includes(routeDest) || routeDest.includes(normOrigin)) &&
            (normDest.includes(routeOrigin) || routeOrigin.includes(normDest))) {
          return dist;
        }
      }
      
      // City-level estimates based on keywords
      if (isIntercityRoute(origin, destination)) {
        return 400; // Default for inter-city
      }
      
      if (isIntraKyoto(origin, destination)) {
        return 5.0; // Average Kyoto distance
      }
      
      if (isIntraOsaka(origin, destination)) {
        return 3.0; // Average Osaka distance
      }
      
      // Default Tokyo area estimate
      return 2.5;
    }
    
    function isIntercityRoute(origin, destination) {
      const cities = ['tokyo', 'kyoto', 'osaka'];
      const origCity = getCityFromLocation(origin);
      const destCity = getCityFromLocation(destination);
      return origCity !== destCity && cities.includes(origCity) && cities.includes(destCity);
    }
    
    function isIntraKyoto(origin, destination) {
      return getCityFromLocation(origin) === 'kyoto' && getCityFromLocation(destination) === 'kyoto';
    }
    
    function isIntraOsaka(origin, destination) {
      return getCityFromLocation(origin) === 'osaka' && getCityFromLocation(destination) === 'osaka';
    }
    
    function getCityFromLocation(location) {
      const loc = location.toLowerCase();
      if (loc.includes('kyoto') || loc.includes('gion') || loc.includes('fushimi') || loc.includes('arashiyama')) {
        return 'kyoto';
      }
      if (loc.includes('osaka') || loc.includes('namba') || loc.includes('dotonbori') || loc.includes('shinsekai')) {
        return 'osaka';
      }
      if (loc.includes('tokyo') || loc.includes('shibuya') || loc.includes('shinjuku') || 
          loc.includes('ginza') || loc.includes('harajuku') || loc.includes('asakusa') ||
          loc.includes('ueno') || loc.includes('akihabara')) {
        return 'tokyo';
      }
      return 'tokyo'; // Default to Tokyo
    }
    
    function createMultiModalDisplay(transitOptions, isDetailed = false) {
      if (!Array.isArray(transitOptions) || transitOptions.length === 0) {
        return '<div style="font-size: var(--small-text);">No transit options available</div>';
      }
      
      const liveIndicator = transitOptions[0].isLive ? '🔴 Live' : '📅 Estimated';
      
      if (!isDetailed) {
        // Show just the fastest option for compact view
        const fastest = transitOptions[0];
        return `${liveIndicator} • ${fastest.duration} • ${fastest.icon} ${fastest.description}`;
      }
      
      // Detailed view with all transportation options
      const optionsHtml = transitOptions.map(option => {
        let costDisplay = '';
        if (option.fare) {
          costDisplay = `<span style="font-weight: 600; color: #059669;">${option.fare}</span>`;
        } else if (option.estimatedCost) {
          costDisplay = `<span style="font-weight: 600; color: #059669;">${option.estimatedCost.yen} (${option.estimatedCost.usd})</span>`;
        } else if (option.mode === 'walking') {
          costDisplay = `<span style="font-weight: 600; color: #059669;">Free</span>`;
        }
        
        let detailsHtml = '';
        if (option.steps && option.steps.length > 0) {
          detailsHtml = `
            <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 4px;">
              ${option.steps.map(step => `
                <div style="font-size: var(--small-text); margin: 2px 0;">
                  <strong>${step.line}</strong>: ${step.departure_stop} to ${step.arrival_stop}
                  <div style="opacity: 0.7;">Departure: ${step.departure_time} • ${step.num_stops} stops</div>
                </div>
              `).join('')}
            </div>
          `;
        }
        
        return `
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 8px; margin: 0 2px; background: rgba(255,255,255,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); min-height: 100px;">
            <div style="font-size: var(--large-text); margin-bottom: 6px;">${option.icon}</div>
            <div style="font-size: var(--base-text); font-weight: 600; margin-bottom: 4px;">${option.duration}</div>
            <div style="font-size: var(--small-text); opacity: 0.8; margin-bottom: 4px;">${option.distance}</div>
            <div style="font-size: var(--small-text); opacity: 0.7; margin-bottom: 6px; line-height: 1.2;">${option.description}</div>
            <div style="font-size: var(--small-text); font-weight: 600; color: #059669; margin-top: auto;">${costDisplay.replace(/<[^>]*>/g, '')}</div>
            ${detailsHtml ? `<div style="font-size: var(--tiny-text); margin-top: 4px; opacity: 0.6;">${detailsHtml}</div>` : ''}
          </div>
        `;
      }).join('');
      
      return `
        <div style="margin-top: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: var(--small-text); color: #059669; font-weight: 600;">${liveIndicator}</span>
            <span style="font-size: var(--small-text); opacity: 0.7;">Choose your transport</span>
          </div>
          <div style="display: flex; gap: 4px; justify-content: space-between;">
            ${optionsHtml}
          </div>
        </div>
      `;
    }
    
    // Function to create map links (Apple Maps for iOS)
    function createMapLink(locationName, displayName = null) {
      const location = LOCATION_DATABASE[locationName];
      if (!location) {
        return displayName || locationName;
      }
      
      const display = displayName || locationName;
      const encodedAddress = encodeURIComponent(location.address);
      
      // Use Apple Maps URL scheme for better iOS integration
      const mapUrl = `https://maps.apple.com/?q=${encodedAddress}`;
      
      return `<a href="${mapUrl}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none;"><div style="display: inline-block;"><span style="text-decoration: underline; font-weight: 500;">${display}</span><div style="font-size: 0.8em; color: #6b7280; margin-top: 2px;">📍 ${location.address}</div></div></a>`;
    }
    
    // Debug logging function
    function addDebugLog(message, type = 'info') {
      const debugLog = document.getElementById('debug-log');
      const item = document.createElement('div');
      item.className = 'debug-item';
      if (type === 'success') item.classList.add('success');
      if (type === 'error') item.classList.add('error');
      
      const timestamp = new Date().toLocaleTimeString();
      item.innerHTML = `[${timestamp}] ${message}`;
      debugLog.appendChild(item);
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // Simple loading approach - simulateLoading function removed

    // Start loading simulation when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Update version display
      try {
        document.getElementById('version-display').textContent = APP_VERSION;
      } catch (e) {
        console.log('Version display not found');
      }
      
      addDebugLog('🔄 DOM loaded', 'success');
      addDebugLog(`📱 Japan Travel App ${APP_VERSION}`, 'info');
      
      
      // Load text size preference
      try {
        loadTextSizePreference();
      } catch (e) {
        console.log('Text size preference failed');
      }
      
      // Use simple working loading - 2 seconds then show app
      addDebugLog('🔄 Loading app...', 'info');
      setTimeout(() => {
        addDebugLog('🎉 App ready!', 'success');
        
        // Hide loading and show app
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        // Initialize text size (ensure default is set)
        if (!document.documentElement.getAttribute('data-text-size')) {
          document.documentElement.setAttribute('data-text-size', 'medium');
        }
        
        // Initialize to current trip day (non-blocking)
        try {
          currentDayIndex = getCurrentTripDay();
          addDebugLog(`📅 Starting on trip day ${currentDayIndex + 1}`, 'info');
          
          // Initialize the current day's content after a short delay
          setTimeout(() => {
            updateDayDisplay().catch(error => {
              console.error('Failed to update day display:', error);
              addDebugLog('⚠️ Day display update failed, using fallback', 'error');
            });
          }, 500);
        } catch (error) {
          console.error('Failed to initialize trip day:', error);
          addDebugLog('⚠️ Trip day initialization failed', 'error');
          currentDayIndex = 0; // Default to first day
        }
        
        addDebugLog('✅ App launched successfully!', 'success');
      }, 2000);
    });

    // Fallback disabled - using single DOMContentLoaded approach
    // setTimeout(() => {
    //   if (document.getElementById('app').classList.contains('hidden')) {
    //     addDebugLog('⚠️ Fallback loading triggered', 'error');
    //     simulateLoading();
    //   }
    // }, 2000);

    // Complete trip data with all activities from reference itinerary
    const tripDays = [
      {
        date: 'Monday, July 14', 
        title: 'Arrival & Gentle Recovery', 
        city: 'Tokyo',
        weather: 'Hot & humid (84-90°F with 78-83% humidity)',
        weatherAdvisory: 'July is Japan\'s hottest, most humid month. Plan indoor activities during peak heat (11am-4pm)',
        activities: [
          {
            type: 'transport',
            time: '4:30 AM - 7:30 AM',
            title: 'Airport to Hotel',
            location: 'Haneda Airport to Shibuya',
            route: {
              origin: 'Haneda Airport, Tokyo, Japan',
              destination: 'Shibuya Station, Tokyo, Japan'
            },
            description: 'Navigate immigration and customs at Haneda Airport, take Airport Express to Shibuya Station, check into Hyatt House Shibuya',
            whatToDo: [
              'Navigate immigration and customs at Haneda Airport',
              'Take Airport Express to Shibuya Station',
              'Check into Hyatt House Shibuya (early if possible)',
              'Store luggage and freshen up',
              'Get oriented with hotel amenities'
            ],
            whatToExpect: 'Modern, efficient trains with English signage. Early check-in likely available.',
            cost: { yen: 800, usd: 5.50 }
          },
          {
            type: 'dining',
            time: '8:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:30 AM - 12:00 PM',
            title: 'Shibuya Crossing Experience',
            location: 'Shibuya',
            description: 'Iconic Tokyo orientation without overwhelming jetlag',
            significance: 'World\'s busiest pedestrian crossing - iconic Tokyo moment',
            whatToDo: [
              'Cross the famous Shibuya Crossing during rush periods',
              'Take photos with Hachiko statue (loyal dog memorial)',
              'View crossing from Starbucks 2F for aerial perspective',
              'Walk through Center Gai for people-watching',
              'Visit 109 building for youth fashion culture'
            ],
            whatToExpect: 'World\'s busiest pedestrian crossing. Overwhelming but exhilarating first Tokyo moment.',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'dining',
            time: '12:00 PM - 1:00 PM',
            title: 'First Tokyo Lunch',
            location: 'Shibuya area',
            description: 'Budget-friendly conveyor belt sushi experience',
            restaurants: [
              {
                name: 'Uobei Shibuya Dogenzaka',
                cost: '¥130-280 per plate',
                description: 'Touch panel conveyor sushi, popular with locals and tourists alike',
                whyRecommended: 'Quality budget option recognized by locals',
                whatToExpect: 'Casual atmosphere with automated ordering system'
              },
              {
                name: 'Numazuko Sushi (Tokyo Station)',
                cost: '¥150 per plate',
                description: 'Fresh sushi delivered by automated belt system with multilingual ordering',
                whyRecommended: 'Excellent for first-time visitors',
                whatToExpect: 'Modern conveyor belt system with English support'
              },
              {
                name: 'Ganko Sushi',
                cost: '¥138+ per plate',
                description: 'Traditional chain with authentic atmosphere',
                whyRecommended: 'Recognized by locals as quality budget option',
                whatToExpect: 'Traditional sushi bar atmosphere'
              }
            ],
            cost: { yen: 265, usd: 1.85 }
          },
          {
            type: 'cultural',
            time: '1:30 PM - 5:00 PM',
            title: 'Meiji Shrine & Harajuku',
            location: 'Meiji Shrine to Harajuku',
            description: 'Essential Tokyo contrast - sacred shrine + pop culture street',
            significance: '1920 shrine in forest setting, then colorful kawaii culture',
            whatToDo: [
              'Write wishes on ema (wooden plaques) and hang them',
              'Witness traditional Shinto wedding ceremonies (if occurring)',
              'Walk peaceful forest paths among 100,000+ trees',
              'Visit main shrine and bow properly (bow twice, clap twice, bow once)',
              'Walk down Takeshita Street for kawaii culture',
              'Try rainbow cotton candy and character crepes',
              'Browse vintage shops and fashion stores',
              'Visit Omotesando Hills for luxury contrast'
            ],
            culturalEtiquette: 'At Shinto shrines: bow twice, clap twice, bow once. Purify hands and mouth at water basin before entering.',
            whatToExpect: '1920 shrine in forest setting, then colorful kawaii culture and unique fashion.',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'dining',
            time: '5:30 PM - 7:00 PM',
            title: 'Early Dinner',
            location: 'Shibuya/Ginza area',
            description: 'Quality sushi dinner experience',
            restaurants: [
              {
                name: 'Seamon Ginza',
                cost: '¥1,800',
                description: 'Elegant 20-seat restaurant with freshly grated wasabi, 9 pieces + soup + appetizers',
                whyRecommended: 'Premium quality with traditional preparation',
                whatToExpect: 'Intimate counter experience with expert sushi chefs'
              },
              {
                name: 'Uobei Shibuya Dogenzaka',
                cost: '¥130-280 per plate',
                description: 'Touch panel conveyor sushi with fresh fish delivery by lane',
                whyRecommended: 'Convenient location, reliable quality',
                whatToExpected: 'Modern automated system with fresh ingredients'
              },
              {
                name: 'Kura Sushi (Shibuya)',
                cost: '¥150 per plate average',
                description: 'Family-friendly conveyor belt with colorful atmosphere and digital ordering',
                whyRecommended: 'Fun interactive experience with games',
                whatToExpect: 'Lively atmosphere with digital entertainment'
              }
            ],
            cost: { yen: 1800, usd: 12.60 }
          }
        ],
        totalCost: { yen: 3465, usd: 24.25 },
        costBreakdown: {
          food: { yen: 2065, usd: 14.45 },
          transport: { yen: 800, usd: 5.50 },
          attractions: { yen: 600, usd: 4.20 }
        }
      },
      {
        date: 'Tuesday, July 15', 
        title: 'Traditional Tokyo & Summer Festival', 
        city: 'Tokyo',
        weather: 'Very hot & humid (86-93°F with 78-83% humidity)',
        weatherAdvisory: 'Early morning activities recommended. Plan indoor activities during peak heat (11am-4pm)',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 12:00 PM',
            title: 'Shibuya Sky',
            location: 'Shibuya Sky',
            description: 'Modern Tokyo\'s newest iconic viewpoint',
            significance: 'Modern Tokyo\'s newest iconic viewpoint',
            whatToDo: [
              'Take panoramic photos from 360° observation deck',
              'Visit rooftop terrace for open-air city views',
              'Experience Sky Gallery with digital art installations',
              'Shop for exclusive Shibuya Sky merchandise'
            ],
            whatToExpected: 'Stunning 360° city views, less crowded than Skytree',
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'dining',
            time: '12:30 PM - 1:30 PM',
            title: 'Traditional Lunch',
            location: 'Near Asakusa',
            description: 'Traditional Japanese lunch after morning activities',
            restaurants: [
              {
                name: 'Daikokuya Tempura (Asakusa)',
                cost: '¥1,500-2,500',
                description: 'Historic tempura restaurant established 1887, near Sensoji Temple',
                whyRecommended: 'Over 130 years of tempura tradition in historic Asakusa location',
                whatToExpect: 'Traditional Edo-style tempura in authentic old Tokyo atmosphere'
              },
              {
                name: 'Namiki Yabu Soba (Asakusa)',
                cost: '¥1,200-2,000',
                description: 'Famous soba restaurant established 1884, handmade buckwheat noodles',
                whyRecommended: 'Historic soba specialist with traditional Edo-period preparation methods',
                whatToExpected: 'Authentic buckwheat noodles in traditional wooden setting'
              }
            ],
            cost: { yen: 1800, usd: 12.60 }
          },
          {
            type: 'cultural',
            time: '1:30 PM - 4:00 PM',
            title: 'Traditional Asakusa',
            location: 'Asakusa',
            description: 'Tokyo\'s oldest temple (7th century) & traditional shopping street',
            significance: 'Tokyo\'s oldest temple (7th century) & traditional shopping street',
            whatToDo: [
              'Purify yourself at water basin before entering',
              'Wave incense smoke over yourself for good health',
              'Draw omikuji (fortune slips) and tie bad ones to racks',
              'Ring bell and pray at main hall',
              'Try ningyo-yaki (doll-shaped cakes with sweet filling)',
              'Sample fresh taiyaki (fish-shaped pastry)',
              'Buy traditional folding fans and chopsticks',
              'Watch artisans make traditional crafts'
            ],
            culturalEtiquette: 'Purify hands and mouth at water basin. Bow before entering temple grounds. Be respectful during prayers.',
            whatToExpected: '1,400-year-old temple, traditional architecture, street food culture',
            cost: { yen: 500, usd: 3.50 }
          },
          {
            type: 'cultural',
            time: '5:30 PM - 8:00 PM',
            title: 'Mitama Matsuri Festival',
            location: 'Yasukuni Shrine',
            description: 'One of Tokyo\'s most spectacular summer festivals (July 13-16, 2025) featuring 30,000+ lanterns',
            significance: 'One of Tokyo\'s most spectacular summer festivals featuring 30,000+ lanterns at Yasukuni Shrine',
            whatToDo: [
              'Walk through lantern-lit pathways for magical photos - lanterns illuminated daily from dusk until 9:30pm',
              'Watch traditional Bon Odori dancing performances taking place every evening',
              'Observe Nebuta float parades from Aomori (July 15 at 6:30 PM) and Awa Odori dance demonstrations (July 15 at 7:30 PM)',
              'Experience food trucks selling street food throughout festival period',
              'Listen to taiko drumming performances and traditional music',
              'Access inner shrine courtyard (normally restricted area) during evening hours'
            ],
            festivalHighlights: [
              '30,000+ lanterns illuminated nightly until 9:30pm',
              'Special Nebuta float parades (July 15 at 6:30 PM)',
              'Awa Odori dance demonstrations (July 15 at 7:30 PM)',
              'Traditional Bon Odori dancing every evening',
              'Taiko drumming and traditional music performances',
              'Access to normally restricted inner shrine courtyard'
            ],
            whatToExpected: 'Memorial lanterns creating ethereal atmosphere honoring spirits of war dead, unique spiritual experience',
            cost: { yen: 1500, usd: 10.50 }
          },
          {
            type: 'dining',
            time: '6:00 PM - 7:30 PM',
            title: 'Dinner',
            location: 'Central Tokyo',
            description: 'Quality dinner before evening activities',
            restaurants: [
              {
                name: 'Torikizoku (Shibuya)',
                cost: '¥2,000-3,500',
                description: 'Popular yakitori chain with extensive menu and lively atmosphere',
                whyRecommended: 'Authentic izakaya experience with quality yakitori and reasonable prices',
                whatToExpect: 'Energetic atmosphere with grilled chicken specialties and local beer'
              },
              {
                name: 'Numazuko Sushi (Tokyo Station)',
                cost: '¥2,500-4,000',
                description: 'Modern conveyor belt sushi with fresh fish and automated ordering',
                whyRecommended: 'High-quality sushi with efficient service and reasonable pricing',
                whatToExpected: 'Contemporary sushi bar with multilingual ordering system'
              }
            ],
            cost: { yen: 2800, usd: 19.60 }
          },
          {
            type: 'nightlife',
            time: '8:30 PM - 10:00 PM',
            title: 'CÉ LA VI Tokyo',
            location: 'Shibuya Sky, 14-5 Shibuya, Shibuya City, Tokyo 150-0002',
            description: 'Premium rooftop experience with city views',
            significance: 'Premium rooftop experience with city views',
            whatToDo: [
              'Enjoy panoramic night views of Tokyo',
              'Try signature cocktails with Asian influences',
              'Take photos on outdoor terrace',
              'Experience sophisticated international atmosphere'
            ],
            whatToExpected: 'Sophisticated atmosphere, panoramic night views, quality cocktails',
            cost: { yen: 4500, usd: 31.50 }
          }
        ],
        totalCost: { yen: 13100, usd: 91.70 },
        costBreakdown: {
          food: { yen: 6100, usd: 42.70 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 2500, usd: 17.50 },
          nightlife: { yen: 4500, usd: 31.50 }
        }
      },
      {
        date: 'Wednesday, July 16', 
        title: 'Cultural Heritage & Digital Art Immersion', 
        city: 'Tokyo',
        weather: 'Extremely hot (88-93°F)',
        weatherAdvisory: 'Perfect day for indoor cultural experiences - museums and teamLab',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpected: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 1:00 PM',
            title: 'Tokyo National Museum',
            location: 'Tokyo National Museum',
            description: 'Japan\'s premier cultural institution - world\'s largest Japanese art collection',
            significance: 'Japan\'s premier cultural institution housing 89 National Treasures and world\'s largest Japanese art collection',
            whatToDo: [
              'See ancient Buddhist sculptures and religious art',
              'Explore samurai swords and armor collections (89 National Treasures)',
              'View traditional Japanese paintings and calligraphy',
              'Learn about Japanese pottery and ceramics from different periods',
              'Visit Gallery of Hōryū-ji Treasures (7th-8th century artifacts)',
              'Use English audio guides for comprehensive understanding'
            ],
            whatToExpect: 'World\'s largest Japanese art collection, samurai weapons, Buddhist art, National Treasures',
            selfGuidedTour: {
              title: 'Self-Guided Walking Tour: Tokyo National Museum',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #8B4513; margin-bottom: 10px;">🏛️ Complete Museum Tour (3 hours)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">📍 Entry Point: Honkan (Main Building)</strong>
                    <p>Begin at Japan's oldest museum building (1938), designed in the "Imperial Crown Style" blending Japanese and Western architecture. Purchase your ticket and collect the English floor map and audio guide (¥520 extra, highly recommended).</p>
                    <p><em>Historical Note:</em> Founded in 1872, this is Japan's oldest museum with the world's largest collection of Japanese cultural properties.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🗡️ Stop 1: Samurai Gallery (2F Room 3) - 45 minutes</strong>
                    <p>Start with Japan's most famous samurai sword and armor collection. This gallery houses 19 of the museum's 89 National Treasures.</p>
                    <p><strong>Must-See Items:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tachi blade by Mikazuki Munechika (三日月宗近):</strong> One of Japan's five greatest swords, forged 1000+ years ago</li>
                      <li><strong>Red-laced armor (12th century):</strong> Worn by actual samurai warriors, notice the intricate metalwork</li>
                      <li><strong>Helmet collection:</strong> Each design tells a story about the warrior's clan and beliefs</li>
                      <li><strong>Technique displays:</strong> Learn how swords were forged using traditional tatara steel-making</li>
                    </ul>
                    <p><em>What to notice:</em> The slight curve (sori) in each sword blade, designed for mounted combat. Look for the hamon (temper line) - each swordsmith's signature pattern.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🙏 Stop 2: Buddhist Art Gallery (2F Room 11) - 30 minutes</strong>
                    <p>Experience the evolution of Buddhist art from 6th-12th centuries, showing how Japanese artists adapted Chinese and Korean influences.</p>
                    <p><strong>Key Observations:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Early Period (6th-8th century):</strong> Powerful, imposing Buddha statues with stern expressions</li>
                      <li><strong>Heian Period (9th-12th century):</strong> More graceful, approachable expressions reflecting "Pure Land" Buddhism</li>
                      <li><strong>Mandala paintings:</strong> Cosmic maps showing the Buddhist universe</li>
                      <li><strong>Bodhisattva statues:</strong> Notice their jewelry and flowing robes vs. simple Buddha garments</li>
                    </ul>
                    <p><em>Cultural Context:</em> Buddhism arrived in Japan in 538 CE, blending with native Shinto beliefs to create uniquely Japanese Buddhist art.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🎨 Stop 3: Japanese Paintings Gallery (2F Rooms 7-8) - 40 minutes</strong>
                    <p>Explore the development of uniquely Japanese painting styles, from Chinese-influenced works to distinctly Japanese aesthetics.</p>
                    <p><strong>Artistic Evolution:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Yamato-e style:</strong> Distinctly Japanese painting depicting court life and seasonal beauty</li>
                      <li><strong>Screen paintings (byōbu):</strong> Room-sized artworks telling stories of literature and nature</li>
                      <li><strong>Scroll paintings (emakimono):</strong> Early "manga" - stories told in sequential images</li>
                      <li><strong>Seasonal themes:</strong> Cherry blossoms, autumn leaves, snow scenes reflecting Japanese aesthetic sensibilities</li>
                    </ul>
                    <p><em>Technique spotlight:</em> Notice the use of gold leaf backgrounds (kinpun) and the "blown-off roof" perspective in court scenes.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🏺 Stop 4: Ceramics & Crafts Gallery (1F Room 15) - 25 minutes</strong>
                    <p>Discover Japan's ceramic traditions from ancient Jomon pottery (14,000 years old) to refined tea ceremony wares.</p>
                    <p><strong>Ceramic Journey:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Jomon pottery (10,000 BCE):</strong> World's oldest pottery, with rope-pattern decorations</li>
                      <li><strong>Raku tea bowls:</strong> Deliberately imperfect, embodying wabi-sabi aesthetic</li>
                      <li><strong>Imari porcelain:</strong> Colorful export ware that influenced European ceramics</li>
                      <li><strong>Bizen pottery:</strong> Unglazed, fire-marked ceramics prized for their natural beauty</li>
                    </ul>
                    <p><em>Cultural insight:</em> The Japanese aesthetic of finding beauty in imperfection and impermanence is most evident in tea ceremony ceramics.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🏛️ Stop 5: Gallery of Hōryū-ji Treasures - 30 minutes</strong>
                    <p>Visit the separate building housing 7th-8th century treasures from Hōryū-ji Temple, Japan's oldest surviving wooden structures.</p>
                    <p><strong>Ancient Treasures:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Kudara Kannon statue:</strong> Elegant 7th-century Buddhist sculpture from Korean peninsula</li>
                      <li><strong>Tamamushi Shrine:</strong> Miniature temple decorated with beetle wing cases</li>
                      <li><strong>Bronze mirrors:</strong> Showing early cultural exchange with China and Korea</li>
                      <li><strong>Ancient textiles:</strong> Rare surviving fabrics showing sophisticated weaving techniques</li>
                    </ul>
                    <p><em>Historical significance:</em> These artifacts represent Japan's earliest Buddhist culture and international connections.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌿 Stop 6: Museum Gardens & Surroundings - 20 minutes</strong>
                    <p>Before leaving, explore the museum's traditional gardens and nearby Ueno Park attractions.</p>
                    <p><strong>Garden Features:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Five-story pagoda:</strong> Historic structure visible from museum grounds</li>
                      <li><strong>Tea house demonstrations:</strong> Occasional traditional tea ceremony displays</li>
                      <li><strong>Seasonal plantings:</strong> Cherry blossoms (spring), lotus pond (summer)</li>
                      <li><strong>Stone garden:</strong> Zen-style contemplative space for reflection</li>
                    </ul>
                  </div>

                  <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <strong style="color: #1B4A2C;">🎯 Cultural Etiquette & Tips:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Photography permitted in most areas (check for no-photo symbols)</li>
                      <li>Audio guide highly recommended for deeper cultural understanding</li>
                      <li>Speak quietly to maintain contemplative atmosphere</li>
                      <li>Don't touch artifacts - oils from hands cause damage</li>
                      <li>Rotating exhibitions mean some items may not be on display</li>
                      <li>Museum shop offers high-quality reproductions and books</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 1000, usd: 7.00 }
          },
          {
            type: 'dining',
            time: '1:00 PM - 2:00 PM',
            title: 'Ueno Lunch',
            location: 'Near Tokyo National Museum',
            description: 'Traditional lunch in historic Ueno district',
            restaurants: [
              {
                name: 'Ippudo Ramen Ueno',
                cost: '¥1,200-1,800',
                description: 'World-famous tonkotsu ramen near museum district',
                whyRecommended: 'Convenient location, consistent quality, perfect after museum visit',
                whatToExpect: 'Rich tonkotsu broth, efficient service, tourist-friendly'
              },
              {
                name: 'Somenya Saito Ueno',
                cost: '¥1,500-2,200',
                description: 'Award-winning ramen shop with delicate duck-based broth',
                whyRecommended: 'Michelin-mentioned quality, unique duck broth specialty',
                whatToExpect: 'Refined ramen experience, artistic presentation'
              }
            ],
            cost: { yen: 1600, usd: 11.20 }
          },
          {
            type: 'transport',
            time: '2:00 PM - 2:45 PM',
            title: 'Ueno to Odaiba Transit',
            location: 'Ueno → Shin-Toyosu',
            route: {
              origin: 'Ueno Station, Tokyo, Japan',
              destination: 'Shin-Toyosu Station, Tokyo, Japan'
            },
            description: 'Journey from traditional museum district to futuristic waterfront',
            whatToDo: [
              'Take JR Yamanote Line from Ueno to Shimbashi (12 minutes)',
              'Transfer to Yurikamome Line at Shimbashi',
              'Take Yurikamome Line to Shin-Toyosu (13 minutes)',
              'Short walk to teamLab Planets venue'
            ],
            whatToExpected: 'Scenic waterfront views on Yurikamome automated train',
            cost: { yen: 350, usd: 2.45 }
          },
          {
            type: 'cultural',
            time: '3:00 PM - 6:00 PM',
            title: 'teamLab Planets',
            location: 'teamLab Planets',
            description: 'World\'s most visited digital art museum with 2025 expansion',
            significance: 'World\'s most visited digital art museum with immersive water experiences and new Athletics Forest',
            whatToDo: [
              'Wade through knee-deep water with digital koi swimming around you',
              'Walk barefoot through Crystal Universe with infinite mirrors',
              'Lie down in Floating Flower Garden as flowers move above you',
              'Jump on rapidly rotating bouncing spheres that light up (NEW 2025 Athletics Forest)',
              'Create caterpillars by bouncing on same-colored spheres',
              'Use smartphone to catch and study extinct animals'
            ],
            whatToExpect: 'Mind-bending immersive art, walk through water, new athletics area - bring shorts/waterproof clothing',
            culturalEtiquette: 'Remove shoes and socks, wear shorts or waterproof clothing, no photography in some areas',
            selfGuidedTour: {
              title: 'Self-Guided Experience: teamLab Planets',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #8B4513; margin-bottom: 10px;">🌊 Complete Immersive Journey (3 hours)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">📍 Entry Preparation: Locker Area</strong>
                    <p>Upon arrival, store all belongings in provided lockers. Remove shoes, socks, and any jewelry. Change into shorts if not already wearing them. teamLab provides towels but bring waterproof phone case for photos where permitted.</p>
                    <p><em>Tech Note:</em> This museum uses cutting-edge projection mapping, motion sensors, and AI to create art that responds to your movements and presence.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌊 Zone 1: Water Area - Infinite Crystal Universe (45 minutes)</strong>
                    <p>Enter the signature water experience - knee-deep warm water with 50,000 LED crystals hanging from ceiling, creating infinite reflections.</p>
                    <p><strong>Experience Techniques:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Move slowly:</strong> Rapid movements cause dramatic color changes throughout entire space</li>
                      <li><strong>Stand still:</strong> Watch colors gradually shift and evolve around you</li>
                      <li><strong>Touch crystals gently:</strong> Each touch creates ripple effects across the installation</li>
                      <li><strong>Photography spots:</strong> Center area for infinity mirror effect, edges for crystal close-ups</li>
                    </ul>
                    <p><em>Artistic concept:</em> Represents the infinite nature of digital space where boundaries between self and artwork dissolve.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🐠 Zone 2: Koi Pond Experience (30 minutes)</strong>
                    <p>Wade through digital koi pond where virtual fish swim around your legs, responding to your movements and creating flowers when they touch you.</p>
                    <p><strong>Interactive Elements:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Fish behavior:</strong> Digital koi avoid your legs initially, then become curious and approach</li>
                      <li><strong>Flower creation:</strong> When fish bump into you, they transform into colorful digital flowers</li>
                      <li><strong>Seasonal changes:</strong> Pool environment shifts between spring cherry blossoms and autumn leaves</li>
                      <li><strong>Best experience:</strong> Stay still and let koi approach - creates maximum flower blooms</li>
                    </ul>
                    <p><em>Technology:</em> Uses computer vision to track your exact position and AI to simulate realistic fish behavior patterns.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌸 Zone 3: Floating Flower Garden (40 minutes)</strong>
                    <p>Enter a space filled with thousands of live orchids suspended from ceiling that move up and down as you walk through, creating a living garden that responds to your presence.</p>
                    <p><strong>Sensory Experience:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Flower movement:</strong> Orchids rise as you approach, creating a path through the garden</li>
                      <li><strong>Fragrance:</strong> Real orchid scents change as flowers move closer to your face</li>
                      <li><strong>Light patterns:</strong> Subtle lighting follows your movement, illuminating flowers around you</li>
                      <li><strong>Meditation moments:</strong> Find a quiet spot and lie down as flowers float above you</li>
                    </ul>
                    <p><em>Design philosophy:</em> Blends digital technology with living nature to create "supernatural" garden experience.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">⚡ Zone 4: Athletics Forest (NEW 2025) (45 minutes)</strong>
                    <p>Experience the brand-new active zone with bouncing spheres, climbing installations, and motion-reactive environments.</p>
                    <p><strong>Athletic Artworks:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Bouncing Sphere Constellation:</strong> Jump on spheres that light up and create music based on your bouncing rhythm</li>
                      <li><strong>Caterpillar Creation:</strong> Bounce on same-colored spheres consecutively to create digital caterpillars</li>
                      <li><strong>Extinct Animal App:</strong> Use provided smartphone to "catch" and study extinct species that appear around you</li>
                      <li><strong>Climbing Wall:</strong> Scale interactive wall where handholds light up and change color as you climb</li>
                    </ul>
                    <p><em>Innovation:</em> World's first "athletic art" combining physical exercise with immersive digital art experience.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌌 Zone 5: Infinite Space & Soft Black Hole (30 minutes)</strong>
                    <p>Experience rooms where traditional spatial boundaries disappear through mirror effects and flowing digital environments.</p>
                    <p><strong>Spatial Illusions:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Mirror rooms:</strong> Infinite reflections create sense of floating in digital space</li>
                      <li><strong>Soft materials:</strong> Large inflatable installations you can climb on and reshape</li>
                      <li><strong>Flowing waterfalls:</strong> Digital water that responds to your touch and movement</li>
                      <li><strong>Color immersion:</strong> Entire room changes color based on collective visitor movements</li>
                    </ul>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🍜 Zone 6: Post-Experience - Vegan Ramen (20 minutes)</strong>
                    <p>End your visit at teamLab's exclusive vegan ramen restaurant where the bowls and ingredients change color as you eat.</p>
                    <p><strong>Culinary Art:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Color-changing bowls:</strong> Temperature-sensitive ceramics that shift hues with hot ramen</li>
                      <li><strong>Digital placemats:</strong> Interactive table surfaces that respond to your bowl placement</li>
                      <li><strong>Sustainable focus:</strong> All-vegan menu reflecting teamLab's environmental consciousness</li>
                      <li><strong>Art integration:</strong> Even dining becomes part of the artistic experience</li>
                    </ul>
                  </div>

                  <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <strong style="color: #1B4A2C;">🎯 Essential Experience Tips:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Wear dark, form-fitting clothes for best projection visibility</li>
                      <li>Bring waterproof phone case - some areas allow photography</li>
                      <li>Move slowly and deliberately - rapid movements can overwhelm sensors</li>
                      <li>Expect to get wet - towels provided but bring extra clothes</li>
                      <li>Book timed entry tickets in advance - very popular attraction</li>
                      <li>Allow full 3 hours - rushing diminishes the transformative experience</li>
                      <li>Download teamLab app for augmented reality features in Athletics Forest</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 4500, usd: 31.50 }
          },
          {
            type: 'dining',
            time: '6:30 PM - 7:30 PM',
            title: 'Odaiba Waterfront Dinner',
            location: 'Odaiba area',
            description: 'Modern dining with Tokyo Bay views',
            restaurants: [
              {
                name: 'Bills Odaiba',
                cost: '¥2,000-3,500',
                description: 'Famous Australian cafe with waterfront views and signature ricotta pancakes',
                whyRecommended: 'Stunning bay views, perfect for post-teamLab relaxation',
                whatToExpect: 'Modern cafe atmosphere, Instagram-worthy views'
              },
              {
                name: 'Aqua City Food Court',
                cost: '¥1,200-2,000',
                description: 'Multiple dining options with bay views in modern shopping complex',
                whyRecommended: 'Variety of choices, convenient location, great views',
                whatToExpected: 'Food court efficiency with elevated quality and views'
              }
            ],
            cost: { yen: 2200, usd: 15.40 }
          },
          {
            type: 'transport',
            time: '7:30 PM - 8:30 PM',
            title: 'Return to Shibuya',
            location: 'Odaiba → Shibuya',
            route: {
              origin: 'Odaiba, Tokyo, Japan',
              destination: 'Shibuya Station, Tokyo, Japan'
            },
            description: 'Evening return to hotel district',
            whatToDo: [
              'Take Yurikamome Line from Toyosu to Shimbashi',
              'Transfer to JR Yamanote Line',
              'Take Yamanote Line to Shibuya',
              'Short walk to Hyatt House Shibuya'
            ],
            whatToExpect: 'Relaxing journey back to hotel area',
            cost: { yen: 350, usd: 2.45 }
          }
        ],
        totalCost: { yen: 10000, usd: 70.00 },
        costBreakdown: {
          food: { yen: 3800, usd: 26.60 },
          transport: { yen: 700, usd: 4.90 },
          attractions: { yen: 5500, usd: 38.50 },
          nightlife: { yen: 0, usd: 0 }
        }
      },
      {
        date: 'Thursday, July 17', 
        title: 'Digital Art & Edo Heritage Experience', 
        city: 'Tokyo',
        weather: 'Hot & humid with possible afternoon thunderstorms',
        weatherAdvisory: 'Indoor museum morning, shaded park afternoon',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:30 AM - 11:30 AM',
            title: 'teamLab Planets',
            location: 'teamLab Planets',
            description: 'World\'s most visited digital art museum with immersive interactive experiences',
            significance: 'Cutting-edge digital art installation where you become part of the artwork through movement and touch',
            whatToDo: [
              'Walk through knee-deep water with digital koi fish swimming around your legs',
              'Experience floating flower garden that responds to your presence',
              'Interact with infinite crystal universe installation',
              'Explore the new Athletics Forest with bouncing spheres and climbing walls',
              'Walk through soft black hole room and flowing waterfall installations',
              'Try the color-changing vegan ramen at the end of your visit'
            ],
            whatToExpect: 'Mind-bending immersive art, walk through water, new athletics area - bring shorts/waterproof clothing',
            culturalEtiquette: 'Remove shoes and socks, wear shorts or waterproof clothing, no photography in some areas',
            selfGuidedTour: {
              title: 'Self-Guided Experience: teamLab Planets',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #8B4513; margin-bottom: 10px;">🌊 Complete Immersive Journey (2 hours)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">📍 Entry Preparation: Locker Area</strong>
                    <p>Upon arrival, store all belongings in provided lockers. Remove shoes, socks, and any jewelry. Change into shorts if not already wearing them. teamLab provides towels but bring waterproof phone case for photos where permitted.</p>
                    <p><em>Tech Note:</em> This museum uses cutting-edge projection mapping, motion sensors, and AI to create art that responds to your movements and presence.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌊 Zone 1: Water Area - Infinite Crystal Universe (30 minutes)</strong>
                    <p>Enter the signature water experience - knee-deep warm water with 50,000 LED crystals hanging from ceiling, creating infinite reflections.</p>
                    <p><strong>Experience Techniques:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Move slowly:</strong> Rapid movements cause dramatic color changes throughout entire space</li>
                      <li><strong>Stand still:</strong> Watch colors gradually shift and evolve around you</li>
                      <li><strong>Touch crystals gently:</strong> Each touch creates ripple effects across the installation</li>
                      <li><strong>Photography spots:</strong> Center area for infinity mirror effect, edges for crystal close-ups</li>
                    </ul>
                    <p><em>Artistic concept:</em> Represents the infinite nature of digital space where boundaries between self and artwork dissolve.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🐠 Zone 2: Koi Pond Experience (25 minutes)</strong>
                    <p>Wade through digital koi pond where virtual fish swim around your legs, responding to your movements and creating flowers when they touch you.</p>
                    <p><strong>Interactive Elements:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Fish behavior:</strong> Digital koi avoid your legs initially, then become curious and approach</li>
                      <li><strong>Flower creation:</strong> When fish bump into you, they transform into colorful digital flowers</li>
                      <li><strong>Seasonal changes:</strong> Pool environment shifts between spring cherry blossoms and autumn leaves</li>
                      <li><strong>Best experience:</strong> Stay still and let koi approach - creates maximum flower blooms</li>
                    </ul>
                    <p><em>Technology:</em> Uses computer vision to track your exact position and AI to simulate realistic fish behavior patterns.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌸 Zone 3: Floating Flower Garden (25 minutes)</strong>
                    <p>Enter a space filled with thousands of live orchids suspended from ceiling that move up and down as you walk through, creating a living garden that responds to your presence.</p>
                    <p><strong>Sensory Experience:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Flower movement:</strong> Orchids rise as you approach, creating a path through the garden</li>
                      <li><strong>Fragrance:</strong> Real orchid scents change as flowers move closer to your face</li>
                      <li><strong>Light patterns:</strong> Subtle lighting follows your movement, illuminating flowers around you</li>
                      <li><strong>Meditation moments:</strong> Find a quiet spot and lie down as flowers float above you</li>
                    </ul>
                    <p><em>Design philosophy:</em> Blends digital technology with living nature to create "supernatural" garden experience.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">⚡ Zone 4: Athletics Forest (NEW 2025) (30 minutes)</strong>
                    <p>Experience the brand-new active zone with bouncing spheres, climbing installations, and motion-reactive environments.</p>
                    <p><strong>Athletic Artworks:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Bouncing Sphere Constellation:</strong> Jump on spheres that light up and create music based on your bouncing rhythm</li>
                      <li><strong>Caterpillar Creation:</strong> Bounce on same-colored spheres consecutively to create digital caterpillars</li>
                      <li><strong>Extinct Animal App:</strong> Use provided smartphone to "catch" and study extinct species that appear around you</li>
                      <li><strong>Climbing Wall:</strong> Scale interactive wall where handholds light up and change color as you climb</li>
                    </ul>
                    <p><em>Innovation:</em> World's first "athletic art" combining physical exercise with immersive digital art experience.</p>
                  </div>

                  <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <strong style="color: #1B4A2C;">🎯 Essential Experience Tips:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Wear dark, form-fitting clothes for best projection visibility</li>
                      <li>Bring waterproof phone case - some areas allow photography</li>
                      <li>Move slowly and deliberately - rapid movements can overwhelm sensors</li>
                      <li>Expect to get wet - towels provided but bring extra clothes</li>
                      <li>Book timed entry tickets in advance - very popular attraction</li>
                      <li>Allow full 2 hours - rushing diminishes the transformative experience</li>
                      <li>Download teamLab app for augmented reality features in Athletics Forest</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 4500, usd: 31.50 }
          },
          {
            type: 'cultural',
            time: '11:45 AM - 12:30 PM',
            title: 'Sumida Hokusai Museum',
            location: 'Sumida Hokusai Museum',
            description: 'Dedicated to ukiyo-e master Katsushika Hokusai and Edo period culture',
            significance: 'World\'s premier collection of Hokusai\'s works including "The Great Wave" and insights into Edo period life',
            whatToDo: [
              'View original "Thirty-six Views of Mount Fuji" series including The Great Wave',
              'Explore Hokusai\'s life through chronological displays',
              'See reconstructed master\'s atelier based on apprentice paintings',
              'Learn about ukiyo-e woodblock printing techniques',
              'Discover how Sumida district looked during Hokusai\'s lifetime (1760-1849)',
              'Experience interactive displays showing printing process'
            ],
            whatToExpect: 'World-famous ukiyo-e art, intimate museum setting, deep cultural insights into Edo period',
            culturalEtiquette: 'No photography of artworks, speak quietly to preserve contemplative atmosphere',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'dining',
            time: '12:30 PM - 1:30 PM',
            title: 'Ryogoku Sumo District Lunch',
            location: 'Near Sumida Hokusai Museum',
            description: 'Traditional lunch in historic sumo district',
            restaurants: [
              {
                name: 'Chanko Kirishima',
                cost: '¥1,500-2,200',
                description: 'Authentic chanko nabe (sumo wrestler stew) in historic sumo district',
                whyRecommended: 'Traditional sumo cuisine, cultural immersion, hearty portions',
                whatToExpect: 'Rich hot pot with vegetables and meat, sumo memorabilia atmosphere'
              },
              {
                name: 'Ryogoku Terrace Cafe',
                cost: '¥1,200-1,800',
                description: 'Modern Japanese cafe on 9th floor of Ryogoku Kokugikan with sumo stadium views',
                whyRecommended: 'Panoramic city views, seasonal Japanese set meals, convenient museum location',
                whatToExpect: 'Contemporary Japanese cuisine with traditional touches, English menu available'
              },
              {
                name: 'Tsukiji Itadori Ryogoku',
                cost: '¥1,500-2,000',
                description: 'Popular kaisendon (seafood bowl) specialist from Tsukiji Market',
                whyRecommended: 'Fresh seafood direct from Tsukiji, generous portions, local favorite',
                whatToExpect: 'Choose-your-own sashimi bowls, efficient service, authentic market quality'
              }
            ],
            cost: { yen: 1700, usd: 11.90 }
          },
          {
            type: 'transport',
            time: '1:30 PM - 2:00 PM',
            title: 'Ryogoku to Ueno Transit',
            location: 'Ryogoku → Ueno',
            route: {
              origin: 'Ryogoku Station, Tokyo, Japan',
              destination: 'Ueno Station, Tokyo, Japan'
            },
            description: 'Short journey from sumo district to park district',
            whatToDo: [
              'Take JR Sobu Line from Ryogoku to Akihabara (3 minutes)',
              'Transfer to JR Yamanote Line at Akihabara',
              'Take Yamanote Line to Ueno (2 minutes)',
              'Walk to Ueno Park entrance'
            ],
            whatToExpect: 'Quick efficient transit between historic districts',
            cost: { yen: 160, usd: 1.12 }
          },
          {
            type: 'cultural',
            time: '2:00 PM - 4:30 PM',
            title: 'Ueno Park Exploration & Rest',
            location: 'Ueno Park',
            description: 'Japan\'s first public park with beautiful gardens and temples',
            significance: 'Japan\'s first public park with beautiful gardens and temples',
            whatToDo: [
              'Stroll through traditional Japanese gardens',
              'Visit Toshogu Shrine dedicated to Tokugawa Ieyasu',
              'Rest in shaded areas during peak heat',
              'Take photos of Shinobazu Pond and Bentendo Temple',
              'Browse park\'s cultural atmosphere'
            ],
            whatToExpect: 'Peaceful gardens, traditional temples, relief from July heat',
            selfGuidedTour: {
              title: 'Self-Guided Walking Tour: Ueno Park Cultural District',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #8B4513; margin-bottom: 10px;">🌸 Complete Park & Temple Tour (2.5 hours)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">📍 Entry Point: JR Ueno Station Park Exit</strong>
                    <p>Begin at Japan's first public park, established in 1873. Originally the grounds of Kaneiji Temple, this area was once the family temple of the Tokugawa shoguns. Pick up a free park map from the visitor center.</p>
                    <p><em>Historical Note:</em> Ueno Park was created as part of Japan's modernization efforts during the Meiji period, introducing the Western concept of public parks to Japan.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">⛩️ Stop 1: Toshogu Shrine (東照宮) - 30 minutes</strong>
                    <p>Visit the elaborate shrine dedicated to Tokugawa Ieyasu, founder of the Tokugawa shogunate. This 1627 shrine survived WWII bombing and showcases peak Edo period craftsmanship.</p>
                    <p><strong>Architectural Marvels:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Golden Hall (Haiden):</strong> Covered in intricate gold leaf with 200+ detailed carvings</li>
                      <li><strong>Famous Sleeping Cat (Nemuri-neko):</strong> Hidari Jingoro's masterpiece carving above the entrance</li>
                      <li><strong>Transparent Fence:</strong> Unique see-through design allowing year-round viewing</li>
                      <li><strong>Peony Garden (seasonal):</strong> 40+ varieties bloom in spring and winter seasons</li>
                    </ul>
                    <p><em>Cultural practice:</em> Bow twice, clap twice, bow once at the main shrine. Make a wish for good health and prosperity.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌊 Stop 2: Shinobazu Pond & Bentendo Temple - 40 minutes</strong>
                    <p>Walk to Tokyo's largest natural pond, featuring a beautiful hexagonal temple built on an artificial island connected by a bridge.</p>
                    <p><strong>Pond Zones to Explore:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Lotus Zone:</strong> Thousands of lotus flowers bloom in summer (peak July-August)</li>
                      <li><strong>Bentendo Temple:</strong> Dedicated to Benzaiten, goddess of music, arts, and good fortune</li>
                      <li><strong>Wildlife Observation:</strong> Spot wild ducks, herons, and seasonal migratory birds</li>
                      <li><strong>Boating Area:</strong> Traditional swan boat rentals available (¥700/30min)</li>
                    </ul>
                    <p><em>Photography tip:</em> Best shots from the bridge approach to Bentendo, especially during golden hour.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🗼 Stop 3: Ueno Park Five-Story Pagoda - 20 minutes</strong>
                    <p>Visit the 1958 reconstruction of the original 1631 pagoda, one of Tokyo's most recognizable landmarks visible from Tokyo National Museum.</p>
                    <p><strong>Pagoda Insights:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Architectural technique:</strong> Central pillar (shin-bashira) design that makes it earthquake resistant</li>
                      <li><strong>Buddhist symbolism:</strong> Five stories represent earth, water, fire, wind, and void</li>
                      <li><strong>Modern innovation:</strong> Steel frame construction disguised as traditional wood</li>
                      <li><strong>Surrounding gardens:</strong> Traditional Japanese landscaping with seasonal flowers</li>
                    </ul>
                    <p><em>Engineering marvel:</em> The pagoda's flexible design has withstood every major Tokyo earthquake since 1958.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌸 Stop 4: Cherry Tree Grove & Hanami Spots - 25 minutes</strong>
                    <p>Explore Tokyo's most famous cherry blossom viewing area with over 1,000 cherry trees of different varieties (spectacular in spring, beautiful year-round).</p>
                    <p><strong>Tree Variety Identification:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Someiyoshino:</strong> Classic pink cherry blossoms, most common variety</li>
                      <li><strong>Yamazakura:</strong> Wild mountain cherry with pink flowers and bronze leaves</li>
                      <li><strong>Kanzan:</strong> Double-flowering variety with deeper pink blooms</li>
                      <li><strong>Summer foliage:</strong> Lush green canopy providing essential shade in July heat</li>
                    </ul>
                    <p><em>Cultural significance:</em> Hanami (flower viewing) tradition here dates back 400+ years, representing the ephemeral nature of life.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🎨 Stop 5: Museum District Overview - 15 minutes</strong>
                    <p>Take in the cultural complex surrounding the park, home to more museums per square kilometer than anywhere else in Japan.</p>
                    <p><strong>Cultural Institution Tour:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tokyo National Museum:</strong> You've experienced Japan's cultural treasures here</li>
                      <li><strong>National Museum of Western Art:</strong> Le Corbusier-designed building with European masterpieces</li>
                      <li><strong>Tokyo Metropolitan Art Museum:</strong> Contemporary Japanese and international exhibitions</li>
                      <li><strong>National Science Museum:</strong> Family-friendly exhibits including dinosaur displays</li>
                    </ul>
                    <p><em>Planning insight:</em> This concentration of culture makes Ueno "Tokyo's cultural heart" with over 140 years of history.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🍃 Stop 6: Rest & Contemplation Areas - 20 minutes</strong>
                    <p>Find peaceful spots throughout the park designed for rest and meditation, essential during Tokyo's intense summer heat.</p>
                    <p><strong>Shaded Retreat Spots:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Bamboo Grove:</strong> Natural air conditioning with cooling bamboo shade</li>
                      <li><strong>Traditional Gardens:</strong> Stone benches surrounded by carefully planned seasonal plantings</li>
                      <li><strong>Pond-side Benches:</strong> Cooling effect from water evaporation</li>
                      <li><strong>Tea House Vicinity:</strong> Occasional rest facilities with vending machines and shade</li>
                    </ul>
                  </div>

                  <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <strong style="color: #1B4A2C;">🎯 Summer Survival & Cultural Tips:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Visit during early hours or late afternoon to avoid peak heat</li>
                      <li>Bring water - vending machines available but stay hydrated</li>
                      <li>Wear hat and sunscreen - limited shade in some areas</li>
                      <li>Bow before entering any shrine or temple areas</li>
                      <li>Take time to sit and observe - park designed for contemplation</li>
                      <li>Free admission to park, small fees for some temple areas</li>
                      <li>Combine with nearby Ameyoko Market for shopping and food</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'dining',
            time: '6:00 PM - 7:30 PM',
            title: 'Michelin Dinner',
            location: 'Various locations',
            description: 'Michelin-quality ramen experience',
            restaurants: [
              {
                name: 'Nakiryu (Otsuka)',
                cost: '¥1,000-1,500',
                description: 'Michelin Bib Gourmand tantanmen specialist - spicy sesame noodles that earned worldwide recognition',
                whyRecommended: 'Former Michelin star, now Bib Gourmand with exceptional quality',
                whatToExpect: 'Long wait times, exceptional spicy sesame ramen'
              },
              {
                name: 'Ramen Break Beats (Meguro)',
                cost: '¥1,200-1,500',
                description: 'New 2025 Michelin Bib Gourmand entry - sophisticated ramen with porcini mushrooms',
                whyRecommended: 'Latest Michelin recognition, innovative techniques',
                whatToExpect: 'Contemporary ramen artistry with premium ingredients'
              },
              {
                name: 'Konjiki Hototogisu (Shinjuku)',
                cost: '¥1,000-1,300',
                description: 'Former Michelin-starred, now Bib Gourmand - famous for "triple soup" shoyu soba',
                whyRecommended: 'Innovative triple-soup technique, complex flavors',
                whatToExpect: 'Refined ramen with sophisticated preparation methods'
              }
            ],
            cost: { yen: 1300, usd: 9.10 }
          },
          {
            type: 'nightlife',
            time: '8:30 PM - 10:30 PM',
            title: 'Golden Gai Exploration',
            location: 'Shinjuku Golden Gai',
            description: 'Historic post-war drinking district',
            significance: 'Historic post-war drinking district',
            whatToDo: [
              'Visit 2-3 different tiny bars (5-6 seats each)',
              'Chat with local salarymen and mama-sans',
              'Try different types of Japanese whiskey and sake',
              'Experience authentic post-war Tokyo atmosphere',
              'Order yakitori and other bar snacks'
            ],
            whatToExpect: 'Tiny bars, local salarymen, authentic atmosphere, multiple venue hopping',
            cost: { yen: 2500, usd: 17.50 }
          }
        ],
        totalCost: { yen: 6260, usd: 43.82 },
        costBreakdown: {
          food: { yen: 3000, usd: 21.00 },
          transport: { yen: 160, usd: 1.12 },
          attractions: { yen: 600, usd: 4.20 },
          nightlife: { yen: 2500, usd: 17.50 }
        }
      },
      {
        date: 'Friday, July 18', 
        title: 'Imperial Heritage & Tokyo Icons', 
        city: 'Tokyo',
        weather: 'Hot morning, possible rain afternoon (84-90°F)',
        weatherAdvisory: 'Imperial gardens morning, classic tower afternoon, epic nightlife finale',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 11:30 AM',
            title: 'Imperial Palace East Gardens',
            location: 'Imperial Palace East Gardens',
            description: 'Historic heart of Tokyo, former Edo Castle grounds',
            significance: 'Historic heart of Tokyo, former Edo Castle grounds where Tokugawa shoguns ruled for 265 years',
            whatToDo: [
              'Walk through beautifully maintained Japanese gardens',
              'Visit ruins of Edo Castle foundations',
              'Climb to observation deck for city views',
              'See seasonal flowers and traditional landscaping',
              'Learn about samurai history at information displays'
            ],
            whatToExpect: 'Peaceful contrast to city chaos, beautiful gardens, historical significance',
            selfGuidedTour: {
              title: 'Self-Guided Walking Tour: Imperial Palace East Gardens',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #8B4513; margin-bottom: 10px;">🏛️ Complete Walking Tour (90 minutes)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">📍 Entry Point: Otemon Gate (大手門)</strong>
                    <p>Begin your journey at the historic main entrance to Edo Castle. As you approach, notice the massive stone foundations (ishigaki) - these were built using an intricate puzzle-like technique called "nozura-zukuri" where stones fit together without mortar. The current gatehouse is a 1967 reconstruction of the original destroyed in WWII.</p>
                    <p><em>Historical Note:</em> This gate once welcomed samurai retainers and officials entering the most powerful castle in Japan. The Tokugawa shoguns ruled from here for 265 years (1603-1868).</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🏰 Stop 1: Sannomaru Shozokan (三の丸尚蔵館) - 5 minutes</strong>
                    <p>Immediately after entry, visit this small museum housing imperial treasures. The building sits on what was once the "Sannomaru" (Third Circle) - the outermost defensive ring of Edo Castle. Look for rotating exhibitions of paintings, calligraphy, and crafts from the imperial collection.</p>
                    <p><em>What you're seeing:</em> This area housed lower-ranking samurai and served as the first line of defense.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌸 Stop 2: Ninomaru Gardens (二の丸庭園) - 20 minutes</strong>
                    <p>Walk north toward the reconstructed Ninomaru Garden, designed in 1630 by Kobori Enshu, master of tea ceremony and garden design. This is a "chisen-kaiyushiki" (pond-strolling) garden meant to be viewed while walking.</p>
                    <p><strong>Key Features to Notice:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Stone Bridges:</strong> Represent the journey of life and spiritual crossing</li>
                      <li><strong>Carefully Placed Rocks:</strong> Each stone represents mountains or islands in miniature</li>
                      <li><strong>Seasonal Plantings:</strong> Plum (February), cherry (April), azalea (May), iris (June)</li>
                      <li><strong>Pond Reflection:</strong> Designed to mirror the sky and create infinite depth</li>
                    </ul>
                    <p><em>Cultural Context:</em> This garden embodied the aesthetic principle of "wabi-sabi" - finding beauty in imperfection and impermanence, central to Japanese philosophy.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🏯 Stop 3: Honmaru Ruins (本丸跡) - 25 minutes</strong>
                    <p>Continue uphill to the heart of the original castle - the Honmaru (Main Circle). This elevated platform once held the magnificent five-story main keep (tenshu), destroyed by fire in 1657 and never rebuilt.</p>
                    <p><strong>Foundation Exploration:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Stone Base Outlines:</strong> Trace the footprint of buildings that housed the shogun's private quarters</li>
                      <li><strong>Elevated Platform:</strong> Strategic height gave defensive advantage and demonstrated power</li>
                      <li><strong>Moats (now lawn):</strong> Imagine water-filled defensive barriers that once surrounded this area</li>
                      <li><strong>Guard Positions:</strong> Notice small stone platforms where samurai guards once stood watch</li>
                    </ul>
                    <p><em>Imagine:</em> In 1650, this area buzzed with 80,000 people including samurai, servants, craftsmen, and merchants serving the most powerful military government in the world.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌿 Stop 4: Futaba-tei Teahouse Site - 10 minutes</strong>
                    <p>Descend toward this peaceful spot where the Meiji Emperor once held tea ceremonies. The current grassy area was once home to an elegant teahouse representing the transition from military (samurai) to imperial (cultural) rule after 1868.</p>
                    <p><em>Transition Point:</em> This symbolizes Japan's transformation from feudal isolation to modern imperial state - from sword to tea ceremony, from warfare to culture.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🗼 Stop 5: Shiomi-zaka (Tidal View Slope) - 15 minutes</strong>
                    <p>Walk to this elevated viewing area for panoramic views of modern Tokyo. The name "Shiomi" (tide viewing) recalls when Tokyo Bay was visible from here before modern development.</p>
                    <p><strong>Photo Opportunities:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tokyo Station:</strong> Red brick building completed in 1914, designed to echo Amsterdam Central Station</li>
                      <li><strong>Marunouchi Skyline:</strong> Japan's financial district, built on land that was once samurai estates</li>
                      <li><strong>Garden Contrast:</strong> Perfect shot showing traditional gardens against ultramodern city</li>
                    </ul>
                    <p><em>Reflection Moment:</em> You're standing where shoguns once surveyed their domain. Today's view encompasses four centuries of continuous development from the same vantage point.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌺 Stop 6: Seasonal Garden Areas - 10 minutes</strong>
                    <p>Before departing, explore the seasonal sections based on your visit time:</p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>July Visit:</strong> Hydrangeas and summer flowers, traditional bamboo installations</li>
                      <li><strong>Rose Garden:</strong> Western-style addition representing Meiji-era openness to foreign influence</li>
                      <li><strong>Herb Garden:</strong> Traditional medicinal plants once used by court physicians</li>
                    </ul>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🚪 Exit Strategy: Hirakawa-mon Gate - 5 minutes</strong>
                    <p>Exit through Hirakawa-mon Gate (平川門) if possible - this was historically the "unclean gate" used for removing the deceased and criminals. Today it offers a quieter exit and different perspective on the massive defensive walls.</p>
                    <p><em>Final Thought:</em> As you leave, remember you've walked through the power center of Japan for over 400 years - from shogun to emperor to symbol of modern democracy.</p>
                  </div>

                  <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <strong style="color: #1B4A2C;">🎯 Cultural Etiquette Reminders:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Bow slightly when passing through gates (traditional respect)</li>
                      <li>Stay on designated paths (protects both gardens and visitors)</li>
                      <li>Photography is welcome, but be respectful of other visitors</li>
                      <li>Speak quietly to maintain the contemplative atmosphere</li>
                      <li>Free entry, but guards check bags at entrance</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'dining',
            time: '12:00 PM - 1:00 PM',
            title: 'Imperial District Lunch',
            location: 'Marunouchi/Imperial Palace area',
            description: 'Refined lunch in Tokyo\'s prestigious business district',
            restaurants: [
              {
                name: 'Kihachi Marunouchi Building',
                cost: '¥1,800-2,500',
                description: 'Renowned French-Japanese fusion restaurant by celebrity chef Kihachi Kumagai',
                whyRecommended: 'Michelin-mentioned chef, seasonal kaiseki-French fusion, elegant Imperial Palace proximity',
                whatToExpect: 'Sophisticated lunch sets with French technique and Japanese ingredients, impeccable presentation'
              },
              {
                name: 'Nihonbashi Tamai Tokyo Station',
                cost: '¥1,200-1,800',
                description: 'Famous anago (sea eel) specialty restaurant established in 1837',
                whyRecommended: '185-year history, signature anago-meshi (eel rice), traditional Edo cuisine',
                whatToExpect: 'Perfectly grilled sea eel over rice, delicate flavors, historic recipes'
              },
              {
                name: 'Kyoboshi Marunouchi',
                cost: '¥1,500-2,200',
                description: 'High-end sushi restaurant specializing in Edomae-style preparation',
                whyRecommended: 'Traditional Edomae sushi techniques, premium Tsukiji fish, lunch kaiseki sets',
                whatToExpected: 'Fresh seasonal sushi, elegant presentation, traditional preparation methods'
              }
            ],
            cost: { yen: 1600, usd: 11.20 }
          },
          {
            type: 'transport',
            time: '1:00 PM - 1:30 PM',
            title: 'Marunouchi to Tokyo Tower Transit',
            location: 'Imperial Palace → Tokyo Tower',
            route: {
              origin: 'Tokyo Station, Tokyo, Japan',
              destination: 'Tokyo Tower, Tokyo, Japan'
            },
            description: 'Journey from imperial district to classic Tokyo landmark',
            whatToDo: [
              'Take JR Yamanote Line from Tokyo to Shimbashi (3 minutes)',
              'Transfer to Toei Oedo Line at Shimbashi',
              'Take Oedo Line to Akabanebashi (6 minutes)',
              'Walk 5 minutes to Tokyo Tower entrance'
            ],
            whatToExpect: 'Efficient transit from business district to tower district',
            cost: { yen: 280, usd: 1.96 }
          },
          {
            type: 'cultural',
            time: '2:00 PM - 4:00 PM',
            title: 'Tokyo Tower',
            location: 'Tokyo Tower',
            description: 'Classic Tokyo landmark for final views',
            significance: 'Classic Tokyo landmark for final views',
            whatToDo: [
              'Visit Main Observatory (150m) and Special Observatory (250m)',
              'Take photos of iconic red and white tower',
              'Shop for Tokyo Tower exclusive merchandise',
              'See panoramic views of Tokyo Bay and city',
              'Compare views with modern experiences from previous days'
            ],
            whatToExpect: 'Iconic tower views, nostalgic Tokyo symbol',
            selfGuidedTour: {
              title: 'Self-Guided Experience: Tokyo Tower & Minato District',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #8B4513; margin-bottom: 10px;">🗼 Complete Tower & Area Experience (2+ hours)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">📍 Approach: Onarimon Station to Tower Base</strong>
                    <p>Walk from Onarimon Station through the tree-lined approach, experiencing the dramatic scale transition from street level to Tokyo's second-tallest structure. Notice how the 1958 Eiffel Tower-inspired design was created to exceed its French inspiration by 13 meters.</p>
                    <p><em>Design Note:</em> The red and white color scheme wasn't just aesthetic - aviation safety regulations required these specific colors for aircraft visibility.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🎟️ Stop 1: FootTown Complex (Ground Level) - 20 minutes</strong>
                    <p>Begin at the base complex housing shops, restaurants, and the Tokyo Tower Aquarium. This commercial area supports the tower's operations and provides context for 1950s Japanese optimism.</p>
                    <p><strong>Ground Level Highlights:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tokyo Tower Official Shop:</strong> Exclusive tower-shaped souvenirs and retro merchandise</li>
                      <li><strong>Historical Displays:</strong> Photos showing Tokyo's reconstruction after WWII</li>
                      <li><strong>Scale Model:</strong> Compare Tokyo Tower's 333m height with other global landmarks</li>
                      <li><strong>Ticket Purchase:</strong> Choose Main Observatory (¥1,200) or combo ticket with Top Deck (¥3,000)</li>
                    </ul>
                    <p><em>Historical context:</em> Built during Japan's post-war economic recovery, symbolizing the nation's return to prominence.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🏙️ Stop 2: Main Observatory - 150m (45 minutes)</strong>
                    <p>Ascend to the main viewing platform for 360-degree panoramic views of Tokyo, with specific viewing zones for different landmarks.</p>
                    <p><strong>Directional Viewing Guide:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>North View:</strong> Imperial Palace grounds, Tokyo Station, and Ueno district you visited</li>
                      <li><strong>East View:</strong> Sumida River, Tokyo Skytree (your next day's destination), and Odaiba area</li>
                      <li><strong>South View:</strong> Tokyo Bay, Rainbow Bridge, and on clear days Mount Fuji (75km away)</li>
                      <li><strong>West View:</strong> Shibuya, Harajuku, and the sprawling residential areas extending to mountains</li>
                    </ul>
                    <p><em>Photography tips:</em> Golden hour (sunset) provides warmest light. Use tower's glass panels as frames for city shots.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">⛅ Stop 3: Special Observatory - 250m (30 minutes)</strong>
                    <p>Experience Tokyo's highest traditional observation deck (before Skytree era), offering more intimate views and historical significance.</p>
                    <p><strong>Elevated Perspective:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Weather Station:</strong> Official Tokyo meteorological observation point since 1958</li>
                      <li><strong>Broadcasting Equipment:</strong> See the actual radio/TV transmission infrastructure</li>
                      <li><strong>Clear Day Views:</strong> Mount Fuji visibility on 15% of days (best winter mornings)</li>
                      <li><strong>Urban Planning Perspective:</strong> Understand Tokyo's concentric ring development pattern</li>
                    </ul>
                    <p><em>Engineering insight:</em> The tower sways up to 20cm in strong winds but remains completely safe due to flexible steel construction.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">⛩️ Step 4: Zojoji Temple Complex (Adjacent) - 25 minutes</strong>
                    <p>Walk 3 minutes to this remarkable Buddhist temple that predates Tokyo Tower by 400+ years, creating a stunning contrast between traditional and modern Japan.</p>
                    <p><strong>Temple Highlights:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Main Hall (Daiden):</strong> Reconstructed 1974, houses sacred Buddhist images</li>
                      <li><strong>Tokugawa Mausoleum:</strong> Burial site of 6 Tokugawa shoguns (separate paid area)</li>
                      <li><strong>Sangedatsumon Gate:</strong> Original 1622 structure, designated Important Cultural Property</li>
                      <li><strong>Modern Photography:</strong> Perfect shots of ancient temple with modern tower backdrop</li>
                    </ul>
                    <p><em>Cultural juxtaposition:</em> This represents Japan's ability to preserve tradition while embracing modernity - 400-year-old temple coexisting with 1950s architecture.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌳 Stop 5: Shiba Park & Prince Park Tower Area - 20 minutes</strong>
                    <p>Explore the landscaped gardens surrounding Tokyo Tower, designed to provide peaceful contrast to the urban intensity of central Tokyo.</p>
                    <p><strong>Garden Features:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Seasonal Plantings:</strong> Cherry blossoms (spring), summer hydrangeas, autumn maple colors</li>
                      <li><strong>Traditional Bridges:</strong> Stone and wooden bridges over small streams and ponds</li>
                      <li><strong>Rest Areas:</strong> Benches positioned for optimal tower viewing angles</li>
                      <li><strong>Hotel Integration:</strong> See how Prince Park Tower hotel incorporates the tower views</li>
                    </ul>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🍴 Stop 6: Roppongi Hills Connection & Dining - 15 minutes</strong>
                    <p>Walk toward nearby Roppongi Hills (10 minutes) to see Tokyo's evolution from the Tower era (1950s) to the Hills era (2000s), representing different phases of Tokyo's development.</p>
                    <p><strong>Area Dining Options:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tokyo Tower Cafe:</strong> Tower-themed desserts and drinks with views</li>
                      <li><strong>Tofu-ya Ukai:</strong> Traditional kaiseki in historic setting (expensive but exceptional)</li>
                      <li><strong>Roppongi Hills Restaurants:</strong> International cuisine with modern city views</li>
                      <li><strong>Local Izakaya:</strong> Authentic Japanese pub experience in surrounding streets</li>
                    </ul>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #2C5234;">🌉 Stop 7: Tokyo Bay Views & Rainbow Bridge - 10 minutes</strong>
                    <p>From Tokyo Tower's south-facing areas, appreciate the engineered Tokyo Bay coastline and Rainbow Bridge, showcasing Japan's land reclamation expertise.</p>
                    <p><strong>Engineering Marvels:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Odaiba Island:</strong> Artificial island where you experienced teamLab Planets</li>
                      <li><strong>Rainbow Bridge:</strong> 798-meter suspension bridge connecting central Tokyo to waterfront</li>
                      <li><strong>Port Infrastructure:</strong> See massive container terminals and shipping operations</li>
                      <li><strong>Haneda Airport:</strong> Runway lights visible in distance, showing Tokyo's aviation accessibility</li>
                    </ul>
                  </div>

                  <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <strong style="color: #1B4A2C;">🎯 Tokyo Tower Experience Tips:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Visit during sunset for golden hour photography - tower lights illuminate at dusk</li>
                      <li>Combo tickets save money if planning to visit Top Deck (though Main Observatory sufficient for most)</li>
                      <li>Clear days offer Mount Fuji views - check weather apps for visibility forecasts</li>
                      <li>Compare this "retro-future" 1950s vision with tomorrow's ultra-modern Skytree experience</li>
                      <li>Zojoji Temple free, but special exhibitions may have small fees</li>
                      <li>Area walking easily extends to Roppongi Hills for shopping and dining</li>
                      <li>Tower's red/white paint job requires repainting every 5 years - marvel at maintenance precision</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 1200, usd: 8.40 }
          },
          {
            type: 'dining',
            time: '5:00 PM - 6:30 PM',
            title: 'Light Dinner',
            location: 'Near hotel',
            description: 'Final Tokyo meal before nightlife adventure',
            restaurants: [
              {
                name: 'Kozasa',
                cost: '¥1,500-2,500',
                description: 'Long-established yakitori specialist, local favorite since 1928',
                whyRecommended: 'Traditional grilled chicken expertise with intimate counter seating and authentic atmosphere',
                whatToExpect: 'Traditional izakaya atmosphere with expert yakitori preparation and local clientele',
                address: '3-6-2 Shibuya, Shibuya City, Tokyo 150-0002'
              },
              {
                name: 'Shibuya Food Show (Tokyu)',
                cost: '¥1,500-2,500',
                description: 'Premium department store food court near Hyatt House with gourmet options',
                whyRecommended: 'High-quality prepared foods and bento from top Tokyo vendors',
                whatToExpected: 'Upscale food hall with excellent takeaway options for quick dining'
              }
            ],
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'nightlife',
            time: '11:00 PM - 2:00 AM',
            title: 'WOMB Shibuya (EDM Club)',
            location: 'Shibuya',
            address: '2-16 Maruyamacho, Shibuya City, Tokyo 150-0044',
            description: 'Tokyo\'s premier electronic music venue, ranked among world\'s top clubs by Mixmag magazine',
            significance: 'Tokyo\'s premier electronic music venue, ranked among world\'s top clubs by Mixmag magazine',
            whatToDo: [
              'Experience famous mirror ball room on main floor with Asia\'s largest mirror ball',
              'Dance to house and techno from international DJs and top local artists',
              'Explore all 4 floors with different music styles and atmospheres (main floor, intimate basement, lounge areas)',
              'Enjoy world-class sound system with high-quality lighting and laser productions',
              'Meet international clubbers and locals in friendly, welcoming crowd'
            ],
            whatToExpected: '4 floors of house/techno, serious sound system, diverse international crowd, professional production quality',
            cost: { yen: 4000, usd: 28.00 }
          },
          {
            type: 'nightlife',
            time: '2:00 AM - 4:00 AM',
            title: 'Ni-chome Gay District',
            location: 'Shinjuku Ni-chome',
            description: 'Asia\'s largest gay district with over 300 LGBTQ+ venues in compact area',
            significance: 'Asia\'s largest gay district with over 300 LGBTQ+ venues in compact area',
            restaurants: [
              {
                name: 'Arty Farty',
                cost: '¥2,000-3,000 + drinks',
                description: 'Popular dance club with pop and electronic music, diverse international crowd',
                whyRecommended: 'Most international-friendly, great for tourists',
                whatToExpect: 'High-energy dance floor with diverse crowd',
                address: '2-11-7 Shinjuku, Shinjuku City, Tokyo 160-0022'
              },
              {
                name: 'AiSOTOPE Lounge',
                cost: '¥1,500-2,500 + drinks',
                description: 'Intimate bar atmosphere with friendly mama-san culture and local regulars',
                whyRecommended: 'Authentic Japanese gay bar culture',
                whatToExpect: 'Intimate setting with local interaction'
              },
              {
                name: 'Dragon Men',
                cost: '¥1,500-2,000 + drinks',
                description: 'Casual bar with English-speaking staff and welcoming atmosphere for tourists',
                whyRecommended: 'Tourist-friendly with English support',
                whatToExpect: 'Relaxed atmosphere, easy communication'
              }
            ],
            whatToExpected: 'Welcoming inclusive atmosphere, diverse venues from intimate bars to dance clubs, late-night energy until dawn',
            cost: { yen: 6000, usd: 42.00 }
          }
        ],
        totalCost: { yen: 15080, usd: 105.56 },
        costBreakdown: {
          food: { yen: 3600, usd: 25.20 },
          transport: { yen: 280, usd: 1.96 },
          attractions: { yen: 1200, usd: 8.40 },
          nightlife: { yen: 10000, usd: 70.00 },
          shopping: { yen: 0, usd: 0 },
          drinks: { yen: 0, usd: 0 }
        }
      },
      {
        date: 'Saturday, July 19', 
        title: 'Tokyo Skytree Finale & Bullet Train Journey', 
        city: 'Kyoto',
        weather: 'Hot travel day, cooler evening in Kyoto (82-88°F)',
        weatherAdvisory: 'Morning Skytree experience, afternoon bullet train departure',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Final Tokyo breakfast before bullet train journey',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 12:30 PM',
            title: 'Tokyo Skytree Experience',
            location: 'Tokyo Skytree',
            description: 'Tokyo\'s tallest structure and modern architectural marvel - final Tokyo landmark',
            significance: 'Tokyo\'s tallest structure at 634m, modern architectural marvel representing new Tokyo',
            whatToDo: [
              'Ascend to Tembo Deck (350m) for 360° panoramic views of Tokyo',
              'Experience Tembo Galleria (450m) - highest observation point in Japan',
              'Take photos of iconic silver spire and modern Tokyo skyline',
              'See Mount Fuji on clear days and compare views with Tokyo Tower experience',
              'Shop for exclusive Skytree character goods and Tokyo souvenirs',
              'Enjoy final Tokyo moments from highest vantage point'
            ],
            whatToExpect: 'Spectacular 360° city views, modern observation technology, perfect Tokyo finale',
            selfGuidedTour: {
              title: 'Self-Guided Experience: Tokyo Skytree & Sumida District',
              content: `
                <div style="line-height: 1.6; margin-top: 10px;">
                  <h4 style="color: #4F46E5; margin-bottom: 10px;">🗼 Complete Skytree & Area Experience (2.5+ hours)</h4>
                  
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #1E40AF;">📍 Approach: Tokyo Skytree Station to Base Complex</strong>
                    <p>Emerge from Tokyo Skytree Station (formerly Narihirabashi) to witness the dramatic 634-meter spire piercing the sky. The triangular base gradually transitions to circular at 320m, representing traditional Japanese architectural evolution from earth (triangle) to heaven (circle).</p>
                    <p><em>Engineering Marvel:</em> The 634m height wasn't arbitrary - it references the historical name "Musashi Province" (6-3-4 in Japanese numerology), linking ultra-modern engineering with ancient regional identity.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #1E40AF;">🏢 Stop 1: Tokyo Skytree Town Complex (Ground Level) - 25 minutes</strong>
                    <p>Begin at the base complex featuring Tokyo Solamachi shopping mall, aquarium, and cultural facilities. This isn't just commercial space - it's urban planning designed to create a "vertical town" serving 32 million annual visitors.</p>
                    <p><strong>Ground Level Exploration:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tokyo Skytree Official Shop:</strong> Exclusive Sorakara-chan mascot goods and architectural models</li>
                      <li><strong>Engineering Displays:</strong> Cross-sections showing the tower's sophisticated earthquake-resistant design</li>
                      <li><strong>Height Comparison:</strong> Interactive exhibits comparing Skytree with global towers</li>
                      <li><strong>LED Lighting Preview:</strong> Learn about the tower's 1,995 LED lights and nightly color themes</li>
                      <li><strong>Ticket Selection:</strong> Tembo Deck (¥2,100) or complete Tembo Galleria experience (¥3,100)</li>
                    </ul>
                    <p><em>Cultural significance:</em> Built to replace Tokyo Tower as the primary broadcasting antenna, representing Japan's digital age transition.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #1E40AF;">🌤️ Stop 2: Tembo Deck - 350m (50 minutes)</strong>
                    <p>Ascend via high-speed elevators (600m/minute) to the main observation deck. At 350 meters, you're experiencing views from higher than most aircraft fly over the city.</p>
                    <p><strong>360° Viewing Strategy:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Southwest View:</strong> Tokyo Bay, Rainbow Bridge, Odaiba's artificial islands, and yesterday's Tokyo Tower</li>
                      <li><strong>Northwest View:</strong> Imperial Palace, Tokyo Station, and the business districts you've explored</li>
                      <li><strong>Northeast View:</strong> Ueno Park where you visited museums, extending to distant mountains</li>
                      <li><strong>Southeast View:</strong> Tokyo DisneySea, Haneda Airport, and on exceptional days, Mount Fuji (75km distant)</li>
                    </ul>
                    <p><em>Atmospheric perspective:</em> Notice how the urban sprawl extends endlessly to the horizon - Tokyo metropolitan area houses 38 million people, visible as a continuous urban landscape.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #1E40AF;">🚀 Stop 3: Tembo Galleria - 450m (30 minutes)</strong>
                    <p>Continue to Japan's highest accessible observation point via glass-tube elevator. The spiraling walkway offers continuously changing perspectives as you ascend the final 100 meters.</p>
                    <p><strong>Ultimate Tokyo Perspective:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Curvature of Earth:</strong> On clear days, observe the Earth's curvature at the horizon</li>
                      <li><strong>Weather Patterns:</strong> Watch cloud formations and weather systems moving across the Kanto Plain</li>
                      <li><strong>Urban Planning Insights:</strong> See how rail lines radiate from central Tokyo like spokes on a wheel</li>
                      <li><strong>Digital Installations:</strong> Interactive floor projections showing real-time Tokyo data</li>
                      <li><strong>Photographic Opportunities:</strong> Floor-to-ceiling windows allow unobstructed photography</li>
                    </ul>
                    <p><em>Technological achievement:</em> The observation gallery's glass tubes can withstand earthquakes up to magnitude 7, swaying up to 2 meters while remaining safe.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #1E40AF;">🎌 Stop 4: Sumida District Cultural Experience (30 minutes after tower)</strong>
                    <p>Descend to explore the historically significant Sumida district, home to traditional craftsmen and the famous Sumida River that appears in countless ukiyo-e woodblock prints.</p>
                    <p><strong>Traditional Area Highlights:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Sumida Hokusai Museum:</strong> 5-minute walk - dedicated to the famous ukiyo-e artist who lived here</li>
                      <li><strong>Tokyo Sky Tree East Tower:</strong> Traditional shopping street with 100+ year-old businesses</li>
                      <li><strong>Sumida River Walk:</strong> Riverside path offering perfect Skytree reflection photos</li>
                      <li><strong>Kototoi Bridge:</strong> Historic bridge providing classic Skytree approach photography</li>
                    </ul>
                    <p><em>Historical layering:</em> This district exemplifies Tokyo's ability to layer ultra-modern (Skytree) over centuries-old traditional neighborhoods.</p>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <strong style="color: #1E40AF;">🍜 Stop 5: Local Food & Souvenir Experience (20 minutes)</strong>
                    <p>Before departing, experience authentic Sumida district food culture at the base complex or nearby traditional establishments.</p>
                    <p><strong>Culinary & Shopping Options:</strong></p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><strong>Tokyo Solamachi Restaurant Floor:</strong> 30+ restaurants from casual to upscale with Skytree views</li>
                      <li><strong>Sumida Local Sweets:</strong> Traditional wagashi (Japanese confections) shops within walking distance</li>
                      <li><strong>Skytree Character Goods:</strong> Exclusive merchandise only available at the base complex</li>
                      <li><strong>Traditional Crafts:</strong> Local artisan products representing Sumida's craftsman heritage</li>
                    </ul>
                    <p><em>Departure preparation:</em> Perfect transition point for bullet train journey - direct access to transportation hub.</p>
                  </div>

                  <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border: 1px solid #4F46E5; border-radius: 8px; padding: 12px; margin-top: 15px;">
                    <strong style="color: #1E3A8A;">🎯 Tokyo Skytree Experience Tips:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>Visit early morning for clearest visibility - afternoon haze often obscures distant views</li>
                      <li>Fast Skytree Ticket worth extra cost - skip long entry lines during peak season</li>
                      <li>Weather check crucial - clear days offer Mount Fuji views, cloudy days still provide urban spectacle</li>
                      <li>Compare modern engineering precision with Tokyo Tower's 1950s aesthetic from yesterday</li>
                      <li>Sumida district exploration adds cultural depth beyond just tower experience</li>
                      <li>Photography gear recommended - telephoto lens captures distant landmarks clearly</li>
                      <li>LED light show begins at sunset - tower becomes illuminated art installation</li>
                      <li>Transportation hub accessibility makes this perfect final Tokyo experience before bullet train</li>
                    </ul>
                  </div>
                </div>
              `
            },
            cost: { yen: 3000, usd: 21.00 }
          },
          {
            type: 'activity',
            time: '12:30 PM - 1:30 PM',
            title: 'Tokyo Station Preparation',
            location: 'Tokyo Station area',
            description: 'Final preparations and bullet train boarding',
            whatToDo: [
              'Retrieve luggage and travel to Tokyo Station',
              'Purchase premium ekiben (train bento) from station vendors',
              'Buy last-minute Japanese snacks and drinks for journey',
              'Take photos of historic Tokyo Station red brick building',
              'Board shinkansen with reserved seats'
            ],
            whatToExpect: 'Efficient station operations, premium travel food options, excitement for bullet train',
            cost: { yen: 1200, usd: 8.40 }
          },
          {
            type: 'transport',
            time: '2:00 PM - 5:00 PM',
            title: 'Shinkansen Bullet Train Experience',
            location: 'Tokyo to Kyoto',
            route: {
              origin: 'Tokyo Station, Tokyo, Japan',
              destination: 'Kyoto Station, Kyoto, Japan'
            },
            description: 'Japan\'s engineering marvel - 320 km/h journey with legendary punctuality (average delay: 18 seconds annually)',
            significance: 'Japan\'s engineering marvel - 320 km/h journey with legendary punctuality',
            whatToDo: [
              'Purchase ekiben (luxury train bento) from Tokyo Station vendors before boarding - featuring regional specialties',
              'Reserve seats D or E on right side for potential Mount Fuji views (weather permitting in July)',
              'Take photos of sleek bullet train nose and marvel at engineering precision',
              'Experience legendary punctuality and smooth 320 km/h travel with no turbulence',
              'Enjoy gourmet ekiben featuring seasonal ingredients and artistic presentation',
              'Use onboard WiFi to research Kyoto activities and traditional customs',
              'Watch Japanese countryside transform from urban Tokyo to historic Kansai region'
            ],
            whatToExpected: 'Ultra-smooth high-speed experience with potential Mount Fuji views on clear days, exceptional on-board dining',
            cost: { yen: 13850, usd: 95.00 }
          },
          {
            type: 'cultural',
            time: '5:00 PM - 7:00 PM',
            title: 'Kyoto Arrival & Gion Preview',
            location: 'Kyoto',
            description: 'First taste of traditional Japan atmosphere',
            significance: 'Immediate atmospheric change to traditional Japan, preserved Edo-period architecture',
            whatToDo: [
              'Check into Hyatt Place Kyoto and settle into traditional-modern atmosphere',
              'Purchase Kyoto City Bus Day Pass (¥600) for unlimited bus travel',
              'Rest and prepare for tomorrow\'s Gion Matsuri festival experience',
              'Walk through Gion district\'s historic preserved streets (Hanami-koji)',
              'Visit Yasaka Shrine for sunset photos',
              'Experience dramatically different pace from Tokyo\'s kinetic energy',
              'Spot geiko and maiko if fortunate (early evening is optimal time)'
            ],
            whatToExpected: 'Immediate atmospheric change to traditional Japan, preserved Edo-period architecture',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'dining',
            time: '7:00 PM - 8:30 PM',
            title: 'First Kyoto Dinner',
            location: 'Gion district',
            description: 'Introduction to Kyoto\'s refined culinary tradition',
            restaurants: [
              {
                name: 'K36 Rooftop Bar',
                cost: '¥3,600-5,100',
                description: 'Eye-level Yasaka Pagoda view (unique in the world) with craft cocktails',
                whyRecommended: 'Only bar in world with eye-level view of historic pagoda',
                whatToExpect: 'Stunning pagoda views, sophisticated cocktail atmosphere'
              },
              {
                name: 'Hanasaki Manjiro (Higashiyama)',
                cost: '¥6,000-8,000',
                description: 'Affordable kaiseki dinner near Yasaka Shrine for authentic multi-course experience',
                whyRecommended: 'Traditional kaiseki at accessible prices near historic sites',
                whatToExpect: 'Multi-course seasonal presentation, refined Kyoto cuisine'
              },
              {
                name: 'Traditional Tea House in Gion',
                cost: '¥2,000-3,000',
                description: 'Experience geiko district evening culture with matcha and wagashi sweets',
                whyRecommended: 'Authentic geisha district cultural experience',
                whatToExpect: 'Traditional tea ceremony atmosphere, seasonal sweets'
              }
            ],
            cost: { yen: 4000, usd: 28.00 }
          }
        ],
        totalCost: { yen: 22050, usd: 154.35 },
        costBreakdown: {
          food: { yen: 5200, usd: 36.40 },
          transport: { yen: 13850, usd: 95.00 },
          attractions: { yen: 3000, usd: 21.00 }
        }
      },
      {
        date: 'Sunday, July 20', 
        title: 'Condensed Kyoto Highlights', 
        city: 'Kyoto',
        weather: 'Very hot & humid (86-93°F with 78-83% humidity)',
        weatherAdvisory: 'Early temple visits recommended for best experience before crowds',
        activities: [
          {
            type: 'dining',
            time: '8:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:00 AM - 1:00 PM',
            title: 'Gion Matsuri Festival Atmosphere',
            location: 'Central Kyoto',
            description: 'Experience the ongoing month-long festival atmosphere during active celebration period',
            significance: 'Experience the ongoing month-long festival atmosphere during active celebration period',
            whatToDo: [
              'Watch artisans build floats by hand (float construction viewing)',
              'Experience ongoing celebration at Yasaka Shrine',
              'Buy sacred good luck charms (chimaki) from float neighborhoods',
              'See completed floats on display in various districts',
              'Listen to Gion Hayashi musicians practicing',
              'Try traditional festival snacks from vendors',
              'Visit float museums displaying tapestries and artifacts'
            ],
            festivalHighlights: [
              'Float construction viewing - watch artisans build floats by hand',
              'Festival atmosphere at Yasaka Shrine with ongoing celebrations',
              'Chimaki sacred good luck charms from float neighborhoods',
              'Float displays throughout various Kyoto districts',
              'Traditional Gion Hayashi music practice sessions',
              'Traditional festival food vendors throughout area',
              'Float museums with priceless tapestries and historical artifacts'
            ],
            whatToExpected: 'Intimate festival experience without parade crowds, authentic local participation',
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'dining',
            time: '1:00 PM - 2:30 PM',
            title: 'Festival Lunch',
            location: 'Kyoto Station area',
            description: 'Quality lunch after morning festival activities',
            restaurants: [
              {
                name: 'Katsukura Kyoto Station',
                cost: '¥2,000-3,000',
                description: 'Premium tonkatsu specialist since 1965',
                whyRecommended: 'Legendary tonkatsu restaurant with traditional preparation methods',
                whatToExpect: 'Crispy tonkatsu with traditional accompaniments, historical atmosphere'
              },
              {
                name: 'Kyoto Station Ramen Koji',
                cost: '¥1,200-2,000',
                description: '8 regional ramen styles under one roof',
                whyRecommended: 'Convenient access to multiple regional ramen styles',
                whatToExpect: 'Food court atmosphere with authentic regional specialties'
              }
            ],
            cost: { yen: 2500, usd: 17.50 }
          },
          {
            type: 'cultural',
            time: '3:00 PM - 6:00 PM',
            title: 'Gion District Deep Dive',
            location: 'Gion',
            description: 'Japan\'s most famous geisha district preserving 400+ years of traditional culture',
            significance: 'Japan\'s most famous geisha district preserving 400+ years of traditional culture',
            whatToDo: [
              'Walk Hanami-koji - main geisha spotting street with historic tea houses',
              'Explore Shirakawa area - most photogenic traditional buildings and canal views',
              'Visit Kennin-ji Temple - Japan\'s oldest Zen temple (1202) with rock gardens',
              'Browse traditional craft shops: kimono accessories, handmade paper, incense',
              'Take photos of traditional machiya (wooden townhouse) architecture',
              'Experience refined aesthetics representing 1,200 years of imperial taste',
              'Respectfully observe geiko and maiko if encountered (no photos without permission)'
            ],
            culturalEtiquette: 'Respectfully observe geiko and maiko from distance. No photos without permission. Maintain quiet, respectful behavior in traditional areas.',
            whatToExpected: 'Preserved Edo-period streets, traditional wooden architecture, potential geiko sightings',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'nightlife',
            time: '8:00 PM - 10:00 PM',
            title: 'Traditional Kyoto Evening',
            location: 'Higashiyama area',
            description: 'Authentic Kyoto evening experience',
            restaurants: [
              {
                name: 'K36 Rooftop Bar',
                cost: '¥3,600-5,100',
                description: 'Eye-level Yasaka Pagoda view (unique in the world) with craft cocktails',
                whyRecommended: 'Only bar in world with eye-level view of historic pagoda',
                whatToExpect: 'Stunning pagoda views, sophisticated cocktail atmosphere'
              },
              {
                name: 'Hanasaki Manjiro (Higashiyama)',
                cost: '¥6,000-8,000',
                description: 'Affordable kaiseki dinner near Yasaka Shrine for authentic multi-course experience',
                whyRecommended: 'Traditional kaiseki at accessible prices near historic sites',
                whatToExpect: 'Multi-course seasonal presentation, refined Kyoto cuisine'
              },
              {
                name: 'Traditional Tea House in Gion',
                cost: '¥2,000-3,000',
                description: 'Experience geiko district evening culture with matcha and wagashi sweets',
                whyRecommended: 'Authentic geisha district cultural experience',
                whatToExpected: 'Traditional tea ceremony atmosphere, seasonal sweets'
              }
            ],
            cost: { yen: 4000, usd: 28.00 }
          }
        ],
        totalCost: { yen: 9100, usd: 63.70 },
        costBreakdown: {
          food: { yen: 2500, usd: 17.50 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 2600, usd: 18.20 },
          nightlife: { yen: 4000, usd: 28.00 },
          festival: { yen: 2000, usd: 14.00 }
        }
      },
      {
        date: 'Monday, July 21', 
        title: 'Osaka Day Trip - Culinary Capital', 
        city: 'Kyoto',
        weather: 'Very hot & humid (86-93°F with 78-83% humidity)',
        weatherAdvisory: 'Full day trip to Japan\'s culinary capital - stay hydrated during street food tour',
        activities: [
          {
            type: 'dining',
            time: '8:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'transport',
            time: '9:00 AM - 10:00 AM',
            title: 'Travel to Osaka',
            location: 'Kyoto to Osaka',
            route: {
              origin: 'Kyoto Station, Kyoto, Japan',
              destination: 'Osaka Station, Osaka, Japan'
            },
            description: 'Express train to Japan\'s kitchen',
            whatToDo: [
              'Take comfortable express train from Kyoto to Osaka',
              'Prepare mentally for food-focused day in Japan\'s culinary capital',
              'Review Dotonbori street food map and must-try specialties'
            ],
            whatToExpect: '45-minute comfortable journey through Kansai countryside',
            cost: { yen: 570, usd: 4.00 }
          },
          {
            type: 'cultural',
            time: '10:30 AM - 12:00 PM',
            title: 'Osaka Castle',
            location: 'Osaka Castle Park',
            description: 'Symbol of Toyotomi Hideyoshi\'s unification of Japan (1583), represents Osaka\'s historical role as Japan\'s commercial heart',
            significance: 'Symbol of Toyotomi Hideyoshi\'s unification of Japan (1583)',
            whatToDo: [
              'Explore reconstructed castle\'s 8 floors with historical exhibits',
              'Learn about Japanese unification period and Hideyoshi\'s rise from farmer to ruler',
              'Enjoy panoramic views of modern Osaka from top floor observation deck',
              'Walk through castle park and traditional Japanese gardens',
              'See artifacts from Sengoku (Warring States) period',
              'Take photos of iconic white castle architecture against modern skyline'
            ],
            whatToExpected: 'Modern reconstruction with historical exhibits and elevator access, panoramic city views',
            cost: { yen: 1200, usd: 8.50 }
          },
          {
            type: 'dining',
            time: '12:30 PM - 1:30 PM',
            title: 'Dotonbori Street Food Experience',
            location: 'Dotonbori',
            description: 'Dotonbori embodies Osaka\'s "kuidaore" culture - eat until you drop. Birthplace of takoyaki, okonomiyaki, and kushikatsu',
            significance: 'Dotonbori embodies Osaka\'s "kuidaore" culture - eat until you drop',
            whatToDo: [
              'Try takoyaki at Wanaka - Original octopus balls, Osaka\'s signature dish (¥500-800)',
              'Experience okonomiyaki at Mizuno - Osaka-style savory pancake with special sauce (¥800-1,200)',
              'Sample kushikatsu at Daruma - Fried skewers with strict no double-dipping rule (¥100-300 per stick)',
              'Taste ikayaki from street stalls - Grilled whole squid pressed flat (¥300-500)',
              'Try taiyaki for dessert - Fish-shaped pastry with various fillings (¥200-400)',
              'Take mandatory photos with iconic Glico running man neon sign'
            ],
            restaurants: [
              {
                name: 'Takoyaki at Wanaka',
                cost: '¥500-800',
                description: 'Original octopus balls - Osaka\'s signature dish',
                whyRecommended: 'Most famous takoyaki stand in Dotonbori, established reputation',
                whatToExpected: 'Hot, crispy outside with creamy octopus interior',
                address: '1-5-5 Dotonbori, Chuo Ward, Osaka 542-0071'
              },
              {
                name: 'Okonomiyaki at Mizuno',
                cost: '¥800-1,200',
                description: 'Osaka-style savory pancake with special sauce',
                whyRecommended: 'Historic restaurant perfecting okonomiyaki for generations',
                whatToExpected: 'Thick, hearty pancake with complex umami flavors'
              },
              {
                name: 'Kushikatsu at Daruma',
                cost: '¥100-300 per stick',
                description: 'Fried skewers with strict no double-dipping rule',
                whyRecommended: 'Original kushikatsu restaurant with famous double-dipping prohibition',
                whatToExpected: 'Crispy battered skewers with tangy dipping sauce'
              }
            ],
            whatToExpected: 'Overwhelming sensory experience with neon signs and canal views, incredible street food variety',
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'activity',
            time: '4:00 PM - 6:00 PM',
            title: 'Mario Kart Street Racing Osaka',
            location: 'Osaka streets',
            description: '90-minute tour through staggeringly beautiful streets of Osaka in go-karts',
            significance: 'Unique perspective of Osaka from street level at 45-60 km/h',
            whatToDo: [
              '90-minute tour through main touristy districts: Umeda in North, castle on east, and Namba in south',
              'Experience karts reaching 45-60 km/h depending on motor power',
              'Choose from wide range of fun costumes provided free of charge',
              'Drive through staggeringly beautiful streets of Osaka',
              'See the city from unique street-level perspective',
              'Take photos during stops at major landmarks'
            ],
            whatToExpected: 'High-energy street racing experience with costume fun and city tour',
            requirements: 'International Driving Permit from AAA (1949 Geneva Convention)',
            cost: { yen: 10000, usd: 70.00 }
          },
          {
            type: 'dining',
            time: '7:00 PM - 8:30 PM',
            title: 'Proper Osaka Dinner',
            location: 'Dotonbori area',
            description: 'Experience famous Osaka hospitality ("Osaka no obachan" - welcoming auntie culture)',
            restaurants: [
              {
                name: 'Authentic Osaka-style okonomiyaki restaurant',
                cost: '¥2,000-3,000',
                description: 'Traditional sit-down okonomiyaki experience',
                whyRecommended: 'Experience authentic Osaka hospitality culture',
                whatToExpected: 'Welcoming atmosphere with traditional Osaka charm'
              },
              {
                name: 'Shinsekai kushikatsu restaurant',
                cost: '¥2,500-3,500',
                description: 'Historic kushikatsu in retro Shinsekai district',
                whyRecommended: 'Authentic neighborhood atmosphere with local specialties',
                whatToExpected: 'Nostalgic Showa-era atmosphere with crispy skewers'
              }
            ],
            cost: { yen: 2500, usd: 17.50 }
          },
          {
            type: 'nightlife',
            time: '9:00 PM - 10:30 PM',
            title: 'Osaka Nightlife Experience',
            location: 'Doyama District',
            description: 'Osaka\'s Doyama District represents Japan\'s progressive and inclusive LGBTQ+ culture',
            significance: 'Osaka\'s Doyama District represents Japan\'s progressive and inclusive LGBTQ+ culture',
            restaurants: [
              {
                name: 'Grand Slam',
                cost: '¥3,000-4,000',
                description: 'Traditional Japanese gay bar with welcoming mama-san atmosphere',
                whyRecommended: 'Authentic Japanese gay bar culture with friendly atmosphere',
                whatToExpected: 'Intimate setting with mama-san hospitality'
              },
              {
                name: 'EXPLOSION',
                cost: '¥4,000-6,000',
                description: 'High-energy gay dance club with international crowd and latest J-pop/EDM',
                whyRecommended: 'High-energy dance environment with diverse crowd',
                whatToExpected: 'Modern club atmosphere with latest music'
              },
              {
                name: 'Club Circus',
                cost: '¥3,500-5,000',
                description: 'Multi-floor EDM venue for electronic music enthusiasts',
                whyRecommended: 'Serious EDM venue with multiple floors and environments',
                whatToExpected: 'Professional sound system with dedicated electronic music focus'
              }
            ],
            whatToExpected: 'Diverse venues with different energy levels, welcoming LGBTQ+ community atmosphere',
            cost: { yen: 5000, usd: 35.00 }
          },
          {
            type: 'transport',
            time: '11:00 PM - 12:00 AM',
            title: 'Return to Kyoto',
            location: 'Osaka to Kyoto',
            route: {
              origin: 'Osaka Station, Osaka, Japan',
              destination: 'Kyoto Station, Kyoto, Japan'
            },
            description: 'Late night return to hotel',
            whatToExpect: 'Quick return journey to Kyoto hotel',
            cost: { yen: 570, usd: 4.00 }
          }
        ],
        totalCost: { yen: 20840, usd: 146.00 },
        costBreakdown: {
          food: { yen: 4500, usd: 31.50 },
          transport: { yen: 1140, usd: 8.00 },
          attractions: { yen: 1200, usd: 8.50 },
          activities: { yen: 10000, usd: 70.00 },
          nightlife: { yen: 5000, usd: 35.00 }
        }
      },
      {
        date: 'Tuesday, July 22', 
        title: 'Nara Day Trip - Sacred Deer & Temples', 
        city: 'Kyoto',
        weather: 'Hot and humid, typical Kansai summer weather (84-90°F)',
        weatherAdvisory: 'Early start recommended for Nara temples and deer park - bring water and sun protection',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'transport',
            time: '10:00 AM - 10:45 AM',
            title: 'Travel to Nara',
            location: 'Kyoto to Nara',
            route: {
              origin: 'Kyoto Station, Kyoto, Japan',
              destination: 'Nara Station, Nara, Japan'
            },
            description: 'Train to Japan\'s ancient capital and sacred deer park',
            whatToDo: [
              'Take JR Nara Line from Kyoto Station (covered by JR Pass)',
              'Enjoy countryside views during 45-minute journey',
              'Prepare deer crackers money (¥150 per pack)'
            ],
            whatToExpect: '45-minute scenic journey through historical Kansai region',
            cost: { yen: 720, usd: 5.00 }
          },
          {
            type: 'cultural',
            time: '11:15 AM - 12:30 PM',
            title: 'Todai-ji Temple & Great Buddha',
            location: 'Todai-ji Temple',
            description: 'UNESCO World Heritage site housing 15-meter tall Buddha statue in world\'s largest wooden building',
            significance: 'Eastern Great Temple built in 752, symbol of Buddhist influence in ancient Japan',
            whatToDo: [
              'Walk through Nandaimon Gate with fierce Nio Guardian statues',
              'Enter Daibutsuden Hall to see 15-meter tall Great Buddha (Daibutsu)',
              'Try squeezing through Buddha\'s nostril pillar hole for good luck',
              'Learn about temple\'s role in spreading Buddhism throughout Japan',
              'Visit temple museum showcasing national treasures',
              'Feed sacred deer along temple pathways'
            ],
            whatToExpect: 'Massive wooden structure with awe-inspiring Buddha statue, deer interactions throughout',
            cost: { yen: 500, usd: 3.50 }
          },
          {
            type: 'cultural',
            time: '12:45 PM - 2:30 PM',
            title: 'Nara Deer Park Experience',
            location: 'Nara Park',
            description: 'Interact with 1,200+ sacred deer roaming freely in Japan\'s first permanent capital',
            significance: 'Sacred Sika deer protected as messengers of the gods for over 1,300 years',
            whatToDo: [
              'Purchase deer crackers (shika senbei) for ¥150 per pack',
              'Experience famous bowing deer - they bow back when you bow!',
              'Feed deer throughout 500+ hectare park grounds',
              'Take photos with friendly deer (avoid taunting them)',
              'Walk tree-lined paths with stone lanterns covered in moss',
              'Visit smaller shrines scattered throughout the park'
            ],
            culturalEtiquette: 'Bow to deer before feeding. Never feed anything except official deer crackers. Be patient - aggressive behavior causes deer to kick.',
            whatToExpect: 'Surreal experience with hundreds of tame deer, beautiful park setting',
            cost: { yen: 300, usd: 2.10 }
          },
          {
            type: 'dining',
            time: '2:30 PM - 3:30 PM',
            title: 'Nara Local Specialties Lunch',
            location: 'Naramachi District',
            description: 'Traditional merchant district with preserved machiya townhouses',
            restaurants: [
              {
                name: 'Kamakura Pasta Nara',
                cost: '¥1,500-2,000',
                description: 'Japanese-Italian fusion in traditional setting',
                whyRecommended: 'Unique Nara interpretation of pasta in historic building',
                whatToExpect: 'Creative fusion dishes in atmospheric machiya'
              },
              {
                name: 'Naramachi traditional restaurant',
                cost: '¥1,800-2,500',
                description: 'Local Nara specialties including kakinoha-zushi',
                whyRecommended: 'Authentic local cuisine wrapped in persimmon leaves',
                whatToExpect: 'Traditional preserved sushi unique to Nara region'
              },
              {
                name: 'Mahoroba Daibutsu Pudding',
                cost: '¥400-600',
                description: 'Famous Nara pudding shop for dessert',
                whyRecommended: 'Award-winning local pudding, perfect afternoon treat',
                whatToExpect: 'Silky smooth pudding with unique local flavors'
              }
            ],
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'cultural',
            time: '3:45 PM - 5:00 PM',
            title: 'Kasuga Taisha Shrine',
            location: 'Kasuga Taisha',
            description: 'Shinto shrine famous for 3,000 stone and bronze lanterns',
            significance: 'Built in 768 by powerful Fujiwara clan, showcases Shinto architectural beauty',
            whatToDo: [
              'Walk pathway lined with moss-covered stone lanterns',
              'Enter inner sanctuary to see hundreds of bronze lanterns',
              'Make offering and receive fortune slip (omikuji)',
              'Admire vermillion shrine buildings against forest backdrop',
              'Experience twice-yearly lantern lighting festivals (if visiting during)',
              'Purchase protective amulets or shrine stamps (goshuin)'
            ],
            culturalEtiquette: 'Bow before passing through torii gates. Purify hands and mouth at water basin before entering.',
            whatToExpect: 'Mystical atmosphere with thousands of lanterns in forest setting',
            cost: { yen: 500, usd: 3.50 }
          },
          {
            type: 'transport',
            time: '5:30 PM - 6:15 PM',
            title: 'Return to Kyoto',
            location: 'Nara to Kyoto',
            route: {
              origin: 'Nara Station, Nara, Japan',
              destination: 'Kyoto Station, Kyoto, Japan'
            },
            description: 'Evening return to Kyoto',
            whatToDo: [
              'Take JR Nara Line back to Kyoto',
              'Relax after full day of temple visits and deer interactions',
              'Plan evening activities in Kyoto'
            ],
            whatToExpect: 'Comfortable evening journey back to Kyoto',
            cost: { yen: 720, usd: 5.00 }
          },
          {
            type: 'dining',
            time: '7:00 PM - 8:30 PM',
            title: 'Kyoto Evening Dinner',
            location: 'Central Kyoto',
            description: 'Relaxing dinner after Nara adventure',
            restaurants: [
              {
                name: 'Ganko Takoyaki',
                cost: '¥2,000-3,000',
                description: 'Quality kushikatsu and Japanese comfort food',
                whyRecommended: 'Reliable chain with consistent quality and English menu',
                whatToExpect: 'Casual atmosphere perfect for post-sightseeing meal'
              },
              {
                name: 'Local izakaya',
                cost: '¥2,500-3,500',
                description: 'Traditional Japanese pub atmosphere',
                whyRecommended: 'Authentic local experience with variety of small dishes',
                whatToExpect: 'Lively atmosphere with locals, great for unwinding'
              }
            ],
            cost: { yen: 2500, usd: 17.50 }
          }
        ],
        totalCost: { yen: 4170, usd: 29.15 },
        costBreakdown: {
          food: { yen: 2500, usd: 17.50 },
          transport: { yen: 1440, usd: 10.00 },
          attractions: { yen: 1300, usd: 9.10 }
        }
      },
      {
        date: 'Wednesday, July 23', 
        title: 'Final Kyoto & Gion Matsuri Yoiyama Evening', 
        city: 'Kyoto',
        weather: 'Hot and humid, typical Kansai summer weather (84-90°F)',
        weatherAdvisory: 'Experience the climactic Yoi-yama evening before July 24 parade - most exciting night of 1,150+ year festival',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 12:00 PM',
            title: 'Nijo Castle',
            location: 'Nijo Castle, Kyoto',
            description: 'Where Japan\'s last Shogun surrendered power in 1867, ending 700+ years of samurai rule',
            significance: 'Historic site where Shogun Yoshinobu abdicated power to Emperor Meiji, ending the samurai era',
            whatToDo: [
              'Walk on famous "nightingale floors" that squeak as security warning system',
              'See historic room where Shogun Yoshinobu abdicated power to Emperor Meiji',
              'Admire ornate painted screens (fusuma-e) and ceiling art by Kano school artists',
              'Explore beautiful traditional Japanese castle gardens with seasonal plantings',
              'Learn about end of samurai era and Japan\'s transition to modern state',
              'Take photos of unique architectural features and garden landscapes'
            ],
            whatToExpect: 'Unique squeaking security floors, ornate interior art representing pinnacle of Japanese craftsmanship',
            cost: { yen: 800, usd: 5.60 }
          },
          {
            type: 'dining',
            time: '12:30 PM - 3:00 PM',
            title: 'Nishiki Market Final Exploration',
            location: 'Nishiki Market, Kyoto',
            description: '"Kyoto\'s Kitchen" serving the imperial capital for 400+ years with 126 specialty shops in 1,280-foot covered market',
            significance: '"Kyoto\'s Kitchen" serving the imperial capital for 400+ years',
            whatToDo: [
              'Try tofu doughnuts and yuba (soy skin) specialties unique to Kyoto',
              'Sample Kyoto\'s famous matcha and traditional wagashi (seasonal sweets)',
              'Buy traditional Kyoto pickles (tsukemono) and specialty seasonings',
              'Watch traditional food preparation methods passed down through generations',
              'Purchase authentic Kyoto souvenirs: matcha tea, traditional ceramics',
              'Interact with vendors who represent family businesses spanning centuries'
            ],
            whatToExpect: 'Highest quality ingredients reflecting imperial standards, traditional preparation methods, unique Kyoto flavors',
            restaurants: [
              {
                name: 'Tofu doughnuts & yuba specialties',
                cost: '¥500-800 per item',
                description: 'Unique Kyoto tofu preparations including sweet and savory options',
                whyRecommended: 'Traditional Kyoto Buddhist cuisine adapted for market snacking',
                whatToExpect: 'Surprisingly delicious tofu-based treats unlike anywhere else'
              },
              {
                name: 'Matcha and wagashi sweets',
                cost: '¥600-1,200 per set',
                description: 'Premium Kyoto matcha with seasonal traditional sweets',
                whyRecommended: 'Imperial-level quality matcha representing Kyoto\'s tea ceremony heritage',
                whatToExpect: 'Ceremonial-grade matcha with artistic seasonal confections'
              },
              {
                name: 'Traditional tsukemono pickles',
                cost: '¥800-1,500 per selection',
                description: 'Kyoto-style pickled vegetables using traditional methods',
                whyRecommended: 'Centuries-old family recipes unique to Kyoto\'s imperial cuisine',
                whatToExpect: 'Complex fermented flavors representing Kyoto\'s culinary refinement'
              }
            ],
            cost: { yen: 2750, usd: 19.25 }
          },
          {
            type: 'cultural',
            time: '3:30 PM - 5:00 PM',
            title: 'Additional Temple Experience',
            location: 'Kyoto temples',
            description: 'Final temple visit before festival evening',
            significance: 'Complete Kyoto temple experience with UNESCO World Heritage sites',
            whatToDo: [
              'Visit Kiyomizu-dera Temple with famous wooden stage and city views',
              'Alternative: Sanjusangen-do Hall with 1,001 golden statues of Kannon',
              'Alternative: Walk Philosopher\'s Path along canal connecting temples',
              'Take final photos of traditional temple architecture',
              'Experience peaceful temple atmosphere before festival excitement',
              'Purchase temple stamps (goshuin) as authentic souvenirs'
            ],
            whatToExpect: 'Serene temple atmosphere providing contrast to evening festival energy',
            cost: { yen: 500, usd: 3.50 }
          },
          {
            type: 'cultural',
            time: '6:00 PM - 11:00 PM',
            title: 'Gion Matsuri Yoiyama Evening Festivities',
            location: 'Central Kyoto',
            description: 'Experience the climactic Yoi-yama evening before July 24 parade - most exciting night of 1,150+ year festival tradition',
            significance: 'Climactic evening of 1,150+ year festival tradition with street closures creating festival wonderland',
            whatToDo: [
              'Experience street closures transforming Shijo-dori into pedestrian festival paradise',
              'View completed yamaboko floats illuminated with traditional komagata lanterns',
              'Purchase sacred protective chimaki charms only available during festival period',
              'Experience Byobu Matsuri - traditional families displaying treasured artworks in machiya houses',
              'Listen to "kon-chinki" sounds from Gion Hayashi musicians filling the air',
              'Join locals dressed in colorful cotton yukata robes creating picturesque atmosphere',
              'Sample authentic festival food from street vendors: yakitori, takoyaki, taiyaki',
              'Witness peak festival excitement with illuminated floats towering over exhibits'
            ],
            festivalHighlights: [
              'Street closures creating pedestrian festival wonderland',
              'Illuminated yamaboko floats in final positions before parade',
              'Sacred chimaki charm purchases from float neighborhoods',
              'Traditional Byobu Matsuri house displays',
              'Authentic Gion Hayashi festival music throughout area',
              'Yukata-clad locals creating authentic festival atmosphere',
              'Traditional festival food vendors lining transformed streets'
            ],
            whatToExpect: 'Peak festival excitement with magical atmosphere representing 1,150+ years of tradition, authentic cultural immersion',
            restaurants: [
              {
                name: 'Festival food stalls',
                cost: '¥500-800 per item',
                description: 'Authentic yakitori, takoyaki, taiyaki, and okonomiyaki from street vendors',
                whyRecommended: 'Essential festival experience with traditional preparation methods',
                whatToExpect: 'Authentic festival atmosphere with locals, traditional cooking methods'
              }
            ],
            whatToExpect: 'Bittersweet final meal with reflection on transformative cultural experiences and memories',
            cost: { yen: 4500, usd: 31.50 }
          }
        ],
        totalCost: { yen: 7250, usd: 50.75 },
        costBreakdown: {
          food: { yen: 2750, usd: 19.25 },
          transport: { yen: 0, usd: 0 },
          attractions: { yen: 1300, usd: 9.10 },
          festival: { yen: 4000, usd: 28.00 }
        }
      },
      {
        date: 'Thursday, July 24', 
        title: 'Kyoto to Tokyo Bay via Shinkansen', 
        city: 'Kyoto to Tokyo Bay',
        weather: 'Hot travel day with Tokyo Bay evening (82-88°F)',
        weatherAdvisory: 'Travel day from Kyoto to Tokyo Bay for Disney resort experience',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Final Kyoto breakfast before Tokyo Bay travel',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 12:00 PM',
            title: 'Final Kyoto Shopping & Memories',
            location: 'Kyoto Station area',
            description: 'Last-minute Kyoto souvenir shopping before bullet train journey',
            significance: 'Final opportunity to purchase authentic Kyoto specialties before Tokyo Bay travel',
            whatToDo: [
              'Purchase final Japanese snacks and regional Kyoto specialties',
              'Buy traditional Kyoto souvenirs: matcha tea, ceramics, traditional crafts',
              'Organize luggage for bullet train journey to Tokyo Bay',
              'Take final photos around iconic Kyoto Station architecture',
              'Visit Kyoto Station souvenir shops for last-minute authentic items',
              'Stock up on Kyoto-specific treats unavailable elsewhere in Japan'
            ],
            whatToExpect: 'Efficient Kyoto Station shopping with authentic regional specialties, preparation for exciting bullet train journey',
            cost: { yen: 2500, usd: 17.50 }
          },
          {
            type: 'transport',
            time: '1:00 PM - 4:00 PM',
            title: 'Shinkansen to Tokyo',
            location: 'Kyoto to Tokyo',
            route: {
              origin: 'Kyoto Station, Kyoto, Japan',
              destination: 'Tokyo Station, Tokyo, Japan'
            },
            description: 'Bullet train journey back to Tokyo for Disney resort experience',
            significance: 'Return bullet train journey with different regional ekiben experience',
            whatToDo: [
              'Board afternoon bullet train back to Tokyo',
              'Purchase different regional ekiben for return journey experience',
              'Use travel time to plan Tokyo Disney day and resort activities',
              'Watch countryside transform back to urban Tokyo landscape',
              'Enjoy comfortable high-speed travel with luggage storage',
              'Take photos of Mount Fuji views if weather permits'
            ],
            whatToExpect: 'Smooth 320 km/h journey with different ekiben varieties, anticipation building for Disney experience',
            cost: { yen: 13850, usd: 95.00 }
          },
          {
            type: 'cultural',
            time: '4:00 PM - 8:00 PM',
            title: 'Tokyo Bay Area Arrival',
            location: 'Tokyo Bay',
            description: 'Check into waterfront hotel and explore Disney resort area',
            significance: 'Arrival at Tokyo Disney Resort area for magical conclusion to Japan trip',
            whatToDo: [
              'Arrive at Hyatt Regency Tokyo Bay near Tokyo Disney Resort',
              'Check into waterfront hotel with bay views and Disney shuttle access',
              'Rest and refresh after Kyoto farewell and bullet train travel',
              'Explore Tokyo Disney Resort area and Ikspiari shopping complex',
              'Plan tomorrow\'s Disney strategy and restaurant reservations',
              'Enjoy waterfront evening atmosphere with Tokyo Bay views'
            ],
            whatToExpect: 'Modern waterfront hotel with Disney magic beginning, relaxing bay views after travel day',
            restaurants: [
              {
                name: 'Ikspiari restaurants',
                cost: '¥2,000-3,500',
                description: 'Multiple dining options within Disney resort complex',
                whyRecommended: 'Convenient resort dining with Disney atmosphere beginning',
                whatToExpect: 'Family-friendly dining with Disney resort ambiance'
              },
              {
                name: 'Hotel waterfront dining',
                cost: '¥2,500-4,000',
                description: 'Hotel restaurants with Tokyo Bay views',
                whyRecommended: 'Relaxing bay views perfect for travel day recovery',
                whatToExpect: 'Peaceful waterfront dining with city skyline views'
              }
            ],
            cost: { yen: 3000, usd: 21.00 }
          }
        ],
        totalCost: { yen: 19350, usd: 133.50 },
        costBreakdown: {
          food: { yen: 3000, usd: 21.00 },
          transport: { yen: 13850, usd: 95.00 },
          shopping: { yen: 2500, usd: 17.50 }
        }
      },
      {
        date: 'Friday, July 25', 
        title: 'Tokyo Disney Resort Day', 
        city: 'Tokyo Bay',
        weather: 'Hot & humid (84-90°F with 78-83% humidity)',
        weatherAdvisory: 'Full day at theme park - stay hydrated and take breaks in air conditioning',
        activities: [
          {
            type: 'dining',
            time: '8:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Regency Tokyo Bay',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:00 AM - 10:00 PM',
            title: 'Tokyo Disney Resort Full Day',
            location: 'Tokyo DisneySea',
            description: 'Japan\'s most popular theme park with unique Japanese Disney culture',
            significance: 'World\'s only DisneySea park with unique attractions, Japanese Disney hospitality',
            whatToDo: [
              'Choose Tokyo DisneySea (unique to Japan) over Disneyland',
              'Arrive at rope drop for popular attractions with shorter wait times',
              'Use Disney Premier Access (paid FastPass system) for major attractions',
              'Experience Mediterranean Harbor with Venetian gondolas',
              'Visit Mysterious Island: Journey to Center of Earth and 20,000 Leagues',
              'Explore Arabian Coast with Aladdin-themed area and Sinbad\'s voyage',
              'Visit American Waterfront with 1912 New York and Cape Cod atmospheres',
              'Experience Fantasy Springs (NEW 2024): Frozen, Tangled, and Peter Pan areas',
              'Enjoy \'Believe! Sea of Dreams\' nighttime spectacular with projections and fireworks'
            ],
            whatToExpected: 'World\'s only DisneySea park with unique attractions, Japanese Disney hospitality, seasonal summer entertainment',
            cost: { yen: 9400, usd: 65.80 }
          },
          {
            type: 'dining',
            time: '12:00 PM - 7:30 PM',
            title: 'Disney Dining Experience',
            location: 'Tokyo DisneySea',
            description: 'Character-themed dining and themed restaurants within DisneySea',
            restaurants: [
              {
                name: 'Magellan\'s',
                cost: '¥4,000-6,000',
                description: 'Fine dining restaurant with maritime exploration theme',
                whyRecommended: 'Premium Disney dining experience',
                whatToExpect: 'Elegant atmosphere with maritime decor'
              },
              {
                name: 'Character dining options',
                cost: '¥2,500-4,000',
                description: 'Special themed restaurants with Disney character interactions',
                whyRecommended: 'Unique Japanese Disney character experience',
                whatToExpect: 'Character meet and greets during meal'
              }
            ],
            cost: { yen: 6500, usd: 45.50 }
          }
        ],
        totalCost: { yen: 17100, usd: 119.70 },
        costBreakdown: {
          disney_admission: { yen: 9400, usd: 65.80 },
          food: { yen: 6500, usd: 45.50 },
          souvenirs: { yen: 1200, usd: 8.40 }
        }
      },
      {
        date: 'Saturday, July 26', 
        title: 'Final Tokyo & Departure', 
        city: 'Tokyo Bay',
        weather: 'Hot morning, departure preparations (82-88°F)',
        weatherAdvisory: 'Final morning in Japan before departure - organize efficiently for international travel',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Regency Tokyo Bay',
            description: 'Final breakfast included due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 1:00 PM',
            title: 'Final Tokyo Shopping & Memories',
            location: 'Tokyo Station & Disney Resort area',
            description: 'Last-minute shopping and farewell to Japan',
            significance: 'Final opportunity for character goods and unique Japanese souvenirs',
            whatToDo: [
              'Visit Tokyo Station Character Street for Hello Kitty, Pokémon, Studio Ghibli goods',
              'Purchase final Japanese snacks and Kit Kat flavors for home',
              'Buy Tokyo Banana and other regional omiyage (souvenir) specialties',
              'Visit Ikspiari shopping complex for last-minute Disney goods',
              'Purchase unique Japanese Disney items not available elsewhere',
              'Organize luggage and souvenirs for international departure',
              'Take final photos around Tokyo Disney Resort area'
            ],
            whatToExpected: 'Final opportunity for character goods and unique Japanese souvenirs',
            cost: { yen: 3000, usd: 21.00 }
          },
          {
            type: 'transport',
            time: '1:00 PM - 5:25 PM',
            title: 'Departure Process',
            location: 'Tokyo Bay to Narita Airport',
            description: 'Journey to Narita Airport and international departure',
            whatToDo: [
              'Organize luggage and souvenirs for international departure',
              'Take Narita Express to Narita Airport (1 hour journey)',
              'Navigate departure procedures and duty-free shopping',
              'Board international flight NRT to SAN to CLT departing 5:25 PM'
            ],
            whatToExpected: 'Efficient Japanese airport service, final experience of Japanese hospitality, same-day arrival in CLT due to time zones',
            cost: { yen: 3200, usd: 22.40 }
          }
        ],
        totalCost: { yen: 6200, usd: 43.40 },
        costBreakdown: {
          shopping: { yen: 3000, usd: 21.00 },
          transport: { yen: 3200, usd: 22.40 }
        }
      }
    ];

    let currentDayIndex = 0;
    
    // Function to calculate the actual current day of the trip
    function getCurrentTripDay() {
      const tripStartDate = new Date('2025-07-14'); // July 14, 2025
      const tripEndDate = new Date('2025-07-26');   // July 26, 2025
      const today = new Date();
      
      // Reset time to compare dates only
      today.setHours(0, 0, 0, 0);
      tripStartDate.setHours(0, 0, 0, 0);
      tripEndDate.setHours(0, 0, 0, 0);
      
      // If before trip starts, show Day 1
      if (today < tripStartDate) {
        return 0;
      }
      
      // If after trip ends, show last day
      if (today > tripEndDate) {
        return tripDays.length - 1;
      }
      
      // Calculate days since trip start
      const daysSinceStart = Math.floor((today - tripStartDate) / (1000 * 60 * 60 * 24));
      return Math.min(daysSinceStart, tripDays.length - 1);
    }

    // Day navigation functions
    async function updateDayDisplay() {
      const currentDay = tripDays[currentDayIndex];
      const actualTodayIndex = getCurrentTripDay();
      
      // Update navigation bar
      document.getElementById('current-date').textContent = currentDay.date;
      
      // Show "TODAY" indicator if this is the actual current day
      const dayText = currentDayIndex === actualTodayIndex ? 
        `Day ${currentDayIndex + 1} of ${tripDays.length} • TODAY` : 
        `Day ${currentDayIndex + 1} of ${tripDays.length}`;
      document.getElementById('current-day').textContent = dayText;
      
      // Update navigation buttons
      document.getElementById('prev-day').disabled = currentDayIndex === 0;
      document.getElementById('next-day').disabled = currentDayIndex === tripDays.length - 1;
      
      // Update main content
      await updateMainContent(currentDay);
      
      // Update date picker if it's open
      const datePicker = document.getElementById('date-picker-tray');
      if (datePicker && datePicker.classList.contains('show')) {
        populateDateList();
      }
      
      addDebugLog(`📅 Switched to ${currentDay.title} in ${currentDay.city}`, 'info');
    }

    // Activity type styling
    const activityTypeStyles = {
      'transport': { bg: 'linear-gradient(135deg, #dcfce7, #bbf7d0)', border: '#86efac', icon: '🚆' },
      'cultural': { bg: 'linear-gradient(135deg, #ddd6fe, #e0e7ff)', border: '#c4b5fd', icon: '🏛️' },
      'activity': { bg: 'linear-gradient(135deg, #bfdbfe, #dbeafe)', border: '#93c5fd', icon: '🎯' },
      'dining': { bg: 'linear-gradient(135deg, #fed7d7, #fecaca)', border: '#fca5a5', icon: '🍜' },
      'nightlife': { bg: 'linear-gradient(135deg, #e7e5e4, #d6d3d1)', border: '#a8a29e', icon: '🍸' }
    };

    // Update the main content area
    async function updateMainContent(dayData) {
      const contentContainer = document.getElementById('day-content');
      
      // Create the complete day structure with placeholder weather
      contentContainer.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <span class="day-title">${dayData.title}</span>
          <span class="city-badge">${dayData.city}</span>
        </div>
        <div class="date-text">${dayData.date}, 2025</div>
        
        <div class="weather-warning" id="live-weather-display">
          <span>🌐</span>
          <span style="font-size: var(--base-text);">Loading current weather...</span>
        </div>
        
        <!-- Activity cards will be inserted here -->
        
        <!-- Daily Cost Summary -->
        <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-top: 24px;">
          <div style="font-weight: bold; font-size: var(--large-text); color: #1e40af; margin-bottom: 12px;">Daily Cost Summary</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="text-align: center;">
              <div style="font-size: var(--title-text); font-weight: bold; color: #2563eb;">¥${dayData.totalCost.yen.toLocaleString()}</div>
              <div style="font-size: var(--base-text); color: #3b82f6;">Japanese Yen</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: var(--title-text); font-weight: bold; color: #2563eb;">$${dayData.totalCost.usd.toFixed(2)}</div>
              <div style="font-size: var(--base-text); color: #3b82f6;">US Dollars</div>
            </div>
          </div>
        </div>
      `;
      
      // Load live weather data
      await updateLiveWeather(dayData.city);
      
      // Update activities (pass dayData.date as day ID for restaurant selection context)
      await updateActivities(dayData.activities, dayData.date);
      
      // Update header date in navigation
      const headerDate = document.getElementById('current-date');
      const dateParts = dayData.date.split(', ');
      headerDate.textContent = dateParts[0] + ', ' + dateParts[1];
    }
    
    async function updateLiveWeather(city) {
      try {
        console.log(`🌐 Starting weather update for: ${city}`);
        
        // Clear cache for debugging - force fresh API calls
        localStorage.clear();
        console.log(`🗑️ Cleared all cache for fresh API call`);
        
        // Calculate the date for the current trip day being viewed
        const today = new Date();
        const tripStart = new Date('2025-07-14');
        const tripEnd = new Date('2025-07-26');
        
        // Get the date for current trip day being viewed
        const viewingDate = new Date(tripStart);
        viewingDate.setDate(viewingDate.getDate() + currentDayIndex);
        const viewingDateStr = viewingDate.toISOString().split('T')[0];
        
        console.log(`📅 Viewing trip day ${currentDayIndex + 1} - Date: ${viewingDateStr}`);
        console.log(`📅 Today's date: ${today.toISOString().split('T')[0]}`);
        
        // Determine if we're viewing a future trip date
        const isCurrentTrip = today >= tripStart && today <= tripEnd;
        const isViewingTripDay = viewingDate >= tripStart && viewingDate <= tripEnd;
        const isViewingFutureTrip = viewingDate >= today && viewingDate <= tripEnd;
        const daysAhead = Math.floor((viewingDate - today) / (1000 * 60 * 60 * 24));
        
        // Check if viewing today specifically (using local timezone)
        const todayLocal = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const isViewingToday = viewingDateStr === todayLocal;
        
        // Additional debugging for date calculation
        console.log(`🕐 Full today object:`, today);
        console.log(`🕐 Today ISO string:`, today.toISOString());
        console.log(`🕐 Today local date string:`, today.toDateString());
        console.log(`🕐 Today getDate():`, today.getDate());
        console.log(`🕐 Today getMonth():`, today.getMonth() + 1);
        console.log(`🕐 Today getFullYear():`, today.getFullYear());
        
        console.log(`🔍 Trip status: ${isCurrentTrip ? 'During trip' : 'Outside trip period'}`);
        console.log(`🔍 Viewing trip day: ${isViewingTripDay} | Future trip day: ${isViewingFutureTrip} (${daysAhead} days ahead)`);
        console.log(`🔍 Is viewing today: ${isViewingToday} | Today local: '${todayLocal}' | Viewing string: '${viewingDateStr}'`);
        
        const weatherData = await getWeatherWithFallback(city);
        console.log(`📊 Weather data received for ${city}:`, weatherData);
        console.log(`🔍 Weather isStatic flag: ${weatherData?.isStatic}`);
        console.log(`🌡️ Live temp: ${weatherData?.main?.temp}°C (${celsiusToFahrenheit(weatherData?.main?.temp)}°F)`);
        
        // Try to get forecast data
        let targetForecast = null;
        let forecastPeriods = [];
        let forecastMode = 'current'; // 'current', 'forecast', 'historical'
        
        try {
          if (isViewingFutureTrip && daysAhead <= 5) {
            // Within 5-day forecast range
            const forecastData = await getFiveDayForecast(city);
            
            // Get all forecast periods for the viewing date
            forecastPeriods = forecastData.list.filter(item => {
              const itemDate = new Date(item.dt * 1000);
              return itemDate.toISOString().split('T')[0] === viewingDateStr;
            });
            
            // Parse daily summary
            const dailyForecasts = parseForecastData(forecastData, city);
            targetForecast = dailyForecasts.find(d => d.date === viewingDateStr);
            
            if (targetForecast) {
              forecastMode = 'forecast';
              console.log(`📅 Found forecast for ${viewingDateStr}:`, targetForecast);
            }
          } else if (daysAhead === 0) {
            // Today - show current weather + today's forecast
            const forecastData = await getFiveDayForecast(city);
            const todayStr = today.toISOString().split('T')[0];
            
            forecastPeriods = forecastData.list.filter(item => {
              const itemDate = new Date(item.dt * 1000);
              return itemDate.toISOString().split('T')[0] === todayStr;
            });
            
            const dailyForecasts = parseForecastData(forecastData, city);
            targetForecast = dailyForecasts.find(d => d.date === todayStr);
            forecastMode = 'current';
          }
          
          console.log(`🌤️ Forecast mode: ${forecastMode}`);
          console.log(`🕐 Forecast periods found: ${forecastPeriods.length}`);
        } catch (forecastError) {
          console.log('⚠️ Could not fetch forecast data:', forecastError);
        }
        
        const weatherDisplay = document.getElementById('live-weather-display');
        const recommendation = getWeatherRecommendation(weatherData);
        
        console.log(`🧪 Weather condition checks:`, {
          hasDisplay: !!weatherDisplay,
          hasData: !!weatherData,
          hasMain: !!(weatherData && weatherData.main),
          hasWeather: !!(weatherData && weatherData.weather),
          hasWeatherArray: !!(weatherData && weatherData.weather && weatherData.weather[0]),
          hasForecast: !!targetForecast,
          forecastMode: forecastMode,
          fullWeatherData: weatherData
        });
        
        if (weatherDisplay) {
          // Build the weather display based on the mode
          let weatherContent = '';
          
          if (isViewingTripDay && !targetForecast) {
            // Trip day without available forecast (beyond 5-day range or no data)
            const forecastDate = new Date(viewingDate);
            const dateStr = forecastDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            weatherContent = `
              <div>
                <div style="font-size: var(--small-text); font-weight: 600; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                  📅 Typical Weather for ${dateStr}
                </div>
                <div style="display: flex; align-items: start; gap: 8px;">
                  <span style="font-size: var(--medium-text); margin-top: 2px;">🌡️</span>
                  <div style="flex: 1;">
                    <div style="font-size: var(--base-text); font-weight: 600; margin-bottom: 4px;">
                      July in ${city}: 84-90°F
                    </div>
                    <div style="font-size: var(--small-text); opacity: 0.8; margin-bottom: 4px;">
                      Hot & humid with afternoon showers • 78-83% humidity
                    </div>
                    <div style="font-size: var(--small-text); font-weight: 500;">
                      💡 Pack light clothes, umbrella, and stay hydrated
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            weatherDisplay.style.background = '#fef3c7';
            weatherDisplay.style.borderColor = '#fbbf24';
            weatherDisplay.style.color = '#92400e';
            
          } else if (forecastMode === 'forecast' && targetForecast) {
            // Future trip day with forecast available
            const forecastDate = new Date(viewingDate);
            const dateStr = forecastDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            // Check for rain in forecast periods
            const rainPeriods = forecastPeriods.filter(p => 
              p.weather[0].main.toLowerCase().includes('rain') || 
              p.weather[0].main.toLowerCase().includes('drizzle')
            );
            
            const rainTimes = rainPeriods.map(p => {
              const time = new Date(p.dt * 1000);
              return time.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
            });
            
            weatherContent = `
              <div>
                <div style="font-size: var(--small-text); font-weight: 600; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                  📅 Forecast for ${dateStr}
                </div>
                <div style="display: flex; align-items: start; gap: 8px;">
                  <span style="font-size: var(--medium-text); margin-top: 2px;">${getWeatherIcon(targetForecast.weather)}</span>
                  <div style="flex: 1;">
                    <div style="font-size: var(--base-text); font-weight: 600; margin-bottom: 4px;">
                      High: ${celsiusToFahrenheit(targetForecast.high)}°F • Low: ${celsiusToFahrenheit(targetForecast.low)}°F
                    </div>
                    <div style="font-size: var(--small-text); opacity: 0.8; margin-bottom: 4px;">
                      ${targetForecast.weatherDescription} • ${targetForecast.avgHumidity}% humidity
                    </div>
                    ${rainPeriods.length > 0 ? 
                      `<div style="font-size: var(--small-text); margin-bottom: 4px;">🌧️ Rain expected: ${rainTimes.join(', ')}</div>` :
                      ''
                    }
                    <div style="font-size: var(--small-text); font-weight: 500;">
                      ${targetForecast.weather.toLowerCase().includes('clear') ? 
                        '☀️ Perfect weather for outdoor sightseeing!' :
                        targetForecast.weather.toLowerCase().includes('cloud') ?
                        '☁️ Comfortable conditions, no rain gear needed' :
                        targetForecast.weather.toLowerCase().includes('rain') ?
                        '☔ Pack umbrella, plan indoor alternatives' :
                        '🌤️ Check conditions before heading out'
                      }
                    </div>
                    ${(() => {
                      console.log(`🔍 Forecast mode - checking Currently condition: isViewingToday=${isViewingToday}, isCurrentTrip=${isCurrentTrip}`);
                      return isViewingToday && isCurrentTrip;
                    })() ? `
                      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); margin-left: -8px;">
                        <div style="font-size: var(--base-text); font-weight: 600; text-align: left;">
                          ${getWeatherIcon(weatherData.weather[0].main)} Currently: ${celsiusToFahrenheit(weatherData.main.temp)}°F • ${weatherData.weather[0].description}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            `;
            
            // Set appropriate background color
            if (targetForecast.weather.toLowerCase().includes('rain')) {
              weatherDisplay.style.background = '#f0f9ff';
              weatherDisplay.style.borderColor = '#38bdf8';
              weatherDisplay.style.color = '#0284c7';
            } else if (targetForecast.weather.toLowerCase().includes('clear')) {
              weatherDisplay.style.background = '#f0fdf4';
              weatherDisplay.style.borderColor = '#4ade80';
              weatherDisplay.style.color = '#16a34a';
            } else {
              weatherDisplay.style.background = '#fef3c7';
              weatherDisplay.style.borderColor = '#fbbf24';
              weatherDisplay.style.color = '#92400e';
            }
            
          } else if (weatherData && weatherData.main && weatherData.weather && weatherData.weather[0]) {
            // Current weather (today or post-trip)
            let forecastDetails = '';
            
            if (targetForecast && forecastPeriods.length > 0 && daysAhead === 0) {
              // Add today's forecast details
              const rainPeriods = forecastPeriods.filter(p => 
                p.weather[0].main.toLowerCase().includes('rain') || 
                p.weather[0].main.toLowerCase().includes('drizzle')
              );
              
              const rainTimes = rainPeriods.map(p => {
                const time = new Date(p.dt * 1000);
                return time.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
              });
              
              forecastDetails = `
                <div style="font-size: var(--small-text); margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                  <div style="font-weight: 600; margin-bottom: 4px;">📊 Today's Outlook</div>
                  <div style="display: grid; gap: 4px;">
                    <div>High: ${celsiusToFahrenheit(targetForecast.high)}°F • Low: ${celsiusToFahrenheit(targetForecast.low)}°F</div>
                    ${rainPeriods.length > 0 ? 
                      `<div>🌧️ Rain expected: ${rainTimes.join(', ')}</div>` :
                      `<div>${getWeatherIcon(targetForecast.weather)} ${targetForecast.weatherDescription} all day</div>`
                    }
                    ${targetForecast.weather.toLowerCase().includes('clear') ? 
                      '<div>☀️ Perfect day for outdoor activities!</div>' :
                      targetForecast.weather.toLowerCase().includes('cloud') ?
                      '<div>☁️ Comfortable for walking, no rain gear needed</div>' :
                      targetForecast.weather.toLowerCase().includes('rain') ?
                      '<div>☔ Bring umbrella, indoor backup plans recommended</div>' :
                      ''
                    }
                  </div>
                </div>
              `;
            }
            
            weatherContent = `
              <div>
                <div style="font-size: var(--small-text); font-weight: 600; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                  📡 ${isCurrentTrip && daysAhead === 0 ? 'Live Weather & Today\'s Forecast' : 'Current Weather'}
                </div>
                <div style="display: flex; align-items: start; gap: 8px;">
                  <span style="font-size: var(--medium-text); margin-top: 2px;">${getWeatherIcon(weatherData.weather[0].main)}</span>
                  <div style="flex: 1;">
                    <div style="font-size: var(--base-text); font-weight: 600; margin-bottom: 4px;">
                      ${celsiusToFahrenheit(weatherData.main.temp)}°F (feels like ${celsiusToFahrenheit(weatherData.main.feels_like)}°F)
                      ${weatherData.isStatic ? ' (estimated)' : ''}
                    </div>
                    <div style="font-size: var(--small-text); opacity: 0.8; margin-bottom: 8px;">
                      ${weatherData.weather[0].description} • ${weatherData.main.humidity}% humidity
                    </div>
                    <div style="display: flex; align-items: start; gap: 6px; font-size: var(--small-text);">
                      <span style="margin-top: 1px;">${recommendation.icon}</span>
                      <span>${recommendation.message}</span>
                    </div>
                    ${forecastDetails}
                    ${isViewingToday && isCurrentTrip ? `
                      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); margin-left: -8px;">
                        <div style="font-size: var(--base-text); font-weight: 600; text-align: left;">
                          ${getWeatherIcon(weatherData.weather[0].main)} Currently: ${celsiusToFahrenheit(weatherData.main.temp)}°F • ${weatherData.weather[0].description}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            `;
            
            // Update weather warning background color based on conditions
            if (recommendation.type === 'storm') {
              weatherDisplay.style.background = '#fef2f2';
              weatherDisplay.style.borderColor = '#f87171';
              weatherDisplay.style.color = '#dc2626';
            } else if (recommendation.type === 'rain') {
              weatherDisplay.style.background = '#f0f9ff';
              weatherDisplay.style.borderColor = '#38bdf8';
              weatherDisplay.style.color = '#0284c7';
            } else if (recommendation.type === 'heat') {
              weatherDisplay.style.background = '#fed7aa';
              weatherDisplay.style.borderColor = '#fb923c';
              weatherDisplay.style.color = '#ea580c';
            } else if (recommendation.type === 'warm') {
              weatherDisplay.style.background = '#fef3c7';
              weatherDisplay.style.borderColor = '#fbbf24';
              weatherDisplay.style.color = '#92400e';
            } else {
              weatherDisplay.style.background = '#f0fdf4';
              weatherDisplay.style.borderColor = '#4ade80';
              weatherDisplay.style.color = '#16a34a';
            }
          } else {
            // Fallback
            weatherContent = `
              <div>
                <div style="font-size: var(--small-text); font-weight: 600; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                  📡 Weather
                </div>
                <div style="display: flex; align-items: start; gap: 8px;">
                  <span style="font-size: var(--medium-text); margin-top: 2px;">🌤️</span>
                  <div style="flex: 1;">
                    <div style="font-size: var(--base-text); font-weight: 600; margin-bottom: 4px;">
                      Hot & humid (84-90°F) - estimated
                    </div>
                    <div style="font-size: var(--small-text); opacity: 0.8;">
                      Typical July weather for Japan
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          
          weatherDisplay.innerHTML = weatherContent;
        }
      } catch (error) {
        console.error('Failed to update live weather:', error);
        const weatherDisplay = document.getElementById('live-weather-display');
        if (weatherDisplay) {
          weatherDisplay.innerHTML = `
            <span>⚠️</span>
            <span style="font-size: var(--base-text);">Hot & humid (84-90°F with 78-83% humidity) - estimated</span>
          `;
        }
      }
    }

    async function updateActivities(activities, dayId) {
      // Find the activities container 
      const content = document.getElementById('day-content');
      
      // Remove existing activity cards
      const existingCards = content.querySelectorAll('.activity-card');
      existingCards.forEach(card => card.remove());
      
      // Find insertion point (after weather warning)
      let insertionPoint = content.querySelector('.weather-warning');
      
      // Test if we have activities
      addDebugLog(`📊 Found ${activities.length} activities for day`, 'info');
      
      if (activities.length === 0) {
        addDebugLog(`⚠️ No activities found for current day`, 'warning');
        insertionPoint.insertAdjacentHTML('afterend', '<div style="padding: 20px; text-align: center; color: #666;">No activities found for this day</div>');
        return;
      }

      // Create new activity cards in chronological order
      for (let i = 0; i < activities.length; i++) {
        const activity = activities[i]; // Define activity outside try block
        try {
          addDebugLog(`🎯 Rendering activity ${i+1}/${activities.length}: ${activity.title}`, 'info');
          
          // Test basic activity structure
          if (!activity.title) {
            addDebugLog(`⚠️ Activity ${i+1} missing title`, 'warning');
          }
          if (!activity.type) {
            addDebugLog(`⚠️ Activity ${i+1} missing type`, 'warning');
          }
          
          const activityCard = await createActivityCard(activity, dayId);
          insertionPoint.insertAdjacentHTML('afterend', activityCard);
          insertionPoint = insertionPoint.nextElementSibling;
          addDebugLog(`✅ Activity rendered: ${activity.title}`, 'success');
        } catch (error) {
          addDebugLog(`❌ Failed to render activity ${i+1}: ${error.message}`, 'error');
          console.error('Activity rendering error:', error);
          
          // Insert error card so we can see which activity failed
          const errorCard = `
            <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="color: #dc2626; font-weight: 600;">Error loading activity ${i+1}</div>
              <div style="font-size: 12px; color: #7f1d1d; margin-top: 4px;">Title: ${activity.title || 'Unknown'}</div>
              <div style="font-size: 12px; color: #7f1d1d;">Error: ${error.message}</div>
            </div>
          `;
          insertionPoint.insertAdjacentHTML('afterend', errorCard);
          insertionPoint = insertionPoint.nextElementSibling;
        }
        
        // Add transit card between activities if locations differ
        if (i < activities.length - 1) {
          const nextActivity = activities[i + 1];
          if (shouldShowTransitBetween(activity, nextActivity)) {
            const transitCard = await createTransitBetweenActivities(activity, nextActivity);
            insertionPoint.insertAdjacentHTML('afterend', transitCard);
            insertionPoint = insertionPoint.nextElementSibling;
          }
        }
      }
    }
    
    function shouldShowTransitBetween(currentActivity, nextActivity) {
      // Don't show transit for transport activities (they already have transit info)
      if (currentActivity.type === 'transport' || nextActivity.type === 'transport') {
        return false;
      }
      
      // Don't show if activities are in the same location
      if (currentActivity.location === nextActivity.location) {
        return false;
      }
      
      // Don't show if locations are very similar (same area)
      const currentLoc = (currentActivity.location || '').toLowerCase();
      const nextLoc = (nextActivity.location || '').toLowerCase();
      
      if (currentLoc.includes('shibuya') && nextLoc.includes('shibuya')) {
        return false;
      }
      
      return true;
    }
    
    async function createTransitBetweenActivities(fromActivity, toActivity) {
      const fromLocation = getLocationForTransit(fromActivity.location);
      const toLocation = getLocationForTransit(toActivity.location);
      
      try {
        const transitOptions = await getTransitWithFallback(fromLocation, toLocation);
        
        return `
          <div class="activity-card" style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-color: #94a3b8; border-style: dashed;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 8px;">
                <span style="font-size: 18px;">🚶‍➡️</span>
              </div>
              <div>
                <div style="font-weight: 600; font-size: var(--base-text);">Getting There</div>
                <div style="font-size: var(--small-text); opacity: 0.7;">${fromActivity.location} to ${toActivity.location}</div>
              </div>
            </div>
            ${createMultiModalDisplay(transitOptions, true)}
          </div>
        `;
      } catch (error) {
        return `
          <div class="activity-card" style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-color: #94a3b8; border-style: dashed;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 8px;">
                <span style="font-size: 18px;">🚶‍➡️</span>
              </div>
              <div>
                <div style="font-weight: 600; font-size: var(--base-text);">Getting There</div>
                <div style="font-size: var(--small-text); opacity: 0.7;">${fromActivity.location} to ${toActivity.location}</div>
                <div style="font-size: var(--small-text); margin-top: 4px;">Check local transit options</div>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function getLocationForTransit(location) {
      // Convert activity locations to transit-friendly addresses
      const locationMap = {
        // Tokyo neighborhoods and stations
        'Shibuya': 'Shibuya Station, Tokyo, Japan',
        'Shibuya area': 'Shibuya Station, Tokyo, Japan',
        'Shibuya/Ginza area': 'Ginza Station, Tokyo, Japan',
        'Meiji Shrine to Harajuku': 'Meiji-jingu-mae Station, Tokyo, Japan',
        'Harajuku': 'Harajuku Station, Tokyo, Japan',
        'Shinjuku': 'Shinjuku Station, Tokyo, Japan',
        'Ginza': 'Ginza Station, Tokyo, Japan',
        'Asakusa': 'Asakusa Station, Tokyo, Japan',
        'Ueno': 'Ueno Station, Tokyo, Japan',
        'Akihabara': 'Akihabara Station, Tokyo, Japan',
        'Tokyo Station': 'Tokyo Station, Tokyo, Japan',
        'Tsukiji': 'Tsukiji Market, Tokyo, Japan',
        
        // Hotels and specific venues
        'Hyatt House Shibuya': 'Shibuya Station, Tokyo, Japan',
        'Hyatt Place Kyoto': 'Kyoto Station, Kyoto, Japan',
        'Caption by Hyatt Namba': 'Namba Station, Osaka, Japan',
        
        // Kyoto locations
        'Kyoto Station': 'Kyoto Station, Kyoto, Japan',
        'Gion District': 'Gion-Shijo Station, Kyoto, Japan',
        'Fushimi': 'Fushimi-Inari Station, Kyoto, Japan',
        'Arashiyama': 'Arashiyama Station, Kyoto, Japan',
        
        // Osaka locations
        'Osaka Station': 'Osaka Station, Osaka, Japan',
        'Namba': 'Namba Station, Osaka, Japan',
        'Namba Station': 'Namba Station, Osaka, Japan',
        'Dotonbori': 'Namba Station, Osaka, Japan',
        'Dotonbori area': 'Namba Station, Osaka, Japan',
        'Shinsekai': 'Shinsekai, Osaka, Japan',
        
        // Airports
        'Haneda Airport': 'Haneda Airport, Tokyo, Japan',
        'Itami Airport': 'Itami Airport, Osaka, Japan',
        'Narita Airport': 'Narita Airport, Tokyo, Japan'
      };
      
      // Direct mapping first
      if (locationMap[location]) {
        return locationMap[location];
      }
      
      // Smart partial matching for neighborhoods
      const loc = location.toLowerCase();
      
      // Tokyo neighborhoods
      if (loc.includes('shibuya')) return 'Shibuya Station, Tokyo, Japan';
      if (loc.includes('harajuku')) return 'Harajuku Station, Tokyo, Japan';
      if (loc.includes('shinjuku')) return 'Shinjuku Station, Tokyo, Japan';
      if (loc.includes('ginza')) return 'Ginza Station, Tokyo, Japan';
      if (loc.includes('asakusa')) return 'Asakusa Station, Tokyo, Japan';
      if (loc.includes('ueno')) return 'Ueno Station, Tokyo, Japan';
      if (loc.includes('akihabara')) return 'Akihabara Station, Tokyo, Japan';
      if (loc.includes('tokyo')) return 'Tokyo Station, Tokyo, Japan';
      if (loc.includes('tsukiji')) return 'Tsukiji Market, Tokyo, Japan';
      
      // Kyoto neighborhoods
      if (loc.includes('kyoto')) return 'Kyoto Station, Kyoto, Japan';
      if (loc.includes('gion')) return 'Gion-Shijo Station, Kyoto, Japan';
      if (loc.includes('fushimi')) return 'Fushimi-Inari Station, Kyoto, Japan';
      if (loc.includes('arashiyama')) return 'Arashiyama Station, Kyoto, Japan';
      
      // Osaka neighborhoods
      if (loc.includes('osaka')) return 'Osaka Station, Osaka, Japan';
      if (loc.includes('namba')) return 'Namba Station, Osaka, Japan';
      if (loc.includes('dotonbori')) return 'Namba Station, Osaka, Japan';
      if (loc.includes('shinsekai')) return 'Shinsekai, Osaka, Japan';
      
      // Default fallback
      return `${location}, Tokyo, Japan`;
    }

    async function createActivityCard(activity, dayId = null) {
      try {
        addDebugLog(`🏗️ Creating activity card for: ${activity.title}`, 'info');
        const style = activityTypeStyles[activity.type] || activityTypeStyles.cultural;
        const costDisplay = activity.cost.yen > 0 ? 
        `<div class="activity-cost">
          <div class="cost-yen">¥${activity.cost.yen.toLocaleString()}</div>
          <div class="cost-usd">$${activity.cost.usd.toFixed(2)}</div>
        </div>` : 
        `<div class="activity-cost">
          <div class="cost-yen">Free</div>
        </div>`;

      const significanceSection = activity.significance ? 
        `<div class="significance-box">
          <div class="significance-title">Why This Matters:</div>
          <div style="font-size: var(--base-text);">${activity.significance}</div>
        </div>` : '';

      const whatToDoSection = activity.whatToDo ? 
        `<div style="margin: 12px 0;">
          <h4 style="font-weight: 500; font-size: var(--base-text); margin-bottom: 8px;">What to Do:</h4>
          <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text);">
            ${activity.whatToDo.map(item => {
              // Strategic emoji mapping for key actions
              let emoji = "•";
              const itemLower = item.toLowerCase();
              
              if (itemLower.includes("walk") || itemLower.includes("stroll")) emoji = "🚶";
              else if (itemLower.includes("take photo") || itemLower.includes("photos")) emoji = "📸";
              else if (itemLower.includes("train") || itemLower.includes("subway") || itemLower.includes("metro")) emoji = "🚆";
              else if (itemLower.includes("taxi") || itemLower.includes("bus")) emoji = "🚌";
              else if (itemLower.includes("food") || itemLower.includes("eat") || itemLower.includes("try") || itemLower.includes("sample")) emoji = "🍜";
              else if (itemLower.includes("temple") || itemLower.includes("shrine") || itemLower.includes("pray")) emoji = "⛩️";
              else if (itemLower.includes("bow") || itemLower.includes("purify")) emoji = "🙏";
              else if (itemLower.includes("view") || itemLower.includes("see") || itemLower.includes("watch")) emoji = "👀";
              else if (itemLower.includes("shop") || itemLower.includes("buy") || itemLower.includes("browse")) emoji = "🛍️";
              else if (itemLower.includes("experience") || itemLower.includes("enjoy")) emoji = "✨";
              else if (itemLower.includes("exit") || itemLower.includes("entrance")) emoji = "🚪";
              else if (itemLower.includes("transfer") || itemLower.includes("change")) emoji = "🔄";
              
              return `<li style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: var(--base-text); margin-top: 2px;">${emoji}</span>
                <span style="font-size: var(--base-text);">${item}</span>
              </li>`;
            }).join('')}
          </ul>
        </div>` : '';

      const whatToExpectSection = activity.whatToExpect ? 
        `<div class="significance-box">
          <div class="significance-title">What to Expect:</div>
          <div style="font-size: var(--base-text);">${activity.whatToExpect}</div>
        </div>` : '';

      const culturalEtiquetteSection = activity.culturalEtiquette ? 
        `<div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <div style="display: flex; align-items: start; gap: 8px;">
            <span style="color: #92400e; margin-top: 2px;">🙏</span>
            <div>
              <div style="font-weight: 500; font-size: var(--base-text); margin-bottom: 4px; color: #92400e;">Cultural Etiquette:</div>
              <div style="font-size: var(--base-text); color: #92400e;">${activity.culturalEtiquette}</div>
            </div>
          </div>
        </div>` : '';

      const festivalSection = activity.festivalHighlights ? 
        `<div style="background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <div style="display: flex; align-items: start; gap: 8px;">
            <span style="color: #a16207; margin-top: 2px;">🎌</span>
            <div>
              <div style="font-weight: 500; font-size: var(--base-text); margin-bottom: 4px; color: #a16207;">Festival Highlights:</div>
              <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #92400e;">
                ${activity.festivalHighlights.map(highlight => `<li style="margin-bottom: 2px; font-size: var(--base-text);">${highlight}</li>`).join('')}
              </ul>
            </div>
          </div>
        </div>` : '';

      const selfGuidedTourSection = activity.selfGuidedTour ? 
        `<div style="background: #f0f4f8; border: 1px solid #64748b; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="toggleSelfGuidedTour(this)">
            <span style="color: #475569; font-size: 18px;">🗺️</span>
            <div style="font-weight: 600; font-size: var(--base-text); color: #475569;">${activity.selfGuidedTour.title}</div>
            <span style="color: #475569; margin-left: auto; transition: transform 0.3s ease;" id="tour-arrow">▼</span>
          </div>
          <div style="display: none; margin-top: 12px; border-top: 1px solid #e2e8f0; padding-top: 12px;" id="tour-content">
            ${activity.selfGuidedTour.content}
          </div>
        </div>` : '';

      const restaurantsSection = activity.restaurants ? 
        `<div style="margin-top: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: var(--medium-text);">🍜</span>
            <h4 style="font-weight: 500; font-size: var(--base-text); margin: 0;">Restaurant Options (${activity.restaurants.length}):</h4>
          </div>
          <div style="space-y: 8px;">
            ${activity.restaurants.map((restaurant, idx) => {
              return `
              <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div style="flex: 1;">
                    ${LOCATION_DATABASE[restaurant.name] ? createMapLink(restaurant.name) : `<h5 style="font-weight: 500; font-size: var(--base-text); margin: 0;">${restaurant.name}</h5>`}
                  </div>
                  <span style="font-size: var(--small-text); font-weight: 500; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 4px; margin-left: 8px;">
                    ${restaurant.cost}
                  </span>
                </div>
                <p style="font-size: var(--base-text); margin: 0 0 8px 0;">${restaurant.description}</p>
                ${restaurant.whyRecommended ? `
                  <p style="font-size: var(--small-text); color: #059669; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 4px; margin: 4px 0;">
                    <strong>Why recommended:</strong> ${restaurant.whyRecommended}
                  </p>
                ` : ''}
                ${restaurant.whatToExpect ? `
                  <p style="font-size: var(--small-text); color: #1d4ed8; background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 4px; margin: 4px 0;">
                    <strong>What to expect:</strong> ${restaurant.whatToExpect}
                  </p>
                ` : ''}
              </div>
            `;
            }).join('')}
          </div>
        </div>` : '';

      // Transit integration for transport activities
      let transitSection = '';
      if (activity.type === 'transport' && activity.route) {
        try {
          const transitData = await getTransitWithFallback(activity.route.origin, activity.route.destination);
          transitSection = `
            <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; margin-top: 12px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: var(--medium-text);">🚆</span>
                <h4 style="font-weight: 600; font-size: var(--base-text); margin: 0;">Live Transit Info</h4>
              </div>
              ${createMultiModalDisplay(transitData, true)}
            </div>
          `;
        } catch (error) {
          transitSection = `
            <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; margin-top: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: var(--medium-text);">🚆</span>
                <span style="font-size: var(--base-text);">📅 Scheduled • Check local timetables</span>
              </div>
            </div>
          `;
        }
      }

      return `
        <div class="activity-card" data-activity-id="${activity.id || `${activity.type}_${activity.time.replace(/[^a-zA-Z0-9]/g, '_')}`}" style="background: ${style.bg}; border-color: ${style.border};">
          <div class="activity-header">
            <div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 8px;">
                  <span style="font-size: 18px;">${style.icon}</span>
                </div>
                <div>
                  <div class="activity-type">${activity.type}</div>
                  <div class="activity-time">🕐 ${activity.time}</div>
                </div>
              </div>
            </div>
            ${costDisplay}
          </div>
          <div class="activity-title">${activity.title}</div>
          <div class="activity-location">${LOCATION_DATABASE[activity.location] ? createMapLink(activity.location) : `📍 ${activity.location}`}</div>
          <div class="activity-description">${activity.description}</div>
          ${significanceSection}
          ${whatToDoSection}
          ${whatToExpectSection}
          ${culturalEtiquetteSection}
          ${festivalSection}
          ${selfGuidedTourSection}
          ${restaurantsSection}
          ${transitSection}
        </div>
      `;
      } catch (error) {
        addDebugLog(`❌ Error creating activity card: ${error.message}`, 'error');
        console.error('createActivityCard error:', error);
        // Return a simple fallback card
        return `
          <div class="activity-card" style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="color: #dc2626; font-weight: 600;">Error loading activity: ${activity.title || 'Unknown'}</div>
            <div style="font-size: var(--small-text); color: #7f1d1d; margin-top: 4px;">Check console for details</div>
          </div>
        `;
      }
    }

    function updateCostSummary(totalCost) {
      const costSummary = document.querySelector('.content > div > div:last-child');
      const yenElement = costSummary.querySelector('div[style*="font-size: 24px"]:first-of-type');
      const usdElement = costSummary.querySelector('div[style*="font-size: 24px"]:last-of-type');
      
      yenElement.textContent = `¥${totalCost.yen.toLocaleString()}`;
      usdElement.textContent = `$${totalCost.usd.toFixed(2)}`;
    }

    async function previousDay() {
      if (currentDayIndex > 0) {
        currentDayIndex--;
        await updateDayDisplay();
      }
    }

    async function nextDay() {
      if (currentDayIndex < tripDays.length - 1) {
        currentDayIndex++;
        await updateDayDisplay();
      }
    }
    
    // Function for "Today" button - navigates to actual current day
    async function goToToday() {
      const todayIndex = getCurrentTripDay();
      if (todayIndex !== currentDayIndex) {
        currentDayIndex = todayIndex;
        await updateDayDisplay();
        addDebugLog(`📅 Navigated to actual trip day ${todayIndex + 1}`, 'info');
      } else {
        addDebugLog(`📅 Already viewing current trip day ${todayIndex + 1}`, 'info');
      }
    }
    
    // Date Picker Tray Functions
    function toggleDatePicker() {
      const tray = document.getElementById('date-picker-tray');
      const isShowing = tray.classList.contains('show');
      
      if (isShowing) {
        closeDatePicker();
      } else {
        openDatePicker();
      }
    }
    
    function openDatePicker() {
      const tray = document.getElementById('date-picker-tray');
      populateDateList();
      tray.classList.add('show');
      addDebugLog('📅 Date picker opened', 'info');
    }
    
    function closeDatePicker() {
      const tray = document.getElementById('date-picker-tray');
      tray.classList.remove('show');
      addDebugLog('📅 Date picker closed', 'info');
    }
    
    function populateDateList() {
      const dateList = document.getElementById('date-list');
      const actualTodayIndex = getCurrentTripDay();
      
      dateList.innerHTML = '';
      
      tripDays.forEach((day, index) => {
        const isCurrentDay = index === currentDayIndex;
        const isActualToday = index === actualTodayIndex;
        
        let classes = 'date-item';
        if (isCurrentDay) classes += ' current';
        if (isActualToday) classes += ' today';
        
        const dateItem = document.createElement('button');
        dateItem.className = classes;
        dateItem.onclick = () => selectDate(index);
        
        dateItem.innerHTML = `
          <div class="date-number">${index + 1}</div>
          <div class="date-details">
            <div class="date-title">${day.date}</div>
            <div class="date-subtitle">${day.title}</div>
            <div class="date-city">${day.city}</div>
          </div>
          ${isActualToday ? '<div style="color: #f59e0b; font-weight: 600; font-size: 12px;">TODAY</div>' : ''}
        `;
        
        dateList.appendChild(dateItem);
      });
    }
    
    async function selectDate(dayIndex) {
      currentDayIndex = dayIndex;
      await updateDayDisplay();
      closeDatePicker();
      addDebugLog(`📅 Selected day ${dayIndex + 1}`, 'info');
    }
    
    // Version History Functions
    window.showVersionHistory = function() {
      addDebugLog('🔍 showVersionHistory function called!', 'info');
      console.log('showVersionHistory function called');
      const modal = document.getElementById('version-modal');
      if (modal) {
        addDebugLog('✅ Modal element found', 'success');
        populateVersionHistory();
        modal.classList.add('show');
        addDebugLog('📋 Version history opened', 'info');
      } else {
        addDebugLog('❌ Modal element not found!', 'error');
      }
    };
    
    window.closeVersionHistory = function() {
      const modal = document.getElementById('version-modal');
      modal.classList.remove('show');
      addDebugLog('📋 Version history closed', 'info');
    };
    
    // Test function to verify modal works
    window.testVersionModal = function() {
      addDebugLog('🧪 Testing version modal directly', 'info');
      console.log('Testing version modal');
      showVersionHistory();
    };
    
    function populateVersionHistory() {
      const versionList = document.getElementById('version-history-list');
      
      versionList.innerHTML = VERSION_HISTORY.map(version => `
        <div class="version-item">
          <div class="version-number">${version.version}</div>
          <div class="version-date">Released: ${version.date}</div>
          <ul class="version-changes">
            ${version.changes.map(change => `
              <li class="${change.type}">
                <span class="change-type">${getChangeIcon(change.type)}</span>
                <span>${change.text}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `).join('');
    }
    
    function getChangeIcon(type) {
      switch(type) {
        case 'added': return '✅';
        case 'improved': return '🔧';
        case 'fixed': return '🐛';
        default: return '•';
      }
    }

    // Text size controls functionality
    function toggleTextControls() {
      const controls = document.getElementById('text-controls');
      controls.classList.toggle('show');
      addDebugLog(`📝 Text controls ${controls.classList.contains('show') ? 'opened' : 'closed'}`, 'info');
    }

    // Self-guided tour toggle functionality
    function toggleSelfGuidedTour(headerElement) {
      const tourContent = headerElement.nextElementSibling;
      const arrow = headerElement.querySelector('#tour-arrow');
      
      if (tourContent.style.display === 'none') {
        tourContent.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        addDebugLog('🗺️ Self-guided tour opened', 'info');
      } else {
        tourContent.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
        addDebugLog('🗺️ Self-guided tour closed', 'info');
      }
    }
    
    // Close text controls when clicking outside
    document.addEventListener('click', function(e) {
      const controls = document.getElementById('text-controls');
      const toggle = document.getElementById('text-toggle');
      
      if (!controls.contains(e.target) && e.target !== toggle) {
        controls.classList.remove('show');
      }
      
      // Close date picker when clicking outside
      const datePicker = document.getElementById('date-picker-tray');
      const dayNavCenter = document.querySelector('.day-nav-center');
      
      if (datePicker && dayNavCenter && !datePicker.contains(e.target) && !dayNavCenter.contains(e.target)) {
        closeDatePicker();
      }
      
      // Close version history modal when clicking outside
      const versionModal = document.getElementById('version-modal');
      const versionContent = document.querySelector('.version-content');
      
      if (versionModal && versionContent && versionModal.classList.contains('show') && 
          !versionContent.contains(e.target)) {
        closeVersionHistory();
      }
    });
    
    // Text size adjustment functionality
    function setTextSize(size) {
      // Set data attribute on document root for CSS variables
      document.documentElement.setAttribute('data-text-size', size);
      
      // Update button states
      document.querySelectorAll('.text-size-option').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`text-${size}`).classList.add('active');
      
      // Save preference to localStorage
      localStorage.setItem('japan-app-text-size', size);
      
      // Close the controls menu
      document.getElementById('text-controls').classList.remove('show');
      
      // Text size change confirmation
      setTimeout(() => {
        const scale = getComputedStyle(document.documentElement).getPropertyValue('--text-scale').trim();
        addDebugLog(`📝 Text size changed to ${size} (scale: ${scale})`, 'info');
      }, 100);
    }
    
    // Load saved text size preference
    function loadTextSizePreference() {
      const savedSize = localStorage.getItem('japan-app-text-size');
      if (savedSize && ['small', 'medium', 'large', 'xlarge'].includes(savedSize)) {
        setTextSize(savedSize);
      } else {
        // Set default if no preference saved
        setTextSize('medium');
      }
    }
    
    // Text size preference will be loaded in the main DOMContentLoaded listener
    
    // Text size preference is loaded in the main DOMContentLoaded listener
    
    // View switching functionality - make sure it's globally available
    window.showView = function(viewName) {
      addDebugLog(`🔄 Attempting to switch to ${viewName} view`, 'info');
      
      // Hide all views
      document.getElementById('today-view').classList.add('hidden');
      document.getElementById('overview-view').classList.add('hidden');
      document.getElementById('budget-view').classList.add('hidden');
      document.getElementById('forecast-view').classList.add('hidden');
      
      // Show selected view
      const targetView = document.getElementById(`${viewName}-view`);
      if (targetView) {
        targetView.classList.remove('hidden');
        addDebugLog(`✅ ${viewName} view is now visible`, 'success');
      } else {
        addDebugLog(`❌ Could not find ${viewName}-view element`, 'error');
      }
      
      // Update navigation states
      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeButton = document.getElementById(`nav-${viewName}`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
      
      // Hide/show day navigation based on view
      const dayNav = document.querySelector('.day-nav');
      if (viewName === 'today') {
        dayNav.style.display = 'flex';
        // When switching to Today view, navigate to actual current day
        goToToday();
      } else {
        dayNav.style.display = 'none';
      }
      
      // Load content for the view
      if (viewName === 'overview') {
        if (document.getElementById('overview-view').children.length === 0) {
          addDebugLog(`📋 Loading overview content`, 'info');
          loadOverviewContent();
        } else {
          // Re-attach version tile event listener if content already exists
          addDebugLog(`📋 Re-attaching version tile listener`, 'info');
          const versionTile = document.getElementById('version-tile');
          if (versionTile) {
            addDebugLog('✅ Version tile found, re-adding event handlers', 'success');
            
            // Function to handle the version tile interaction
            function handleVersionTileClick(event) {
              event.preventDefault();
              event.stopPropagation();
              addDebugLog('🔍 Version tile interacted! (re-attached)', 'info');
              console.log('Version tile interacted (re-attached), calling showVersionHistory()');
              
              // Add immediate visual feedback
              versionTile.style.transform = 'scale(0.95)';
              versionTile.style.background = 'linear-gradient(135deg, #e2e8f0, #cbd5e1)';
              
              setTimeout(() => {
                versionTile.style.transform = 'scale(1)';
                versionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
                showVersionHistory();
              }, 100);
            }
            
            // Remove any existing listeners and add new ones
            versionTile.replaceWith(versionTile.cloneNode(true));
            const newVersionTile = document.getElementById('version-tile');
            
            newVersionTile.addEventListener('click', handleVersionTileClick);
            newVersionTile.addEventListener('touchend', handleVersionTileClick);
            
            // Add visual feedback for touch start
            newVersionTile.addEventListener('touchstart', function(event) {
              addDebugLog('👆 Version tile touch started (re-attached)', 'info');
              newVersionTile.style.transform = 'scale(0.98)';
              newVersionTile.style.background = 'linear-gradient(135deg, #e0e7ff, #c7d2fe)';
            });
            
            // Reset visual feedback if touch is cancelled
            newVersionTile.addEventListener('touchcancel', function(event) {
              newVersionTile.style.transform = 'scale(1)';
              newVersionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
            });
            
          } else {
            addDebugLog('❌ Version tile not found on re-attach!', 'error');
          }
          
          // Reload weather advisory
          loadOverviewWeatherAdvisory();
        }
      }
      if (viewName === 'budget' && document.getElementById('budget-view').children.length === 0) {
        addDebugLog(`💰 Loading budget content`, 'info');
        loadBudgetContent();
      }
      if (viewName === 'forecast' && document.getElementById('forecast-view').children.length === 0) {
        addDebugLog(`🌤️ Loading forecast content`, 'info');
        loadForecastContent();
      }
      
      addDebugLog(`📱 Switched to ${viewName} view`, 'info');
    };
    
    // Load Overview content
    function loadOverviewContent() {
      const overviewView = document.getElementById('overview-view');
      overviewView.innerHTML = `
        <div>
          <h2 style="font-size: var(--title-text); font-weight: bold; color: #1f2937; margin-bottom: 16px;">
            🇯🇵 Trip Overview
          </h2>
          
          <!-- Weather Advisory Section -->
          <div id="overview-weather-advisory" style="margin-bottom: 16px;">
            <!-- Weather advisory will be populated here -->
          </div>
          
          <!-- Trip Summary -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #1e40af; margin-bottom: 12px;">📅 July 12-26, 2025 (13 Days)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: var(--base-text); margin-bottom: 12px;">
              <div><strong>🏨 Tokyo:</strong> 7 days</div>
              <div><strong>🏮 Kyoto:</strong> 5 days</div>
              <div><strong>🍜 Osaka:</strong> Day trip</div>
              <div><strong>🦌 Nara:</strong> Day trip</div>
            </div>
            <div style="text-align: center; font-size: var(--base-text);">
              <strong>💰 Total Budget:</strong> ¥168,210 ($1,177.47)
            </div>
          </div>
          
          <!-- Flight & Hotel Information -->
          <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #0ea5e9; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #0c4a6e; margin-bottom: 12px;">✈️ Travel Details</h3>
            <div style="font-size: var(--base-text); color: #0c4a6e; line-height: 1.5;">
              <div style="margin-bottom: 8px;"><strong>Outbound:</strong> CLT to ORD to HND (July 12-14)</div>
              <div style="margin-bottom: 12px;"><strong>Return:</strong> NRT to SAN to CLT (July 26)</div>
              <div style="border-top: 1px solid #0ea5e9; padding-top: 8px;">
                <div><strong>🏨 Hotels:</strong></div>
                <div style="font-size: var(--small-text); margin-left: 8px;">
                  • Hyatt House Shibuya (July 14-19)<br>
                  • Hyatt Place Kyoto (July 19-24)<br>
                  • Hyatt Regency Tokyo Bay (July 24-26)
                </div>
              </div>
            </div>
          </div>
          
          <!-- Cultural Highlights -->
          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 12px;">🎌 Cultural Masterpieces</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #92400e;">
              <li style="margin-bottom: 8px;"><strong>Mitama Matsuri Festival (July 13-16):</strong> 30,000+ lanterns, Nebuta floats, Awa Odori dancing</li>
              <li style="margin-bottom: 8px;"><strong>Gion Matsuri Yoiyama (July 23):</strong> 1,150+ year festival climactic evening</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Fushimi Inari Shrine', 'Fushimi Inari')}:</strong> 10,000+ vermillion torii gates sacred mountain</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Tokyo National Museum')}:</strong> 89 National Treasures, world's largest Japanese art collection</li>
              <li style="margin-bottom: 8px;"><strong>Nara Sacred Deer:</strong> 1,000+ free-roaming deer at ${createMapLink('Todai-ji Temple')}</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Arashiyama Bamboo Grove')}:</strong> Natural cathedral with unique acoustics</li>
            </ul>
          </div>
          
          <!-- Culinary Journey -->
          <div style="background: linear-gradient(135deg, #fed7d7, #fecaca); border: 1px solid #f87171; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">🍜 Culinary Excellence</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #dc2626;">
              <li style="margin-bottom: 8px;"><strong>Tsukiji Market:</strong> Ultra-fresh tuna sashimi, traditional tamagoyaki at century-old stalls</li>
              <li style="margin-bottom: 8px;"><strong>Michelin Experiences:</strong> Nakiryu (Bib Gourmand) tantanmen specialist ramen</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Dotonbori')} Street Food:</strong> Takoyaki at original Wanaka (founded 1939), okonomiyaki birthplace</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Nishiki Market')}:</strong> 400+ years 'Kyoto's Kitchen', imperial capital ingredients</li>
              <li style="margin-bottom: 8px;"><strong>Premium Sushi:</strong> Seamon Ginza, traditional kaiseki dining experiences</li>
              <li style="margin-bottom: 8px;"><strong>Nara Specialties:</strong> Mahoroba Daibutsu Pudding, traditional sweets</li>
            </ul>
          </div>
          
          <!-- Modern Adventures -->
          <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border: 1px solid #8b5cf6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #7c3aed; margin-bottom: 12px;">🚗 Unique Adventures</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #7c3aed;">
              <li style="margin-bottom: 8px;"><strong>Mario Kart Racing in Osaka:</strong> Street racing through Dotonbori entertainment district</li>
              <li style="margin-bottom: 8px;"><strong>Tokyo Skytree:</strong> Tokyo's tallest structure with 360° metropolitan views</li>
              <li style="margin-bottom: 8px;"><strong>teamLab Planets:</strong> World's most visited digital art museum with 2025 expansion</li>
              <li style="margin-bottom: 8px;"><strong>Shinkansen Bullet Train (2 rides):</strong> 320 km/h engineering marvel, 18-second average delay</li>
              <li style="margin-bottom: 8px;"><strong>Tokyo DisneySea:</strong> World's only DisneySea park with Fantasy Springs (NEW 2024)</li>
              <li style="margin-bottom: 8px;"><strong>Golden Gai:</strong> Historic post-war drinking district with tiny 5-seat bars</li>
            </ul>
          </div>
          
          <!-- Premium Nightlife -->
          <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border: 1px solid #a855f7; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #9333ea; margin-bottom: 12px;">🌃 Premium Views & Nightlife</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #9333ea;">
              <li style="margin-bottom: 8px;"><strong>K36 Kyoto:</strong> Eye-level Yasaka Pagoda view (unique in world)</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('WOMB Shibuya')}:</strong> Tokyo's premier EDM club</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Ni-chome', 'Ni-chome Tokyo')}:</strong> Asia's largest LGBTQ+ district</li>
              <li style="margin-bottom: 8px;"><strong>Premium Rooftops:</strong> Craft cocktails with city panoramas</li>
            </ul>
          </div>
          
          <!-- Trip Highlights -->
          <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); border: 1px solid #10b981; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #065f46; margin-bottom: 12px;">✨ 2025 Trip Highlights</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #065f46;">
              <li style="margin-bottom: 8px;"><strong>NEW: Tokyo Disney Resort:</strong> Full day at world's only DisneySea with Fantasy Springs</li>
              <li style="margin-bottom: 8px;"><strong>NEW: Nara Sacred Deer Experience:</strong> Interactive feeding with 1,000+ free-roaming deer</li>
              <li style="margin-bottom: 8px;"><strong>Perfect Festival Timing:</strong> Mitama Matsuri (July 13-16) + Gion Matsuri Yoiyama (July 23)</li>
              <li style="margin-bottom: 8px;"><strong>Two Bullet Train Journeys:</strong> TokyotoKyoto + KyototoTokyo Bay experiences</li>
              <li style="margin-bottom: 8px;"><strong>Three Hotel Experiences:</strong> Shibuya city center + Kyoto traditional + Tokyo Bay Disney resort</li>
              <li style="margin-bottom: 8px;"><strong>Cost Optimization:</strong> Mario Kart in Osaka (29% savings) + Tokyo Skytree (79% savings vs Tokyo Mario Kart)</li>
            </ul>
          </div>
          
          <!-- App Info -->
          <div id="version-tile" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border: 1px solid #cbd5e1; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease; -webkit-tap-highlight-color: rgba(59, 130, 246, 0.3); user-select: none;">
            <div style="font-size: var(--base-text); color: #64748b; margin-bottom: 4px;">Japan Travel App</div>
            <div style="font-size: var(--small-text); color: #3b82f6; font-family: monospace; font-weight: 600;">${APP_VERSION}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">📋 Tap to view version history</div>
          </div>
        </div>
      `;
      
      // Add comprehensive touch/click handlers to version tile
      const versionTile = document.getElementById('version-tile');
      if (versionTile) {
        addDebugLog('✅ Version tile found, adding event handlers', 'success');
        
        // Function to handle the version tile interaction
        function handleVersionTileClick(event) {
          event.preventDefault();
          event.stopPropagation();
          addDebugLog('🔍 Version tile interacted!', 'info');
          console.log('Version tile interacted, calling showVersionHistory()');
          
          // Add immediate visual feedback
          versionTile.style.transform = 'scale(0.95)';
          versionTile.style.background = 'linear-gradient(135deg, #e2e8f0, #cbd5e1)';
          
          setTimeout(() => {
            versionTile.style.transform = 'scale(1)';
            versionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
            showVersionHistory();
          }, 100);
        }
        
        // Add multiple event types for better mobile compatibility
        versionTile.addEventListener('click', handleVersionTileClick);
        versionTile.addEventListener('touchend', handleVersionTileClick);
        
        // Add visual feedback for touch start
        versionTile.addEventListener('touchstart', function(event) {
          addDebugLog('👆 Version tile touch started', 'info');
          versionTile.style.transform = 'scale(0.98)';
          versionTile.style.background = 'linear-gradient(135deg, #e0e7ff, #c7d2fe)';
        });
        
        // Reset visual feedback if touch is cancelled
        versionTile.addEventListener('touchcancel', function(event) {
          versionTile.style.transform = 'scale(1)';
          versionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
        });
        
      } else {
        addDebugLog('❌ Version tile not found!', 'error');
      }
      
      // Load weather advisory for overview
      loadOverviewWeatherAdvisory();
    }
    
    async function loadOverviewWeatherAdvisory() {
      const advisoryContainer = document.getElementById('overview-weather-advisory');
      if (!advisoryContainer) return;
      
      try {
        // Get weather for all cities
        const tokyoWeather = await getWeatherWithFallback('Tokyo');
        const kyotoWeather = await getWeatherWithFallback('Kyoto');
        const osakaWeather = await getWeatherWithFallback('Osaka');
        
        const tokyoRec = getWeatherRecommendation(tokyoWeather);
        const kyotoRec = getWeatherRecommendation(kyotoWeather);
        const osakaRec = getWeatherRecommendation(osakaWeather);
        
        // Determine overall trip weather advisory
        let overallAdvice = '';
        let adviceType = 'good';
        let adviceIcon = '✨';
        
        // Check for severe weather across all cities
        if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'storm')) {
          adviceType = 'storm';
          adviceIcon = '⛈️';
          overallAdvice = 'Severe weather warnings across Japan - monitor conditions closely and have indoor backup plans ready';
        } else if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'rain')) {
          adviceType = 'rain';
          adviceIcon = '☔';
          overallAdvice = 'Rain expected in some areas - pack umbrella and consider indoor activities like museums, shopping centers, and covered markets';
        } else if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'heat')) {
          adviceType = 'heat';
          adviceIcon = '🌡️';
          overallAdvice = 'Very hot and humid conditions across Japan - stay hydrated, seek air conditioning frequently, and plan outdoor activities for early morning or evening';
        } else if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'warm')) {
          adviceType = 'warm';
          adviceIcon = '☀️';
          overallAdvice = 'Warm weather expected - stay hydrated and take breaks in air-conditioned spaces';
        } else {
          overallAdvice = 'Great weather conditions across all destinations - perfect for outdoor sightseeing and activities!';
        }
        
        // Add current conditions note if using live data
        const isLiveData = !tokyoWeather.isStatic;
        const dataNote = isLiveData ? 
          'Based on current weather conditions. Trip dates are in July 2025.' : 
          'Estimated conditions for July travel period.';
        
        advisoryContainer.innerHTML = `
          <div style="background: ${getAdvisoryBackground(adviceType)}; border: 1px solid ${getAdvisoryBorder(adviceType)}; border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: var(--large-text); margin-top: 2px;">${adviceIcon}</span>
              <div style="flex: 1;">
                <h3 style="font-size: var(--large-text); font-weight: bold; color: ${getAdvisoryTextColor(adviceType)}; margin-bottom: 8px;">
                  Trip Weather Advisory
                </h3>
                <p style="font-size: var(--base-text); color: ${getAdvisoryTextColor(adviceType)}; margin-bottom: 12px; line-height: 1.5;">
                  ${overallAdvice}
                </p>
                
                <!-- City Weather Summary -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                  <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                    <div style="font-size: var(--medium-text); margin-bottom: 4px;">${getWeatherIcon(tokyoWeather.weather[0].main)}</div>
                    <div style="font-size: var(--small-text); font-weight: 600; color: ${getAdvisoryTextColor(adviceType)};">Tokyo</div>
                    <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)};">${celsiusToFahrenheit(tokyoWeather.main.temp)}°F</div>
                  </div>
                  <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                    <div style="font-size: var(--medium-text); margin-bottom: 4px;">${getWeatherIcon(kyotoWeather.weather[0].main)}</div>
                    <div style="font-size: var(--small-text); font-weight: 600; color: ${getAdvisoryTextColor(adviceType)};">Kyoto</div>
                    <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)};">${celsiusToFahrenheit(kyotoWeather.main.temp)}°F</div>
                  </div>
                  <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                    <div style="font-size: var(--medium-text); margin-bottom: 4px;">${getWeatherIcon(osakaWeather.weather[0].main)}</div>
                    <div style="font-size: var(--small-text); font-weight: 600; color: ${getAdvisoryTextColor(adviceType)};">Osaka</div>
                    <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)};">${celsiusToFahrenheit(osakaWeather.main.temp)}°F</div>
                  </div>
                </div>
                
                <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)}; opacity: 0.8; font-style: italic;">
                  ${dataNote}
                </div>
              </div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Failed to load overview weather advisory:', error);
        // Show default July advisory
        advisoryContainer.innerHTML = `
          <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: var(--large-text); margin-top: 2px;">🌡️</span>
              <div>
                <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 8px;">
                  July Weather Advisory
                </h3>
                <p style="font-size: var(--base-text); color: #92400e; line-height: 1.5;">
                  July is Japan's hottest, most humid month (84-90°F with 78-83% humidity). Plan indoor activities during peak heat (11am-4pm) and save outdoor sightseeing for early morning or evening.
                </p>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function getAdvisoryBackground(type) {
      switch(type) {
        case 'storm': return '#fef2f2';
        case 'rain': return '#f0f9ff';
        case 'heat': return '#fed7aa';
        case 'warm': return '#fef3c7';
        default: return '#f0fdf4';
      }
    }
    
    function getAdvisoryBorder(type) {
      switch(type) {
        case 'storm': return '#f87171';
        case 'rain': return '#38bdf8';
        case 'heat': return '#fb923c';
        case 'warm': return '#fbbf24';
        default: return '#4ade80';
      }
    }
    
    function getAdvisoryTextColor(type) {
      switch(type) {
        case 'storm': return '#dc2626';
        case 'rain': return '#0284c7';
        case 'heat': return '#ea580c';
        case 'warm': return '#92400e';
        default: return '#16a34a';
      }
    }
    
    // Load Budget content  
    function loadBudgetContent() {
      const budgetView = document.getElementById('budget-view');
      budgetView.innerHTML = `
        <div>
          <h2 style="font-size: var(--title-text); font-weight: bold; color: #1f2937; margin-bottom: 16px;">
            💰 Complete Trip Budget
          </h2>
          
          <!-- Grand Total -->
          <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 1px solid #4ade80; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
            <h3 style="font-size: var(--xl-text); font-weight: bold; color: #15803d; margin-bottom: 8px;">🇯🇵 GRAND TOTAL</h3>
            <div style="font-size: var(--title-text); font-weight: bold; color: #15803d; margin-bottom: 4px;">¥168,310 ($1,178.17)</div>
            <div style="font-size: var(--base-text); color: #16a34a;">Daily Average: $90.62 per day over 13 days</div>
            <div style="font-size: var(--small-text); color: #16a34a; margin-top: 4px;">Exchange Rate: ¥143 = $1 USD</div>
          </div>
          
          <!-- Category Breakdown -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #1e40af; margin-bottom: 12px;">📊 Budget by Category</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: var(--base-text); color: #1e40af;">
              <div><strong>🍽️ Food & Dining:</strong> ¥44,830 ($313.81)</div>
              <div><strong>🚊 Transportation:</strong> ¥38,490 ($269.43)</div>
              <div><strong>🏛️ Attractions:</strong> ¥30,040 ($210.28)</div>
              <div><strong>🌃 Nightlife:</strong> ¥23,600 ($165.20)</div>
              <div><strong>🎌 Festivals:</strong> ¥6,450 ($45.15)</div>
              <div><strong>🎢 Disney:</strong> ¥9,400 ($65.80)</div>
              <div><strong>🎯 Activities:</strong> ¥10,000 ($70.00)</div>
              <div><strong>🛍️ Shopping:</strong> ¥5,500 ($38.50)</div>
            </div>
          </div>
          
          <!-- Tokyo Phase (First Stay) -->
          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 12px;">🗼 Tokyo Phase 1 (5 Days) - July 14-18</h3>
            <div style="font-size: var(--base-text); color: #92400e; margin-bottom: 12px;"><strong>Total: ¥50,530 ($353.31)</strong></div>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #92400e;">
              <li>Day 1 (July 14 - Arrival & Recovery): ¥3,480 ($24.26)</li>
              <li>Day 2 (July 15 - Traditional + Mitama Matsuri): ¥8,450 ($59.15)</li>
              <li>Day 3 (July 16 - Modern + teamLab + Skytree): ¥14,200 ($99.40)</li>
              <li>Day 4 (July 17 - Markets + Museums + Culture): ¥9,700 ($67.90)</li>
              <li>Day 5 (July 18 - Final Tokyo + Premium Nightlife): ¥14,700 ($102.90)</li>
            </ul>
          </div>
          
          <!-- Transfer Day -->
          <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border: 1px solid #8b5cf6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #7c3aed; margin-bottom: 8px;">🚄 Tokyo to Kyoto (July 19)</h3>
            <div style="font-size: var(--base-text); color: #7c3aed;">
              <strong>Bullet Train + Food + Transport: ¥18,300 ($128.10)</strong>
            </div>
          </div>
          
          <!-- Kyoto Phase -->
          <div style="background: linear-gradient(135deg, #fed7d7, #fecaca); border: 1px solid #f87171; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">🏮 Kyoto Phase (5 Days) - July 20-23</h3>
            <div style="font-size: var(--base-text); color: #dc2626; margin-bottom: 12px;"><strong>Total: ¥39,330 ($275.39)</strong></div>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #dc2626;">
              <li>Day 7 (July 20 - Kyoto Highlights): ¥11,970 ($83.79)</li>
              <li>Day 8 (July 21 - Osaka Day Trip): ¥14,340 ($100.50)</li>
              <li>Day 9 (July 22 - Nara Day Trip): ¥4,470 ($31.25)</li>
              <li>Day 10 (July 23 - Final Kyoto + Gion Matsuri): ¥8,550 ($59.85)</li>
            </ul>
          </div>
          
          <!-- Tokyo Bay Phase -->
          <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #0ea5e9; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #0c4a6e; margin-bottom: 12px;">🏰 Tokyo Bay Phase (3 Days) - July 24-26</h3>
            <div style="font-size: var(--base-text); color: #0c4a6e; margin-bottom: 12px;"><strong>Total: ¥42,650 ($296.60)</strong></div>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #0c4a6e;">
              <li>Day 11 (July 24 - Kyoto to Tokyo Bay): ¥19,350 ($133.50)</li>
              <li>Day 12 (July 25 - Tokyo DisneySea): ¥17,100 ($119.70)</li>
              <li>Day 13 (July 26 - Final Tokyo & Departure): ¥6,200 ($43.40)</li>
            </ul>
          </div>
          
          <!-- What's Included -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #1e40af; margin-bottom: 12px;">✅ What This Includes</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #1e40af;">
              <li style="margin-bottom: 4px;"><strong>All meals:</strong> Street food to Michelin Bib Gourmand dining</li>
              <li style="margin-bottom: 4px;"><strong>All transportation:</strong> Local trains, buses, 2x bullet train rides</li>
              <li style="margin-bottom: 4px;"><strong>Cultural activities:</strong> Museums, temples, digital art, festivals</li>
              <li style="margin-bottom: 4px;"><strong>Premium nightlife:</strong> Rooftop bars, EDM clubs, LGBTQ+ venues</li>
              <li style="margin-bottom: 4px;"><strong>Festival experiences:</strong> Mitama Matsuri + Gion Matsuri Yoiyama</li>
              <li style="margin-bottom: 4px;"><strong>Unique activities:</strong> Mario Kart, Tokyo Skytree, teamLab Planets, Disney</li>
              <li style="margin-bottom: 4px;"><strong>Day trips:</strong> Osaka street food tour, Nara sacred deer experience</li>
            </ul>
          </div>
          
          <!-- Not Included -->
          <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #f87171; border-radius: 12px; padding: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">❌ NOT Included</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #dc2626;">
              <li style="margin-bottom: 4px;"><strong>Hotels:</strong> Fully covered by Hyatt Globalist status</li>
              <li style="margin-bottom: 4px;"><strong>Breakfast:</strong> Included daily at hotels due to Globalist status</li>
              <li style="margin-bottom: 4px;"><strong>International flights:</strong> CLT-ORD-HND and NRT-SAN-CLT</li>
              <li style="margin-bottom: 4px;"><strong>Personal shopping:</strong> Souvenirs and individual purchases</li>
              <li style="margin-bottom: 4px;"><strong>Travel insurance:</strong> Recommended but calculated separately</li>
              <li style="margin-bottom: 4px;"><strong>International Driving Permit:</strong> Required for Mario Kart (¥2,400)</li>
            </ul>
          </div>
        </div>
      `;
    }

    // Currency converter features removed for stability

    // Temperature and distance conversion utilities
    function celsiusToFahrenheit(celsius) {
      return Math.round((celsius * 9/5) + 32);
    }
    
    function kmToMiles(km) {
      return (km * 0.621371).toFixed(1);
    }
    
    function metersToFeet(meters) {
      return Math.round(meters * 3.28084);
    }

    
    function getCurrentDayLocation() {
      // Get the hotel location for the current day
      const dayNum = parseInt(currentDay.split('-')[2]);
      
      if (dayNum >= 14 && dayNum <= 19) {
        return 'Hyatt House Shibuya, Tokyo';
      } else if (dayNum >= 19 && dayNum <= 23) {
        return 'Hyatt Place Kyoto';
      } else if (dayNum >= 23 && dayNum <= 24) {
        return 'Caption by Hyatt Namba, Osaka';
      }
      
      return 'Tokyo Station'; // fallback
    }

    // Add click handlers for debugging
    document.addEventListener('click', function(e) {
      addDebugLog(`👆 Clicked: ${e.target.tagName}`, 'info');
    });

    // 5-day Forecast Functions
    async function getFiveDayForecast(city) {
      console.log(`🔮 Fetching 5-day forecast for ${city}`);
      
      if (!WEATHER_CONFIG.apiKey || WEATHER_CONFIG.apiKey === 'YOUR_API_KEY_HERE') {
        throw new Error('Weather API key not configured');
      }
      
      const coords = CITY_COORDINATES[city];
      if (!coords) {
        throw new Error(`No coordinates found for city: ${city}`);
      }
      
      // 5-day forecast endpoint (free tier)
      const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${coords.lat}&lon=${coords.lon}&appid=${WEATHER_CONFIG.apiKey}&units=metric`;
      const url = `${WEATHER_CONFIG.baseUrl}${encodeURIComponent(forecastUrl)}`;
      
      console.log(`🌐 Making forecast API request for ${city}`);
      
      const response = await fetch(url);
      console.log(`📡 Forecast API response status: ${response.status}`);
      
      if (!response.ok) {
        throw new Error(`Forecast API error: ${response.status}`);
      }
      
      const proxyData = await response.json();
      const forecastData = JSON.parse(proxyData.contents);
      console.log(`🌤️ Parsed forecast data:`, forecastData);
      
      return forecastData;
    }

    // Parse 3-hour forecast data into daily summaries
    function parseForecastData(forecastData, city) {
      const dailyForecasts = {};
      
      forecastData.list.forEach(item => {
        const date = new Date(item.dt * 1000);
        const dateKey = date.toISOString().split('T')[0];
        
        if (!dailyForecasts[dateKey]) {
          dailyForecasts[dateKey] = {
            date: dateKey,
            city: city,
            temps: [],
            weather: [],
            humidity: [],
            dt: item.dt
          };
        }
        
        dailyForecasts[dateKey].temps.push(item.main.temp);
        dailyForecasts[dateKey].weather.push(item.weather[0]);
        dailyForecasts[dateKey].humidity.push(item.main.humidity);
      });
      
      // Convert to array and calculate daily summaries
      return Object.values(dailyForecasts).map(day => {
        const temps = day.temps;
        const weatherCounts = {};
        
        // Count weather conditions
        day.weather.forEach(w => {
          weatherCounts[w.main] = (weatherCounts[w.main] || 0) + 1;
        });
        
        // Get most common weather
        const dominantWeather = Object.entries(weatherCounts)
          .sort((a, b) => b[1] - a[1])[0][0];
        
        return {
          date: day.date,
          city: day.city,
          high: Math.max(...temps),
          low: Math.min(...temps),
          avgTemp: temps.reduce((a, b) => a + b) / temps.length,
          avgHumidity: Math.round(day.humidity.reduce((a, b) => a + b) / day.humidity.length),
          weather: dominantWeather,
          weatherDescription: day.weather.find(w => w.main === dominantWeather).description,
          dt: day.dt
        };
      });
    }

    // Determine which city to show forecast for based on trip itinerary
    function getCityForDate(date) {
      const tripStart = new Date('2025-07-14');
      const tripEnd = new Date('2025-07-26');
      const checkDate = new Date(date);
      
      // If after trip, always show Tokyo
      if (checkDate > tripEnd) {
        return 'Tokyo';
      }
      
      // During trip, determine city based on itinerary
      const dayOfTrip = Math.floor((checkDate - tripStart) / (1000 * 60 * 60 * 24)) + 1;
      
      if (dayOfTrip <= 5) {
        return 'Tokyo';
      } else if (dayOfTrip <= 10) {
        return 'Kyoto';
      } else {
        return 'Tokyo'; // Tokyo Bay for final days
      }
    }

    // Load Forecast content
    async function loadForecastContent() {
      const forecastView = document.getElementById('forecast-view');
      forecastView.innerHTML = `
        <div>
          <h2 style="font-size: var(--title-text); font-weight: bold; color: #1f2937; margin-bottom: 16px;">
            🌤️ 5-Day Forecast
          </h2>
          
          <div id="forecast-loading" style="text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px;">☁️</div>
            <div style="font-size: var(--base-text); color: #6b7280;">Loading forecast data...</div>
          </div>
          
          <div id="forecast-content" style="display: none;">
            <!-- Forecast cards will be populated here -->
          </div>
          
          <div id="forecast-error" style="display: none;">
            <!-- Error message will be shown here -->
          </div>
        </div>
      `;
      
      try {
        // Determine which city to show based on current date
        const today = new Date();
        const city = getCityForDate(today);
        
        addDebugLog(`🏙️ Showing forecast for ${city}`, 'info');
        
        // Fetch 5-day forecast
        const forecastData = await getFiveDayForecast(city);
        const dailyForecasts = parseForecastData(forecastData, city);
        
        // Filter out past days
        const futureDays = dailyForecasts.filter(day => {
          const dayDate = new Date(day.date);
          dayDate.setHours(23, 59, 59); // Include entire day
          return dayDate >= today;
        });
        
        // Hide loading, show content
        document.getElementById('forecast-loading').style.display = 'none';
        document.getElementById('forecast-content').style.display = 'block';
        
        // Build forecast cards
        const forecastContent = document.getElementById('forecast-content');
        forecastContent.innerHTML = `
          <div style="font-size: var(--base-text); color: #6b7280; margin-bottom: 16px; text-align: center;">
            Forecast for <span style="font-weight: bold; color: #3730a3;">${city}</span>
            ${city !== 'Tokyo' ? '<span style="font-size: var(--small-text);"> (based on your itinerary)</span>' : ''}
          </div>
          
          <div style="display: grid; gap: 12px;">
            ${futureDays.slice(0, 5).map((day, index) => {
              const date = new Date(day.date);
              const dayName = index === 0 ? 'Today' : 
                            index === 1 ? 'Tomorrow' : 
                            date.toLocaleDateString('en-US', { weekday: 'short' });
              const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              
              // Check if this date is during the trip
              const tripStart = new Date('2025-07-14');
              const tripEnd = new Date('2025-07-26');
              const isDuringTrip = date >= tripStart && date <= tripEnd;
              const tripCity = isDuringTrip ? getCityForDate(date) : null;
              
              return `
                <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #0ea5e9; border-radius: 12px; padding: 16px;">
                  <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center;">
                    <!-- Date Section -->
                    <div>
                      <div style="font-size: var(--large-text); font-weight: bold; color: #0c4a6e;">${dayName}</div>
                      <div style="font-size: var(--base-text); color: #0369a1;">${dateStr}</div>
                      ${tripCity && tripCity !== city ? `
                        <div style="font-size: var(--small-text); color: #0369a1; margin-top: 4px;">
                          <span style="background: #dbeafe; padding: 2px 6px; border-radius: 4px;">${tripCity}</span>
                        </div>
                      ` : ''}
                    </div>
                    
                    <!-- Weather Icon & Description -->
                    <div style="text-align: center;">
                      <div style="font-size: 48px; margin-bottom: 4px;">${getWeatherIcon(day.weather)}</div>
                      <div style="font-size: var(--small-text); color: #0369a1;">${day.weatherDescription}</div>
                    </div>
                    
                    <!-- Temperature -->
                    <div style="text-align: right;">
                      <div style="font-size: var(--large-text); font-weight: bold; color: #0c4a6e;">
                        ${celsiusToFahrenheit(day.high)}°
                      </div>
                      <div style="font-size: var(--base-text); color: #0369a1;">
                        ${celsiusToFahrenheit(day.low)}°
                      </div>
                      <div style="font-size: var(--small-text); color: #0369a1; margin-top: 4px;">
                        ${day.avgHumidity}% 💧
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: var(--small-text); color: #6b7280; text-align: center;">
            <div>Data from OpenWeatherMap • Updated ${new Date().toLocaleTimeString()}</div>
            ${futureDays.length < 5 ? '<div style="margin-top: 4px;">Showing all available future days</div>' : ''}
          </div>
        `;
        
        addDebugLog(`✅ Forecast loaded successfully`, 'success');
        
      } catch (error) {
        console.error('Forecast error:', error);
        addDebugLog(`❌ Forecast error: ${error.message}`, 'error');
        
        // Hide loading, show error
        document.getElementById('forecast-loading').style.display = 'none';
        document.getElementById('forecast-error').style.display = 'block';
        
        // Show fallback content
        const forecastError = document.getElementById('forecast-error');
        forecastError.innerHTML = `
          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 16px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 8px;">🌧️</div>
            <div style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 8px;">
              Unable to Load Forecast
            </div>
            <div style="font-size: var(--base-text); color: #7f1d1d; margin-bottom: 16px;">
              Weather forecast data is temporarily unavailable
            </div>
            <div style="font-size: var(--small-text); color: #991b1b;">
              ${error.message}
            </div>
          </div>
          
          <!-- Show static July weather info as fallback -->
          <div style="margin-top: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 12px;">
              📅 Typical July Weather
            </h3>
            <div style="font-size: var(--base-text); color: #92400e; line-height: 1.6;">
              <div style="margin-bottom: 8px;"><strong>Tokyo:</strong> 84-90°F (29-32°C), 78% humidity</div>
              <div style="margin-bottom: 8px;"><strong>Kyoto:</strong> 82-88°F (28-31°C), 80% humidity</div>
              <div style="margin-bottom: 8px;"><strong>Osaka:</strong> 83-89°F (28-32°C), 83% humidity</div>
              <div style="margin-top: 12px; font-size: var(--small-text);">
                July is Japan's hottest month with occasional afternoon thunderstorms. 
                Pack light, breathable clothing and always carry water.
              </div>
            </div>
          </div>
        `;
      }
    }
  </script>
</body>
</html><!-- Deployment trigger Wed Jul 16 09:59:48 JST 2025 -->
<!-- Rebuild Wed Jul 16 18:12:01 JST 2025 -->
