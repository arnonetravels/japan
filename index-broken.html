<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>🇯🇵 Japan Travel App</title>
  
  <!-- Mobile optimizations -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Japan Travel">
  <meta name="theme-color" content="#6366f1">
  
  <style>
    /* Inline CSS - no external dependencies */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f9fafb 0%, #e2e8f0 100%);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Loading screen styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
      text-align: center;
    }
    
    .loading-logo {
      font-size: 48px;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    
    .loading-title {
      font-size: 24px;
      font-weight: bold;
      color: #4f46e5;
      margin-bottom: 10px;
    }
    
    .loading-subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 30px;
    }
    
    /* Loading bar */
    .loading-bar-container {
      width: 100%;
      max-width: 300px;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, #4f46e5, #7c3aed);
      border-radius: 4px;
      animation: loading 3s ease-in-out infinite;
      transform-origin: left;
    }
    
    .debug-log {
      width: 100%;
      max-width: 300px;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 15px;
      font-size: 12px;
      color: #374151;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .debug-item {
      padding: 2px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .debug-item:last-child {
      border-bottom: none;
    }
    
    .version-info {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-size: 11px;
      color: #9ca3af;
      opacity: 0.7;
      font-family: 'Monaco', 'Menlo', monospace;
    }
    
    .success {
      color: #059669;
    }
    
    .error {
      color: #dc2626;
    }
    
    .hidden {
      display: none;
    }
    
    /* App styles */
    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: linear-gradient(90deg, #4f46e5, #7c3aed, #4f46e5);
      color: white;
      padding: 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      /* Extend header to account for iPhone status bar */
      padding-top: max(16px, calc(16px + env(safe-area-inset-top)));
    }
    
    .header-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .header-subtitle {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .content {
      flex: 1;
      padding: 16px;
      padding-bottom: 140px; /* Space for both navigation bars */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    .day-title {
      font-size: var(--title-text);
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .city-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #3730a3;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: var(--small-text);
      font-weight: 500;
      margin-left: 8px;
    }
    
    .date-text {
      color: #6b7280;
      font-size: var(--base-text);
      margin-bottom: 16px;
    }
    
    .weather-warning {
      background: #fef3c7;
      color: #92400e;
      padding: 12px;
      border-radius: 8px;
      font-size: var(--base-text);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .activity-card {
      background: linear-gradient(135deg, #ddd6fe, #e0e7ff);
      border: 1px solid #c4b5fd;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .activity-type {
      font-size: var(--small-text);
      text-transform: uppercase;
      font-weight: 500;
      opacity: 0.7;
      letter-spacing: 0.5px;
    }
    
    .activity-time {
      font-size: var(--small-text);
      opacity: 0.7;
      margin-top: 4px;
    }
    
    .activity-cost {
      background: rgba(255,255,255,0.7);
      padding: 8px;
      border-radius: 8px;
      text-align: right;
    }
    
    .cost-yen {
      font-weight: bold;
      font-size: var(--base-text);
    }
    
    .cost-usd {
      font-size: var(--small-text);
      opacity: 0.7;
    }
    
    .activity-title {
      font-size: var(--large-text);
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .activity-location {
      color: #6b7280;
      font-size: var(--base-text);
      margin-bottom: 8px;
    }
    
    .activity-description {
      font-size: var(--base-text);
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .significance-box {
      background: rgba(255,255,255,0.5);
      padding: 12px;
      border-radius: 8px;
    }
    
    .significance-title {
      font-weight: 500;
      font-size: var(--base-text);
      margin-bottom: 4px;
    }
    
    /* Day Navigation */
    .day-nav {
      position: fixed;
      bottom: 70px; /* Above bottom nav */
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 12px 16px;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      z-index: 90;
    }
    
    /* Date Picker Tray */
    .date-picker-tray {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      z-index: 95;
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .date-picker-tray.show {
      transform: translateY(0);
    }
    
    .tray-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fafc;
      text-align: center;
      font-weight: 600;
      color: #374151;
    }
    
    .date-list {
      padding: 8px 0;
    }
    
    .date-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .date-item:hover {
      background: #f3f4f6;
    }
    
    .date-item.current {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
    }
    
    .date-item.today {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
    }
    
    .date-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 12px;
      font-size: 14px;
    }
    
    .date-item.current .date-number {
      background: #3b82f6;
      color: white;
    }
    
    .date-item.today .date-number {
      background: #f59e0b;
      color: white;
    }
    
    .date-details {
      flex: 1;
    }
    
    .date-title {
      font-weight: 500;
      font-size: 16px;
      color: #374151;
      margin-bottom: 2px;
    }
    
    .date-subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    
    .date-city {
      font-size: 12px;
      color: #3b82f6;
      font-weight: 500;
      margin-top: 2px;
    }
    
    /* Version History Modal */
    .version-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .version-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .version-content {
      background: white;
      border-radius: 12px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .version-modal.show .version-content {
      transform: translateY(0);
    }
    
    .version-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: 12px 12px 0 0;
    }
    
    .version-title {
      font-size: 20px;
      font-weight: bold;
      color: #1f2937;
      margin: 0 0 8px 0;
    }
    
    .version-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    
    .version-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }
    
    .version-close:hover {
      background: #f3f4f6;
    }
    
    .version-list {
      padding: 20px;
    }
    
    .version-item {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .version-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .version-number {
      font-size: 18px;
      font-weight: bold;
      color: #3b82f6;
      margin-bottom: 8px;
    }
    
    .version-date {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    
    .version-changes {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .version-changes li {
      display: flex;
      align-items: flex-start;
      margin-bottom: 6px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .version-changes li:last-child {
      margin-bottom: 0;
    }
    
    .change-type {
      margin-right: 8px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .version-changes .added { color: #059669; }
    .version-changes .improved { color: #3b82f6; }
    .version-changes .fixed { color: #f59e0b; }
    
    .day-nav-button {
      background: #f3f4f6;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    .day-nav-button:hover {
      background: #e5e7eb;
    }
    
    .day-nav-button:disabled {
      background: #f9fafb;
      color: #d1d5db;
      cursor: not-allowed;
    }
    
    .day-nav-center {
      flex: 1;
      text-align: center;
      padding: 0 16px;
    }
    
    .day-nav-date {
      font-weight: 600;
      font-size: var(--base-text);
      color: #1f2937;
      margin-bottom: 2px;
    }
    
    .day-nav-day {
      font-size: var(--small-text);
      color: #6b7280;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      z-index: 80;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    
    .nav-button {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      border: none;
      background: none;
      cursor: pointer;
      color: #6b7280;
      font-size: 10px;
      font-weight: 500;
    }
    
    .nav-button.active {
      color: #4f46e5;
    }
    
    .nav-icon {
      font-size: 16px;
      margin-bottom: 2px;
      display: block;
    }
    
    /* CSS Variables for text scaling */
    :root {
      --text-scale: 1;
    }
    
    :root[data-text-size="small"] {
      --text-scale: 0.85;
    }
    
    :root[data-text-size="medium"] {
      --text-scale: 1;
    }
    
    :root[data-text-size="large"] {
      --text-scale: 1.15;
    }
    
    :root[data-text-size="xlarge"] {
      --text-scale: 1.3;
    }
    
    /* Text size calculations */
    :root {
      --small-text: calc(12px * var(--text-scale));
      --base-text: calc(14px * var(--text-scale));
      --medium-text: calc(16px * var(--text-scale));
      --large-text: calc(18px * var(--text-scale));
      --xl-text: calc(20px * var(--text-scale));
      --title-text: calc(24px * var(--text-scale));
    }

    /* Text Size Controls - Collapsible */
    .text-toggle {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top)); /* Within header area */
      left: 20px;
      z-index: 1000;
    }
    
    .text-toggle-btn {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #4f46e5;
      font-weight: bold;
      font-size: 16px;
      font-family: serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    
    .text-toggle-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.05);
    }
    
    .text-controls {
      position: absolute;
      top: 50px;
      left: 0;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }
    
    .text-controls.show {
      display: flex;
    }
    
    .text-size-option {
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: #374151;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .text-size-option:hover {
      background: #f3f4f6;
    }
    
    .text-size-option.active {
      background: #4f46e5;
      color: white;
    }
    
    .size-preview {
      font-family: serif;
      font-weight: bold;
    }
    
    .size-preview.small { font-size: 11px; }
    .size-preview.medium { font-size: 13px; }
    .size-preview.large { font-size: 15px; }
    .size-preview.xlarge { font-size: 17px; }
    

    /* Animations */
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes loading {
      0% {
        transform: scaleX(0);
      }
      50% {
        transform: scaleX(0.7);
      }
      100% {
        transform: scaleX(1);
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading" class="loading-container">
    <div class="loading-logo">🇯🇵</div>
    <div class="loading-title">Japan Travel App</div>
    <div class="loading-subtitle">Preparing your adventure...</div>
    
    <div class="loading-bar-container">
      <div class="loading-bar"></div>
    </div>
    
    <div id="debug-log" class="debug-log">
      <div class="debug-item">🔄 Initializing app...</div>
    </div>
    
    <div class="version-info" id="version-display">v0.9.20250110</div>
  </div>

  <!-- Main App (initially hidden) -->
  <div id="app" class="app-container hidden">
    <!-- Text Size Controls -->
    <div class="text-toggle">
      <button class="text-toggle-btn" onclick="toggleTextControls()" id="text-toggle" title="Text size">A</button>
      <div class="text-controls" id="text-controls">
        <button class="text-size-option" onclick="setTextSize('small')" id="text-small">
          <span class="size-preview small">A</span>
          <span>Small</span>
        </button>
        <button class="text-size-option active" onclick="setTextSize('medium')" id="text-medium">
          <span class="size-preview medium">A</span>
          <span>Medium</span>
        </button>
        <button class="text-size-option" onclick="setTextSize('large')" id="text-large">
          <span class="size-preview large">A</span>
          <span>Large</span>
        </button>
        <button class="text-size-option" onclick="setTextSize('xlarge')" id="text-xlarge">
          <span class="size-preview xlarge">A</span>
          <span>Extra Large</span>
        </button>
      </div>
    </div>
    
    <!-- Header -->
    <header class="header">
      <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
        <span style="font-size: 24px;">🏔️</span>
        <div>
          <div class="header-title">Japan Adventure</div>
          <div class="header-subtitle">Tokyo • Kyoto • Osaka</div>
        </div>
        <span style="font-size: 24px;">🌸</span>
      </div>
    </header>

    <!-- Main Content -->
    <main class="content">
      <!-- Today View -->
      <div id="today-view">
        <div id="day-content">
          <!-- Day content will be populated dynamically -->
        </div>
      </div>
      
      <!-- Overview View -->
      <div id="overview-view" class="content hidden">
        <!-- Overview content will be populated here -->
      </div>
      
      <!-- Budget View -->
      <div id="budget-view" class="content hidden">
        <!-- Budget content will be populated here -->
      </div>
      
      <!-- Currency View -->
      <div id="currency-view" class="content hidden">
        <!-- Currency content will be populated here -->
      </div>
    </main>

    <!-- Day Navigation -->
    <div class="day-nav">
      <button class="day-nav-button" onclick="previousDay()" id="prev-day">
        ←
      </button>
      <div class="day-nav-center" onclick="toggleDatePicker()" style="cursor: pointer;">
        <div class="day-nav-date" id="current-date">Monday, July 14</div>
        <div class="day-nav-day" id="current-day">Day 1 of 11</div>
      </div>
      <button class="day-nav-button" onclick="nextDay()" id="next-day">
        →
      </button>
    </div>

    <!-- Date Picker Tray -->
    <div class="date-picker-tray" id="date-picker-tray">
      <div class="tray-header">
        Select Trip Day
      </div>
      <div class="date-list" id="date-list">
        <!-- Date items will be populated by JavaScript -->
      </div>
    </div>

    <!-- Version History Modal -->
    <div class="version-modal" id="version-modal">
      <div class="version-content">
        <div class="version-header">
          <button class="version-close" onclick="closeVersionHistory()">×</button>
          <h2 class="version-title">🇯🇵 Japan Travel App</h2>
          <p class="version-subtitle">Version History & Release Notes</p>
        </div>
        <div class="version-list" id="version-history-list">
          <!-- Version history will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <button class="nav-button active" onclick="showView('today')" id="nav-today">
        <span class="nav-icon">📅</span>
        Today
      </button>
      <button class="nav-button" onclick="showView('overview')" id="nav-overview">
        <span class="nav-icon">📍</span>
        Overview
      </button>
      <button class="nav-button" onclick="showView('budget')" id="nav-budget">
        <span class="nav-icon">💰</span>
        Budget
      </button>
      <button class="nav-button" onclick="showView('currency')" id="nav-currency">
        <span class="nav-icon">💱</span>
        Currency
      </button>
    </div>
  </div>

  <script>
    // App version
    const APP_VERSION = 'v1.4.0.20250111';
    
    // Weather API Configuration
    // SETUP: Replace 'YOUR_API_KEY_HERE' with your OpenWeatherMap API key
    const WEATHER_CONFIG = {
      apiKey: '30812f90aa07f58d0028e8649f21e58a',
      baseUrl: 'https://api.openweathermap.org/data/2.5/',
      updateInterval: 30 * 60 * 1000, // 30 minutes
      cache: {
        duration: 15 * 60 * 1000, // 15 minutes
        key: 'japan_weather_cache'
      }
    };
    
    // Transit API Configuration
    // SETUP: Add your Google Maps API key here
    const TRANSIT_CONFIG = {
      apiKey: 'AIzaSyAhuKHxeg8f-OVpS1o50pwBGHCDcBa0pxk',
      baseUrl: 'https://maps.googleapis.com/maps/api/directions/json',
      cache: {
        duration: 5 * 60 * 1000, // 5 minutes for transit data
        key: 'japan_transit_cache'
      }
    };
    
    // City coordinates for weather API
    const CITY_COORDINATES = {
      'Tokyo': { lat: 35.6762, lon: 139.6503 },
      'Kyoto': { lat: 35.0116, lon: 135.7681 },
      'Osaka': { lat: 34.6937, lon: 135.5023 }
    };
    
    // Weather icons mapping
    const WEATHER_ICONS = {
      'clear': '☀️',
      'clouds': '☁️',
      'rain': '🌧️',
      'drizzle': '🌦️',
      'thunderstorm': '⛈️',
      'snow': '❄️',
      'mist': '🌫️',
      'fog': '🌫️',
      'haze': '🌫️'
    };
    
    // Comprehensive version history
    const VERSION_HISTORY = [
      {
        version: 'v1.1.1.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'fixed', text: 'Version history modal access - entire version tile now clickable' },
          { type: 'improved', text: 'Enhanced version tile with touch feedback and visual cues' },
          { type: 'improved', text: 'Added tap indicator and mobile-optimized interactions' }
        ]
      },
      {
        version: 'v1.1.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Interactive date picker tray with slide-up animation' },
          { type: 'added', text: 'Quick day selection by tapping date in navigation bar' },
          { type: 'added', text: 'Comprehensive version history library with modal access' },
          { type: 'improved', text: 'Visual indicators for current day and actual "today"' },
          { type: 'improved', text: 'Enhanced mobile UX with smooth transitions' }
        ]
      },
      {
        version: 'v1.0.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Smart "Today" button navigation based on actual trip dates' },
          { type: 'added', text: 'Automatic current day detection (July 14-24, 2025)' },
          { type: 'added', text: 'Real-time "TODAY" indicator in day navigation' },
          { type: 'improved', text: 'App initialization starts on current trip day' },
          { type: 'improved', text: 'Enhanced debug logging for date calculations' }
        ]
      },
      {
        version: 'v0.95.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Apple Maps integration for all location links' },
          { type: 'fixed', text: 'Address validation: Hyatt House Shibuya, Caption by Hyatt Namba' },
          { type: 'fixed', text: 'Restaurant address corrections: Uobei Shibuya Dogenzaka' },
          { type: 'added', text: 'Comprehensive location database with 35+ verified addresses' },
          { type: 'improved', text: 'Native iOS map experience with precise navigation' }
        ]
      },
      {
        version: 'v0.9.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Clickable map links for hotels, restaurants, and attractions' },
          { type: 'added', text: 'Address display with pin emoji for all locations' },
          { type: 'added', text: 'Restaurant validation: Numazuko closure handling' },
          { type: 'improved', text: 'Location database with verified addresses' },
          { type: 'improved', text: 'Enhanced navigation to all trip destinations' }
        ]
      },
      {
        version: 'v0.8.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Sticky header and dual footer layout design' },
          { type: 'added', text: 'Text size adjustment with collapsible "A" button' },
          { type: 'added', text: 'Working Overview and Budget navigation' },
          { type: 'added', text: 'Comprehensive Budget breakdown ($916-1,252 total)' },
          { type: 'added', text: 'Cultural highlights and trip overview content' },
          { type: 'fixed', text: 'Text size CSS variables implementation' },
          { type: 'fixed', text: 'Bottom navigation functionality restored' }
        ]
      },
      {
        version: 'v0.7.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Complete Days 6-11 with enhanced CLAUDE.md structure' },
          { type: 'added', text: 'Kyoto temple experiences and bamboo grove visits' },
          { type: 'added', text: 'Osaka culinary adventures with street food marathon' },
          { type: 'added', text: 'LGBTQ+ nightlife venues in all cities' },
          { type: 'added', text: 'Premium rooftop bars and city views' },
          { type: 'improved', text: 'Cultural etiquette sections for all activities' },
          { type: 'improved', text: 'Multiple restaurant options with detailed descriptions' }
        ]
      },
      {
        version: 'v0.6.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Enhanced Days 1-5 with complete activity details' },
          { type: 'added', text: 'Festival integration: Mitama Matsuri and Gion Matsuri' },
          { type: 'added', text: 'teamLab Planets and Mario Kart Tokyo experiences' },
          { type: 'added', text: 'EDM club recommendations: WOMB Shibuya' },
          { type: 'added', text: 'Traditional cultural experiences and etiquette guides' },
          { type: 'fixed', text: 'Chronological activity ordering (morning to evening)' },
          { type: 'improved', text: 'Comprehensive "What to Do" and "What to Expect" sections' }
        ]
      },
      {
        version: 'v0.5.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Dynamic day navigation with previous/next arrows' },
          { type: 'added', text: 'Complete trip data structure for all 11 days' },
          { type: 'added', text: 'Activity type categorization with color coding' },
          { type: 'added', text: 'Cost summaries and budget tracking' },
          { type: 'fixed', text: 'Mobile browser compatibility (no external dependencies)' },
          { type: 'fixed', text: 'Day 1 static content loading issue' },
          { type: 'improved', text: 'Activity card design with enhanced visual hierarchy' }
        ]
      },
      {
        version: 'v0.4.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Weather advisory system with dynamic display' },
          { type: 'added', text: 'Loading screen with progress indicators' },
          { type: 'added', text: 'Debug logging system for troubleshooting' },
          { type: 'improved', text: 'Mobile responsiveness and touch optimization' },
          { type: 'improved', text: 'iOS web app meta tags and optimizations' }
        ]
      },
      {
        version: 'v0.3.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Basic 11-day Japan itinerary structure' },
          { type: 'added', text: 'Hotel information: Hyatt House, Hyatt Place, Caption by Hyatt' },
          { type: 'added', text: 'Restaurant recommendations with pricing' },
          { type: 'added', text: 'Transportation details and costs' },
          { type: 'improved', text: 'Daily activity organization and timing' }
        ]
      },
      {
        version: 'v0.2.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Mobile-first responsive design' },
          { type: 'added', text: 'CSS gradient backgrounds and modern styling' },
          { type: 'added', text: 'Bottom navigation bar' },
          { type: 'improved', text: 'Touch-friendly interface elements' }
        ]
      },
      {
        version: 'v0.1.20250110',
        date: 'January 10, 2025',
        changes: [
          { type: 'added', text: 'Initial app framework and structure' },
          { type: 'added', text: 'Basic HTML/CSS/JavaScript foundation' },
          { type: 'added', text: 'App versioning system implementation' }
        ]
      }
    ];
    
    // Location database with addresses for map links
    const locationDatabase = {
      // Hotels
      'Hyatt House Shibuya': {
        address: '3-3 Sakuragaoka-cho, Shibuya City, Tokyo 150-0031, Japan',
        type: 'hotel'
      },
      'Hyatt Place Kyoto': {
        address: '644-2 Sannenzaka, Higashiyama Ward, Kyoto 605-0862, Japan',
        type: 'hotel'
      },
      'Caption by Hyatt Namba': {
        address: '2-7-5 Nippombashi, Chuo Ward, Osaka 542-0073, Japan',
        type: 'hotel'
      },
      
      // Major Attractions
      'Shibuya Crossing': {
        address: '2-2-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'attraction'
      },
      'Meiji Shrine': {
        address: '1-1 Kamizono-cho, Shibuya City, Tokyo 151-8557, Japan',
        type: 'shrine'
      },
      'Sensoji Temple': {
        address: '2-3-1 Asakusa, Taito City, Tokyo 111-0032, Japan',
        type: 'temple'
      },
      'Tokyo National Museum': {
        address: '13-9 Uenokoen, Taito City, Tokyo 110-8712, Japan',
        type: 'museum'
      },
      'Fushimi Inari Shrine': {
        address: '68 Fukakusa Yabunouchicho, Fushimi Ward, Kyoto 612-0882, Japan',
        type: 'shrine'
      },
      'Arashiyama Bamboo Grove': {
        address: 'Arashiyama Sagatenryuji Susukinobabacho, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'attraction'
      },
      'Gion District': {
        address: 'Gion, Higashiyama Ward, Kyoto 605-0001, Japan',
        type: 'district'
      },
      'Nijo Castle': {
        address: '541 Nijojocho, Nakagyo Ward, Kyoto 604-8301, Japan',
        type: 'castle'
      },
      'Osaka Castle': {
        address: '1-1 Osakajo, Chuo Ward, Osaka 540-0002, Japan',
        type: 'castle'
      },
      'Dotonbori': {
        address: 'Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'district'
      },
      
      // Transportation
      'Haneda Airport': {
        address: '3-3-2 Hanedakuko, Ota City, Tokyo 144-0041, Japan',
        type: 'airport'
      },
      'Shibuya Station': {
        address: '2-24-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'station'
      },
      'Tokyo Station': {
        address: '1-1 Marunouchi, Chiyoda City, Tokyo 100-0005, Japan',
        type: 'station'
      },
      'Kyoto Station': {
        address: 'Higashishiokoji-cho, Shimogyo Ward, Kyoto 600-8216, Japan',
        type: 'station'
      },
      
      // Restaurants
      'Uobei Shibuya Dogenzaka': {
        address: '2-29-11 Dogenzaka, Shibuya City, Tokyo 150-0043, Japan',
        type: 'restaurant'
      },
      'Numazuko Sushi (Tokyo Station)': {
        address: '3-34-16 Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'restaurant'
      },
      'Seamon Ginza': {
        address: '4-14-16 Ginza, Chuo City, Tokyo 104-0061, Japan',
        type: 'restaurant'
      },
      'Nakiryu': {
        address: '2-34-4 Minamiikebukuro, Toshima City, Tokyo 171-0022, Japan',
        type: 'restaurant'
      },
      'Nakiryu (Otsuka)': {
        address: '2-34-4 Minamiikebukuro, Toshima City, Tokyo 171-0022, Japan',
        type: 'restaurant'
      },
      'Katsukura Kyoto Station': {
        address: 'Kyoto Station Building, 901 Higashishiokoji-cho, Shimogyo Ward, Kyoto 600-8216, Japan',
        type: 'restaurant'
      },
      'Wanaka': {
        address: '1-4-16 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      'Takoyaki at Wanaka': {
        address: '1-4-16 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      'Mizuno': {
        address: '1-4-15 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      'Okonomiyaki at Mizuno': {
        address: '1-4-15 Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'restaurant'
      },
      
      // More Restaurants
      'Ganko Sushi': {
        address: '6-4-12 Ginza, Chuo City, Tokyo 104-0061, Japan',
        type: 'restaurant'
      },
      'Kura Sushi Shibuya': {
        address: '28-6 Udagawacho, Shibuya City, Tokyo 150-0042, Japan',
        type: 'restaurant'
      },
      'Ichiran Ramen Shibuya': {
        address: '1-22-7 Jinnan, Shibuya City, Tokyo 150-0041, Japan',
        type: 'restaurant'
      },
      'Ramen Break Beats': {
        address: '1-5-8 Meguro, Meguro City, Tokyo 153-0063, Japan',
        type: 'restaurant'
      },
      'Konjiki Hototogisu': {
        address: '1-17-1 Kabukicho, Shinjuku City, Tokyo 160-0021, Japan',
        type: 'restaurant'
      },
      'Kyoto Station Ramen Koji': {
        address: 'Kyoto Station Building 10F, 901 Higashishiokoji-cho, Shimogyo Ward, Kyoto 600-8216, Japan',
        type: 'restaurant'
      },
      'Yudofu Sagano': {
        address: '45 Saga Tenryuji Susukinobabacho, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'restaurant'
      },
      'Daruma Kushikatsu': {
        address: '1-8-25 Shinsekai, Naniwa Ward, Osaka 556-0002, Japan',
        type: 'restaurant'
      },
      
      // More Attractions
      'Shibuya Sky': {
        address: '2-24-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'attraction'
      },
      'Yasukuni Shrine': {
        address: '3-1-1 Kudanminami, Chiyoda City, Tokyo 102-8246, Japan',
        type: 'shrine'
      },
      'Imperial Palace East Gardens': {
        address: '1-1 Chiyoda, Chiyoda City, Tokyo 100-8111, Japan',
        type: 'attraction'
      },
      'Ueno Park': {
        address: 'Uenokoen, Taito City, Tokyo 110-0007, Japan',
        type: 'park'
      },
      'Tokyo Tower': {
        address: '4-2-8 Shibakoen, Minato City, Tokyo 105-0011, Japan',
        type: 'attraction'
      },
      'teamLab Planets': {
        address: '6-1-16 Toyosu, Koto City, Tokyo 135-0061, Japan',
        type: 'museum'
      },
      'Tenryu-ji Temple': {
        address: '68 Saga Tenryuji Susukinobabacho, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'temple'
      },
      'Yasaka Shrine': {
        address: '625 Gionmachi Kitagawa, Higashiyama Ward, Kyoto 605-0073, Japan',
        type: 'shrine'
      },
      'Nishiki Market': {
        address: '604 Nishiki-koji Dori, Nakagyo Ward, Kyoto 604-8054, Japan',
        type: 'market'
      },
      
      // Districts
      'Harajuku': {
        address: 'Harajuku, Shibuya City, Tokyo 150-0001, Japan',
        type: 'district'
      },
      'Asakusa': {
        address: 'Asakusa, Taito City, Tokyo 111-0032, Japan',
        type: 'district'
      },
      'Shinjuku': {
        address: 'Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'district'
      },
      'Ginza': {
        address: 'Ginza, Chuo City, Tokyo 104-0061, Japan',
        type: 'district'
      },
      'Shibuya': {
        address: 'Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'district'
      },
      'Arashiyama': {
        address: 'Arashiyama, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'district'
      },
      'Higashiyama': {
        address: 'Higashiyama Ward, Kyoto 605-0000, Japan',
        type: 'district'
      },
      'Namba': {
        address: 'Namba, Chuo Ward, Osaka 542-0076, Japan',
        type: 'district'
      },
      
      // Nightlife
      'WOMB Shibuya': {
        address: '2-16 Maruyamacho, Shibuya City, Tokyo 150-0044, Japan',
        type: 'nightlife'
      },
      'Shinjuku Golden Gai': {
        address: '1-1-6 Kabukicho, Shinjuku City, Tokyo 160-0021, Japan',
        type: 'nightlife'
      },
      'Ni-chome': {
        address: '2-chome Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'district'
      },
      'CÉ LA VI Tokyo': {
        address: '6-10-1 Roppongi, Minato City, Tokyo 106-6108, Japan',
        type: 'nightlife'
      },
      'Andaz Tokyo Rooftop': {
        address: '1-23-4 Toranomon, Minato City, Tokyo 105-0001, Japan',
        type: 'nightlife'
      },
      'K36 Rooftop Bar': {
        address: '36 Kodonocho, Higashiyama Ward, Kyoto 605-0921, Japan',
        type: 'nightlife'
      },
      
      // Additional Restaurants
      'Ganko Ramen (Tokyo Station)': {
        address: 'B1F Yaesu South Exit, Tokyo Station, Chiyoda City, Tokyo 100-0005, Japan',
        type: 'restaurant'
      },
      'Hanasaki Manjiro (Higashiyama)': {
        address: '518 Washiocho, Higashiyama Ward, Kyoto 605-0072, Japan',
        type: 'restaurant'
      },
      'Kushikatsu at Daruma': {
        address: '1-8-25 Shinsekai, Naniwa Ward, Osaka 556-0002, Japan',
        type: 'restaurant'
      },
      'Rengetsu-jaya (Higashiyama)': {
        address: 'Higashiyama Ward, Kyoto 605-0862, Japan',
        type: 'restaurant'
      },
      'Tousuiro (Gion or Nakagyo location)': {
        address: 'Gion, Higashiyama Ward, Kyoto 605-0001, Japan',
        type: 'restaurant'
      },
      'Yudofu Sagano (Arashiyama)': {
        address: '45 Susukinobana-cho, SagaTenryu-ji, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'restaurant'
      },
      'Yudofu Sagano': {
        address: '45 Susukinobana-cho, SagaTenryu-ji, Ukyo Ward, Kyoto 616-8385, Japan',
        type: 'restaurant'
      },
      
      // Additional locations from activities
      'Haneda Airport → Shibuya': {
        address: '2-24-1 Shibuya, Shibuya City, Tokyo 150-0002, Japan',
        type: 'route'
      },
      'Shinjuku Ni-chome': {
        address: '2-chome Shinjuku, Shinjuku City, Tokyo 160-0022, Japan',
        type: 'district'
      },
      'Central Kyoto': {
        address: 'Nakagyo Ward, Kyoto 604-8006, Japan',
        type: 'district'
      },
      'Dotonbori area': {
        address: 'Dotonbori, Chuo Ward, Osaka 542-0071, Japan',
        type: 'district'
      }
    };
    
    // Weather API Functions
    class WeatherCache {
      static isValid(timestamp) {
        return Date.now() - timestamp < WEATHER_CONFIG.cache.duration;
      }
      
      static save(city, data) {
        try {
          localStorage.setItem(`weather_${city}`, JSON.stringify({
            data,
            timestamp: Date.now()
          }));
        } catch (error) {
          console.warn('Weather cache save failed:', error);
        }
      }
      
      static load(city) {
        try {
          const cached = localStorage.getItem(`weather_${city}`);
          if (cached) {
            const parsed = JSON.parse(cached);
            if (this.isValid(parsed.timestamp)) {
              return parsed.data;
            }
          }
        } catch (error) {
          console.warn('Weather cache load failed:', error);
        }
        return null;
      }
    }
    
    async function getCurrentWeather(city) {
      if (!WEATHER_CONFIG.apiKey || WEATHER_CONFIG.apiKey === 'YOUR_API_KEY_HERE') {
        throw new Error('Weather API key not configured');
      }
      
      const coords = CITY_COORDINATES[city];
      if (!coords) {
        throw new Error(`No coordinates found for city: ${city}`);
      }
      
      const url = `${WEATHER_CONFIG.baseUrl}weather?lat=${coords.lat}&lon=${coords.lon}&appid=${WEATHER_CONFIG.apiKey}&units=metric`;
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Weather API error: ${response.status}`);
      }
      
      return response.json();
    }
    
    async function getWeatherWithFallback(city) {
      try {
        // Try cache first
        const cached = WeatherCache.load(city);
        if (cached) {
          addDebugLog(`☁️ Using cached weather for ${city}`, 'info');
          return cached;
        }
        
        // Fetch fresh data
        addDebugLog(`🌐 Fetching live weather for ${city}`, 'info');
        const weather = await getCurrentWeather(city);
        WeatherCache.save(city, weather);
        addDebugLog(`✅ Live weather loaded for ${city}`, 'success');
        return weather;
      } catch (error) {
        addDebugLog(`❌ Weather API error: ${error.message}`, 'error');
        console.error('Weather API error:', error);
        // Fall back to static weather data
        return getStaticWeatherData(city);
      }
    }
    
    function getStaticWeatherData(city) {
      // Fallback weather data for July in Japan
      return {
        main: {
          temp: 30,
          feels_like: 35,
          humidity: 78,
          temp_min: 28,
          temp_max: 32
        },
        weather: [{
          main: 'Clear',
          description: 'hot and humid',
          icon: '01d'
        }],
        name: city,
        isStatic: true
      };
    }
    
    function getWeatherIcon(weatherMain) {
      const main = weatherMain.toLowerCase();
      return WEATHER_ICONS[main] || '🌤️';
    }
    
    function createWeatherDisplay(weatherData, includeDetails = true) {
      const icon = getWeatherIcon(weatherData.weather[0].main);
      const isStatic = weatherData.isStatic;
      const staticIndicator = isStatic ? ' (estimated)' : '';
      
      if (!includeDetails) {
        return `${icon} ${Math.round(weatherData.main.temp)}°C${staticIndicator}`;
      }
      
      return `
        <div style="display: flex; align-items: center; gap: 8px; font-size: var(--base-text);">
          <span style="font-size: var(--medium-text);">${icon}</span>
          <div>
            <div style="font-weight: 600;">${Math.round(weatherData.main.temp)}°C (feels like ${Math.round(weatherData.main.feels_like)}°C)${staticIndicator}</div>
            <div style="font-size: var(--small-text); opacity: 0.8;">${weatherData.weather[0].description} • ${weatherData.main.humidity}% humidity</div>
          </div>
        </div>
      `;
    }
    
    function getWeatherRecommendation(weatherData) {
      const temp = weatherData.main.temp;
      const humidity = weatherData.main.humidity;
      const condition = weatherData.weather[0].main.toLowerCase();
      
      if (condition.includes('rain') || condition.includes('drizzle')) {
        return {
          type: 'rain',
          icon: '☔',
          message: 'Rain expected - consider indoor activities like museums, shopping centers, or covered markets'
        };
      }
      
      if (condition.includes('thunderstorm')) {
        return {
          type: 'storm',
          icon: '⛈️',
          message: 'Thunderstorms possible - stay indoors and avoid outdoor sightseeing'
        };
      }
      
      if (temp > 32 || (temp > 28 && humidity > 75)) {
        return {
          type: 'heat',
          icon: '🌡️',
          message: 'Very hot and humid - stay hydrated, seek air conditioning, and plan outdoor activities for early morning or evening'
        };
      }
      
      if (temp > 28) {
        return {
          type: 'warm',
          icon: '☀️',
          message: 'Hot weather - stay hydrated and take breaks in air-conditioned spaces'
        };
      }
      
      return {
        type: 'good',
        icon: '✨',
        message: 'Great weather for outdoor activities!'
      };
    }
    
    // Transit API Functions
    class TransitCache {
      static isValid(timestamp) {
        return Date.now() - timestamp < TRANSIT_CONFIG.cache.duration;
      }
      
      static save(routeKey, data) {
        try {
          localStorage.setItem(`transit_${routeKey}`, JSON.stringify({
            data,
            timestamp: Date.now()
          }));
        } catch (error) {
          console.warn('Transit cache save failed:', error);
        }
      }
      
      static load(routeKey) {
        try {
          const cached = localStorage.getItem(`transit_${routeKey}`);
          if (cached) {
            const parsed = JSON.parse(cached);
            if (this.isValid(parsed.timestamp)) {
              return parsed.data;
            }
          }
        } catch (error) {
          console.warn('Transit cache load failed:', error);
        }
        return null;
      }
    }
    
    async function getMultiModalDirections(origin, destination) {
      if (!TRANSIT_CONFIG.apiKey || TRANSIT_CONFIG.apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
        throw new Error('Google Maps API key not configured');
      }
      
      // Create route key for caching
      const routeKey = `${origin}_to_${destination}`.replace(/[^a-zA-Z0-9]/g, '_');
      
      // Check cache first
      const cached = TransitCache.load(routeKey);
      if (cached) {
        addDebugLog(`🚆 Using cached multi-modal data for ${origin} → ${destination}`, 'info');
        return cached;
      }
      
      // Get multiple transportation modes
      const modes = ['walking', 'transit', 'driving'];
      const results = {};
      
      for (const mode of modes) {
        try {
          const params = new URLSearchParams({
            origin: origin,
            destination: destination,
            mode: mode,
            departure_time: 'now',
            key: TRANSIT_CONFIG.apiKey,
            language: 'en',
            region: 'jp'
          });
          
          const url = `${TRANSIT_CONFIG.baseUrl}?${params}`;
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
          
          const response = await fetch(proxyUrl);
          if (response.ok) {
            const data = await response.json();
            if (data.routes && data.routes.length > 0) {
              results[mode] = data;
            }
          }
        } catch (error) {
          console.warn(`Failed to get ${mode} directions:`, error);
        }
      }
      
      // Cache the result
      TransitCache.save(routeKey, results);
      
      return results;
    }
    
    async function getTransitWithFallback(origin, destination) {
      try {
        addDebugLog(`🚆 Fetching multi-modal transit: ${origin} → ${destination}`, 'info');
        const multiModalData = await getMultiModalDirections(origin, destination);
        addDebugLog(`✅ Multi-modal transit data loaded`, 'success');
        return parseMultiModalData(multiModalData);
      } catch (error) {
        addDebugLog(`❌ Transit API error: ${error.message}`, 'error');
        console.error('Transit API error:', error);
        // Fall back to static transit data
        return getStaticMultiModalData(origin, destination);
      }
    }
    
    function parseMultiModalData(multiModalData) {
      const options = [];
      
      // Parse walking
      if (multiModalData.walking) {
        const walkingRoute = multiModalData.walking.routes[0];
        const walkingLeg = walkingRoute.legs[0];
        options.push({
          mode: 'walking',
          icon: '🚶',
          duration: walkingLeg.duration.text,
          distance: walkingLeg.distance.text,
          description: 'Walking route',
          isLive: true
        });
      }
      
      // Parse transit
      if (multiModalData.transit) {
        const transitRoute = multiModalData.transit.routes[0];
        const transitLeg = transitRoute.legs[0];
        const transitSteps = transitLeg.steps.filter(step => step.travel_mode === 'TRANSIT');
        
        options.push({
          mode: 'transit',
          icon: '🚆',
          duration: transitLeg.duration.text,
          distance: transitLeg.distance.text,
          departure_time: transitLeg.departure_time?.text || 'Now',
          arrival_time: transitLeg.arrival_time?.text || 'Unknown',
          steps: transitSteps.map(step => ({
            line: step.transit_details?.line?.short_name || step.transit_details?.line?.name || 'Train',
            departure_stop: step.transit_details?.departure_stop?.name || 'Unknown',
            arrival_stop: step.transit_details?.arrival_stop?.name || 'Unknown',
            departure_time: step.transit_details?.departure_time?.text || 'Unknown',
            num_stops: step.transit_details?.num_stops || 0
          })),
          fare: transitRoute.fare?.text || null,
          description: `${transitSteps.length} transit step${transitSteps.length > 1 ? 's' : ''}`,
          isLive: true
        });
      }
      
      // Parse driving (taxi)
      if (multiModalData.driving) {
        const drivingRoute = multiModalData.driving.routes[0];
        const drivingLeg = drivingRoute.legs[0];
        options.push({
          mode: 'driving',
          icon: '🚕',
          duration: drivingLeg.duration.text,
          distance: drivingLeg.distance.text,
          description: 'Taxi/ride-sharing',
          estimatedCost: estimateTaxiCost(drivingLeg.distance.value, drivingLeg.duration.value),
          isLive: true
        });
      }
      
      return options;
    }
    
    function estimateTaxiCost(distanceMeters, durationSeconds) {
      // Tokyo taxi rates (approximate): ¥410 initial + ¥80 per 280m or 90 seconds
      const initialFare = 410;
      const additionalUnits = Math.max(
        Math.ceil(distanceMeters / 280), 
        Math.ceil(durationSeconds / 90)
      ) - 1;
      const totalYen = initialFare + (additionalUnits * 80);
      const totalUSD = totalYen * 0.007; // Approximate conversion
      
      return {
        yen: `¥${totalYen.toLocaleString()}`,
        usd: `$${totalUSD.toFixed(2)}`
      };
    }
    
    function getStaticMultiModalData(origin, destination) {
      // Estimate distances for common Tokyo routes
      const estimatedDistance = estimateDistance(origin, destination);
      
      // More realistic timing calculations
      let walkingTime, transitTime, taxiTime;
      
      if (estimatedDistance >= 50) { // Inter-city (bullet train routes)
        walkingTime = 999; // Not walkable
        transitTime = Math.ceil(estimatedDistance / 5); // ~300 km/h average including stops
        taxiTime = Math.ceil(estimatedDistance / 1.2); // ~70 km/h highway average
      } else if (estimatedDistance >= 10) { // Long distance within city
        walkingTime = Math.ceil(estimatedDistance * 12); // 5 km/h walking speed
        transitTime = Math.max(15, Math.ceil(estimatedDistance * 3.5 + 10)); // Transit + waiting time
        taxiTime = Math.max(15, Math.ceil(estimatedDistance * 2.5 + 5)); // Traffic + pickup time
      } else { // Local neighborhood travel
        walkingTime = Math.max(3, Math.ceil(estimatedDistance * 12)); // 5 km/h walking
        transitTime = Math.max(8, Math.ceil(estimatedDistance * 4 + 8)); // Local trains + walking to stations
        taxiTime = Math.max(5, Math.ceil(estimatedDistance * 4 + 3)); // City traffic
      }
      
      const options = [];
      
      // Walking option (if reasonable distance)
      if (walkingTime < 120) { // Less than 2 hours
        options.push({
          mode: 'walking',
          icon: '🚶',
          duration: `${walkingTime} min`,
          distance: `${estimatedDistance.toFixed(1)} km`,
          description: walkingTime <= 20 ? 'Pleasant walk' : walkingTime <= 45 ? 'Long walk' : 'Very long walk',
          isLive: false
        });
      }
      
      // Transit option
      const transitIcon = estimatedDistance >= 50 ? '🚄' : estimatedDistance >= 10 ? '🚆' : '🚇';
      const transitDesc = estimatedDistance >= 50 ? 'Bullet train' : estimatedDistance >= 10 ? 'Express train' : 'Local train/subway';
      const transitFare = estimatedDistance >= 50 ? 
        Math.ceil(estimatedDistance * 25) : // Bullet train pricing
        Math.max(150, Math.ceil(estimatedDistance * 180)); // Local transit
      
      options.push({
        mode: 'transit',
        icon: transitIcon,
        duration: `${transitTime} min`,
        distance: `${estimatedDistance.toFixed(1)} km`,
        description: transitDesc,
        fare: `¥${transitFare.toLocaleString()}`,
        isLive: false
      });
      
      // Taxi option (if reasonable for the distance)
      if (estimatedDistance < 50) { // Don't suggest taxi for inter-city
        const taxiCost = estimatedDistance >= 10 ? 
          Math.ceil(estimatedDistance * 800) : // Long distance taxi
          Math.max(500, Math.ceil(estimatedDistance * 600)); // Local taxi
        
        options.push({
          mode: 'driving',
          icon: '🚕',
          duration: `${taxiTime} min`,
          distance: `${estimatedDistance.toFixed(1)} km`,
          description: estimatedDistance >= 10 ? 'Long taxi ride' : 'Taxi/ride-sharing',
          estimatedCost: {
            yen: `¥${taxiCost.toLocaleString()}`,
            usd: `$${(taxiCost * 0.007).toFixed(2)}`
          },
          isLive: false
        });
      }
      
      return options;
    }
    
    function estimateDistance(origin, destination) {
      // Enhanced distance estimation for Tokyo neighborhoods and regions
      const distances = {
        // Tokyo neighborhoods - precise distances
        'shibuya_to_harajuku': 1.2,
        'shibuya_to_meiji': 1.5,
        'harajuku_to_meiji': 0.3,
        'shibuya_to_ginza': 3.5,
        'shibuya_to_shinjuku': 2.1,
        'shibuya_to_asakusa': 8.5,
        'shibuya_to_ueno': 7.2,
        'shibuya_to_akihabara': 6.8,
        'shibuya_to_tsukiji': 4.3,
        'ginza_to_tsukiji': 1.8,
        'ginza_to_asakusa': 5.2,
        'ginza_to_tokyo_station': 1.2,
        'harajuku_to_shinjuku': 1.8,
        'harajuku_to_akihabara': 5.9,
        'shinjuku_to_asakusa': 7.8,
        'shinjuku_to_akihabara': 4.2,
        'asakusa_to_ueno': 2.1,
        'asakusa_to_akihabara': 3.5,
        'ueno_to_akihabara': 1.8,
        'tokyo_station_to_asakusa': 4.1,
        'tokyo_station_to_ginza': 1.2,
        'tokyo_station_to_shinjuku': 3.8,
        
        // Inter-city distances
        'tokyo_to_kyoto': 475,
        'kyoto_to_osaka': 55,
        'osaka_to_itami': 15,
        'osaka_to_namba': 2.1,
        'kyoto_to_namba': 57,
        
        // Kyoto neighborhoods
        'kyoto_station_to_gion': 3.2,
        'kyoto_station_to_fushimi': 8.5,
        'kyoto_station_to_arashiyama': 12.1,
        'gion_to_fushimi': 6.8,
        'gion_to_arashiyama': 9.5,
        'fushimi_to_arashiyama': 15.2,
        
        // Osaka neighborhoods  
        'osaka_station_to_dotonbori': 2.8,
        'osaka_station_to_namba': 2.1,
        'namba_to_dotonbori': 0.4,
        'osaka_station_to_shinsekai': 3.5,
        'namba_to_shinsekai': 1.2
      };
      
      // Normalize location names for comparison
      const normalizeLocation = (loc) => {
        return loc.toLowerCase()
          .replace(/[^a-z]/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '');
      };
      
      const normOrigin = normalizeLocation(origin);
      const normDest = normalizeLocation(destination);
      
      // Direct route lookup
      const directRoute = `${normOrigin}_to_${normDest}`;
      const reverseRoute = `${normDest}_to_${normOrigin}`;
      
      if (distances[directRoute]) return distances[directRoute];
      if (distances[reverseRoute]) return distances[reverseRoute];
      
      // Partial matching with neighborhoods
      for (const [route, dist] of Object.entries(distances)) {
        const [routeOrigin, routeDest] = route.split('_to_');
        
        // Check if either origin or destination contains the route components
        if ((normOrigin.includes(routeOrigin) || routeOrigin.includes(normOrigin)) &&
            (normDest.includes(routeDest) || routeDest.includes(normDest))) {
          return dist;
        }
        
        // Check reverse
        if ((normOrigin.includes(routeDest) || routeDest.includes(normOrigin)) &&
            (normDest.includes(routeOrigin) || routeOrigin.includes(normDest))) {
          return dist;
        }
      }
      
      // City-level estimates based on keywords
      if (isIntercityRoute(origin, destination)) {
        return 400; // Default for inter-city
      }
      
      if (isIntraKyoto(origin, destination)) {
        return 5.0; // Average Kyoto distance
      }
      
      if (isIntraOsaka(origin, destination)) {
        return 3.0; // Average Osaka distance
      }
      
      // Default Tokyo area estimate
      return 2.5;
    }
    
    function isIntercityRoute(origin, destination) {
      const cities = ['tokyo', 'kyoto', 'osaka'];
      const origCity = getCityFromLocation(origin);
      const destCity = getCityFromLocation(destination);
      return origCity !== destCity && cities.includes(origCity) && cities.includes(destCity);
    }
    
    function isIntraKyoto(origin, destination) {
      return getCityFromLocation(origin) === 'kyoto' && getCityFromLocation(destination) === 'kyoto';
    }
    
    function isIntraOsaka(origin, destination) {
      return getCityFromLocation(origin) === 'osaka' && getCityFromLocation(destination) === 'osaka';
    }
    
    function getCityFromLocation(location) {
      const loc = location.toLowerCase();
      if (loc.includes('kyoto') || loc.includes('gion') || loc.includes('fushimi') || loc.includes('arashiyama')) {
        return 'kyoto';
      }
      if (loc.includes('osaka') || loc.includes('namba') || loc.includes('dotonbori') || loc.includes('shinsekai')) {
        return 'osaka';
      }
      if (loc.includes('tokyo') || loc.includes('shibuya') || loc.includes('shinjuku') || 
          loc.includes('ginza') || loc.includes('harajuku') || loc.includes('asakusa') ||
          loc.includes('ueno') || loc.includes('akihabara')) {
        return 'tokyo';
      }
      return 'tokyo'; // Default to Tokyo
    }
    
    function createMultiModalDisplay(transitOptions, isDetailed = false) {
      if (!Array.isArray(transitOptions) || transitOptions.length === 0) {
        return '<div style="font-size: var(--small-text);">No transit options available</div>';
      }
      
      const liveIndicator = transitOptions[0].isLive ? '🔴 Live' : '📅 Estimated';
      
      if (!isDetailed) {
        // Show just the fastest option for compact view
        const fastest = transitOptions[0];
        return `${liveIndicator} • ${fastest.duration} • ${fastest.icon} ${fastest.description}`;
      }
      
      // Detailed view with all transportation options
      const optionsHtml = transitOptions.map(option => {
        let costDisplay = '';
        if (option.fare) {
          costDisplay = `<span style="font-weight: 600; color: #059669;">${option.fare}</span>`;
        } else if (option.estimatedCost) {
          costDisplay = `<span style="font-weight: 600; color: #059669;">${option.estimatedCost.yen} (${option.estimatedCost.usd})</span>`;
        } else if (option.mode === 'walking') {
          costDisplay = `<span style="font-weight: 600; color: #059669;">Free</span>`;
        }
        
        let detailsHtml = '';
        if (option.steps && option.steps.length > 0) {
          detailsHtml = `
            <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 4px;">
              ${option.steps.map(step => `
                <div style="font-size: var(--small-text); margin: 2px 0;">
                  <strong>${step.line}</strong>: ${step.departure_stop} → ${step.arrival_stop}
                  <div style="opacity: 0.7;">Departure: ${step.departure_time} • ${step.num_stops} stops</div>
                </div>
              `).join('')}
            </div>
          `;
        }
        
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: var(--medium-text);">${option.icon}</span>
                <div>
                  <div style="font-size: var(--base-text); font-weight: 600;">${option.duration}</div>
                  <div style="font-size: var(--small-text); opacity: 0.8;">${option.distance} • ${option.description}</div>
                </div>
              </div>
              ${detailsHtml}
            </div>
            <div style="text-align: right; margin-left: 12px;">
              ${costDisplay}
            </div>
          </div>
        `;
      }).join('');
      
      return `
        <div style="margin-top: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: var(--small-text); color: #059669; font-weight: 600;">${liveIndicator}</span>
            <span style="font-size: var(--small-text); opacity: 0.7;">Choose your transport</span>
          </div>
          ${optionsHtml}
        </div>
      `;
    }
    
    // Function to create map links (Apple Maps for iOS)
    function createMapLink(locationName, displayName = null) {
      const location = locationDatabase[locationName];
      if (!location) {
        return displayName || locationName;
      }
      
      const display = displayName || locationName;
      const encodedAddress = encodeURIComponent(location.address);
      
      // Use Apple Maps URL scheme for better iOS integration
      const mapUrl = `https://maps.apple.com/?q=${encodedAddress}`;
      
      return `<a href="${mapUrl}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none;"><div style="display: inline-block;"><span style="text-decoration: underline; font-weight: 500;">${display}</span><div style="font-size: 0.8em; color: #6b7280; margin-top: 2px;">📍 ${location.address}</div></div></a>`;
    }
    
    // Debug logging function
    function addDebugLog(message, type = 'info') {
      const debugLog = document.getElementById('debug-log');
      const item = document.createElement('div');
      item.className = 'debug-item';
      if (type === 'success') item.classList.add('success');
      if (type === 'error') item.classList.add('error');
      
      const timestamp = new Date().toLocaleTimeString();
      item.innerHTML = `[${timestamp}] ${message}`;
      debugLog.appendChild(item);
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // Simulate loading steps with delays
    function simulateLoading() {
      addDebugLog('✅ CSS loaded successfully', 'success');
      
      setTimeout(() => {
        addDebugLog('🔄 Checking device compatibility...');
        
        setTimeout(() => {
          addDebugLog('✅ Device compatible', 'success');
          addDebugLog('🔄 Loading itinerary data...');
          
          setTimeout(() => {
            addDebugLog('✅ Itinerary data loaded', 'success');
            addDebugLog('🔄 Preparing interface...');
            
            setTimeout(() => {
              addDebugLog('✅ Interface ready', 'success');
              addDebugLog('🚀 Launching app...');
              
              setTimeout(() => {
                addDebugLog('🎉 App ready - launching interface!', 'success');
                
                // Hide loading screen and show app
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Initialize text size (ensure default is set)
                if (!document.documentElement.getAttribute('data-text-size')) {
                  document.documentElement.setAttribute('data-text-size', 'medium');
                }
                
                addDebugLog('✅ App launched successfully!', 'success');
              }, 500);
            }, 300);
          }, 400);
        }, 300);
      }, 500);
    }

    // Simple loading approach
    document.addEventListener('DOMContentLoaded', function() {
      // Update version display
      try {
        document.getElementById('version-display').textContent = APP_VERSION;
      } catch (e) {
        console.log('Version display not found');
      }
      
      addDebugLog('🔄 DOM loaded', 'success');
      addDebugLog(`📱 Japan Travel App ${APP_VERSION}`, 'info');
      
      // Load text size preference
      try {
        loadTextSizePreference();
      } catch (e) {
        console.log('Text size preference failed');
      }
      
      // Simple 2-second loading, then show app
      addDebugLog('🔄 Loading app...', 'info');
      setTimeout(() => {
        addDebugLog('🎉 Ready to launch!', 'success');
        
        // Hide loading and show app
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        addDebugLog('✅ App launched!', 'success');
      }, 2000);
    });

    // Fallback disabled - using single DOMContentLoaded approach
    // setTimeout(() => {
    //   if (document.getElementById('app').classList.contains('hidden')) {
    //     addDebugLog('⚠️ Fallback loading triggered', 'error');
    //     simulateLoading();
    //   }
    // }, 2000);

    // Complete trip data with all activities from reference itinerary
    const tripDays = [
      {
        date: 'Monday, July 14', 
        title: 'Arrival & Gentle Recovery', 
        city: 'Tokyo',
        weather: 'Hot & humid (29-32°C/84-90°F with 78-83% humidity)',
        weatherAdvisory: 'July is Japan\'s hottest, most humid month. Plan indoor activities during peak heat (11am-4pm)',
        activities: [
          {
            type: 'transport',
            time: '4:30 AM - 7:30 AM',
            title: 'Airport to Hotel',
            location: 'Haneda Airport → Shibuya',
            route: {
              origin: 'Haneda Airport, Tokyo, Japan',
              destination: 'Shibuya Station, Tokyo, Japan'
            },
            description: 'Navigate immigration and customs at Haneda Airport, take Airport Express to Shibuya Station, check into Hyatt House Shibuya',
            whatToDo: [
              'Navigate immigration and customs at Haneda Airport',
              'Take Airport Express to Shibuya Station',
              'Check into Hyatt House Shibuya (early if possible)',
              'Store luggage and freshen up',
              'Get oriented with hotel amenities'
            ],
            whatToExpect: 'Modern, efficient trains with English signage. Early check-in likely available.',
            cost: { yen: 800, usd: 5.50 }
          },
          {
            type: 'dining',
            time: '8:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:30 AM - 12:00 PM',
            title: 'Shibuya Crossing Experience',
            location: 'Shibuya',
            description: 'Iconic Tokyo orientation without overwhelming jetlag',
            significance: 'World\'s busiest pedestrian crossing - iconic Tokyo moment',
            whatToDo: [
              'Cross the famous Shibuya Crossing during rush periods',
              'Take photos with Hachiko statue (loyal dog memorial)',
              'View crossing from Starbucks 2F for aerial perspective',
              'Walk through Center Gai for people-watching',
              'Visit 109 building for youth fashion culture'
            ],
            whatToExpect: 'World\'s busiest pedestrian crossing. Overwhelming but exhilarating first Tokyo moment.',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'dining',
            time: '12:00 PM - 1:00 PM',
            title: 'First Tokyo Lunch',
            location: 'Shibuya area',
            description: 'Budget-friendly conveyor belt sushi experience',
            restaurants: [
              {
                name: 'Uobei Shibuya Dogenzaka',
                cost: '¥130-280 per plate',
                description: 'Touch panel conveyor sushi, popular with locals and tourists alike',
                whyRecommended: 'Quality budget option recognized by locals',
                whatToExpect: 'Casual atmosphere with automated ordering system'
              },
              {
                name: 'Numazuko Sushi (Tokyo Station)',
                cost: '¥150 per plate',
                description: 'Fresh sushi delivered by automated belt system with multilingual ordering',
                whyRecommended: 'Excellent for first-time visitors',
                whatToExpect: 'Modern conveyor belt system with English support'
              },
              {
                name: 'Ganko Sushi',
                cost: '¥138+ per plate',
                description: 'Traditional chain with authentic atmosphere',
                whyRecommended: 'Recognized by locals as quality budget option',
                whatToExpect: 'Traditional sushi bar atmosphere'
              }
            ],
            cost: { yen: 265, usd: 1.85 }
          },
          {
            type: 'cultural',
            time: '1:30 PM - 5:00 PM',
            title: 'Meiji Shrine & Harajuku',
            location: 'Meiji Shrine → Harajuku',
            description: 'Essential Tokyo contrast - sacred shrine + pop culture street',
            significance: '1920 shrine in forest setting, then colorful kawaii culture',
            whatToDo: [
              'Write wishes on ema (wooden plaques) and hang them',
              'Witness traditional Shinto wedding ceremonies (if occurring)',
              'Walk peaceful forest paths among 100,000+ trees',
              'Visit main shrine and bow properly (bow twice, clap twice, bow once)',
              'Walk down Takeshita Street for kawaii culture',
              'Try rainbow cotton candy and character crepes',
              'Browse vintage shops and fashion stores',
              'Visit Omotesando Hills for luxury contrast'
            ],
            culturalEtiquette: 'At Shinto shrines: bow twice, clap twice, bow once. Purify hands and mouth at water basin before entering.',
            whatToExpect: '1920 shrine in forest setting, then colorful kawaii culture and unique fashion.',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'dining',
            time: '5:30 PM - 7:00 PM',
            title: 'Early Dinner',
            location: 'Shibuya/Ginza area',
            description: 'Quality sushi dinner experience',
            restaurants: [
              {
                name: 'Seamon Ginza',
                cost: '¥1,800',
                description: 'Elegant 20-seat restaurant with freshly grated wasabi, 9 pieces + soup + appetizers',
                whyRecommended: 'Premium quality with traditional preparation',
                whatToExpect: 'Intimate counter experience with expert sushi chefs'
              },
              {
                name: 'Uobei Shibuya Dogenzaka',
                cost: '¥130-280 per plate',
                description: 'Touch panel conveyor sushi with fresh fish delivery by lane',
                whyRecommended: 'Convenient location, reliable quality',
                whatToExpected: 'Modern automated system with fresh ingredients'
              },
              {
                name: 'Kura Sushi (Shibuya)',
                cost: '¥150 per plate average',
                description: 'Family-friendly conveyor belt with colorful atmosphere and digital ordering',
                whyRecommended: 'Fun interactive experience with games',
                whatToExpect: 'Lively atmosphere with digital entertainment'
              }
            ],
            cost: { yen: 1800, usd: 12.60 }
          }
        ],
        totalCost: { yen: 3465, usd: 24.25 },
        costBreakdown: {
          food: { yen: 2065, usd: 14.45 },
          transport: { yen: 800, usd: 5.50 },
          attractions: { yen: 600, usd: 4.20 }
        }
      },
      {
        date: 'Tuesday, July 15', 
        title: 'Traditional Tokyo & Summer Festival', 
        city: 'Tokyo',
        weather: 'Very hot & humid (30-33°C/86-91°F with 78-83% humidity)',
        weatherAdvisory: 'Early morning activities recommended. Plan indoor activities during peak heat (11am-4pm)',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 12:00 PM',
            title: 'Shibuya Sky',
            location: 'Shibuya Sky',
            description: 'Modern Tokyo\'s newest iconic viewpoint',
            significance: 'Modern Tokyo\'s newest iconic viewpoint',
            whatToDo: [
              'Take panoramic photos from 360° observation deck',
              'Visit rooftop terrace for open-air city views',
              'Experience Sky Gallery with digital art installations',
              'Shop for exclusive Shibuya Sky merchandise'
            ],
            whatToExpected: 'Stunning 360° city views, less crowded than Skytree',
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'cultural',
            time: '1:00 PM - 4:00 PM',
            title: 'Traditional Asakusa',
            location: 'Asakusa',
            description: 'Tokyo\'s oldest temple (7th century) & traditional shopping street',
            significance: 'Tokyo\'s oldest temple (7th century) & traditional shopping street',
            whatToDo: [
              'Purify yourself at water basin before entering',
              'Wave incense smoke over yourself for good health',
              'Draw omikuji (fortune slips) and tie bad ones to racks',
              'Ring bell and pray at main hall',
              'Try ningyo-yaki (doll-shaped cakes with sweet filling)',
              'Sample fresh taiyaki (fish-shaped pastry)',
              'Buy traditional folding fans and chopsticks',
              'Watch artisans make traditional crafts'
            ],
            culturalEtiquette: 'Purify hands and mouth at water basin. Bow before entering temple grounds. Be respectful during prayers.',
            whatToExpected: '1,400-year-old temple, traditional architecture, street food culture',
            cost: { yen: 500, usd: 3.50 }
          },
          {
            type: 'cultural',
            time: '5:30 PM - 8:00 PM',
            title: 'Mitama Matsuri Festival',
            location: 'Yasukuni Shrine',
            description: 'One of Tokyo\'s most spectacular summer festivals (July 13-16, 2025) featuring 30,000+ lanterns',
            significance: 'One of Tokyo\'s most spectacular summer festivals featuring 30,000+ lanterns at Yasukuni Shrine',
            whatToDo: [
              'Walk through lantern-lit pathways for magical photos - lanterns illuminated daily from dusk until 9:30pm',
              'Watch traditional Bon Odori dancing performances taking place every evening',
              'Observe Nebuta float parades from Aomori (July 15 at 6:30 PM) and Awa Odori dance demonstrations (July 15 at 7:30 PM)',
              'Experience food trucks selling street food throughout festival period',
              'Listen to taiko drumming performances and traditional music',
              'Access inner shrine courtyard (normally restricted area) during evening hours'
            ],
            festivalHighlights: [
              '30,000+ lanterns illuminated nightly until 9:30pm',
              'Special Nebuta float parades (July 15 at 6:30 PM)',
              'Awa Odori dance demonstrations (July 15 at 7:30 PM)',
              'Traditional Bon Odori dancing every evening',
              'Taiko drumming and traditional music performances',
              'Access to normally restricted inner shrine courtyard'
            ],
            whatToExpected: 'Memorial lanterns creating ethereal atmosphere honoring spirits of war dead, unique spiritual experience',
            cost: { yen: 1500, usd: 10.50 }
          },
          {
            type: 'nightlife',
            time: '8:30 PM - 10:00 PM',
            title: 'CÉ LA VI Tokyo',
            location: 'Roppongi Hills',
            description: 'Premium rooftop experience with city views',
            significance: 'Premium rooftop experience with city views',
            whatToDo: [
              'Enjoy panoramic night views of Tokyo',
              'Try signature cocktails with Asian influences',
              'Take photos on outdoor terrace',
              'Experience sophisticated international atmosphere'
            ],
            whatToExpected: 'Sophisticated atmosphere, panoramic night views, quality cocktails',
            cost: { yen: 4500, usd: 31.50 }
          }
        ],
        totalCost: { yen: 8500, usd: 59.50 },
        costBreakdown: {
          food: { yen: 1500, usd: 10.50 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 2500, usd: 17.50 },
          nightlife: { yen: 4500, usd: 31.50 }
        }
      },
      {
        date: 'Wednesday, July 16', 
        title: 'Modern Tokyo & Immersive Experiences', 
        city: 'Tokyo',
        weather: 'Extremely hot (31-34°C/88-93°F)',
        weatherAdvisory: 'Indoor activities during midday essential',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 11:30 AM',
            title: 'Imperial Palace East Gardens',
            location: 'Imperial Palace',
            description: 'Historic heart of Tokyo, former Edo Castle grounds',
            significance: 'Historic heart of Tokyo, former Edo Castle grounds',
            whatToDo: [
              'Walk through beautifully maintained Japanese gardens',
              'Visit ruins of Edo Castle foundations',
              'Climb to observation deck for city views',
              'See seasonal flowers and traditional landscaping',
              'Learn about samurai history at information displays'
            ],
            whatToExpect: 'Peaceful contrast to city chaos, beautiful gardens, historical significance',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'activity',
            time: '12:00 PM - 3:30 PM',
            title: 'Mario Kart Street Racing',
            location: 'Shibuya Crossing',
            description: 'Uniquely Tokyo experience - drive through famous intersections',
            significance: 'Uniquely Tokyo experience - drive through famous intersections',
            whatToDo: [
              'Dress up in superhero costumes (no longer Mario-themed due to Nintendo lawsuit)',
              'Drive go-karts through Shibuya Crossing at street level',
              'Tour famous Tokyo landmarks in costume',
              'Take photos with international group participants',
              'Experience Tokyo traffic from unique perspective'
            ],
            whatToExpect: 'Professional guides, Shibuya Crossing at street level, international group fun',
            note: 'Requires International Driving Permit from AAA (1949 Geneva Convention)',
            alternative: 'Tokyo Skytree visit - ¥3,000 ($21) if no International Driving Permit',
            cost: { yen: 14000, usd: 98.00 }
          },
          {
            type: 'cultural',
            time: '4:00 PM - 7:00 PM',
            title: 'teamLab Planets',
            location: 'Toyosu',
            description: 'World\'s most visited digital art museum with 2025 expansion',
            significance: 'World\'s most visited digital art museum with 2025 expansion',
            whatToDo: [
              'Wade through knee-deep water with digital koi swimming around you',
              'Walk barefoot through Crystal Universe with infinite mirrors',
              'Lie down in Floating Flower Garden as flowers move above you',
              'Jump on rapidly rotating bouncing spheres that light up (NEW 2025 Athletics Forest)',
              'Create caterpillars by bouncing on same-colored spheres',
              'Use smartphone to catch and study extinct animals'
            ],
            whatToExpect: 'Mind-bending immersive art, walk through water, new athletics area',
            cost: { yen: 4500, usd: 31.50 }
          },
          {
            type: 'dining',
            time: '7:30 PM - 8:30 PM',
            title: 'Ramen Dinner',
            location: 'Various locations',
            description: 'Michelin-quality ramen experience',
            restaurants: [
              {
                name: 'Nakiryu (Otsuka)',
                cost: '¥1,000-1,500',
                description: 'Michelin Bib Gourmand (formerly 1-star) - Famous for tantanmen (spicy sesame noodles)',
                whyRecommended: 'World-renowned spicy sesame noodles that earned Michelin recognition',
                whatToExpect: 'Expect 1-2 hour wait, exceptional quality'
              },
              {
                name: 'Ganko Ramen (Tokyo Station)',
                cost: '¥800-1,200',
                description: 'Multiple regional ramen styles under one roof',
                whyRecommended: 'Variety of regional styles in convenient location',
                whatToExpect: 'Food court style with multiple ramen options'
              },
              {
                name: 'Ichiran Ramen',
                cost: '¥900-1,200',
                description: 'Individual booth experience with customizable tonkotsu ramen',
                whyRecommended: 'Unique solo dining experience, highly customizable',
                whatToExpect: 'Private booth with detailed customization options'
              }
            ],
            cost: { yen: 1200, usd: 8.40 }
          },
          {
            type: 'nightlife',
            time: '9:00 PM - 10:30 PM',
            title: 'Andaz Tokyo Rooftop',
            location: 'Toranomon Hills',
            description: 'Premium ending to immersive day',
            significance: 'Premium ending to immersive day',
            whatToDo: [
              'Enjoy views from one of Tokyo\'s highest bars',
              'Try craft cocktails with Japanese ingredients',
              'Take photos of Toranomon Hills night views',
              'Experience sophisticated business district atmosphere'
            ],
            whatToExpect: 'Toranomon Hills views, sophisticated atmosphere',
            cost: { yen: 5500, usd: 38.50 }
          }
        ],
        totalCost: { yen: 25200, usd: 176.40 },
        costBreakdown: {
          food: { yen: 1200, usd: 8.40 },
          transport: { yen: 800, usd: 5.60 },
          attractions: { yen: 18500, usd: 129.50 },
          nightlife: { yen: 5500, usd: 38.50 }
        }
      },
      {
        date: 'Thursday, July 17', 
        title: 'Markets & Cultural Deep Dive', 
        city: 'Tokyo',
        weather: 'Hot & humid with possible afternoon thunderstorms',
        weatherAdvisory: 'Skip hotel breakfast for market experience',
        activities: [
          {
            type: 'dining',
            time: '6:00 AM - 8:30 AM',
            title: 'Tsukiji Market Food Tour',
            location: 'Tsukiji',
            description: 'Historic fish market, legendary food stalls since 1947',
            significance: 'Historic fish market, legendary food stalls since 1947',
            whatToDo: [
              'Try famous tuna sashimi at Yamacho stall',
              'Sample fresh tamagoyaki (sweet egg omelet) at Joyato',
              'Taste various sushi and sashimi from different vendors',
              'Watch skilled vendors prepare fresh seafood',
              'Try uni (sea urchin) and seasonal specialties',
              'Take photos of authentic market atmosphere'
            ],
            whatToExpect: 'Ultra-fresh seafood, authentic vendors, traditional preparation methods',
            cost: { yen: 3500, usd: 24.50 }
          },
          {
            type: 'cultural',
            time: '9:30 AM - 12:30 PM',
            title: 'Tokyo National Museum',
            location: 'Ueno',
            description: 'Japan\'s premier cultural institution - world\'s largest Japanese art collection',
            significance: 'Japan\'s premier cultural institution - world\'s largest Japanese art collection',
            whatToDo: [
              'See ancient Buddhist sculptures and religious art',
              'Explore samurai swords and armor collections (89 National Treasures)',
              'View traditional Japanese paintings and calligraphy',
              'Learn about Japanese pottery and ceramics from different periods',
              'Visit Gallery of Hōryū-ji Treasures (7th-8th century artifacts)',
              'Use English audio guides for comprehensive understanding'
            ],
            whatToExpect: 'World\'s largest Japanese art collection, samurai weapons, Buddhist art, National Treasures',
            cost: { yen: 1000, usd: 7.00 }
          },
          {
            type: 'dining',
            time: '12:30 PM - 1:30 PM',
            title: 'Lunch in Ueno Area',
            location: 'Ueno',
            description: 'Traditional Japanese lunch',
            restaurants: [
              {
                name: 'Traditional tofu restaurant',
                cost: '¥1,500-2,000',
                description: 'Experience Kyoto-style yudofu cuisine',
                whyRecommended: 'Authentic Buddhist temple-style preparation',
                whatToExpect: 'Serene atmosphere with traditional tofu preparations'
              },
              {
                name: 'Local Ueno establishments',
                cost: '¥1,200-1,800',
                description: 'Sample neighborhood specialties',
                whyRecommended: 'Local favorites near museum district',
                whatToExpect: 'Casual atmosphere with regional Tokyo dishes'
              }
            ],
            cost: { yen: 1600, usd: 11.20 }
          },
          {
            type: 'cultural',
            time: '1:30 PM - 4:00 PM',
            title: 'Ueno Park Exploration & Rest',
            location: 'Ueno Park',
            description: 'Japan\'s first public park with beautiful gardens and temples',
            significance: 'Japan\'s first public park with beautiful gardens and temples',
            whatToDo: [
              'Stroll through traditional Japanese gardens',
              'Visit Toshogu Shrine dedicated to Tokugawa Ieyasu',
              'Rest in shaded areas during peak heat',
              'Take photos of Shinobazu Pond and Bentendo Temple',
              'Browse park\'s cultural atmosphere'
            ],
            whatToExpect: 'Peaceful gardens, traditional temples, relief from July heat',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'dining',
            time: '6:00 PM - 7:30 PM',
            title: 'Michelin Dinner',
            location: 'Various locations',
            description: 'Michelin-quality ramen experience',
            restaurants: [
              {
                name: 'Nakiryu (Otsuka)',
                cost: '¥1,000-1,500',
                description: 'Michelin Bib Gourmand tantanmen specialist - spicy sesame noodles that earned worldwide recognition',
                whyRecommended: 'Former Michelin star, now Bib Gourmand with exceptional quality',
                whatToExpect: 'Long wait times, exceptional spicy sesame ramen'
              },
              {
                name: 'Ramen Break Beats (Meguro)',
                cost: '¥1,200-1,500',
                description: 'New 2025 Michelin Bib Gourmand entry - sophisticated ramen with porcini mushrooms',
                whyRecommended: 'Latest Michelin recognition, innovative techniques',
                whatToExpect: 'Contemporary ramen artistry with premium ingredients'
              },
              {
                name: 'Konjiki Hototogisu (Shinjuku)',
                cost: '¥1,000-1,300',
                description: 'Former Michelin-starred, now Bib Gourmand - famous for "triple soup" shoyu soba',
                whyRecommended: 'Innovative triple-soup technique, complex flavors',
                whatToExpect: 'Refined ramen with sophisticated preparation methods'
              }
            ],
            cost: { yen: 1300, usd: 9.10 }
          },
          {
            type: 'nightlife',
            time: '8:30 PM - 10:30 PM',
            title: 'Golden Gai Exploration',
            location: 'Shinjuku Golden Gai',
            description: 'Historic post-war drinking district',
            significance: 'Historic post-war drinking district',
            whatToDo: [
              'Visit 2-3 different tiny bars (5-6 seats each)',
              'Chat with local salarymen and mama-sans',
              'Try different types of Japanese whiskey and sake',
              'Experience authentic post-war Tokyo atmosphere',
              'Order yakitori and other bar snacks'
            ],
            whatToExpect: 'Tiny bars, local salarymen, authentic atmosphere, multiple venue hopping',
            cost: { yen: 2500, usd: 17.50 }
          }
        ],
        totalCost: { yen: 9900, usd: 69.30 },
        costBreakdown: {
          food: { yen: 6400, usd: 44.80 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 1000, usd: 7.00 },
          nightlife: { yen: 2500, usd: 17.50 }
        }
      },
      {
        date: 'Friday, July 18', 
        title: 'Final Tokyo & Prime Nightlife', 
        city: 'Tokyo',
        weather: 'Hot morning, possible rain afternoon (29-32°C/84-90°F)',
        weatherAdvisory: 'Final Tokyo day with major nightlife experience',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'activity',
            time: '10:00 AM - 12:00 PM',
            title: 'Harajuku Shopping',
            location: 'Harajuku',
            description: 'Youth fashion capital and luxury district',
            significance: 'Youth fashion capital and luxury district',
            whatToDo: [
              'Try rainbow cotton candy and character crepes on Takeshita Street',
              'Browse kawaii fashion and cosplay stores',
              'Window shop luxury brands at Omotesando Hills',
              'Take photos with street fashion enthusiasts'
            ],
            whatToExpect: 'Kawaii culture, outrageous fashion, luxury brands',
            cost: { yen: 1000, usd: 7.00 }
          },
          {
            type: 'cultural',
            time: '1:00 PM - 4:00 PM',
            title: 'Tokyo Tower',
            location: 'Tokyo Tower',
            description: 'Classic Tokyo landmark for final views',
            significance: 'Classic Tokyo landmark for final views',
            whatToDo: [
              'Visit Main Observatory (150m) and Special Observatory (250m)',
              'Take photos of iconic red and white tower',
              'Shop for Tokyo Tower exclusive merchandise',
              'See panoramic views of Tokyo Bay and city',
              'Compare views with modern experiences from previous days'
            ],
            whatToExpect: 'Iconic tower views, nostalgic Tokyo symbol',
            cost: { yen: 1200, usd: 8.40 }
          },
          {
            type: 'dining',
            time: '5:00 PM - 6:30 PM',
            title: 'Light Dinner',
            location: 'Near hotel',
            description: 'Final Tokyo meal before nightlife adventure',
            restaurants: [
              {
                name: 'Local restaurant near hotel',
                cost: '¥1,500-2,500',
                description: 'Convenient location for convenience',
                whyRecommended: 'Close to hotel, prepare for extensive nightlife',
                whatToExpect: 'Light meal to fuel evening activities'
              }
            ],
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'nightlife',
            time: '11:00 PM - 2:00 AM',
            title: 'WOMB Shibuya (EDM Club)',
            location: 'Shibuya',
            description: 'Tokyo\'s premier electronic music venue, ranked among world\'s top clubs by Mixmag magazine',
            significance: 'Tokyo\'s premier electronic music venue, ranked among world\'s top clubs by Mixmag magazine',
            whatToDo: [
              'Experience famous mirror ball room on main floor with Asia\'s largest mirror ball',
              'Dance to house and techno from international DJs and top local artists',
              'Explore all 4 floors with different music styles and atmospheres (main floor, intimate basement, lounge areas)',
              'Enjoy world-class sound system with high-quality lighting and laser productions',
              'Meet international clubbers and locals in friendly, welcoming crowd'
            ],
            whatToExpected: '4 floors of house/techno, serious sound system, diverse international crowd, professional production quality',
            cost: { yen: 4000, usd: 28.00 }
          },
          {
            type: 'nightlife',
            time: '2:00 AM - 4:00 AM',
            title: 'Ni-chome Gay District',
            location: 'Shinjuku Ni-chome',
            description: 'Asia\'s largest gay district with over 300 LGBTQ+ venues in compact area',
            significance: 'Asia\'s largest gay district with over 300 LGBTQ+ venues in compact area',
            restaurants: [
              {
                name: 'Arty Farty',
                cost: '¥2,000-3,000 + drinks',
                description: 'Popular dance club with pop and electronic music, diverse international crowd',
                whyRecommended: 'Most international-friendly, great for tourists',
                whatToExpect: 'High-energy dance floor with diverse crowd'
              },
              {
                name: 'AiSOTOPE Lounge',
                cost: '¥1,500-2,500 + drinks',
                description: 'Intimate bar atmosphere with friendly mama-san culture and local regulars',
                whyRecommended: 'Authentic Japanese gay bar culture',
                whatToExpect: 'Intimate setting with local interaction'
              },
              {
                name: 'Dragon Men',
                cost: '¥1,500-2,000 + drinks',
                description: 'Casual bar with English-speaking staff and welcoming atmosphere for tourists',
                whyRecommended: 'Tourist-friendly with English support',
                whatToExpect: 'Relaxed atmosphere, easy communication'
              }
            ],
            whatToExpected: 'Welcoming inclusive atmosphere, diverse venues from intimate bars to dance clubs, late-night energy until dawn',
            cost: { yen: 6000, usd: 42.00 }
          }
        ],
        totalCost: { yen: 14200, usd: 99.40 },
        costBreakdown: {
          food: { yen: 2000, usd: 14.00 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 2200, usd: 15.40 },
          nightlife: { yen: 10000, usd: 70.00 }
        }
      },
      {
        date: 'Saturday, July 19', 
        title: 'Tokyo to Kyoto via Bullet Train', 
        city: 'Kyoto',
        weather: 'Hot travel day, cooler evening in Kyoto (28-31°C/82-88°F)',
        weatherAdvisory: 'Travel day with evening arrival in Kyoto',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt House Shibuya',
            description: 'Final Tokyo breakfast before bullet train journey',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'activity',
            time: '10:00 AM - 12:00 PM',
            title: 'Final Tokyo Moments',
            location: 'Shibuya area',
            description: 'Last-minute preparations and Tokyo farewell',
            whatToDo: [
              'Pack souvenirs and organize luggage for bullet train journey',
              'Check out of Hyatt House Shibuya (store luggage until departure)',
              'Visit convenience store for gourmet train snacks and drinks',
              'Take final photos around iconic Shibuya Crossing',
              'Purchase last-minute Tokyo character goods and regional snacks'
            ],
            whatToExpect: 'Incredible convenience store quality with gourmet options, perfect travel snacks',
            cost: { yen: 800, usd: 5.60 }
          },
          {
            type: 'transport',
            time: '12:00 PM - 3:00 PM',
            title: 'Shinkansen Bullet Train Experience',
            location: 'Tokyo → Kyoto',
            route: {
              origin: 'Tokyo Station, Tokyo, Japan',
              destination: 'Kyoto Station, Kyoto, Japan'
            },
            description: 'Japan\'s engineering marvel - 320 km/h journey with legendary punctuality (average delay: 18 seconds annually)',
            significance: 'Japan\'s engineering marvel - 320 km/h journey with legendary punctuality',
            whatToDo: [
              'Purchase ekiben (luxury train bento) from Tokyo Station vendors before boarding - featuring regional specialties',
              'Reserve seats D or E on right side for potential Mount Fuji views (weather permitting in July)',
              'Take photos of sleek bullet train nose and marvel at engineering precision',
              'Experience legendary punctuality and smooth 320 km/h travel with no turbulence',
              'Enjoy gourmet ekiben featuring seasonal ingredients and artistic presentation',
              'Use onboard WiFi to research Kyoto activities and traditional customs',
              'Watch Japanese countryside transform from urban Tokyo to historic Kansai region'
            ],
            whatToExpected: 'Ultra-smooth high-speed experience with potential Mount Fuji views on clear days, exceptional on-board dining',
            cost: { yen: 15050, usd: 105.35 }
          },
          {
            type: 'cultural',
            time: '3:00 PM - 8:00 PM',
            title: 'Kyoto Arrival & Gion Preview',
            location: 'Kyoto',
            description: 'First taste of traditional Japan atmosphere',
            significance: 'Immediate atmospheric change to traditional Japan, preserved Edo-period architecture',
            whatToDo: [
              'Check into Hyatt Place Kyoto and settle into traditional-modern atmosphere',
              'Purchase Kyoto City Bus Day Pass (¥600) for unlimited bus travel',
              'Rest and prepare for tomorrow\'s Gion Matsuri festival experience',
              'Walk through Gion district\'s historic preserved streets (Hanami-koji)',
              'Visit Yasaka Shrine for sunset photos',
              'Experience dramatically different pace from Tokyo\'s kinetic energy',
              'Light traditional kaiseki-style dinner to prepare palate for Kyoto cuisine',
              'Spot geiko and maiko if fortunate (early evening is optimal time)'
            ],
            whatToExpected: 'Immediate atmospheric change to traditional Japan, preserved Edo-period architecture',
            cost: { yen: 3600, usd: 25.20 }
          }
        ],
        totalCost: { yen: 19450, usd: 136.15 },
        costBreakdown: {
          food: { yen: 1800, usd: 12.60 },
          transport: { yen: 15050, usd: 105.35 },
          attractions: { yen: 3600, usd: 25.20 }
        }
      },
      {
        date: 'Sunday, July 20', 
        title: 'Gion Matsuri Festival Culture & Kyoto', 
        city: 'Kyoto',
        weather: 'Very hot & humid (30-33°C/86-91°F with 78-83% humidity)',
        weatherAdvisory: 'Early temple visits recommended. Experience ongoing month-long festival atmosphere',
        activities: [
          {
            type: 'dining',
            time: '8:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:00 AM - 1:00 PM',
            title: 'Gion Matsuri Festival Atmosphere',
            location: 'Central Kyoto',
            description: 'Experience the ongoing month-long festival atmosphere during active celebration period',
            significance: 'Experience the ongoing month-long festival atmosphere during active celebration period',
            whatToDo: [
              'Watch artisans build floats by hand (float construction viewing)',
              'Experience ongoing celebration at Yasaka Shrine',
              'Buy sacred good luck charms (chimaki) from float neighborhoods',
              'See completed floats on display in various districts',
              'Listen to Gion Hayashi musicians practicing',
              'Try traditional festival snacks from vendors',
              'Visit float museums displaying tapestries and artifacts'
            ],
            festivalHighlights: [
              'Float construction viewing - watch artisans build floats by hand',
              'Festival atmosphere at Yasaka Shrine with ongoing celebrations',
              'Chimaki sacred good luck charms from float neighborhoods',
              'Float displays throughout various Kyoto districts',
              'Traditional Gion Hayashi music practice sessions',
              'Traditional festival food vendors throughout area',
              'Float museums with priceless tapestries and historical artifacts'
            ],
            whatToExpected: 'Intimate festival experience without parade crowds, authentic local participation',
            cost: { yen: 2000, usd: 14.00 }
          },
          {
            type: 'dining',
            time: '1:00 PM - 2:30 PM',
            title: 'Festival Lunch',
            location: 'Kyoto Station area',
            description: 'Quality lunch after morning festival activities',
            restaurants: [
              {
                name: 'Katsukura Kyoto Station',
                cost: '¥2,000-3,000',
                description: 'Premium tonkatsu specialist since 1965',
                whyRecommended: 'Legendary tonkatsu restaurant with traditional preparation methods',
                whatToExpect: 'Crispy tonkatsu with traditional accompaniments, historical atmosphere'
              },
              {
                name: 'Kyoto Station Ramen Koji',
                cost: '¥1,200-2,000',
                description: '8 regional ramen styles under one roof',
                whyRecommended: 'Convenient access to multiple regional ramen styles',
                whatToExpect: 'Food court atmosphere with authentic regional specialties'
              }
            ],
            cost: { yen: 2500, usd: 17.50 }
          },
          {
            type: 'cultural',
            time: '3:00 PM - 6:00 PM',
            title: 'Gion District Deep Dive',
            location: 'Gion',
            description: 'Japan\'s most famous geisha district preserving 400+ years of traditional culture',
            significance: 'Japan\'s most famous geisha district preserving 400+ years of traditional culture',
            whatToDo: [
              'Walk Hanami-koji - main geisha spotting street with historic tea houses',
              'Explore Shirakawa area - most photogenic traditional buildings and canal views',
              'Visit Kennin-ji Temple - Japan\'s oldest Zen temple (1202) with rock gardens',
              'Browse traditional craft shops: kimono accessories, handmade paper, incense',
              'Take photos of traditional machiya (wooden townhouse) architecture',
              'Experience refined aesthetics representing 1,200 years of imperial taste',
              'Respectfully observe geiko and maiko if encountered (no photos without permission)'
            ],
            culturalEtiquette: 'Respectfully observe geiko and maiko from distance. No photos without permission. Maintain quiet, respectful behavior in traditional areas.',
            whatToExpected: 'Preserved Edo-period streets, traditional wooden architecture, potential geiko sightings',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'nightlife',
            time: '8:00 PM - 10:00 PM',
            title: 'Traditional Kyoto Evening',
            location: 'Higashiyama area',
            description: 'Authentic Kyoto evening experience',
            restaurants: [
              {
                name: 'K36 Rooftop Bar',
                cost: '¥3,600-5,100',
                description: 'Eye-level Yasaka Pagoda view (unique in the world) with craft cocktails',
                whyRecommended: 'Only bar in world with eye-level view of historic pagoda',
                whatToExpect: 'Stunning pagoda views, sophisticated cocktail atmosphere'
              },
              {
                name: 'Hanasaki Manjiro (Higashiyama)',
                cost: '¥6,000-8,000',
                description: 'Affordable kaiseki dinner near Yasaka Shrine for authentic multi-course experience',
                whyRecommended: 'Traditional kaiseki at accessible prices near historic sites',
                whatToExpect: 'Multi-course seasonal presentation, refined Kyoto cuisine'
              },
              {
                name: 'Traditional Tea House in Gion',
                cost: '¥2,000-3,000',
                description: 'Experience geiko district evening culture with matcha and wagashi sweets',
                whyRecommended: 'Authentic geisha district cultural experience',
                whatToExpected: 'Traditional tea ceremony atmosphere, seasonal sweets'
              }
            ],
            cost: { yen: 4000, usd: 28.00 }
          }
        ],
        totalCost: { yen: 9100, usd: 63.70 },
        costBreakdown: {
          food: { yen: 2500, usd: 17.50 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 2600, usd: 18.20 },
          nightlife: { yen: 4000, usd: 28.00 },
          festival: { yen: 2000, usd: 14.00 }
        }
      },
      {
        date: 'Monday, July 21', 
        title: 'Temples & Bamboo Grove', 
        city: 'Kyoto',
        weather: 'Very hot & humid (30-33°C/86-91°F with 78-83% humidity)',
        weatherAdvisory: 'Early start for temple visits before heat. Skip hotel breakfast for early departure',
        activities: [
          {
            type: 'cultural',
            time: '7:00 AM - 10:00 AM',
            title: 'Fushimi Inari Shrine (Early Morning)',
            location: 'Fushimi',
            description: '10,000+ vermillion torii gates create tunnels up sacred Inari mountain, representing Japan\'s unique blend of spirituality and commerce',
            significance: '10,000+ vermillion torii gates create tunnels up sacred Inari mountain',
            whatToDo: [
              'Begin hike through famous vermillion torii tunnels before crowds arrive',
              'Climb sacred mountain path to summit (2-3 hours for full hike)',
              'Read inscriptions on torii gates showing business donor names and dates',
              'Visit multiple sub-shrines along mountain path dedicated to different kami',
              'Take photos in early morning light without tourist crowds',
              'Purchase small torii plaques (¥500-1,000) to leave prayers for business success'
            ],
            culturalEtiquette: 'Bow before entering torii gates. Be respectful of active shrine worship. Small donations encouraged when making wishes.',
            whatToExpected: 'Thousands of vermillion gates creating tunnel effect, mountain hiking with stone steps, early morning tranquility',
            cost: { yen: 400, usd: 2.80 }
          },
          {
            type: 'dining',
            time: '11:00 AM - 12:00 PM',
            title: 'Late Breakfast/Early Lunch',
            location: 'Arashiyama area',
            description: 'Traditional Kyoto cuisine after early temple visit',
            restaurants: [
              {
                name: 'Yudofu Sagano (Arashiyama)',
                cost: '¥3,800 set meal',
                description: 'Traditional tofu cuisine in beautiful garden setting',
                whyRecommended: 'Authentic Buddhist temple-style tofu preparation in historic setting',
                whatToExpect: 'Serene garden atmosphere with multiple traditional tofu preparations'
              },
              {
                name: 'Rengetsu-jaya (Higashiyama)',
                cost: '¥4,000+',
                description: 'Tofu kaiseki in traditional machiya townhouse for refined tofu experience',
                whyRecommended: 'Historic machiya setting with refined kaiseki presentation',
                whatToExpected: 'Traditional wooden architecture with sophisticated tofu dishes'
              },
              {
                name: 'Local Kyoto specialties',
                cost: '¥1,500-2,500',
                description: 'Seasonal kaiseki-style presentations featuring Kyoto vegetables',
                whyRecommended: 'Accessible pricing with authentic Kyoto vegetable specialties',
                whatToExpected: 'Fresh Kyoto vegetables with traditional preparation methods'
              }
            ],
            cost: { yen: 2500, usd: 17.50 }
          },
          {
            type: 'cultural',
            time: '1:30 PM - 5:30 PM',
            title: 'Arashiyama Bamboo Grove & Tenryu-ji',
            location: 'Arashiyama',
            description: 'Thousands of towering bamboo create natural cathedral with unique acoustic properties',
            significance: 'Thousands of towering bamboo create natural cathedral with unique acoustic properties',
            whatToDo: [
              'Walk through famous bamboo forest pathways - main path 500m long',
              'Listen carefully to unique bamboo rustling sounds (take video for audio)',
              'Take photos in natural green cathedral lighting effect',
              'Experience one of Japan\'s most iconic natural photography locations',
              'Feel temperature drop of 5-10°F inside bamboo grove',
              'Visit UNESCO World Heritage Zen temple (1339) and rock garden',
              'Learn about Buddhist philosophy and traditional temple architecture',
              'See seasonal flowers and traditional Japanese landscaping techniques',
              'Experience classic "borrowed scenery" (shakkei) garden design',
              'Browse bamboo crafts and traditional Kyoto souvenirs',
              'Try local Arashiyama specialties: bamboo ice cream, traditional sweets'
            ],
            culturalEtiquette: 'Maintain quiet atmosphere in bamboo grove. Stay on designated paths. Be respectful during temple visits and garden meditation areas.',
            whatToExpected: 'Towering bamboo tunnels creating otherworldly atmosphere, unique acoustic experience',
            cost: { yen: 960, usd: 6.72 }
          },
          {
            type: 'dining',
            time: '7:00 PM - 8:30 PM',
            title: 'Traditional Kyoto Dinner',
            location: 'Central Kyoto',
            description: 'Authentic Kyoto cuisine representing 1,200 years of imperial culinary refinement',
            restaurants: [
              {
                name: 'Tousuiro (Gion or Nakagyo location)',
                cost: '¥5,000-7,000',
                description: 'Multi-course tofu kaiseki featuring Kyoto\'s famous tofu preparations',
                whyRecommended: 'Premium tofu specialist with refined kaiseki presentation',
                whatToExpected: 'Multiple tofu preparations showcasing Kyoto\'s tofu mastery'
              },
              {
                name: 'Yudofu Sagano',
                cost: '¥3,800 set menu',
                description: 'Buddhist-style yudofu (simmered tofu) in traditional Arashiyama setting',
                whyRecommended: 'Authentic Buddhist temple-style preparation in historic location',
                whatToExpected: 'Simple, refined tofu presentation in peaceful garden setting'
              },
              {
                name: 'Local kaiseki restaurant',
                cost: '¥4,000-6,000',
                description: 'Authentic Kyoto cuisine representing 1,200 years of imperial culinary refinement',
                whyRecommended: 'Traditional Kyoto cuisine with seasonal imperial influence',
                whatToExpected: 'Multi-course seasonal presentation with refined techniques'
              }
            ],
            cost: { yen: 5000, usd: 35.00 }
          }
        ],
        totalCost: { yen: 8860, usd: 62.02 },
        costBreakdown: {
          food: { yen: 7500, usd: 52.50 },
          transport: { yen: 600, usd: 4.20 },
          attractions: { yen: 1360, usd: 9.52 }
        }
      },
      {
        date: 'Tuesday, July 22', 
        title: 'Osaka Day Trip - Culinary Capital', 
        city: 'Osaka',
        weather: 'Hot and humid, typical Kansai summer weather (29-32°C/84-90°F)',
        weatherAdvisory: 'Full day trip to Japan\'s culinary capital - return to Kyoto evening',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'transport',
            time: '10:00 AM - 11:00 AM',
            title: 'Travel to Osaka',
            location: 'Kyoto → Osaka',
            route: {
              origin: 'Kyoto Station, Kyoto, Japan',
              destination: 'Osaka Station, Osaka, Japan'
            },
            description: 'Express train to Japan\'s kitchen',
            whatToDo: [
              'Take comfortable express train from Kyoto to Osaka',
              'Prepare mentally for food-focused day in Japan\'s culinary capital',
              'Review Dotonbori street food map and must-try specialties'
            ],
            whatToExpect: '45-minute comfortable journey through Kansai countryside',
            cost: { yen: 570, usd: 4.00 }
          },
          {
            type: 'cultural',
            time: '11:30 AM - 1:00 PM',
            title: 'Osaka Castle',
            location: 'Osaka Castle Park',
            description: 'Symbol of Toyotomi Hideyoshi\'s unification of Japan (1583), represents Osaka\'s historical role as Japan\'s commercial heart',
            significance: 'Symbol of Toyotomi Hideyoshi\'s unification of Japan (1583)',
            whatToDo: [
              'Explore reconstructed castle\'s 8 floors with historical exhibits',
              'Learn about Japanese unification period and Hideyoshi\'s rise from farmer to ruler',
              'Enjoy panoramic views of modern Osaka from top floor observation deck',
              'Walk through castle park and traditional Japanese gardens',
              'See artifacts from Sengoku (Warring States) period',
              'Take photos of iconic white castle architecture against modern skyline'
            ],
            whatToExpected: 'Modern reconstruction with historical exhibits and elevator access, panoramic city views',
            cost: { yen: 600, usd: 4.20 }
          },
          {
            type: 'dining',
            time: '2:00 PM - 5:00 PM',
            title: 'Dotonbori Street Food Marathon',
            location: 'Dotonbori',
            description: 'Dotonbori embodies Osaka\'s "kuidaore" culture - eat until you drop. Birthplace of takoyaki, okonomiyaki, and kushikatsu',
            significance: 'Dotonbori embodies Osaka\'s "kuidaore" culture - eat until you drop',
            whatToDo: [
              'Try takoyaki at Wanaka - Original octopus balls, Osaka\'s signature dish (¥500-800)',
              'Experience okonomiyaki at Mizuno - Osaka-style savory pancake with special sauce (¥800-1,200)',
              'Sample kushikatsu at Daruma - Fried skewers with strict no double-dipping rule (¥100-300 per stick)',
              'Taste ikayaki from street stalls - Grilled whole squid pressed flat (¥300-500)',
              'Try taiyaki for dessert - Fish-shaped pastry with various fillings (¥200-400)',
              'Take mandatory photos with iconic Glico running man neon sign'
            ],
            restaurants: [
              {
                name: 'Takoyaki at Wanaka',
                cost: '¥500-800',
                description: 'Original octopus balls - Osaka\'s signature dish',
                whyRecommended: 'Most famous takoyaki stand in Dotonbori, established reputation',
                whatToExpected: 'Hot, crispy outside with creamy octopus interior'
              },
              {
                name: 'Okonomiyaki at Mizuno',
                cost: '¥800-1,200',
                description: 'Osaka-style savory pancake with special sauce',
                whyRecommended: 'Historic restaurant perfecting okonomiyaki for generations',
                whatToExpected: 'Thick, hearty pancake with complex umami flavors'
              },
              {
                name: 'Kushikatsu at Daruma',
                cost: '¥100-300 per stick',
                description: 'Fried skewers with strict no double-dipping rule',
                whyRecommended: 'Original kushikatsu restaurant with famous double-dipping prohibition',
                whatToExpected: 'Crispy battered skewers with tangy dipping sauce'
              }
            ],
            whatToExpected: 'Overwhelming sensory experience with neon signs and canal views, incredible street food variety',
            cost: { yen: 2800, usd: 19.60 }
          },
          {
            type: 'dining',
            time: '6:00 PM - 7:30 PM',
            title: 'Proper Sit-Down Dinner',
            location: 'Dotonbori area',
            description: 'Experience famous Osaka hospitality ("Osaka no obachan" - welcoming auntie culture)',
            restaurants: [
              {
                name: 'Authentic Osaka-style okonomiyaki restaurant',
                cost: '¥2,000-3,000',
                description: 'Traditional sit-down okonomiyaki experience',
                whyRecommended: 'Experience authentic Osaka hospitality culture',
                whatToExpected: 'Welcoming atmosphere with traditional Osaka charm'
              }
            ],
            cost: { yen: 2500, usd: 17.50 }
          },
          {
            type: 'nightlife',
            time: '9:00 PM - 11:30 PM',
            title: 'Osaka Nightlife Experience',
            location: 'Doyama District',
            description: 'Osaka\'s Doyama District represents Japan\'s progressive and inclusive LGBTQ+ culture',
            significance: 'Osaka\'s Doyama District represents Japan\'s progressive and inclusive LGBTQ+ culture',
            restaurants: [
              {
                name: 'Grand Slam',
                cost: '¥3,000-4,000',
                description: 'Traditional Japanese gay bar with welcoming mama-san atmosphere',
                whyRecommended: 'Authentic Japanese gay bar culture with friendly atmosphere',
                whatToExpected: 'Intimate setting with mama-san hospitality'
              },
              {
                name: 'EXPLOSION',
                cost: '¥4,000-6,000',
                description: 'High-energy gay dance club with international crowd and latest J-pop/EDM',
                whyRecommended: 'High-energy dance environment with diverse crowd',
                whatToExpected: 'Modern club atmosphere with latest music'
              },
              {
                name: 'Club Circus',
                cost: '¥3,500-5,000',
                description: 'Multi-floor EDM venue for electronic music enthusiasts',
                whyRecommended: 'Serious EDM venue with multiple floors and environments',
                whatToExpected: 'Professional sound system with dedicated electronic music focus'
              }
            ],
            whatToExpected: 'Diverse venues with different energy levels, welcoming LGBTQ+ community atmosphere',
            cost: { yen: 5000, usd: 35.00 }
          },
          {
            type: 'transport',
            time: '12:00 AM - 1:00 AM',
            title: 'Return to Kyoto',
            location: 'Osaka → Kyoto',
            route: {
              origin: 'Osaka Station, Osaka, Japan',
              destination: 'Kyoto Station, Kyoto, Japan'
            },
            description: 'Late night return to hotel',
            whatToExpect: 'Quick return journey to Kyoto hotel',
            cost: { yen: 570, usd: 4.00 }
          }
        ],
        totalCost: { yen: 12040, usd: 84.30 },
        costBreakdown: {
          food: { yen: 5300, usd: 37.10 },
          transport: { yen: 1140, usd: 8.00 },
          attractions: { yen: 600, usd: 4.20 },
          nightlife: { yen: 5000, usd: 35.00 }
        }
      },
      {
        date: 'Wednesday, July 23', 
        title: 'Final Kyoto & Transfer to Osaka', 
        city: 'Osaka',
        weather: 'Hot and humid, typical Kansai summer weather (29-32°C/84-90°F)',
        weatherAdvisory: 'Final Kyoto exploration before moving to Osaka for departure preparations',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Hyatt Place Kyoto',
            description: 'Breakfast included daily due to Hyatt Globalist status',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '10:00 AM - 12:00 PM',
            title: 'Nijo Castle',
            location: 'Nijo Castle, Kyoto',
            description: 'Where Japan\'s last Shogun surrendered power in 1867, ending 700+ years of samurai rule',
            significance: 'Historic site where Shogun Yoshinobu abdicated power to Emperor Meiji, ending the samurai era',
            whatToDo: [
              'Walk on famous "nightingale floors" that squeak as security warning system',
              'See historic room where Shogun Yoshinobu abdicated power to Emperor Meiji',
              'Admire ornate painted screens (fusuma-e) and ceiling art by Kano school artists',
              'Explore beautiful traditional Japanese castle gardens with seasonal plantings',
              'Learn about end of samurai era and Japan\'s transition to modern state',
              'Take photos of unique architectural features and garden landscapes'
            ],
            whatToExpect: 'Unique squeaking security floors, ornate interior art representing pinnacle of Japanese craftsmanship',
            cost: { yen: 800, usd: 5.60 }
          },
          {
            type: 'dining',
            time: '1:00 PM - 3:00 PM',
            title: 'Nishiki Market Final Exploration',
            location: 'Nishiki Market, Kyoto',
            description: '"Kyoto\'s Kitchen" serving the imperial capital for 400+ years with 126 specialty shops in 390-meter covered market',
            significance: '"Kyoto\'s Kitchen" serving the imperial capital for 400+ years',
            whatToDo: [
              'Try tofu doughnuts and yuba (soy skin) specialties unique to Kyoto',
              'Sample Kyoto\'s famous matcha and traditional wagashi (seasonal sweets)',
              'Buy traditional Kyoto pickles (tsukemono) and specialty seasonings',
              'Watch traditional food preparation methods passed down through generations',
              'Purchase authentic Kyoto souvenirs: matcha tea, traditional ceramics',
              'Interact with vendors who represent family businesses spanning centuries'
            ],
            whatToExpect: 'Highest quality ingredients reflecting imperial standards, traditional preparation methods, unique Kyoto flavors',
            restaurants: [
              {
                name: 'Tofu doughnuts & yuba specialties',
                cost: '¥500-800 per item',
                description: 'Unique Kyoto tofu preparations including sweet and savory options',
                whyRecommended: 'Traditional Kyoto Buddhist cuisine adapted for market snacking',
                whatToExpect: 'Surprisingly delicious tofu-based treats unlike anywhere else'
              },
              {
                name: 'Matcha and wagashi sweets',
                cost: '¥600-1,200 per set',
                description: 'Premium Kyoto matcha with seasonal traditional sweets',
                whyRecommended: 'Imperial-level quality matcha representing Kyoto\'s tea ceremony heritage',
                whatToExpect: 'Ceremonial-grade matcha with artistic seasonal confections'
              },
              {
                name: 'Traditional tsukemono pickles',
                cost: '¥800-1,500 per selection',
                description: 'Kyoto-style pickled vegetables using traditional methods',
                whyRecommended: 'Centuries-old family recipes unique to Kyoto\'s imperial cuisine',
                whatToExpect: 'Complex fermented flavors representing Kyoto\'s culinary refinement'
              }
            ],
            cost: { yen: 2750, usd: 19.25 }
          },
          {
            type: 'transport',
            time: '4:00 PM - 5:30 PM',
            title: 'Transfer to Osaka',
            location: 'Kyoto → Osaka',
            route: {
              origin: 'Kyoto Station, Kyoto, Japan',
              destination: 'Namba Station, Osaka, Japan'
            },
            description: 'Express train to Japan\'s kitchen for final night',
            whatToDo: [
              'Check out of Hyatt Place Kyoto and organize luggage efficiently',
              'Take final express train journey (45 minutes) to Osaka\'s energetic Namba district',
              'Check into Caption by Hyatt Namba Osaka in heart of entertainment district',
              'Rest and prepare for final evening in Japan'
            ],
            whatToExpect: 'Quick comfortable journey through Kansai region, modern hotel in Osaka\'s busiest entertainment district',
            cost: { yen: 570, usd: 4.00 }
          },
          {
            type: 'dining',
            time: '7:00 PM - 9:00 PM',
            title: 'Farewell Dinner',
            location: 'Osaka Namba area',
            description: 'Celebratory final meal reflecting on transformative cultural experiences',
            significance: 'Final meal celebrating the completion of an incredible Japan journey',
            restaurants: [
              {
                name: 'High-end Osaka restaurant',
                cost: '¥4,000-6,000',
                description: 'Premium okonomiyaki or takoyaki at established restaurant',
                whyRecommended: 'Celebrate with Osaka\'s signature dishes at their finest',
                whatToExpect: 'Refined versions of Osaka street food classics in upscale setting'
              },
              {
                name: 'Dotonbori finale',
                cost: '¥2,000-3,000',
                description: 'Return to iconic street food area for final Japanese specialties',
                whyRecommended: 'Revisit iconic location for any missed culinary experiences',
                whatToExpect: 'Nostalgic return to vibrant street food culture'
              },
              {
                name: 'Luxury kaiseki',
                cost: '¥5,000-8,000',
                description: 'Special celebration meal reflecting merchant city\'s culinary excellence',
                whyRecommended: 'Ultimate farewell dinner showcasing Osaka\'s finest cuisine',
                whatToExpect: 'Multi-course seasonal presentation worthy of final night'
              }
            ],
            whatToExpect: 'Bittersweet final meal with reflection on transformative cultural experiences and memories',
            cost: { yen: 4500, usd: 31.50 }
          }
        ],
        totalCost: { yen: 8620, usd: 60.35 },
        costBreakdown: {
          food: { yen: 7250, usd: 50.75 },
          transport: { yen: 570, usd: 4.00 },
          attractions: { yen: 800, usd: 5.60 }
        }
      },
      {
        date: 'Thursday, July 24', 
        title: 'Final Day & Departure', 
        city: 'Osaka',
        weather: 'Hot morning, travel preparations (28-31°C/82-88°F)',
        weatherAdvisory: 'Final morning in Japan before departure - organize efficiently for international travel',
        activities: [
          {
            type: 'dining',
            time: '9:00 AM',
            title: 'Hotel Breakfast',
            location: 'Caption by Hyatt Namba Osaka',
            description: 'Final Japanese breakfast before departure',
            whatToExpect: 'Quality hotel breakfast with Japanese and Western options',
            cost: { yen: 0, usd: 0 }
          },
          {
            type: 'cultural',
            time: '9:30 AM - 12:00 PM',
            title: 'Final Osaka Exploration',
            location: 'Namba district',
            description: 'Last-minute shopping and final moments in Japan',
            significance: 'Final opportunity to capture last memories and purchase final souvenirs',
            whatToDo: [
              'Pack souvenirs and organize luggage efficiently for international departure',
              'Explore Namba district around hotel for last-minute shopping',
              'Purchase final Japanese snacks and treats for flight and home',
              'Visit any missed local shops or convenience stores for unique items',
              'Take last-minute photos around Osaka capturing final Japan moments',
              'Browse Don Quijote for quirky final souvenirs and character goods',
              'Visit traditional craft shops for authentic Japanese handmade items'
            ],
            whatToExpect: 'Bittersweet final morning with last-minute discoveries, efficient shopping district with everything needed for departure',
            restaurants: [
              {
                name: 'Convenience store gourmet selection',
                cost: '¥300-800 per item',
                description: 'Final selection of Japanese snacks and treats for travel',
                whyRecommended: 'Incredible variety of high-quality travel snacks and unique Japanese flavors',
                whatToExpect: 'Amazingly sophisticated convenience store options for flight and home'
              },
              {
                name: 'Local Namba specialties',
                cost: '¥500-1,500 per item',
                description: 'Final taste of Osaka street food and local specialties',
                whyRecommended: 'Last chance to try any missed local favorites',
                whatToExpect: 'Familiar flavors that will trigger Japan memories for years'
              }
            ],
            cost: { yen: 1750, usd: 12.25 }
          },
          {
            type: 'transport',
            time: '1:00 PM - 2:35 PM',
            title: 'Departure Preparation',
            location: 'Osaka → Itami Airport (ITM)',
            route: {
              origin: 'Namba Station, Osaka, Japan',
              destination: 'Itami Airport, Osaka, Japan'
            },
            description: 'Journey to Itami Airport for international departure',
            whatToDo: [
              'Final luggage organization for international departure',
              'Check out of Caption by Hyatt Namba and arrange airport transport',
              'Depart Itami Airport (ITM) at 2:35 PM for journey home via NRT',
              'Reflect on incredible cultural experiences and personal transformation',
              'Complete any final travel documentation requirements'
            ],
            whatToExpect: 'Efficient Japanese airport service, final experience of Japanese hospitality and precision',
            cost: { yen: 1200, usd: 8.40 }
          }
        ],
        totalCost: { yen: 2950, usd: 20.65 },
        costBreakdown: {
          food: { yen: 1750, usd: 12.25 },
          transport: { yen: 1200, usd: 8.40 }
        }
      }
    ];

    let currentDayIndex = 0;
    
    // Function to calculate the actual current day of the trip
    function getCurrentTripDay() {
      const tripStartDate = new Date('2025-07-14'); // July 14, 2025
      const tripEndDate = new Date('2025-07-24');   // July 24, 2025
      const today = new Date();
      
      // Reset time to compare dates only
      today.setHours(0, 0, 0, 0);
      tripStartDate.setHours(0, 0, 0, 0);
      tripEndDate.setHours(0, 0, 0, 0);
      
      // If before trip starts, show Day 1
      if (today < tripStartDate) {
        return 0;
      }
      
      // If after trip ends, show last day
      if (today > tripEndDate) {
        return tripDays.length - 1;
      }
      
      // Calculate days since trip start
      const daysSinceStart = Math.floor((today - tripStartDate) / (1000 * 60 * 60 * 24));
      return Math.min(daysSinceStart, tripDays.length - 1);
    }

    // Day navigation functions
    async function updateDayDisplay() {
      const currentDay = tripDays[currentDayIndex];
      const actualTodayIndex = getCurrentTripDay();
      
      // Update navigation bar
      document.getElementById('current-date').textContent = currentDay.date;
      
      // Show "TODAY" indicator if this is the actual current day
      const dayText = currentDayIndex === actualTodayIndex ? 
        `Day ${currentDayIndex + 1} of ${tripDays.length} • TODAY` : 
        `Day ${currentDayIndex + 1} of ${tripDays.length}`;
      document.getElementById('current-day').textContent = dayText;
      
      // Update navigation buttons
      document.getElementById('prev-day').disabled = currentDayIndex === 0;
      document.getElementById('next-day').disabled = currentDayIndex === tripDays.length - 1;
      
      // Update main content
      await updateMainContent(currentDay);
      
      // Update date picker if it's open
      const datePicker = document.getElementById('date-picker-tray');
      if (datePicker && datePicker.classList.contains('show')) {
        populateDateList();
      }
      
      addDebugLog(`📅 Switched to ${currentDay.title} in ${currentDay.city}`, 'info');
    }

    // Activity type styling
    const activityTypeStyles = {
      'transport': { bg: 'linear-gradient(135deg, #dcfce7, #bbf7d0)', border: '#86efac', icon: '🚆' },
      'cultural': { bg: 'linear-gradient(135deg, #ddd6fe, #e0e7ff)', border: '#c4b5fd', icon: '🏛️' },
      'activity': { bg: 'linear-gradient(135deg, #bfdbfe, #dbeafe)', border: '#93c5fd', icon: '🎯' },
      'dining': { bg: 'linear-gradient(135deg, #fed7d7, #fecaca)', border: '#fca5a5', icon: '🍜' },
      'nightlife': { bg: 'linear-gradient(135deg, #e7e5e4, #d6d3d1)', border: '#a8a29e', icon: '🍸' }
    };

    // Update the main content area
    async function updateMainContent(dayData) {
      const contentContainer = document.getElementById('day-content');
      
      // Create the complete day structure with placeholder weather
      contentContainer.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <span class="day-title">${dayData.title}</span>
          <span class="city-badge">${dayData.city}</span>
        </div>
        <div class="date-text">${dayData.date}, 2025</div>
        
        <div class="weather-warning" id="live-weather-display">
          <span>🌐</span>
          <span style="font-size: var(--base-text);">Loading current weather...</span>
        </div>
        
        <!-- Activity cards will be inserted here -->
        
        <!-- Daily Cost Summary -->
        <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-top: 24px;">
          <div style="font-weight: bold; font-size: var(--large-text); color: #1e40af; margin-bottom: 12px;">Daily Cost Summary</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="text-align: center;">
              <div style="font-size: var(--title-text); font-weight: bold; color: #2563eb;">¥${dayData.totalCost.yen.toLocaleString()}</div>
              <div style="font-size: var(--base-text); color: #3b82f6;">Japanese Yen</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: var(--title-text); font-weight: bold; color: #2563eb;">$${dayData.totalCost.usd.toFixed(2)}</div>
              <div style="font-size: var(--base-text); color: #3b82f6;">US Dollars</div>
            </div>
          </div>
        </div>
      `;
      
      // Load live weather data
      await updateLiveWeather(dayData.city);
      
      // Update activities
      await updateActivities(dayData.activities);
      
      // Update header date in navigation
      const headerDate = document.getElementById('current-date');
      const dateParts = dayData.date.split(', ');
      headerDate.textContent = dateParts[0] + ', ' + dateParts[1];
    }
    
    async function updateLiveWeather(city) {
      try {
        const weatherData = await getWeatherWithFallback(city);
        const weatherDisplay = document.getElementById('live-weather-display');
        const recommendation = getWeatherRecommendation(weatherData);
        
        if (weatherDisplay) {
          weatherDisplay.innerHTML = `
            <div>
              <div style="font-size: var(--small-text); font-weight: 600; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                📡 Live Weather
              </div>
              <div style="display: flex; align-items: start; gap: 8px;">
                <span style="font-size: var(--medium-text); margin-top: 2px;">${getWeatherIcon(weatherData.weather[0].main)}</span>
                <div style="flex: 1;">
                  <div style="font-size: var(--base-text); font-weight: 600; margin-bottom: 4px;">
                    ${Math.round(weatherData.main.temp)}°C (feels like ${Math.round(weatherData.main.feels_like)}°C)
                    ${weatherData.isStatic ? ' (estimated)' : ''}
                  </div>
                  <div style="font-size: var(--small-text); opacity: 0.8; margin-bottom: 8px;">
                    ${weatherData.weather[0].description} • ${weatherData.main.humidity}% humidity
                  </div>
                  <div style="display: flex; align-items: start; gap: 6px; font-size: var(--small-text);">
                    <span style="margin-top: 1px;">${recommendation.icon}</span>
                    <span>${recommendation.message}</span>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Update weather warning background color based on conditions
          if (recommendation.type === 'storm') {
            weatherDisplay.style.background = '#fef2f2';
            weatherDisplay.style.borderColor = '#f87171';
            weatherDisplay.style.color = '#dc2626';
          } else if (recommendation.type === 'rain') {
            weatherDisplay.style.background = '#f0f9ff';
            weatherDisplay.style.borderColor = '#38bdf8';
            weatherDisplay.style.color = '#0284c7';
          } else if (recommendation.type === 'heat') {
            weatherDisplay.style.background = '#fed7aa';
            weatherDisplay.style.borderColor = '#fb923c';
            weatherDisplay.style.color = '#ea580c';
          } else if (recommendation.type === 'warm') {
            weatherDisplay.style.background = '#fef3c7';
            weatherDisplay.style.borderColor = '#fbbf24';
            weatherDisplay.style.color = '#92400e';
          } else {
            weatherDisplay.style.background = '#f0fdf4';
            weatherDisplay.style.borderColor = '#4ade80';
            weatherDisplay.style.color = '#16a34a';
          }
        }
      } catch (error) {
        console.error('Failed to update live weather:', error);
        const weatherDisplay = document.getElementById('live-weather-display');
        if (weatherDisplay) {
          weatherDisplay.innerHTML = `
            <span>⚠️</span>
            <span style="font-size: var(--base-text);">Hot & humid (29-32°C/84-90°F with 78-83% humidity) - estimated</span>
          `;
        }
      }
    }

    async function updateActivities(activities) {
      // Find the activities container 
      const content = document.getElementById('day-content');
      
      // Remove existing activity cards
      const existingCards = content.querySelectorAll('.activity-card');
      existingCards.forEach(card => card.remove());
      
      // Find insertion point (after weather warning)
      let insertionPoint = content.querySelector('.weather-warning');
      
      // Create new activity cards in chronological order
      for (let i = 0; i < activities.length; i++) {
        const activity = activities[i];
        const activityCard = await createActivityCard(activity);
        insertionPoint.insertAdjacentHTML('afterend', activityCard);
        insertionPoint = insertionPoint.nextElementSibling;
        
        // Add transit card between activities if locations differ
        if (i < activities.length - 1) {
          const nextActivity = activities[i + 1];
          if (shouldShowTransitBetween(activity, nextActivity)) {
            const transitCard = await createTransitBetweenActivities(activity, nextActivity);
            insertionPoint.insertAdjacentHTML('afterend', transitCard);
            insertionPoint = insertionPoint.nextElementSibling;
          }
        }
      }
    }
    
    function shouldShowTransitBetween(currentActivity, nextActivity) {
      // Don't show transit for transport activities (they already have transit info)
      if (currentActivity.type === 'transport' || nextActivity.type === 'transport') {
        return false;
      }
      
      // Don't show if activities are in the same location
      if (currentActivity.location === nextActivity.location) {
        return false;
      }
      
      // Don't show if locations are very similar (same area)
      const currentLoc = (currentActivity.location || '').toLowerCase();
      const nextLoc = (nextActivity.location || '').toLowerCase();
      
      if (currentLoc.includes('shibuya') && nextLoc.includes('shibuya')) {
        return false;
      }
      
      return true;
    }
    
    async function createTransitBetweenActivities(fromActivity, toActivity) {
      const fromLocation = getLocationForTransit(fromActivity.location);
      const toLocation = getLocationForTransit(toActivity.location);
      
      try {
        const transitOptions = await getTransitWithFallback(fromLocation, toLocation);
        
        return `
          <div class="activity-card" style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-color: #94a3b8; border-style: dashed;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 8px;">
                <span style="font-size: 18px;">🚶‍➡️</span>
              </div>
              <div>
                <div style="font-weight: 600; font-size: var(--base-text);">Getting There</div>
                <div style="font-size: var(--small-text); opacity: 0.7;">${fromActivity.location} → ${toActivity.location}</div>
              </div>
            </div>
            ${createMultiModalDisplay(transitOptions, true)}
          </div>
        `;
      } catch (error) {
        return `
          <div class="activity-card" style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-color: #94a3b8; border-style: dashed;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 8px;">
                <span style="font-size: 18px;">🚶‍➡️</span>
              </div>
              <div>
                <div style="font-weight: 600; font-size: var(--base-text);">Getting There</div>
                <div style="font-size: var(--small-text); opacity: 0.7;">${fromActivity.location} → ${toActivity.location}</div>
                <div style="font-size: var(--small-text); margin-top: 4px;">Check local transit options</div>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function getLocationForTransit(location) {
      // Convert activity locations to transit-friendly addresses
      const locationMap = {
        // Tokyo neighborhoods and stations
        'Shibuya': 'Shibuya Station, Tokyo, Japan',
        'Shibuya area': 'Shibuya Station, Tokyo, Japan',
        'Shibuya/Ginza area': 'Ginza Station, Tokyo, Japan',
        'Meiji Shrine → Harajuku': 'Meiji-jingu-mae Station, Tokyo, Japan',
        'Harajuku': 'Harajuku Station, Tokyo, Japan',
        'Shinjuku': 'Shinjuku Station, Tokyo, Japan',
        'Ginza': 'Ginza Station, Tokyo, Japan',
        'Asakusa': 'Asakusa Station, Tokyo, Japan',
        'Ueno': 'Ueno Station, Tokyo, Japan',
        'Akihabara': 'Akihabara Station, Tokyo, Japan',
        'Tokyo Station': 'Tokyo Station, Tokyo, Japan',
        'Tsukiji': 'Tsukiji Market, Tokyo, Japan',
        
        // Hotels and specific venues
        'Hyatt House Shibuya': 'Shibuya Station, Tokyo, Japan',
        'Hyatt Place Kyoto': 'Kyoto Station, Kyoto, Japan',
        'Caption by Hyatt Namba': 'Namba Station, Osaka, Japan',
        
        // Kyoto locations
        'Kyoto Station': 'Kyoto Station, Kyoto, Japan',
        'Gion District': 'Gion-Shijo Station, Kyoto, Japan',
        'Fushimi': 'Fushimi-Inari Station, Kyoto, Japan',
        'Arashiyama': 'Arashiyama Station, Kyoto, Japan',
        
        // Osaka locations
        'Osaka Station': 'Osaka Station, Osaka, Japan',
        'Namba': 'Namba Station, Osaka, Japan',
        'Namba Station': 'Namba Station, Osaka, Japan',
        'Dotonbori': 'Namba Station, Osaka, Japan',
        'Dotonbori area': 'Namba Station, Osaka, Japan',
        'Shinsekai': 'Shinsekai, Osaka, Japan',
        
        // Airports
        'Haneda Airport': 'Haneda Airport, Tokyo, Japan',
        'Itami Airport': 'Itami Airport, Osaka, Japan',
        'Narita Airport': 'Narita Airport, Tokyo, Japan'
      };
      
      // Direct mapping first
      if (locationMap[location]) {
        return locationMap[location];
      }
      
      // Smart partial matching for neighborhoods
      const loc = location.toLowerCase();
      
      // Tokyo neighborhoods
      if (loc.includes('shibuya')) return 'Shibuya Station, Tokyo, Japan';
      if (loc.includes('harajuku')) return 'Harajuku Station, Tokyo, Japan';
      if (loc.includes('shinjuku')) return 'Shinjuku Station, Tokyo, Japan';
      if (loc.includes('ginza')) return 'Ginza Station, Tokyo, Japan';
      if (loc.includes('asakusa')) return 'Asakusa Station, Tokyo, Japan';
      if (loc.includes('ueno')) return 'Ueno Station, Tokyo, Japan';
      if (loc.includes('akihabara')) return 'Akihabara Station, Tokyo, Japan';
      if (loc.includes('tokyo')) return 'Tokyo Station, Tokyo, Japan';
      if (loc.includes('tsukiji')) return 'Tsukiji Market, Tokyo, Japan';
      
      // Kyoto neighborhoods
      if (loc.includes('kyoto')) return 'Kyoto Station, Kyoto, Japan';
      if (loc.includes('gion')) return 'Gion-Shijo Station, Kyoto, Japan';
      if (loc.includes('fushimi')) return 'Fushimi-Inari Station, Kyoto, Japan';
      if (loc.includes('arashiyama')) return 'Arashiyama Station, Kyoto, Japan';
      
      // Osaka neighborhoods
      if (loc.includes('osaka')) return 'Osaka Station, Osaka, Japan';
      if (loc.includes('namba')) return 'Namba Station, Osaka, Japan';
      if (loc.includes('dotonbori')) return 'Namba Station, Osaka, Japan';
      if (loc.includes('shinsekai')) return 'Shinsekai, Osaka, Japan';
      
      // Default fallback
      return `${location}, Tokyo, Japan`;
    }

    async function createActivityCard(activity) {
      const style = activityTypeStyles[activity.type] || activityTypeStyles.cultural;
      const costDisplay = activity.cost.yen > 0 ? 
        `<div class="activity-cost">
          <div class="cost-yen">¥${activity.cost.yen.toLocaleString()}</div>
          <div class="cost-usd">$${activity.cost.usd.toFixed(2)}</div>
        </div>` : 
        `<div class="activity-cost">
          <div class="cost-yen">Free</div>
        </div>`;

      const significanceSection = activity.significance ? 
        `<div class="significance-box">
          <div class="significance-title">Why This Matters:</div>
          <div style="font-size: var(--base-text);">${activity.significance}</div>
        </div>` : '';

      const whatToDoSection = activity.whatToDo ? 
        `<div style="margin: 12px 0;">
          <h4 style="font-weight: 500; font-size: var(--base-text); margin-bottom: 8px;">What to Do:</h4>
          <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text);">
            ${activity.whatToDo.map(item => {
              // Strategic emoji mapping for key actions
              let emoji = "•";
              const itemLower = item.toLowerCase();
              
              if (itemLower.includes("walk") || itemLower.includes("stroll")) emoji = "🚶";
              else if (itemLower.includes("take photo") || itemLower.includes("photos")) emoji = "📸";
              else if (itemLower.includes("train") || itemLower.includes("subway") || itemLower.includes("metro")) emoji = "🚆";
              else if (itemLower.includes("taxi") || itemLower.includes("bus")) emoji = "🚌";
              else if (itemLower.includes("food") || itemLower.includes("eat") || itemLower.includes("try") || itemLower.includes("sample")) emoji = "🍜";
              else if (itemLower.includes("temple") || itemLower.includes("shrine") || itemLower.includes("pray")) emoji = "⛩️";
              else if (itemLower.includes("bow") || itemLower.includes("purify")) emoji = "🙏";
              else if (itemLower.includes("view") || itemLower.includes("see") || itemLower.includes("watch")) emoji = "👀";
              else if (itemLower.includes("shop") || itemLower.includes("buy") || itemLower.includes("browse")) emoji = "🛍️";
              else if (itemLower.includes("experience") || itemLower.includes("enjoy")) emoji = "✨";
              else if (itemLower.includes("exit") || itemLower.includes("entrance")) emoji = "🚪";
              else if (itemLower.includes("transfer") || itemLower.includes("change")) emoji = "🔄";
              
              return `<li style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: var(--base-text); margin-top: 2px;">${emoji}</span>
                <span style="font-size: var(--base-text);">${item}</span>
              </li>`;
            }).join('')}
          </ul>
        </div>` : '';

      const whatToExpectSection = activity.whatToExpect ? 
        `<div class="significance-box">
          <div class="significance-title">What to Expect:</div>
          <div style="font-size: var(--base-text);">${activity.whatToExpect}</div>
        </div>` : '';

      const culturalEtiquetteSection = activity.culturalEtiquette ? 
        `<div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <div style="display: flex; align-items: start; gap: 8px;">
            <span style="color: #92400e; margin-top: 2px;">🙏</span>
            <div>
              <div style="font-weight: 500; font-size: var(--base-text); margin-bottom: 4px; color: #92400e;">Cultural Etiquette:</div>
              <div style="font-size: var(--base-text); color: #92400e;">${activity.culturalEtiquette}</div>
            </div>
          </div>
        </div>` : '';

      const festivalSection = activity.festivalHighlights ? 
        `<div style="background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <div style="display: flex; align-items: start; gap: 8px;">
            <span style="color: #a16207; margin-top: 2px;">🎌</span>
            <div>
              <div style="font-weight: 500; font-size: var(--base-text); margin-bottom: 4px; color: #a16207;">Festival Highlights:</div>
              <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #92400e;">
                ${activity.festivalHighlights.map(highlight => `<li style="margin-bottom: 2px; font-size: var(--base-text);">${highlight}</li>`).join('')}
              </ul>
            </div>
          </div>
        </div>` : '';

      const restaurantsSection = activity.restaurants ? 
        `<div style="margin-top: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: var(--medium-text);">🍜</span>
            <h4 style="font-weight: 500; font-size: var(--base-text); margin: 0;">Restaurant Options (${activity.restaurants.length}):</h4>
          </div>
          <div style="space-y: 8px;">
            ${activity.restaurants.map((restaurant, idx) => `
              <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div style="flex: 1;">
                    ${locationDatabase[restaurant.name] ? createMapLink(restaurant.name) : `<h5 style="font-weight: 500; font-size: var(--base-text); margin: 0;">${restaurant.name}</h5>`}
                  </div>
                  <span style="font-size: var(--small-text); font-weight: 500; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 4px; margin-left: 8px;">
                    ${restaurant.cost}
                  </span>
                </div>
                <p style="font-size: var(--base-text); margin: 0 0 8px 0;">${restaurant.description}</p>
                ${restaurant.whyRecommended ? `
                  <p style="font-size: var(--small-text); color: #059669; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 4px; margin: 4px 0;">
                    <strong>Why recommended:</strong> ${restaurant.whyRecommended}
                  </p>
                ` : ''}
                ${restaurant.whatToExpect ? `
                  <p style="font-size: var(--small-text); color: #1d4ed8; background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 4px; margin: 4px 0;">
                    <strong>What to expect:</strong> ${restaurant.whatToExpect}
                  </p>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>` : '';

      // Transit integration for transport activities
      let transitSection = '';
      if (activity.type === 'transport' && activity.route) {
        try {
          const transitData = await getTransitWithFallback(activity.route.origin, activity.route.destination);
          transitSection = `
            <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; margin-top: 12px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: var(--medium-text);">🚆</span>
                <h4 style="font-weight: 600; font-size: var(--base-text); margin: 0;">Live Transit Info</h4>
              </div>
              ${createMultiModalDisplay(transitData, true)}
            </div>
          `;
        } catch (error) {
          transitSection = `
            <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; margin-top: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: var(--medium-text);">🚆</span>
                <span style="font-size: var(--base-text);">📅 Scheduled • Check local timetables</span>
              </div>
            </div>
          `;
        }
      }

      return `
        <div class="activity-card" style="background: ${style.bg}; border-color: ${style.border};">
          <div class="activity-header">
            <div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 8px;">
                  <span style="font-size: 18px;">${style.icon}</span>
                </div>
                <div>
                  <div class="activity-type">${activity.type}</div>
                  <div class="activity-time">🕐 ${activity.time}</div>
                </div>
              </div>
            </div>
            ${costDisplay}
          </div>
          <div class="activity-title">${activity.title}</div>
          <div class="activity-location">${locationDatabase[activity.location] ? createMapLink(activity.location) : `📍 ${activity.location}`}</div>
          <div class="activity-description">${activity.description}</div>
          ${significanceSection}
          ${whatToDoSection}
          ${whatToExpectSection}
          ${culturalEtiquetteSection}
          ${festivalSection}
          ${restaurantsSection}
          ${transitSection}
        </div>
      `;
    }

    function updateCostSummary(totalCost) {
      const costSummary = document.querySelector('.content > div > div:last-child');
      const yenElement = costSummary.querySelector('div[style*="font-size: 24px"]:first-of-type');
      const usdElement = costSummary.querySelector('div[style*="font-size: 24px"]:last-of-type');
      
      yenElement.textContent = `¥${totalCost.yen.toLocaleString()}`;
      usdElement.textContent = `$${totalCost.usd.toFixed(2)}`;
    }

    async function previousDay() {
      if (currentDayIndex > 0) {
        currentDayIndex--;
        await updateDayDisplay();
      }
    }

    async function nextDay() {
      if (currentDayIndex < tripDays.length - 1) {
        currentDayIndex++;
        await updateDayDisplay();
      }
    }
    
    // Function for "Today" button - navigates to actual current day
    async function goToToday() {
      const todayIndex = getCurrentTripDay();
      if (todayIndex !== currentDayIndex) {
        currentDayIndex = todayIndex;
        await updateDayDisplay();
        addDebugLog(`📅 Navigated to actual trip day ${todayIndex + 1}`, 'info');
      } else {
        addDebugLog(`📅 Already viewing current trip day ${todayIndex + 1}`, 'info');
      }
    }
    
    // Date Picker Tray Functions
    function toggleDatePicker() {
      const tray = document.getElementById('date-picker-tray');
      const isShowing = tray.classList.contains('show');
      
      if (isShowing) {
        closeDatePicker();
      } else {
        openDatePicker();
      }
    }
    
    function openDatePicker() {
      const tray = document.getElementById('date-picker-tray');
      populateDateList();
      tray.classList.add('show');
      addDebugLog('📅 Date picker opened', 'info');
    }
    
    function closeDatePicker() {
      const tray = document.getElementById('date-picker-tray');
      tray.classList.remove('show');
      addDebugLog('📅 Date picker closed', 'info');
    }
    
    function populateDateList() {
      const dateList = document.getElementById('date-list');
      const actualTodayIndex = getCurrentTripDay();
      
      dateList.innerHTML = '';
      
      tripDays.forEach((day, index) => {
        const isCurrentDay = index === currentDayIndex;
        const isActualToday = index === actualTodayIndex;
        
        let classes = 'date-item';
        if (isCurrentDay) classes += ' current';
        if (isActualToday) classes += ' today';
        
        const dateItem = document.createElement('button');
        dateItem.className = classes;
        dateItem.onclick = () => selectDate(index);
        
        dateItem.innerHTML = `
          <div class="date-number">${index + 1}</div>
          <div class="date-details">
            <div class="date-title">${day.date}</div>
            <div class="date-subtitle">${day.title}</div>
            <div class="date-city">${day.city}</div>
          </div>
          ${isActualToday ? '<div style="color: #f59e0b; font-weight: 600; font-size: 12px;">TODAY</div>' : ''}
        `;
        
        dateList.appendChild(dateItem);
      });
    }
    
    async function selectDate(dayIndex) {
      currentDayIndex = dayIndex;
      await updateDayDisplay();
      closeDatePicker();
      addDebugLog(`📅 Selected day ${dayIndex + 1}`, 'info');
    }
    
    // Version History Functions
    window.showVersionHistory = function() {
      addDebugLog('🔍 showVersionHistory function called!', 'info');
      console.log('showVersionHistory function called');
      const modal = document.getElementById('version-modal');
      if (modal) {
        addDebugLog('✅ Modal element found', 'success');
        populateVersionHistory();
        modal.classList.add('show');
        addDebugLog('📋 Version history opened', 'info');
      } else {
        addDebugLog('❌ Modal element not found!', 'error');
      }
    };
    
    window.closeVersionHistory = function() {
      const modal = document.getElementById('version-modal');
      modal.classList.remove('show');
      addDebugLog('📋 Version history closed', 'info');
    };
    
    // Test function to verify modal works
    window.testVersionModal = function() {
      addDebugLog('🧪 Testing version modal directly', 'info');
      console.log('Testing version modal');
      showVersionHistory();
    };
    
    function populateVersionHistory() {
      const versionList = document.getElementById('version-history-list');
      
      versionList.innerHTML = VERSION_HISTORY.map(version => `
        <div class="version-item">
          <div class="version-number">${version.version}</div>
          <div class="version-date">Released: ${version.date}</div>
          <ul class="version-changes">
            ${version.changes.map(change => `
              <li class="${change.type}">
                <span class="change-type">${getChangeIcon(change.type)}</span>
                <span>${change.text}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `).join('');
    }
    
    function getChangeIcon(type) {
      switch(type) {
        case 'added': return '✅';
        case 'improved': return '🔧';
        case 'fixed': return '🐛';
        default: return '•';
      }
    }

    // Text size controls functionality
    function toggleTextControls() {
      const controls = document.getElementById('text-controls');
      controls.classList.toggle('show');
      addDebugLog(`📝 Text controls ${controls.classList.contains('show') ? 'opened' : 'closed'}`, 'info');
    }
    
    // Close text controls when clicking outside
    document.addEventListener('click', function(e) {
      const controls = document.getElementById('text-controls');
      const toggle = document.getElementById('text-toggle');
      
      if (!controls.contains(e.target) && e.target !== toggle) {
        controls.classList.remove('show');
      }
      
      // Close date picker when clicking outside
      const datePicker = document.getElementById('date-picker-tray');
      const dayNavCenter = document.querySelector('.day-nav-center');
      
      if (datePicker && dayNavCenter && !datePicker.contains(e.target) && !dayNavCenter.contains(e.target)) {
        closeDatePicker();
      }
      
      // Close version history modal when clicking outside
      const versionModal = document.getElementById('version-modal');
      const versionContent = document.querySelector('.version-content');
      
      if (versionModal && versionContent && versionModal.classList.contains('show') && 
          !versionContent.contains(e.target)) {
        closeVersionHistory();
      }
    });
    
    // Text size adjustment functionality
    function setTextSize(size) {
      // Set data attribute on document root for CSS variables
      document.documentElement.setAttribute('data-text-size', size);
      
      // Update button states
      document.querySelectorAll('.text-size-option').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`text-${size}`).classList.add('active');
      
      // Save preference to localStorage
      localStorage.setItem('japan-app-text-size', size);
      
      // Close the controls menu
      document.getElementById('text-controls').classList.remove('show');
      
      // Text size change confirmation
      setTimeout(() => {
        const scale = getComputedStyle(document.documentElement).getPropertyValue('--text-scale').trim();
        addDebugLog(`📝 Text size changed to ${size} (scale: ${scale})`, 'info');
      }, 100);
    }
    
    // Load saved text size preference
    function loadTextSizePreference() {
      const savedSize = localStorage.getItem('japan-app-text-size');
      if (savedSize && ['small', 'medium', 'large', 'xlarge'].includes(savedSize)) {
        setTextSize(savedSize);
      } else {
        // Set default if no preference saved
        setTextSize('medium');
      }
    }
    
    // Text size preference will be loaded in the main DOMContentLoaded listener
    
    // Text size preference is loaded in the main DOMContentLoaded listener
    
    // View switching functionality - make sure it's globally available
    window.showView = function(viewName) {
      addDebugLog(`🔄 Attempting to switch to ${viewName} view`, 'info');
      
      // Hide all views
      document.getElementById('today-view').classList.add('hidden');
      document.getElementById('overview-view').classList.add('hidden');
      document.getElementById('budget-view').classList.add('hidden');
      document.getElementById('currency-view').classList.add('hidden');
      
      // Show selected view
      const targetView = document.getElementById(`${viewName}-view`);
      if (targetView) {
        targetView.classList.remove('hidden');
        addDebugLog(`✅ ${viewName} view is now visible`, 'success');
      } else {
        addDebugLog(`❌ Could not find ${viewName}-view element`, 'error');
      }
      
      // Update navigation states
      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeButton = document.getElementById(`nav-${viewName}`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
      
      // Hide/show day navigation based on view
      const dayNav = document.querySelector('.day-nav');
      if (viewName === 'today') {
        dayNav.style.display = 'flex';
        // When switching to Today view, navigate to actual current day
        goToToday();
      } else {
        dayNav.style.display = 'none';
      }
      
      // Load content for the view
      if (viewName === 'overview') {
        if (document.getElementById('overview-view').children.length === 0) {
          addDebugLog(`📋 Loading overview content`, 'info');
          loadOverviewContent();
        } else {
          // Re-attach version tile event listener if content already exists
          addDebugLog(`📋 Re-attaching version tile listener`, 'info');
          const versionTile = document.getElementById('version-tile');
          if (versionTile) {
            addDebugLog('✅ Version tile found, re-adding event handlers', 'success');
            
            // Function to handle the version tile interaction
            function handleVersionTileClick(event) {
              event.preventDefault();
              event.stopPropagation();
              addDebugLog('🔍 Version tile interacted! (re-attached)', 'info');
              console.log('Version tile interacted (re-attached), calling showVersionHistory()');
              
              // Add immediate visual feedback
              versionTile.style.transform = 'scale(0.95)';
              versionTile.style.background = 'linear-gradient(135deg, #e2e8f0, #cbd5e1)';
              
              setTimeout(() => {
                versionTile.style.transform = 'scale(1)';
                versionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
                showVersionHistory();
              }, 100);
            }
            
            // Remove any existing listeners and add new ones
            versionTile.replaceWith(versionTile.cloneNode(true));
            const newVersionTile = document.getElementById('version-tile');
            
            newVersionTile.addEventListener('click', handleVersionTileClick);
            newVersionTile.addEventListener('touchend', handleVersionTileClick);
            
            // Add visual feedback for touch start
            newVersionTile.addEventListener('touchstart', function(event) {
              addDebugLog('👆 Version tile touch started (re-attached)', 'info');
              newVersionTile.style.transform = 'scale(0.98)';
              newVersionTile.style.background = 'linear-gradient(135deg, #e0e7ff, #c7d2fe)';
            });
            
            // Reset visual feedback if touch is cancelled
            newVersionTile.addEventListener('touchcancel', function(event) {
              newVersionTile.style.transform = 'scale(1)';
              newVersionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
            });
            
          } else {
            addDebugLog('❌ Version tile not found on re-attach!', 'error');
          }
          
          // Reload weather advisory
          loadOverviewWeatherAdvisory();
        }
      }
      if (viewName === 'budget' && document.getElementById('budget-view').children.length === 0) {
        addDebugLog(`💰 Loading budget content`, 'info');
        loadBudgetContent();
      }
      if (viewName === 'currency' && document.getElementById('currency-view').children.length === 0) {
        addDebugLog(`💱 Loading currency converter`, 'info');
        loadCurrencyContent();
      }
      
      addDebugLog(`📱 Switched to ${viewName} view`, 'info');
    };
    
    // Load Overview content
    function loadOverviewContent() {
      const overviewView = document.getElementById('overview-view');
      overviewView.innerHTML = `
        <div>
          <h2 style="font-size: var(--title-text); font-weight: bold; color: #1f2937; margin-bottom: 16px;">
            🇯🇵 Trip Overview
          </h2>
          
          <!-- Weather Advisory Section -->
          <div id="overview-weather-advisory" style="margin-bottom: 16px;">
            <!-- Weather advisory will be populated here -->
          </div>
          
          <!-- Trip Summary -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #1e40af; margin-bottom: 12px;">📅 July 14-24, 2025</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: var(--base-text);">
              <div><strong>🏨 Tokyo:</strong> 5 days</div>
              <div><strong>🏮 Kyoto:</strong> 4 days</div>
              <div><strong>🍜 Osaka:</strong> 2 days</div>
              <div><strong>💰 Budget:</strong> $916-1,252</div>
            </div>
          </div>
          
          <!-- Cultural Highlights -->
          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 12px;">🎌 Cultural Masterpieces</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #92400e;">
              <li style="margin-bottom: 8px;"><strong>Mitama Matsuri Festival:</strong> 30,000+ lanterns at ${createMapLink('Yasukuni Shrine')}</li>
              <li style="margin-bottom: 8px;"><strong>Gion Matsuri Atmosphere:</strong> 1,150+ year festival tradition</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Fushimi Inari Shrine', 'Fushimi Inari')}:</strong> 10,000+ vermillion torii gates</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Tokyo National Museum')}:</strong> 89 National Treasures</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Sensoji Temple')}:</strong> Tokyo's oldest temple (7th century)</li>
            </ul>
          </div>
          
          <!-- Culinary Journey -->
          <div style="background: linear-gradient(135deg, #fed7d7, #fecaca); border: 1px solid #f87171; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">🍜 Culinary Excellence</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #dc2626;">
              <li style="margin-bottom: 8px;"><strong>Tsukiji Market:</strong> Ultra-fresh sushi at legendary dawn stalls</li>
              <li style="margin-bottom: 8px;"><strong>Michelin Experiences:</strong> Bib Gourmand ramen under $15</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Dotonbori')} Marathon:</strong> Osaka's "eat until you drop" capital</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Nishiki Market')}:</strong> 400+ years of imperial culinary tradition</li>
              <li style="margin-bottom: 8px;"><strong>Regional Specialties:</strong> Tokyo, Kyoto kaiseki, Osaka cuisine</li>
            </ul>
          </div>
          
          <!-- Modern Adventures -->
          <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border: 1px solid #8b5cf6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #7c3aed; margin-bottom: 12px;">🚗 Unique Adventures</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #7c3aed;">
              <li style="margin-bottom: 8px;"><strong>Mario Kart Racing:</strong> Drive through Shibuya Crossing in costume</li>
              <li style="margin-bottom: 8px;"><strong>teamLab Planets:</strong> World's most visited digital art museum</li>
              <li style="margin-bottom: 8px;"><strong>Bullet Train:</strong> 320 km/h engineering marvel</li>
              <li style="margin-bottom: 8px;"><strong>Golden Gai:</strong> Tiny post-war drinking district</li>
            </ul>
          </div>
          
          <!-- Premium Nightlife -->
          <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border: 1px solid #a855f7; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #9333ea; margin-bottom: 12px;">🌃 Premium Views & Nightlife</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #9333ea;">
              <li style="margin-bottom: 8px;"><strong>K36 Kyoto:</strong> Eye-level Yasaka Pagoda view (unique in world)</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('WOMB Shibuya')}:</strong> Tokyo's premier EDM club</li>
              <li style="margin-bottom: 8px;"><strong>${createMapLink('Ni-chome', 'Ni-chome Tokyo')}:</strong> Asia's largest LGBTQ+ district</li>
              <li style="margin-bottom: 8px;"><strong>Premium Rooftops:</strong> Craft cocktails with city panoramas</li>
            </ul>
          </div>
          
          <!-- App Info -->
          <div id="version-tile" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border: 1px solid #cbd5e1; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease; -webkit-tap-highlight-color: rgba(59, 130, 246, 0.3); user-select: none;">
            <div style="font-size: var(--base-text); color: #64748b; margin-bottom: 4px;">Japan Travel App</div>
            <div style="font-size: var(--small-text); color: #3b82f6; font-family: monospace; font-weight: 600;">${APP_VERSION}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">📋 Tap to view version history</div>
          </div>
        </div>
      `;
      
      // Add comprehensive touch/click handlers to version tile
      const versionTile = document.getElementById('version-tile');
      if (versionTile) {
        addDebugLog('✅ Version tile found, adding event handlers', 'success');
        
        // Function to handle the version tile interaction
        function handleVersionTileClick(event) {
          event.preventDefault();
          event.stopPropagation();
          addDebugLog('🔍 Version tile interacted!', 'info');
          console.log('Version tile interacted, calling showVersionHistory()');
          
          // Add immediate visual feedback
          versionTile.style.transform = 'scale(0.95)';
          versionTile.style.background = 'linear-gradient(135deg, #e2e8f0, #cbd5e1)';
          
          setTimeout(() => {
            versionTile.style.transform = 'scale(1)';
            versionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
            showVersionHistory();
          }, 100);
        }
        
        // Add multiple event types for better mobile compatibility
        versionTile.addEventListener('click', handleVersionTileClick);
        versionTile.addEventListener('touchend', handleVersionTileClick);
        
        // Add visual feedback for touch start
        versionTile.addEventListener('touchstart', function(event) {
          addDebugLog('👆 Version tile touch started', 'info');
          versionTile.style.transform = 'scale(0.98)';
          versionTile.style.background = 'linear-gradient(135deg, #e0e7ff, #c7d2fe)';
        });
        
        // Reset visual feedback if touch is cancelled
        versionTile.addEventListener('touchcancel', function(event) {
          versionTile.style.transform = 'scale(1)';
          versionTile.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
        });
        
      } else {
        addDebugLog('❌ Version tile not found!', 'error');
      }
      
      // Load weather advisory for overview
      loadOverviewWeatherAdvisory();
    }
    
    async function loadOverviewWeatherAdvisory() {
      const advisoryContainer = document.getElementById('overview-weather-advisory');
      if (!advisoryContainer) return;
      
      try {
        // Get weather for all cities
        const tokyoWeather = await getWeatherWithFallback('Tokyo');
        const kyotoWeather = await getWeatherWithFallback('Kyoto');
        const osakaWeather = await getWeatherWithFallback('Osaka');
        
        const tokyoRec = getWeatherRecommendation(tokyoWeather);
        const kyotoRec = getWeatherRecommendation(kyotoWeather);
        const osakaRec = getWeatherRecommendation(osakaWeather);
        
        // Determine overall trip weather advisory
        let overallAdvice = '';
        let adviceType = 'good';
        let adviceIcon = '✨';
        
        // Check for severe weather across all cities
        if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'storm')) {
          adviceType = 'storm';
          adviceIcon = '⛈️';
          overallAdvice = 'Severe weather warnings across Japan - monitor conditions closely and have indoor backup plans ready';
        } else if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'rain')) {
          adviceType = 'rain';
          adviceIcon = '☔';
          overallAdvice = 'Rain expected in some areas - pack umbrella and consider indoor activities like museums, shopping centers, and covered markets';
        } else if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'heat')) {
          adviceType = 'heat';
          adviceIcon = '🌡️';
          overallAdvice = 'Very hot and humid conditions across Japan - stay hydrated, seek air conditioning frequently, and plan outdoor activities for early morning or evening';
        } else if ([tokyoRec, kyotoRec, osakaRec].some(rec => rec.type === 'warm')) {
          adviceType = 'warm';
          adviceIcon = '☀️';
          overallAdvice = 'Warm weather expected - stay hydrated and take breaks in air-conditioned spaces';
        } else {
          overallAdvice = 'Great weather conditions across all destinations - perfect for outdoor sightseeing and activities!';
        }
        
        // Add current conditions note if using live data
        const isLiveData = !tokyoWeather.isStatic;
        const dataNote = isLiveData ? 
          'Based on current weather conditions. Trip dates are in July 2025.' : 
          'Estimated conditions for July travel period.';
        
        advisoryContainer.innerHTML = `
          <div style="background: ${getAdvisoryBackground(adviceType)}; border: 1px solid ${getAdvisoryBorder(adviceType)}; border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: var(--large-text); margin-top: 2px;">${adviceIcon}</span>
              <div style="flex: 1;">
                <h3 style="font-size: var(--large-text); font-weight: bold; color: ${getAdvisoryTextColor(adviceType)}; margin-bottom: 8px;">
                  Trip Weather Advisory
                </h3>
                <p style="font-size: var(--base-text); color: ${getAdvisoryTextColor(adviceType)}; margin-bottom: 12px; line-height: 1.5;">
                  ${overallAdvice}
                </p>
                
                <!-- City Weather Summary -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                  <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                    <div style="font-size: var(--medium-text); margin-bottom: 4px;">${getWeatherIcon(tokyoWeather.weather[0].main)}</div>
                    <div style="font-size: var(--small-text); font-weight: 600; color: ${getAdvisoryTextColor(adviceType)};">Tokyo</div>
                    <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)};">${Math.round(tokyoWeather.main.temp)}°C</div>
                  </div>
                  <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                    <div style="font-size: var(--medium-text); margin-bottom: 4px;">${getWeatherIcon(kyotoWeather.weather[0].main)}</div>
                    <div style="font-size: var(--small-text); font-weight: 600; color: ${getAdvisoryTextColor(adviceType)};">Kyoto</div>
                    <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)};">${Math.round(kyotoWeather.main.temp)}°C</div>
                  </div>
                  <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                    <div style="font-size: var(--medium-text); margin-bottom: 4px;">${getWeatherIcon(osakaWeather.weather[0].main)}</div>
                    <div style="font-size: var(--small-text); font-weight: 600; color: ${getAdvisoryTextColor(adviceType)};">Osaka</div>
                    <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)};">${Math.round(osakaWeather.main.temp)}°C</div>
                  </div>
                </div>
                
                <div style="font-size: var(--small-text); color: ${getAdvisoryTextColor(adviceType)}; opacity: 0.8; font-style: italic;">
                  ${dataNote}
                </div>
              </div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Failed to load overview weather advisory:', error);
        // Show default July advisory
        advisoryContainer.innerHTML = `
          <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: var(--large-text); margin-top: 2px;">🌡️</span>
              <div>
                <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 8px;">
                  July Weather Advisory
                </h3>
                <p style="font-size: var(--base-text); color: #92400e; line-height: 1.5;">
                  July is Japan's hottest, most humid month (29-32°C/84-90°F with 78-83% humidity). Plan indoor activities during peak heat (11am-4pm) and save outdoor sightseeing for early morning or evening.
                </p>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function getAdvisoryBackground(type) {
      switch(type) {
        case 'storm': return '#fef2f2';
        case 'rain': return '#f0f9ff';
        case 'heat': return '#fed7aa';
        case 'warm': return '#fef3c7';
        default: return '#f0fdf4';
      }
    }
    
    function getAdvisoryBorder(type) {
      switch(type) {
        case 'storm': return '#f87171';
        case 'rain': return '#38bdf8';
        case 'heat': return '#fb923c';
        case 'warm': return '#fbbf24';
        default: return '#4ade80';
      }
    }
    
    function getAdvisoryTextColor(type) {
      switch(type) {
        case 'storm': return '#dc2626';
        case 'rain': return '#0284c7';
        case 'heat': return '#ea580c';
        case 'warm': return '#92400e';
        default: return '#16a34a';
      }
    }
    
    // Load Budget content  
    function loadBudgetContent() {
      const budgetView = document.getElementById('budget-view');
      budgetView.innerHTML = `
        <div>
          <h2 style="font-size: var(--title-text); font-weight: bold; color: #1f2937; margin-bottom: 16px;">
            💰 Complete Trip Budget
          </h2>
          
          <!-- Grand Total -->
          <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 1px solid #4ade80; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
            <h3 style="font-size: var(--xl-text); font-weight: bold; color: #15803d; margin-bottom: 8px;">🇯🇵 GRAND TOTAL</h3>
            <div style="font-size: var(--title-text); font-weight: bold; color: #15803d; margin-bottom: 4px;">$916 - $1,252</div>
            <div style="font-size: var(--base-text); color: #16a34a;">Daily Average: $83-114 per day</div>
          </div>
          
          <!-- Tokyo Phase -->
          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 12px;">🗼 Tokyo Phase (5 Days) - July 14-18</h3>
            <div style="font-size: var(--base-text); color: #92400e; margin-bottom: 12px;"><strong>Total: $505-690</strong></div>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #92400e;">
              <li>Day 1 (Arrival & Recovery): $31-46</li>
              <li>Day 2 (Traditional + Mitama Matsuri): $107-142</li>
              <li>Day 3 (Modern + teamLab + Mario Kart): $140-175</li>
              <li>Day 4 (Markets + Museums + Culture): $75-95</li>
              <li>Day 5 (Final Tokyo + Premium Nightlife): $152-232</li>
            </ul>
          </div>
          
          <!-- Transfer Day -->
          <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border: 1px solid #8b5cf6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #7c3aed; margin-bottom: 8px;">🚄 Transfer Day - July 19</h3>
            <div style="font-size: var(--base-text); color: #7c3aed;">
              <strong>Bullet Train + Food + Transport: $126-141</strong>
            </div>
          </div>
          
          <!-- Kyoto/Osaka Phase -->
          <div style="background: linear-gradient(135deg, #fed7d7, #fecaca); border: 1px solid #f87171; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">🏮 Kyoto/Osaka Phase (5 Days) - July 20-24</h3>
            <div style="font-size: var(--base-text); color: #dc2626; margin-bottom: 12px;"><strong>Total: $285-421</strong></div>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #dc2626;">
              <li>Day 7 (Gion Matsuri Atmosphere): $57-84</li>
              <li>Day 8 (Temples & Bamboo Grove): $42-57</li>
              <li>Day 9 (Osaka Culinary Day Trip): $94-147</li>
              <li>Day 10 (Final Kyoto + Transfer): $59-89</li>
              <li>Day 11 (Final Day & Departure): $33-44</li>
            </ul>
          </div>
          
          <!-- What's Included -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #1e40af; margin-bottom: 12px;">✅ What This Includes</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #1e40af;">
              <li style="margin-bottom: 4px;"><strong>All meals:</strong> Street food to Michelin Bib Gourmand dining</li>
              <li style="margin-bottom: 4px;"><strong>All transportation:</strong> Local trains, buses, bullet train</li>
              <li style="margin-bottom: 4px;"><strong>Cultural activities:</strong> Museums, temples, digital art, festivals</li>
              <li style="margin-bottom: 4px;"><strong>Premium nightlife:</strong> Rooftop bars, EDM clubs, LGBTQ+ venues</li>
              <li style="margin-bottom: 4px;"><strong>Festival experiences:</strong> Mitama Matsuri + Gion Matsuri</li>
            </ul>
          </div>
          
          <!-- Not Included -->
          <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #f87171; border-radius: 12px; padding: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">❌ NOT Included</h3>
            <ul style="margin: 0; padding-left: 16px; font-size: var(--base-text); color: #dc2626;">
              <li style="margin-bottom: 4px;"><strong>Hotels:</strong> Fully covered by Hyatt Globalist status</li>
              <li style="margin-bottom: 4px;"><strong>International flights:</strong> CLT-ORD-HND and return</li>
              <li style="margin-bottom: 4px;"><strong>Personal shopping:</strong> Souvenirs and individual purchases</li>
              <li style="margin-bottom: 4px;"><strong>Travel insurance:</strong> Recommended but calculated separately</li>
            </ul>
          </div>
        </div>
      `;
    }

    // Load Currency Converter content  
    function loadCurrencyContent() {
      const currencyView = document.getElementById('currency-view');
      currencyView.innerHTML = `
        <div>
          <h2 style="font-size: var(--title-text); font-weight: bold; color: #1f2937; margin-bottom: 16px;">
            💱 Live Currency Converter
          </h2>
          
          <!-- Exchange Rate Display -->
          <div id="exchange-rate-display" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 1px solid #4ade80; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
            <div style="font-size: var(--base-text); color: #15803d; margin-bottom: 8px;">Current Exchange Rate</div>
            <div id="current-rate" style="font-size: var(--title-text); font-weight: bold; color: #15803d;">
              Loading...
            </div>
            <div id="rate-timestamp" style="font-size: var(--small-text); color: #16a34a; margin-top: 4px;">
              Fetching latest rates...
            </div>
            <button onclick="refreshExchangeRate()" style="background: #16a34a; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: var(--small-text); margin-top: 8px; cursor: pointer;">
              🔄 Refresh Rate
            </button>
          </div>
          
          <!-- Currency Converter -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #1e40af; margin-bottom: 16px;">💰 Quick Converter</h3>
            
            <!-- USD to JPY -->
            <div style="margin-bottom: 16px;">
              <label style="font-size: var(--base-text); color: #1e40af; display: block; margin-bottom: 8px;">US Dollars (USD)</label>
              <input type="number" id="usd-input" placeholder="Enter USD amount" style="width: 100%; padding: 12px; border: 1px solid #93c5fd; border-radius: 8px; font-size: var(--base-text);" oninput="convertUSDtoJPY()">
              <div id="usd-result" style="font-size: var(--base-text); color: #1e40af; margin-top: 8px; font-weight: 500;"></div>
            </div>
            
            <!-- JPY to USD -->
            <div style="margin-bottom: 16px;">
              <label style="font-size: var(--base-text); color: #1e40af; display: block; margin-bottom: 8px;">Japanese Yen (JPY)</label>
              <input type="number" id="jpy-input" placeholder="Enter JPY amount" style="width: 100%; padding: 12px; border: 1px solid #93c5fd; border-radius: 8px; font-size: var(--base-text);" oninput="convertJPYtoUSD()">
              <div id="jpy-result" style="font-size: var(--base-text); color: #1e40af; margin-top: 8px; font-weight: 500;"></div>
            </div>
          </div>
          
          <!-- Quick Reference Amounts -->
          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #92400e; margin-bottom: 16px;">🎯 Quick Reference</h3>
            <div id="quick-amounts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div onclick="setUSDAmount(10)" style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #f59e0b;">
                <div style="font-size: var(--base-text); font-weight: bold; color: #92400e;">$10</div>
                <div id="ref-10" style="font-size: var(--small-text); color: #92400e;">≈ ¥---</div>
              </div>
              <div onclick="setUSDAmount(20)" style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #f59e0b;">
                <div style="font-size: var(--base-text); font-weight: bold; color: #92400e;">$20</div>
                <div id="ref-20" style="font-size: var(--small-text); color: #92400e;">≈ ¥---</div>
              </div>
              <div onclick="setUSDAmount(50)" style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #f59e0b;">
                <div style="font-size: var(--base-text); font-weight: bold; color: #92400e;">$50</div>
                <div id="ref-50" style="font-size: var(--small-text); color: #92400e;">≈ ¥---</div>
              </div>
              <div onclick="setUSDAmount(100)" style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #f59e0b;">
                <div style="font-size: var(--base-text); font-weight: bold; color: #92400e;">$100</div>
                <div id="ref-100" style="font-size: var(--small-text); color: #92400e;">≈ ¥---</div>
              </div>
            </div>
          </div>
          
          <!-- Travel Budget Helper -->
          <div style="background: linear-gradient(135deg, #fed7d7, #fecaca); border: 1px solid #f87171; border-radius: 12px; padding: 16px;">
            <h3 style="font-size: var(--large-text); font-weight: bold; color: #dc2626; margin-bottom: 12px;">🎌 Japan Travel Guide</h3>
            <div style="font-size: var(--small-text); color: #dc2626; line-height: 1.6;">
              <div style="margin-bottom: 8px;"><strong>💰 Cash is King:</strong> Many places only accept cash - have ¥10,000-20,000 on hand</div>
              <div style="margin-bottom: 8px;"><strong>🏧 ATMs:</strong> 7-Eleven and Japan Post Bank ATMs accept foreign cards</div>
              <div style="margin-bottom: 8px;"><strong>🍜 Food Guide:</strong> Convenience store meal ¥300-500, Restaurant meal ¥800-2,000</div>
              <div style="margin-bottom: 8px;"><strong>🚇 Transport:</strong> Tokyo Metro day pass ¥800, Individual rides ¥150-300</div>
              <div><strong>☕ Coffee:</strong> Vending machine ¥120, Starbucks ¥350-500</div>
            </div>
          </div>
        </div>
      `;
      
      // Load initial exchange rate
      fetchExchangeRate();
    }

    // Global variables for exchange rate
    let currentExchangeRate = 143.50; // Default fallback rate
    let lastRateUpdate = null;

    // Fetch live exchange rate from API
    async function fetchExchangeRate() {
      try {
        addDebugLog('💱 Fetching live exchange rate...', 'info');
        
        // Use exchangerate-api.com (free tier: 1500 requests/month)
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        
        if (!response.ok) {
          throw new Error('Exchange rate API unavailable');
        }
        
        const data = await response.json();
        currentExchangeRate = data.rates.JPY;
        lastRateUpdate = new Date();
        
        updateExchangeRateDisplay();
        updateQuickReference();
        
        addDebugLog(\`💱 Exchange rate updated: $1 = ¥\${currentExchangeRate.toFixed(2)}\`, 'success');
        
        // Cache the rate for 15 minutes
        localStorage.setItem('japan-app-exchange-rate', JSON.stringify({
          rate: currentExchangeRate,
          timestamp: lastRateUpdate.getTime()
        }));
        
      } catch (error) {
        console.error('Failed to fetch exchange rate:', error);
        addDebugLog('⚠️ Using cached/default exchange rate', 'error');
        
        // Try to use cached rate
        const cached = localStorage.getItem('japan-app-exchange-rate');
        if (cached) {
          const parsedCache = JSON.parse(cached);
          const cacheAge = Date.now() - parsedCache.timestamp;
          
          // Use cache if less than 24 hours old
          if (cacheAge < 24 * 60 * 60 * 1000) {
            currentExchangeRate = parsedCache.rate;
            lastRateUpdate = new Date(parsedCache.timestamp);
            addDebugLog('💱 Using cached exchange rate', 'info');
          }
        }
        
        updateExchangeRateDisplay();
        updateQuickReference();
      }
    }

    // Update the exchange rate display
    function updateExchangeRateDisplay() {
      const rateElement = document.getElementById('current-rate');
      const timestampElement = document.getElementById('rate-timestamp');
      
      if (rateElement) {
        rateElement.textContent = \`$1 USD = ¥\${currentExchangeRate.toFixed(2)} JPY\`;
      }
      
      if (timestampElement && lastRateUpdate) {
        timestampElement.textContent = \`Updated: \${lastRateUpdate.toLocaleTimeString()}\`;
      }
    }

    // Update quick reference amounts
    function updateQuickReference() {
      [10, 20, 50, 100].forEach(amount => {
        const element = document.getElementById(\`ref-\${amount}\`);
        if (element) {
          const jpyAmount = (amount * currentExchangeRate).toFixed(0);
          element.textContent = \`≈ ¥\${jpyAmount}\`;
        }
      });
    }

    // Currency conversion functions
    function convertUSDtoJPY() {
      const usdInput = document.getElementById('usd-input');
      const resultDiv = document.getElementById('usd-result');
      
      if (usdInput && resultDiv) {
        const usdAmount = parseFloat(usdInput.value);
        if (isNaN(usdAmount) || usdAmount <= 0) {
          resultDiv.textContent = '';
          return;
        }
        
        const jpyAmount = (usdAmount * currentExchangeRate).toFixed(0);
        resultDiv.textContent = \`= ¥\${jpyAmount} JPY\`;
      }
    }

    function convertJPYtoUSD() {
      const jpyInput = document.getElementById('jpy-input');
      const resultDiv = document.getElementById('jpy-result');
      
      if (jpyInput && resultDiv) {
        const jpyAmount = parseFloat(jpyInput.value);
        if (isNaN(jpyAmount) || jpyAmount <= 0) {
          resultDiv.textContent = '';
          return;
        }
        
        const usdAmount = (jpyAmount / currentExchangeRate).toFixed(2);
        resultDiv.textContent = \`= $\${usdAmount} USD\`;
      }
    }

    // Set USD amount from quick reference
    function setUSDAmount(amount) {
      const usdInput = document.getElementById('usd-input');
      if (usdInput) {
        usdInput.value = amount;
        convertUSDtoJPY();
      }
    }

    // Refresh exchange rate manually
    function refreshExchangeRate() {
      fetchExchangeRate();
    }

    // Add click handlers for debugging
    document.addEventListener('click', function(e) {
      addDebugLog(`👆 Clicked: ${e.target.tagName}`, 'info');
    });
  </script>
</body>
</html>